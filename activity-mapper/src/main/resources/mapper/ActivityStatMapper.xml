<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.chaoxing.activity.mapper.ActivityStatMapper">
    <resultMap id="BaseResultMap" type="com.chaoxing.activity.model.ActivityStat">
        <result column="activity_id" jdbcType="INTEGER" property="activityId" />
        <result column="stat_date" jdbcType="DATE" property="statDate" />
        <result column="pv" jdbcType="INTEGER" property="pv" />
        <result column="signed_up_num" jdbcType="INTEGER" property="signedUpNum" />
        <result column="signed_in_num" jdbcType="INTEGER" property="signedInNum" />
        <result column="create_time" jdbcType="TIMESTAMP" property="createTime" />
    </resultMap>

    <sql id="Base_Column_List">
        t.activity_id, t.stat_date, t.pv, t.signed_up_num, t.signed_in_num, t.create_time
    </sql>

    <select id="listActivityStat" resultType="com.chaoxing.activity.model.ActivityStat">
        SELECT
            <include refid="Base_Column_List"></include>
        FROM t_activity_stat t
        <where>
            t.activity_id in
            <foreach collection="activityIds" item="value" open="(" close=")" separator=",">
                #{value}
            </foreach>
        </where>
        ORDER BY t.stat_date
    </select>

    <select id="listTopActivity" resultType="com.chaoxing.activity.model.ActivityStat">
        SELECT
            ta.name as activityName, t.activity_id as activityId, t.stat_date as statDate, t.signed_up_num as signedUpNum,
            t.signed_in_num as signedInNum, t.create_time as createTime, a.pv as pv
        FROM (
                 SELECT activity_id, max(stat_date) as stat_date, sum(pv) as pv
                 FROM t_activity_stat
                 <where>
                     activity_id in
                     <foreach collection="activityIds" item="value" open="(" close=")" separator=",">
                         #{value}
                     </foreach>
                 </where>
                 GROUP BY activity_id
             ) a
        INNER JOIN t_activity_stat t ON t.activity_id = a.activity_id and t.stat_date = a.stat_date
        LEFT JOIN t_activity ta ON ta.id = t.activity_id
        ORDER BY t.${sortField} DESC
        LIMIT 0, 10
    </select>
</mapper>