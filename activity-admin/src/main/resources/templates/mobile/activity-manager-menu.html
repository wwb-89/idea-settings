<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org/">

<head>
    <title>管理员权限配置</title>
    <meta http-equiv="Content-type" content="text/html; charset=utf-8" />
    <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, minimal-ui" />
    <meta name="format-detection" content="telephone=no, email=no">
    <meta http-equiv="Pragma" content="no-cache" />
    <meta http-equiv="cache-control" content="no-cache" />
    <link rel="stylesheet" href="/static/mobile/assets/lib/layui/css/layui.css" th:href="@{/mobile/assets/lib/layui/css/layui.css}" />
    <link rel="stylesheet" href="/static/mobile/assets/css/public.css" th:href="@{/mobile/assets/css/public.css}" />
    <link rel="stylesheet" href="/static/mobile/assets/css/dialog.css" th:href="@{/mobile/assets/css/dialog.css}">
    <link rel="stylesheet" href="/static/mobile/assets/css/manage.css" th:href="@{/mobile/assets/css/manage.css}">
    <style type="text/css">
        [v-cloak] {
            display: none;
        }
    </style>
</head>

<body>
    <div class="limit-manage" id="limit-manage" v-cloak>
        <p class="title">{{operateUserName}} 拥有以下模块的管理权限</p>
        <form class="layui-form" lay-filter="menuForm" action="">
            <div class="item" v-for="menu in menus">
                <div class="left">
                    <p class="name">{{menu.name}}</p>
                    <p class="desc">{{menu.desc}}</p>
                </div>
                <input type="checkbox" checked :name="menu.code" lay-skin="switch" lay-filter="switchTest" title="开关">
            </div>
        </form>
    </div>
    <div th:replace="mobile/include/common_js :: common_js(~{::script})">
        <script src="/static/mobile/assets/lib/jquery.1.8.2.min.js" th:src="@{/mobile/assets/lib/jquery.1.8.2.min.js}"></script>
        <script src="/static/mobile/assets/lib/jqthumb.min.js" th:src="@{/mobile/assets/lib/jqthumb.min.js}"></script>
        <script src="/static/mobile/assets/lib/vue.js" th:src="@{/mobile/assets/lib/vue.js}"></script>
        <script src="/static/mobile/assets/lib/layui/layui.js" th:src="@{/mobile/assets/lib/layui/layui.js}"></script>
        <script>
            $(function () {
                $('.jqthumbImg').jqthumb({
                    width: '100%',
                    height: '100%'
                });
            })
            layui.use(['form', 'layer'], function () {
                var form = layui.form,
                    layer = layui.layer
            })
        </script>
        <script th:inline="javascript">
            function ready() {
                vm = new Vue({
                    el: "#limit-manage",
                    data: {
                        activityId: [[${activityId}]],
                        manager: [[${manager}]],
                        operateUid: [[${manager.uid}]],
                        operateUserName: [[${manager.userName}]],
                        menus: [[${menus}]],
                        menuForm: {}
                    },
                    created: function () {
                        var $this = this;
                        $this.initMenu();
                    },
                    mounted: function () {
                        var $this = this;
                        $this.initForm();
                    },
                    methods: {
                        initForm: function() {
                            var $this = this;
                            layui.use('form', function() {
                                var form = layui.form;
                                form.on('switch(switchTest)', function(data) {
                                    var name = data.elem.name;
                                    $this.menuForm[name] = data.elem.checked;
                                    $this.confirmConfig();
                                });
                                form.val('menuForm', $this.menuForm);
                                form.render();
                            });
                        },
                        initMenu: function () {
                            var $this = this;
                            var existMenus = $this.manager.menu || "";
                            $($this.menus).each(function () {
                                // 临时active属性初始化为false
                                $this.menuForm[this.code] = existMenus.indexOf(this.code) != -1;
                            });
                        },
                        // 确认权限配置
                        confirmConfig: function () {
                            var $this = this;
                            var keys = Object.keys($this.menuForm);
                            var menus = [];
                            $(keys).each(function (i) {
                                var menu = keys[i];
                                if ($this.menuForm[menu]) {
                                    menus.push(menu);
                                }
                            });
                            $this.manager.menu = menus.join(",");
                            var url = ctx + "/api/activity/" + $this.activityId + "/manager/menus/config";
                            app.ajaxPost(url, { activityManagerStr: JSON.stringify($this.manager) }, function (data) {
                                if (data.success) {
                                    app.showMsg("配置成功");
                                } else {
                                    var errorMessage = data.message;
                                    app.showMsg(errorMessage);
                                }
                            }, function () {
                                app.showMsg("权限配置失败");
                            }, '权限配置');
                        },
                    }
                })
            }
        </script>
    </div>

</body>

</html>