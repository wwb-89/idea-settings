<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org/">
<head>
    <title>评价审核</title>
    <meta http-equiv="Content-type" content="text/html; charset=utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, minimal-ui" />
    <meta name="format-detection" content="telephone=no, email=no">
    <meta http-equiv="Pragma" content="no-cache" />
    <meta http-equiv="cache-control" content="no-cache" />
    <link rel="stylesheet" href="/static/mobile/assets/lib/layui/css/layui.css" th:href="@{/mobile/assets/lib/layui/css/layui.css}">
    <link rel="stylesheet" href="/static/mobile/assets/css/cssreset.css" th:href="@{/mobile/assets/css/cssreset.css}" />
    <link rel="stylesheet" href="/static/mobile/assets/css/public.css" th:href="@{/mobile/assets/css/public.css}" />
    <link rel="stylesheet" href="/static/mobile/assets/css/dialog.css" th:href="@{/mobile/assets/css/dialog.css}">
    <link rel="stylesheet" href="/static/mobile/assets/css/comment.css" th:href="@{/mobile/assets/css/comment.css}">
    <link rel="stylesheet" href="/static/mobile/assets/lib/mescroll/mescroll.css" th:href="@{/mobile/assets/lib/mescroll/mescroll.css}" />
</head>
<body>
    <div id="comment-examine" v-cloak>
        <template v-if="loaded">
            <div class="comment-examine" v-if="hasRatings">
                <p class="count">共 {{total}} 份</p>
                <div class="comment-list">
                    <div class="list clear" v-for="(rating, index) of ratings">
                        <div class="head-box">
                            <img v-if="isAnonymousShow(index)" src="/static/mobile/assets/images/head-default.png" th:src="@{/mobile/assets/images/head-default.png}" class="jqthumbImg" />
                            <img v-else :src="'http://photo.chaoxing.com/p/'+rating.scorerUid+'_80'" class="jqthumbImg">
                        </div>
                        <div class="content">
                            <div class="head">
                                <span class="name" v-if="isAnonymousShow(index)">匿名</span>
                                <span class="name" v-else>{{rating.scorerUserName}}</span>
                                <span class="time">{{rating.createTime}}</span>
                            </div>
                            <div class="star-box" data-name="star-box"></div>
                            <p class="desc overHidden5">{{rating.comment}}</p>
                            <span class="open_close" @click="showDetailComment($event)"></span>
                        </div>
                        <div class="btn-box">
                            <a href="javascript:" class="del-btn red" @click="rejectOpt(index)">删除</a>
                            <div class="line"></div>
                            <a href="javascript:" class="blue" @click="passRate(index)">通过</a>
                        </div>
                    </div>
                </div>
            </div>
            <!-- 评价审核-空 -->
            <div class="noContent" v-else>暂无内容</div>
        </template>

        <!-- 确认删除 -->
        <div class="dialog del-div" v-show="delConfirm">
            <div class="dialog-overlay">
                <div class="content">
                    <div class="sure">
                        <p>确定删除此条评价吗？</p>
                        <p class="delete" @click="rejectRate">删除</p>
                    </div>
                    <div class="cancle" @click="cancelReject">取消</div>
                </div>
            </div>
        </div>
    </div>

    <div th:replace="mobile/include/common_js :: common_js(~{::script})">
        <script src="/static/mobile/assets/lib/layui/layui.js" th:src="@{/mobile/assets/lib/layui/layui.js}"></script>
        <script src="/static/mobile/assets/lib/jqthumb.min.js" th:src="@{/mobile/assets/lib/jqthumb.min.js}"></script>
        <script src="/static/mobile/assets/lib/mescroll/mescroll.js" th:src="@{/mobile/assets/lib/mescroll/mescroll.js}"></script>
        <script th:inline="javascript">
            ratingAudit = new Vue({
                el: "#comment-examine",
                data: {
                    activity: [[${activity}]],
                    loginUser: [[${session._login_user_}]],
                    ratings: [],
                    delConfirm: false,  //  删除确认框显示
                    loaded: false,
                    total: 0,
                    queryParams: {
                        pageNum: 1,
                        pageSize: 10
                    }
                },
                mounted: function() {
                    var $this = this;
                    $this.initMescroll();
                },
                computed: {
                    hasRatings() {
                        var $this = this;
                        return $this.ratings.length > 0;
                    }
                },
                methods: {
                    initMescroll: function() {
                        var $this = this;
                        if ($this.mescroll == null) {
                            $this.mescroll = new MeScroll("body", {
                                //第一个参数"mescroll"对应上面布局结构div的id (1.3.5版本支持传入dom对象)
                                //如果您的下拉刷新是重置列表数据,那么down完全可以不用配置,具体用法参考第一个基础案例
                                //解析: down.callback默认调用mescroll.resetUpScroll(),而resetUpScroll会将page.num=1,
                                // 再触发up.callback
                                down: {
                                    use: false
                                },
                                up: {
                                    callback: function () {
                                        $this.loadRatings();
                                    }, //上拉加载的回调
                                    htmlNodata: '<p class="upwarp-nodata">-- 没有更多了 --</p>',
                                    noMoreSize: 5, //如果列表已无数据,可设置列表的总数量要大于5才显示无更多数据; 避免列表数据过少(比如只有一条数据),显示无更多数据会不好看 这就是为什么无更多数据有时候不显示的原因.
                                }
                            });
                        }
                    },
                    initJqthumbImg: function() {
                        $('.jqthumbImg').jqthumb({
                            width: '100%',
                            height: '100%'
                        });
                    },
                    showDetailComment: function(e) {
                        var rateDom = e.target
                        if($(rateDom).prev($('.content .desc')).hasClass('overHidden5')){
                            $(rateDom).html('收起')
                            $(rateDom).prev($('.content .desc')).removeClass('overHidden5')
                        }else{
                            $(rateDom).html('展开')
                            $(rateDom).prev($('.content .desc')).addClass('overHidden5')
                        }
                    },
                    // 是否匿名显示
                    isAnonymousShow: function(index) {
                        var $this = this;
                        var scorerUid = $this.ratings[index].scorerUid;
                        if($this.loginUser != null){
                            if($this.loginUser.uid == scorerUid){
                                return false;
                            }
                        }
                        return $this.ratings[index].anonymous;
                    },
                    loadRatings: function(){
                        var $this = this;
                        var url = ctx + "/api/activity/rating/audit/list";
                        var params = {
                            pageNum: $this.queryParams.pageNum,
                            pageSize: $this.queryParams.pageSize,
                            activityId: $this.activity.id,
                            auditStatus: 2
                        };
                        app.ajaxPost(url, params, function (data) {
                            if (data.success) {
                                $this.loaded = true;
                                var ratings = data.data.records;
                                $this.total = data.data.total;
                                $this.mescroll.endByPage(ratings.length, data.data.pages);
                                $this.ratings.pushArray(ratings);
                                $this.queryParams.pageNum++;
                                $this.$nextTick(function () {
                                    $this.rateList();
                                    $this.initJqthumbImg();
                                });
                            } else {
                                var errorMessage = data.message;
                                if (activityApp.isEmpty(errorMessage)) {
                                    errorMessage = "加载评价列表失败";
                                }
                                app.showMsg(errorMessage);
                            }
                        }, function () {
                            app.showMsg("加载评价列表失败");
                        });
                    },
                    // 显示删除操作确认项
                    rejectOpt: function(index) {
                        var $this = this;
                        $this.delConfirm = true;
                        $this.activeIndex = index
                    },
                    // 删除评论(审核不通过)
                    rejectRate: function() {
                        var $this = this;
                        var url = ctx + "/api/activity/rating/audit/reject";
                        var params = {
                            activityId: $this.activity.id,
                            activityRatingDetailId: $this.ratings[$this.activeIndex].id
                        };
                        app.ajaxPost(url, params, function (data) {
                            if (data.success) {
                                app.showMsg("删除成功");
                                window.location.reload();
                            } else {
                                var errorMessage = data.message;
                                if (activityApp.isEmpty(errorMessage)) {
                                    errorMessage = "删除评价失败";
                                }
                                app.showMsg(errorMessage);
                            }
                        }, function () {
                            app.showMsg("删除评价失败");
                        });
                    },
                    // 取消删除操作
                    cancelReject: function() {
                        var $this = this;
                        $this.delConfirm = false;
                        $this.activeIndex = null;
                    },
                    // 通过评论
                    passRate: function(index) {
                        var $this = this;
                        var url = ctx + "/api/activity/rating/audit/pass";
                        var params = {
                            activityId: $this.activity.id,
                            activityRatingDetailId: $this.ratings[index].id
                        };
                        app.ajaxPost(url, params, function (data) {
                            if (data.success) {
                                app.showMsg("审核通过");
                                window.location.reload();
                            } else {
                                var errorMessage = data.message;
                                if (activityApp.isEmpty(errorMessage)) {
                                    errorMessage = "审核操作失败";
                                }
                                app.showMsg(errorMessage);
                            }
                        }, function () {
                            app.showMsg("审核操作失败");
                        });
                    },
                    // 遍历每个li中星星
                    rateList: function () {
                        var $this = this;
                        var rates = $("div[data-name='star-box']");
                        rates.each(function (i, n) {
                            var score = $this.ratings[i].score;

                            $(n).addClass("testX");
                            layui.use(['rate'], function () {
                                var rate = layui.rate;
                                rate.render({
                                    elem: $(n),
                                    value: score,
                                    readonly: true,
                                })
                            })
                        })

                        var openClose = $(".open_close")
                        openClose.each(function(i, n) {
                            if ($(n).prev().height() >= 130 && !$(n).text()) {
                                $(n).html("展开")
                            }
                        })
                    },
                }
            });
        </script>
    </div>
</body>
</html>
