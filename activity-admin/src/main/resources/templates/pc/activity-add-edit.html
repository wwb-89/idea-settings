<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org/">
<head>
    <meta charset="UTF-8">
    <title th:text="${activity == null ? '创建活动' : '编辑活动'}">创建活动</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="/static/pc/assets/lib/element-ui/lib/theme-chalk/index.css" th:href="@{/pc/assets/lib/element-ui/lib/theme-chalk/index.css}">
    <link rel="stylesheet" href="/static/pc/assets/lib/zTree_v3/css/zTreeStyle/zTreeStyle.css" th:href="@{/pc/assets/lib/zTree_v3/css/zTreeStyle/zTreeStyle.css}">
    <link rel="stylesheet" href="/static/pc/assets/css/reset.css" th:href="@{/pc/assets/css/reset.css}">
    <link rel="stylesheet" href="/static/pc/assets/css/public.css" th:href="@{/pc/assets/css/public.css}">
    <link rel="stylesheet" href="/static/pc/assets/css/create.css" th:href="@{/pc/assets/css/create.css}">
    <style type="text/css">
        body .create-class .layui-layer-btn0{
            width: 30px;
            height: 30px;
            border: 1px solid #82c3ff;
            border-radius: 15px;
            font-size: 13px;
            margin: 5px 10px 0 5px;
            color: #0084ff;
            background: #ffffff;
            line-height: 30px;
        }
        body .create-class .layui-layer-btn1{
            width: 30px !important;
            height: 30px !important;
            border: 1px solid #82c3ff !important;
            border-radius: 15px !important;
            font-size: 13px;
            margin: 5px 5px 0 10px;
            color: #ffffff;
            background: #0084ff;
            line-height: 30px;
        }
        .webuploader-element-invisible {
            display: none;
        }
        [v-cloak] {
            display: none;
        }
    </style>
    <script src="//api.map.baidu.com/api?v=3.0&ak=aG5nWGO5m5tkVhBHGuVppoIRfKbyp5H3"></script>
</head>

<body>
<div class="page" id="activity-vue" v-cloak>
    <!-- 创建活动头部 -->
    <div class="top flex box" v-if="!activity.id">
        <div class="flex">
            <span class="create" v-show="step == 1">创建活动</span>
            <span class="create" v-show="step == 2">选择活动展示页面</span>
            <span class="create_tips" v-show="step == 2">请选择你的活动呈现样式</span>
        </div>
        <div>
            <button type="button" class="create-btn" v-show="step == 2" @click="preStep">上一步</button>
            <button type="button" class="create-btn" v-show="step == 1" @click="nextStep">下一步</button>
        </div>
    </div>
    <!-- 编辑活动头部 -->
    <div class="top flex box" v-if="activity.id">
        <div class="flex">
            <span class="create" v-show="step == 1">编辑活动</span>
            <span class="create" v-show="step == 2">选择活动展示页面</span>
            <span class="create_tips" v-show="step == 2">请选择你的活动呈现样式</span>
        </div>
        <div>
            <button type="button" class="create-btn" v-show="step == 2" @click="preStep">上一步</button>
            <button type="button" class="create-btn" v-show="step == 1 && !activity.webTemplateId" @click="save">下一步</button>
            <button type="button" class="create-btn" v-show="step == 1 && activity.webTemplateId" @click="save">保存</button>
        </div>
    </div>
    <div v-show="step == 1">
        <div class="info box">
            <form action="" onsubmit="return false;">
                <div class="title">基本信息</div>
                <div class="form-item">
                    <label class="label"><img src="/static/pc/assets/images/required.png" th:src="@{/pc/assets/images/required.png}" class="required-img">名称</label>
                    <div class="input-box">
                        <el-input type="text" placeholder="请填写信息，简短的活动名称" v-model.trim="activity.name" maxlength="50" show-word-limit></el-input>
                    </div>
                </div>
                <div class="form-item">
                    <label class="label"><img src="/static/pc/assets/images/required.png" th:src="@{/pc/assets/images/required.png}" class="required-img">时间</label>
                    <div class="input-box">
                        <el-date-picker v-model="activityDateTimeScope"
                                        type="datetimerange"
                                        format="yyyy-MM-dd HH:mm"
                                        value-format="yyyy-MM-dd HH:mm:ss"
                                        prefix-icon="disable"
                                        :clearable="false"
                                        :editable="false"
                                        start-placeholder="开始时间"
                                        end-placeholder="结束时间"
                                        :default-time="['00:00:00', '23:59:59']"
                                        @change="selectActivityDate($event)">
                            <img style="margin: 0 8px;" slot="range-separator" src="/static/pc/assets/images/swap-right.png" th:src="@{/pc/assets/images/swap-right.png}">
                        </el-date-picker>
                        <span class="date-piker-icon">
                            <img src="/static/pc/assets/images/calendar.png" th:src="@{/pc/assets/images/calendar.png}">
                        </span>
                    </div>
                </div>
                <div class="form-item align-start">
                    <label class="label cover"><img src="/static/pc/assets/images/required.png" th:src="@{/pc/assets/images/required.png}" class="required-img">封面</label>
                    <div class="input-box">
                        <div class="img-box">
                            <img :src="activity | getCloudImgUrl" class="cover-img jqthumbImg">
                        </div>
                        <div class="font-box">
                            <span>建议尺寸：540*280</span>
                            <span>大小：小于5M</span>
                            <span>格式：jpg、png、gif</span>
                            <button id="cover-upload-btn" class="cancle-btn upload">上传文件</button>
                        </div>
                    </div>
                </div>
                <div class="form-item">
                    <label class="label">主办方</label>
                    <div class="input-box" style="width: 400px;">
                        <el-input type="text" placeholder="请填写主办方" v-model.trim="activity.organisers" maxlength="20"></el-input>
                    </div>
                </div>
                <div class="form-item">
                    <label class="label">活动类型</label>
                    <div class="input-box">
                        <el-radio v-for="(activityType, index) of activityTypes" :key="'activity-type-' + index" v-model="activity.activityType" :label="activityType.value" name="active-type">{{activityType.name}}</el-radio>
                    </div>
                </div>
                <div class="form-item" v-show="activity.activityType == 'offline'">
                    <label class="label">位置</label>
                    <div class="input-box">
                        <input type="text" readonly required lay-verify="required" v-model.trim="activity.address" placeholder="请选择活动地点" autocomplete="off" class="layui-input name show-addr" style="cursor: pointer;" @click="showActivityMap">
                        <img src="/static/pc/assets/images/location.png" th:src="@{/pc/assets/images/location.png}" class="length icon">
                        <input type="text" v-model.trim="activity.detailAddress" lay-verify="required" placeholder="详细地址，例：E5栋1308室" autocomplete="off" class="layui-input name show-addr-detailed">
                    </div>
                </div>
                <div class="form-item cancel-margin">
                    <label class="label">活动分类</label>
                    <div class="input-box wrap">
                        <div :class="{'type-item': true, 'active': activityClassify.selected}" v-for="(activityClassify, index) of activityClassifies" :key="'activity-classify-' + index" @click="selectActivityClassify(index)">{{activityClassify.name}}
                            <div class="more-btn" v-if="!activityClassify.system"></div>
                            <div class="edit-box" v-if="!activityClassify.system">
                                <div @click="toEditActivityClassify(index, $event)">编辑</div>
                                <div @click="toDeleteActivityClassify(index, $event)">删除</div>
                            </div>
                        </div>
                        <div class="type-item add" @click="toAddActivityClassify">
                            <div class="add_btn"></div>
                            新增
                        </div>
                    </div>
                </div>
                <div class="form-item cancel-margin">
                    <label class="label">活动标签</label>
                    <div class="input-box wrap">
                        <!--添加满3个后，隐藏添加按钮-->
                        <div class="type-item" v-for="(tag, index) of tags" :key="'tag-' + index">{{tag}}<div class="del_btn" @click="deleteTag(index)"></div></div>
                        <div class="type-item add" @click="toAddTag">
                            <div class="add_btn"></div>
                            添加
                        </div>
                    </div>
                </div>
                <div class="form-item last">
                    <label class="label"><img src="/static/pc/assets/images/required.png" th:src="@{/pc/assets/images/required.png}" class="required-img">参与范围</label>
                    <div class="input-box wrap">
                        <!--添加范围后显示后面这项-->
                        <div v-show="participatedOrgs.length < 1">
                            <div class="type-item add" @click="toAddParticipateScope">
                                <div class="add_btn"></div>
                                添加
                            </div>
                        </div>
                        <div class="already_add" v-show="participatedOrgs.length > 0">
                            <div>
                                已选择单位（{{participatedOrgs.length}}）
                            </div>
                            <img src="/static/pc/assets/images/edit-3.png" th:src="@{/pc/assets/images/edit-3.png}" @click="toAddParticipateScope">
                        </div>
                    </div>
                </div>
            </form>
        </div>
        <div class="info box">
            <div class="set-box">
                <div class="title set">报名设置</div>
                <el-switch v-model="enableSignUp" class="switch"></el-switch>
            </div>
            <!-- 点击参与设置 -->
            <form action="" onsubmit="return false;" class="setForm" v-show="enableSignUp">
                <div class="form-item">
                    <label class="label"><img src="/static/pc/assets/images/required.png" th:src="@{/pc/assets/images/required.png}" class="required-img">报名时间</label>
                    <div class="input-box">
                        <el-date-picker v-model="signUpTimeScope"
                                        type="datetimerange"
                                        format="yyyy-MM-dd HH:mm"
                                        value-format="timestamp"
                                        :clearable="false"
                                        :editable="false"
                                        prefix-icon="disable"
                                        start-placeholder="开始时间"
                                        end-placeholder="结束时间"
                                        :default-time="['00:00:00', '23:59:59']"
                                        @change="selectSignUpTime($event)">
                            <img style="margin: 0 8px;" slot="range-separator" src="/static/pc/assets/images/swap-right.png" th:src="@{/pc/assets/images/swap-right.png}">
                        </el-date-picker>
                        <span class="date-piker-icon">
                            <img src="/static/pc/assets/images/time.png" th:src="@{/pc/assets/images/time.png}">
                        </span>
                    </div>
                </div>
                <div class="form-item">
                    <label class="label">人数限制</label>
                    <div class="input-box">
                        <div class="select-person">
                            <el-select v-model="personLimitValue" value-key="id" placeholder="请选择">
                                <el-option label="无限制" :value="0"></el-option>
                                <el-option label="自定义人数" :value="1"></el-option>
                            </el-select>
                        </div>
                        <input v-show="sign.signUp.limitPerson" v-model="sign.signUp.personLimit" type="number" min="1" step="1" maxlength="10" placeholder="请输入正整数" class="person"><span class="person-span" v-show="sign.signUp.limitPerson">人</span>
                    </div>
                </div>
                <div class="form-item align-start">
                    <label class="label" style="line-height: 20px;">信息填写</label>
                    <div class="input-box column">
                        <div class="set-box">
                            <el-switch v-model="sign.signUp.fillInfo"></el-switch>
                            <span class="tips">开启后，报名者需填写信息</span>
                        </div>
                        <div class="set-box configurationForm" v-show="sign.signUp.fillInfo" @click="toConfigForm">
                            <img src="/static/pc/assets/images/setting.png" th:src="@{/pc/assets/images/setting.png}">
                            <span class="tips set-information">配置填报信息</span>
                        </div>
                    </div>
                </div>
                <div class="form-item">
                    <label class="label">报名需审核</label>
                    <div class="input-box">
                        <el-switch v-model="sign.signUp.openAudit"></el-switch>
                        <span class="tips">开启后，参与需发起人审核</span>
                    </div>
                </div>
                <div class="form-item">
                    <label class="label">报名名单公开</label>
                    <div class="input-box">
                        <el-switch v-model="sign.signUp.publicList"></el-switch>
                        <span class="tips">开启后，所有人都能看到报名人员名单</span>
                    </div>
                </div>
                <div class="form-item" v-if="false">
                    <label class="label position"><img src="/static/pc/assets/images/required.png" th:src="@{/pc/assets/images/required.png}" class="required-img">按钮名称</label>
                    <div class="input-box btn-name">
                        <el-input type="text" v-model.trim="sign.signUp.btnName" placeholder="请输入内容" maxlength="6" show-word-limit></el-input>
                    </div>
                </div>
            </form>
        </div>
        <div class="info box">
            <div class="set-box">
                <div class="title set">签到设置</div>
                <el-switch v-model="enableSignIn" class="switch"></el-switch>
            </div>
            <!-- 点击参与设置 -->
            <form action="" onsubmit="return false;" class="setForm" v-show="enableSignIn">
                <div class="form-item">
                    <label class="label">签到方式</label>
                    <div class="input-box">
                        <el-radio v-for="(signInWay, index) of signInWays" :key="'sign-in-way-' + index" v-model="sign.signIn.way" :label="signInWay.value" name="signInWay">{{signInWay.name}}</el-radio>
                    </div>
                </div>
                <div class="form-item" v-show="sign.signIn.way == 2">
                    <label class="label"><img src="/static/pc/assets/images/required.png" th:src="@{/pc/assets/images/required.png}" class="required-img">位置</label>
                    <div class="input-box">
                        <input type="text" readonly required lay-verify="required" v-model.trim="sign.signIn.address" placeholder="请选择签到地点" autocomplete="off" class="layui-input name show-addr" style="cursor: pointer;" @click="showSignInMap">
                        <img src="/static/pc/assets/images/location.png" th:src="@{/pc/assets/images/location.png}" class="length icon">
                        <input type="text" required lay-verify="required" v-model.trim="sign.signIn.detailAddress" placeholder="详细地址，例：E5栋1308室" autocomplete="off" class="layui-input name show-addr-detailed">
                    </div>
                </div>
                <!--<div class="form-item" v-show="sign.signIn.way == 3">
                    <label class="label">扫码方式</label>
                    <div class="input-box">
                        <div>
                            <el-select v-model="sign.signIn.scanCodeWay" placeholder="请选择">
                                <el-option v-for="(scanCodeWay, index) of scanCodeWays" :key="'scan-code-way-' + index" :label="scanCodeWay.name" :value="scanCodeWay.value"></el-option>
                            </el-select>
                        </div>
                    </div>
                </div>-->
                <div class="form-item">
                    <label class="label"><img src="/static/pc/assets/images/required.png" th:src="@{/pc/assets/images/required.png}" class="required-img">签到时间</label>
                    <div class="input-box">
                        <el-date-picker v-model="signInTimeScope"
                                        type="datetimerange"
                                        format="yyyy-MM-dd HH:mm"
                                        value-format="timestamp"
                                        :clearable="false"
                                        :editable="false"
                                        prefix-icon="disable"
                                        start-placeholder="开始时间"
                                        end-placeholder="结束时间"
                                        :default-time="['00:00:00', '23:59:59']"
                                        @change="selectSignInTime($event)">
                            <img style="margin: 0 8px;" slot="range-separator" src="/static/pc/assets/images/swap-right.png" th:src="@{/pc/assets/images/swap-right.png}">
                        </el-date-picker>
                        <span class="date-piker-icon">
                            <img src="/static/pc/assets/images/time.png" th:src="@{/pc/assets/images/time.png}">
                        </span>
                    </div>
                </div>
                <div class="form-item">
                    <label class="label">签到名单公开</label>
                    <div class="input-box">
                        <el-switch v-model="sign.signIn.publicList"></el-switch>
                        <span class="tips">开启后，所有人都能看到签到人员名单</span>
                    </div>
                </div>
                <div class="form-item" v-if="false">
                    <label class="label"><img src="/static/pc/assets/images/required.png" th:src="@{/pc/assets/images/required.png}" class="required-img">按钮名称</label>
                    <div class="input-box btn-name">
                        <el-input type="text" v-model.trim="sign.signIn.btnName" placeholder="请输入内容" maxlength="6" show-word-limit></el-input>
                    </div>
                </div>
            </form>
        </div>
        <div class="info box">
            <div class="set-box">
                <div class="title set">签退设置</div>
                <el-switch v-model="enableSignOut" class="switch"></el-switch>
            </div>
            <!-- 点击参与设置 -->
            <form action="" onsubmit="return false;" class="setForm" v-show="enableSignOut">
                <div class="form-item">
                    <label class="label">签退方式</label>
                    <div class="input-box">
                        <el-radio v-for="(signOutWay, index) of signOutWays" :key="'sign-out-way-' + index" v-model="sign.signOut.way" :label="signOutWay.value" name="signOutWay">{{signOutWay.name}}</el-radio>
                    </div>
                </div>
                <div class="form-item" v-show="sign.signOut.way == 2">
                    <label class="label"><img src="/static/pc/assets/images/required.png" th:src="@{/pc/assets/images/required.png}" class="required-img">位置</label>
                    <div class="input-box">
                        <input type="text" readonly required lay-verify="required" v-model.trim="sign.signOut.address" placeholder="请选择签到地点" autocomplete="off" class="layui-input name show-addr" style="cursor: pointer;" @click="showSignOutMap">
                        <img src="/static/pc/assets/images/location.png" th:src="@{/pc/assets/images/location.png}" class="length icon">
                        <input type="text" required lay-verify="required" v-model.trim="sign.signOut.detailAddress" placeholder="详细地址，例：E5栋1308室" autocomplete="off" class="layui-input name show-addr-detailed">
                    </div>
                </div>
                <!--<div class="form-item" v-show="sign.signOut.way == 3">
                    <label class="label">扫码方式</label>
                    <div class="input-box">
                        <div>
                            <el-select v-model="sign.signOut.scanCodeWay" placeholder="请选择">
                                <el-option v-for="(scanCodeWay, index) of scanCodeWays" :key="'scan-code-way-' + index" :label="scanCodeWay.name" :value="scanCodeWay.value"></el-option>
                            </el-select>
                        </div>
                    </div>
                </div>-->
                <div class="form-item">
                    <label class="label"><img src="/static/pc/assets/images/required.png" th:src="@{/pc/assets/images/required.png}" class="required-img">签退时间</label>
                    <div class="input-box">
                        <el-date-picker v-model="signOutTimeScope"
                                        type="datetimerange"
                                        format="yyyy-MM-dd HH:mm"
                                        value-format="timestamp"
                                        :clearable="false"
                                        :editable="false"
                                        prefix-icon="disable"
                                        start-placeholder="开始时间"
                                        end-placeholder="结束时间"
                                        :default-time="['00:00:00', '23:59:59']"
                                        @change="selectSignOutTime($event)">
                            <img style="margin: 0 8px;" slot="range-separator" src="/static/pc/assets/images/swap-right.png" th:src="@{/pc/assets/images/swap-right.png}">
                        </el-date-picker>
                        <span class="date-piker-icon">
                            <img src="/static/pc/assets/images/time.png" th:src="@{/pc/assets/images/time.png}">
                        </span>
                    </div>
                </div>
                <div class="form-item">
                    <label class="label">签退名单公开</label>
                    <div class="input-box">
                        <el-switch v-model="sign.signOut.publicList"></el-switch>
                        <span class="tips">开启后，所有人都能看到签退人员名单</span>
                    </div>
                </div>
                <div class="form-item" v-if="false">
                    <label class="label"><img src="/static/pc/assets/images/required.png" th:src="@{/pc/assets/images/required.png}" class="required-img">按钮名称</label>
                    <div class="input-box btn-name">
                        <el-input type="text" v-model.trim="sign.signOut.btnName" placeholder="请输入内容" maxlength="6" show-word-limit></el-input>
                    </div>
                </div>
            </form>
        </div>
    </div>
    <!--选择门户模板-->
    <div class="info box" v-show="step > 1">
        <div class="page-show">
            <div class="page-box">
                <div class="page-item" v-for="(webTemplate, index) of webTemplates" :key="'web-templates' + index">
                    <div class="mask-box">
                        <img :src="webTemplate.coverUrl" class="img">
                        <div class="mask">
                            <div class="normal-btn preview" @click="previewTemplate(index)">预览</div>
                            <div class="normal-btn after-sure" @click="selectTemplate(index)">选择</div>
                        </div>
                    </div>
                    <div class="desc overHidden1">{{webTemplate.name}}</div>
                </div>
            </div>
        </div>
    </div>
    <!-- 新增活动分类和自定义选项的弹出框 -->
    <div class="dailog-box1" v-show="addEditActivityClassifyWindowShow">
        <div class="dailog">
            <div class="header">
                <span>活动分类</span>
                <div @click="addEditActivityClassifyWindowShow = false">
                    <img src="/static/pc/assets/images/close.png" th:src="@{/pc/assets/images/close.png}" class="close">
                </div>
            </div>
            <div class="body">
                <el-input type="text" class="fenlei-input" v-model.trim="addEditActivityClassify.name" placeholder="请输入" maxlength="6" show-word-limit></el-input>
            </div>
            <div class="footer">
                <div class="normal-btn cancle" @click="addEditActivityClassifyWindowShow = false">取消</div>
                <div :class="{'normal-btn': true, 'before-sure': !addEditActivityClassify.name, 'after-sure': addEditActivityClassify.name}" @click="addEditActivityClassifySubmit">确定</div>
            </div>
        </div>
    </div>
    <!--新增标签弹窗-->
    <div class="dailog-box1" v-show="addTagWindowShow">
        <div class="dailog">
            <div class="header">
                <span>活动标签</span>
                <div @click="addTagWindowShow = false">
                    <img src="/static/pc/assets/images/close.png" th:src="@{/pc/assets/images/close.png}" class="close">
                </div>
            </div>
            <div class="body">
                <el-input type="text" class="fenlei-input" v-model.trim="addTag" placeholder="请输入" maxlength="6" show-word-limit></el-input>
            </div>
            <div class="footer">
                <div class="normal-btn cancle" @click="addTagWindowShow = false">取消</div>
                <div :class="{'normal-btn': true, 'before-sure': !addTag, 'after-sure': addTag}" @click="addTagSubmit">确定</div>
            </div>
        </div>
    </div>
    <!--编辑页面就不到下一步了-->
    <div class="info box" v-if="activity.pageId">
        <div class="set-box">
            <div class="title">页面设置</div>
        </div>
        <div class="item-box" v-if="activity.webTemplateId == webTemplate.id" v-for="(webTemplate, index) of webTemplates" :key="'web-templates' + index">
            <div class="page-demo">
                <img :src="webTemplate.coverUrl" class="jqthumbImg">
            </div>
            <div class="pageset-right">
                <div class="copy-box">
                    <a type="text" class="copy-link" :href="activity.previewUrl" target="_blank">{{activity.previewUrl}}</a>
                    <a href="javascript:" class="copy" @click="copyTemplatePreviewUrl">复制</a>
                </div>
                <button type="button" class="cancle-btn" @click="configPage">页面配置</button>
            </div>
        </div>
    </div>
    <!-- 删除分类弹窗 -->
    <vue-confirm ref="deleteClassifyWindow" :message="'确认删除此分类'" :cancel="'保留'" :sure="'删除'" @callback="deleteActivityClassifySubmit"></vue-confirm>
    <!--删除标签标签-->
    <vue-confirm ref="deleteTagWindow" :message="'确认删除此标签'" :cancel="'保留'" :sure="'删除'" @callback="deleteTagSubmit"></vue-confirm>
    <!-- 地图弹窗 -->
    <vue-map ref="activityMap" :map-dom-id="'activity-map'" :title="'设置活动地点'" @callback="activityAddressSure"></vue-map>
    <vue-map ref="signInMap" :map-dom-id="'sign-in-map'" :title="'设置签到地点'" @callback="signInAddressSure"></vue-map>
    <vue-map ref="signOutMap" :map-dom-id="'sign-out-map'" :title="'设置签退地点'" @callback="signOutAddressSure"></vue-map>
    <!-- 活动参与范围弹窗 -->
    <vue-activity-participate-scope :fid="fid" ref="activityParticipateScopeWindow" @callback="updateParticipatedOrgs"></vue-activity-participate-scope>
    <!--预览url复制容器-->
    <input type="text" id="template-preview-url-input" v-model.trim="activity.previewUrl" style="position: absolute; top: -100px; height: 1px;">
</div>
<div th:replace="pc/include/common_js :: common_js(~{::script})">
    <script src="/static/pc/assets/lib/zTree_v3/js/jquery.ztree.core.js" th:src="@{/pc/assets/lib/zTree_v3/js/jquery.ztree.core.js}"></script>
    <script src="/static/pc/assets/lib/zTree_v3/js/jquery.ztree.excheck.min.js" th:src="@{/pc/assets/lib/zTree_v3/js/jquery.ztree.excheck.min.js}"></script>
    <script src="/static/pc/assets/lib/zTree_v3/js/jquery.ztree.exedit.js" th:src="@{/pc/assets/lib/zTree_v3/js/jquery.ztree.exedit.js}"></script>
    <script src="/static/pc/assets/lib/element-ui/lib/index.js" th:src="@{/pc/assets/lib/element-ui/lib/index.js}"></script>
    <script src="/static/pc/assets/lib/webuploader/webuploader.js" th:src="@{/pc/assets/lib/webuploader/webuploader.js}"></script>
    <script src="/static/pc/assets/component/map.js" th:src="@{/pc/assets/component/map.js}"></script>
    <script src="/static/pc/assets/component/activity-participate-scope.js" th:src="@{/pc/assets/component/activity-participate-scope.js}"></script>
    <script src="/static/pc/assets/component/confirm.js" th:src="@{/pc/assets/component/confirm.js}"></script>
    <script src="/static/pc/assets/lib/jqthumb.min.js" th:src="@{/pc/assets/lib/jqthumb.min.js}"></script>
    <script th:inline="javascript">
        activityVue = new Vue({
            el: "#activity-vue",
            data: {
                step: 1,
                fid: [[${session._login_user_.fid}]],
                activity: [[${activity}]],
                tags: [],
                // 模板列表
                webTemplates: [[${webTemplates}]],
                areaCode: [[${areaCode}]],
                // 活动日期的范围
                activityDateTimeScope: "",
                activityTypes: [[${activityTypes}]],
                activityClassifies: [[${activityClassifies}]],
                // 文件上传
                uploader: null,
                // 显示隐藏
                // 是否显示地图弹窗
                mapWindowShow: false,
                // 新增修改活动分类弹窗的显示
                addEditActivityClassifyWindowShow: false,
                addEditActivityClassify: {
                    id: null,
                    name: ""
                },
                deleteActivityClassifyId: null,
                // 标签
                addTagWindowShow: false,
                addTag: "",
                deleteActivityTagIndex: "",
                // 参与机构列表
                participatedOrgs: [[${participatedOrgs}]],
                // 处理的模板id
                handleWebTemplateId: "",

                // 签到报名相关
                sign: [[${sign}]],
                // 机构下的表单列表
                forms: [],
                // 签到方式
                signInWays: [],
                // 签退方式
                signOutWays: [],
                // 扫码方式
                scanCodeWays: [],
                // 是否开启报名
                enableSignUp: false,
                // 是否开启签到
                enableSignIn: false,
                // 是否开启签退
                enableSignOut: false,
                // 报名时间范围
                signUpTimeScope: "",
                // 签到时间范围
                signInTimeScope: "",
                // 签退时间范围
                signOutTimeScope: "",
                // 人数限制值
                personLimitValue: 0,

                // 表单
                formConfigLayerIndex: ""
            },
            created: function () {
                var $this = this;
                // 解决跨域
                document.domain = "chaoxing.com";
                var step = [[${step}]];
                if (!activityApp.isEmpty(step)) {
                    $this.step = step > 2 ? 2 : step;
                }
                if (activityApp.isEmpty($this.activity)) {
                    // 第一个分类的id
                    var firstActivityClassifyId = $this.activityClassifies[0].id;
                    $this.activity = {
                        id: null,
                        name: "",
                        startTime: activityApp.generateActivityDefaultStartTime(),
                        endTime: activityApp.generateActivityDefaultEndTime(),
                        coverCloudId: activityApp.getDefaultCoverCloudId(),
                        organisers: [[${session._login_user_.orgName}]],
                        activityType: "offline",
                        address: "",
                        detailAddress: "",
                        longitude: "",
                        dimension: "",
                        activityClassifyId: firstActivityClassifyId,
                        enableSign: true,
                        createAreaCode: $this.areaCode,
                        tags: ""
                    };
                } else {
                    $this.activity.createTime = null;
                    $this.activity.updateTime = null;
                    $this.activity.releaseTime = null;
                    $this.activity.startTime = $this.activity.startTimeStr;
                    $this.activity.endTime = $this.activity.endTimeStr;
                }
                var tags = $this.activity.tags;
                if (activityApp.isEmpty(tags)) {
                    tags = [];
                } else {
                    tags = tags.split(",");
                }
                $this.tags = tags;
                $this.activityDateTimeScope = [$this.activity.startTime, $this.activity.endTime];
                $($this.activityTypes).each(function (i) {
                    if ($this.activity.activityType == this.value) {
                        $this.$set($this.activityTypes[i], "selected", true);
                    } else {
                        $this.$set($this.activityTypes[i], "selected", false);
                    }
                });
                var selectedActivityClassifyId = $this.activity.activityClassifyId;
                $($this.activityClassifies).each(function (i) {
                    if (this.id == selectedActivityClassifyId) {
                        $this.$set($this.activityClassifies[i], "selected", true);
                    } else {
                        $this.$set($this.activityClassifies[i], "selected", false);
                    }
                });
                $this.signInWays = [
                    {name: "普通签到", value: 1},
                    {name: "位置签到", value: 2},
                    {name: "二维码签到", value: 3}
                ];
                $this.signOutWays = [
                    {name: "普通签退", value: 1},
                    {name: "位置签退", value: 2},
                    {name: "二维码签退", value: 3}
                ];
                $this.scanCodeWays = [
                    {name: "用户扫码", value: 1},
                    {name: "管理员扫码", value: 2}
                ];
                if (activityApp.isEmpty($this.sign.id)) {
                    // 生成新的签到报名活动
                    $this.sign = signApp.newSign();
                    $this.enableSignUp = true;
                } else {
                    $this.sign.createTime = "";
                    $this.sign.updateTime = "";
                    // 报名
                    if (!activityApp.isEmpty($this.sign.signUp)) {
                        $this.enableSignUp = true;
                        $this.sign.signUp.startTime = $this.sign.signUp.startTimestamp;
                        $this.sign.signUp.endTime = $this.sign.signUp.endTimestamp;
                        $this.sign.signUp.createTime = "";
                        $this.sign.signUp.updateTime = "";
                    } else {
                        $this.enableSignUp = false;
                        $this.sign.signUp = signApp.newSignUp();
                    }
                    if (!activityApp.isEmpty($this.sign.signUp.startTime)) {
                        $this.signUpTimeScope = [$this.sign.signUp.startTime, $this.sign.signUp.endTime];
                    }
                    // 签到
                    if (!activityApp.isEmpty($this.sign.signIn)) {
                        if (!$this.sign.signIn.deleted) {
                            $this.enableSignIn = true;
                        } else {
                            $this.enableSignIn = false;
                        }
                        $this.sign.signIn.startTime = $this.sign.signIn.startTimestamp;
                        $this.sign.signIn.endTime = $this.sign.signIn.endTimestamp;
                        $this.sign.signIn.createTime = "";
                        $this.sign.signIn.updateTime = "";
                    } else {
                        $this.enableSignIn = false;
                        $this.sign.signIn = signApp.newSignIn();
                    }
                    if (!activityApp.isEmpty($this.sign.signIn.startTime)) {
                        $this.signInTimeScope = [$this.sign.signIn.startTime, $this.sign.signIn.endTime];
                    }
                    // 签退
                    if (!activityApp.isEmpty($this.sign.signOut)) {
                        if (!$this.sign.signOut.deleted) {
                            $this.enableSignOut = true;
                        } else {
                            $this.enableSignOut = false;
                        }
                        $this.sign.signOut.startTime = $this.sign.signOut.startTimestamp;
                        $this.sign.signOut.endTime = $this.sign.signOut.endTimestamp;
                        $this.sign.signOut.createTime = "";
                        $this.sign.signOut.updateTime = "";
                    } else {
                        $this.enableSignOut = false;
                        $this.sign.signOut = signApp.newSignOut();
                    }
                    if (!activityApp.isEmpty($this.sign.signOut.startTime)) {
                        $this.signOutTimeScope = [$this.sign.signOut.startTime, $this.sign.signOut.endTime];
                    }
                }
                if (!$this.activity.enableSign) {
                    $this.enableSignUp = false;
                    $this.enableSignIn = false;
                    $this.enableSignOut = false;
                }
                $this.calPersonLimitValue();
                if (activityApp.isEmpty($this.participatedOrgs)) {
                    $this.participatedOrgs = [];
                }
                if ($this.step == 2) {
                    $this.filterOptionalTemplate();
                }
            },
            mounted: function () {
                var $this = this;
                $this.initUploader();
                $this.handleImg();
            },
            watch: {
                // 报名的人数限制
                personLimitValue: function () {
                    var $this = this;
                    if ($this.personLimitValue == 0) {
                        // 不限制
                        $this.$set($this.sign.signUp, "limitPerson", false);
                    } else {
                        $this.$set($this.sign.signUp, "limitPerson", true);
                    }
                },
                "enableSignUp": function () {
                    var $this = this;
                    $this.$nextTick(function () {
                        $this.activity.enableSign = $this.enableSignUp || $this.enableSignIn || $this.enableSignOut;
                    });
                },
                "enableSignIn": function () {
                    var $this = this;
                    $this.$nextTick(function () {
                        $this.activity.enableSign = $this.enableSignUp || $this.enableSignIn || $this.enableSignOut;
                    });
                },
                "enableSignOut": function () {
                    var $this = this;
                    $this.$nextTick(function () {
                        $this.activity.enableSign = $this.enableSignUp || $this.enableSignIn || $this.enableSignOut;
                    });
                }
            },
            methods: {
                handleImg: function () {
                    $('.jqthumbImg').jqthumb({
                        width: '100%',
                        height: '100%'
                    });
                },
                // 初始化文件上传
                initUploader: function () {
                    var $this = this;
                    $this.uploader = WebUploader.create({
                        // swf文件路径
                        swf: ctx + "/pc/assets/lib/webuploader/Uploader.swf",
                        // 文件接收服务端。
                        server: ctx + "/api/upload/img",
                        // 选择文件的按钮。可选。
                        // 内部根据当前运行是创建，可能是input元素，也可能是flash.
                        pick: "#cover-upload-btn",
                        // 不压缩image, 默认如果是jpeg，文件上传前会压缩一把再上传！
                        resize: false,
                        auto: true,
                        // 只允许选择图片文件。
                        accept: {
                            title: 'Images',
                            extensions: 'gif,jpg,jpeg,bmp,png',
                            mimeTypes: 'image/*'
                        }
                    });
                    $this.uploader.on("uploadSuccess", function (file, response) {
                        if (response.success) {
                            var data = response.data;
                            data = activityApp.getJsonObject(data);
                            var result = data.result;
                            if (result == 1) {
                                var cloudId = data.objectid;
                                $this.$set($this.activity, "coverUrl", "");
                                $this.$set($this.activity, "coverCloudId", cloudId);
                                $this.$nextTick(function () {
                                    $this.handleImg();
                                });
                            } else {
                                app.showMsg("上传失败");
                            }
                        } else {
                            var errorMessage = response.message;
                            if (activityApp.isEmpty(errorMessage)) {
                                errorMessage = "上传失败";
                            }
                            app.showMsg(errorMessage);
                        }
                    });
                    $this.uploader.on("uploadError", function (file, reason) {
                        app.showMsg(reason);
                    });
                },
                // 加载表单列表
                loadForms: function () {
                    var $this = this;
                    var url = ctx + "/api/form/list";
                    app.ajaxPost(url, {}, function (data) {
                        if (data.success) {
                            $this.forms = data.data;
                        } else {
                            var errorMessage = data.message;
                            if (activityApp.isEmpty(errorMessage)) {
                                errorMessage = "加载表单失败";
                            }
                            app.showMsg(errorMessage);
                        }
                    }, function () {
                        app.showMsg("加载表单失败");
                    });
                },
                // 修改活动类型
                changeActivityType: function (index) {
                    var $this = this;
                    var activityType = $this.activityTypes[index];
                    $this.activity.activityType = activityType.value;
                },
                // 显示参与范围弹窗
                toAddParticipateScope: function () {
                    var $this = this;
                    $this.$refs.activityParticipateScopeWindow.showWindow($this.participatedOrgs);
                },
                // 更新参与范围的机构
                updateParticipatedOrgs: function () {
                    var $this = this;
                    $this.participatedOrgs = $this.$refs.activityParticipateScopeWindow.selectedOrgs;
                },
                // 显示百度地图
                showActivityMap: function () {
                    var $this = this;
                    $this.$refs.activityMap.show = true;
                },
                showSignInMap: function () {
                    var $this = this;
                    $this.$refs.signInMap.show = true;
                },
                showSignOutMap: function () {
                    var $this = this;
                    $this.$refs.signOutMap.show = true;
                },
                // 确定活动地址
                activityAddressSure: function () {
                    var $this = this;
                    if (activityApp.isEmpty($this.$refs.activityMap.longitude) || activityApp.isEmpty($this.$refs.activityMap.dimension)) {
                        app.showMsg("请选择地址");
                        return;
                    }
                    $this.activity.address = $this.$refs.activityMap.address;
                    $this.activity.longitude = $this.$refs.activityMap.longitude;
                    $this.activity.dimension = $this.$refs.activityMap.dimension;
                },
                // 确定签到地址
                signInAddressSure: function () {
                    var $this = this;
                    if (activityApp.isEmpty($this.$refs.signInMap.longitude) || activityApp.isEmpty($this.$refs.signInMap.dimension)) {
                        app.showMsg("请选择签到地址");
                        return;
                    }
                    $this.sign.signIn.address = $this.$refs.signInMap.address;
                    $this.sign.signIn.longitude = $this.$refs.signInMap.longitude;
                    $this.sign.signIn.dimension = $this.$refs.signInMap.dimension;
                },
                // 确定签退地址
                signOutAddressSure: function () {
                    var $this = this;
                    if (activityApp.isEmpty($this.$refs.signOutMap.longitude) || activityApp.isEmpty($this.$refs.signOutMap.dimension)) {
                        app.showMsg("请选择签退地址");
                        return;
                    }
                    $this.sign.signOut.address = $this.$refs.signOutMap.address;
                    $this.sign.signOut.longitude = $this.$refs.signOutMap.longitude;
                    $this.sign.signOut.dimension = $this.$refs.signOutMap.dimension;
                },
                selectActivityClassify: function (index) {
                    var $this = this;
                    $($this.activityClassifies).each(function (i) {
                        if (i == index) {
                            $this.$set($this.activityClassifies[i], "selected", true);
                            $this.activity.activityClassifyId = this.id;
                        } else {
                            $this.$set($this.activityClassifies[i], "selected", false);
                        }
                    });
                },
                toAddActivityClassify: function () {
                    var $this = this;
                    $this.addEditActivityClassify = {
                        id: null,
                        name: ""
                    };
                    $this.addEditActivityClassifyWindowShow = true;
                },
                toEditActivityClassify: function (index, e) {
                    e.stopPropagation();
                    var $this = this;
                    var activityClassify = $this.activityClassifies[index];
                    $this.addEditActivityClassify = {
                        id: activityClassify.id,
                        name: activityClassify.name
                    };
                    $this.addEditActivityClassifyWindowShow = true;
                },
                addEditActivityClassifySubmit: function () {
                    var $this = this;
                    if (activityApp.isEmpty($this.addEditActivityClassify.name)) {
                        return;
                    }
                    var isAdd = activityApp.isEmpty($this.addEditActivityClassify.id);
                    var tips = "新增";
                    var url = ctx + "/api/activity/classify/add";
                    if (!isAdd) {
                        url = ctx + "/api/activity/classify/edit";
                        tips = "修改";
                    }
                    var params = {
                        id: $this.addEditActivityClassify.id,
                        name: $this.addEditActivityClassify.name
                    };
                    app.ajaxPostWithLoading(url, params, function (data) {
                        if (data.success) {
                            var data = data.data;
                            if (isAdd) {
                                data.selected = false;
                                $this.activityClassifies.push(data);
                            } else {
                                $($this.activityClassifies).each(function (i) {
                                    if (this.id == data.id) {
                                        data.selected = this.selected;
                                        $this.activityClassifies.splice(i, 1, data);
                                        return false;
                                    }
                                });
                            }
                            $this.addEditActivityClassifyWindowShow = false;
                        } else {
                            var errorMessage = data.message;
                            if (activityApp.isEmpty(errorMessage)) {
                                errorMessage = tips + "分类失败";
                            }
                            app.showMsg(errorMessage);
                        }
                    }, function () {
                        app.showMsg(tips + "分类失败");
                    });
                },
                toDeleteActivityClassify: function (index, e) {
                    e.stopPropagation();
                    var $this = this;
                    var activityClassify = $this.activityClassifies[index];
                    $this.deleteActivityClassifyId = activityClassify.id;
                    $this.$refs.deleteClassifyWindow.show = true;
                },
                deleteActivityClassifySubmit: function () {
                    var $this = this;
                    var url = ctx + "/api/activity/classify/" + $this.deleteActivityClassifyId + "/delete";
                    app.ajaxPostWithLoading(url, {}, function (data) {
                        if (data.success) {
                            $this.$refs.deleteClassifyWindow.show = false;
                            $($this.activityClassifies).each(function (i) {
                                if (this.id == $this.deleteActivityClassifyId) {
                                    if (this.selected) {
                                        $this.activity.activityClassifyId = null;
                                    }
                                    $this.activityClassifies.splice(i, 1);
                                    return false;
                                }
                            });
                        } else {
                            var errorMessage = data.errorMessage;
                            if (activityApp.isEmpty(errorMessage)) {
                                errorMessage = "删除分类失败";
                            }
                            app.showMsg(errorMessage);
                        }
                    }, function () {
                        app.showMsg("删除分类失败");
                    });
                },
                // 添加标签
                toAddTag: function () {
                    var $this = this;
                    $this.addTagWindowShow = true;
                },
                addTagSubmit: function () {
                    var $this = this;
                    if ($this.tags.indexOf($this.addTag) > -1) {
                        app.showMsg("标签已存在");
                        return;
                    }
                    $this.tags.push($this.addTag);
                    $this.activity.tags = $this.tags.join(",");
                    $this.addTag = "";
                    $this.addTagWindowShow = false;
                },
                deleteTag: function (index) {
                    var $this = this;
                    $this.deleteTagIndex = index;
                    $this.$refs.deleteTagWindow.show = true;
                },
                deleteTagSubmit: function () {
                    var $this = this;
                    $this.tags.splice($this.deleteTagIndex, 1);
                    $this.activity.tags = $this.tags.join(",");
                    $this.$refs.deleteTagWindow.show = false;
                },
                // 计算限制人数value
                calPersonLimitValue: function () {
                    var $this = this;
                    $this.personLimitValue = $this.sign.signUp.limitPerson ? 1 : 0;
                },
                // 验证输入
                validateForm: function () {
                    var $this = this;
                    if (activityApp.isEmpty($this.activity.name)) {
                        app.showMsg("活动名称不能为空");
                        return false;
                    }
                    if (activityApp.isEmpty($this.activity.startTime)) {
                        app.showMsg("活动开始时间不能为空");
                        return false;
                    }
                    if (activityApp.isEmpty($this.activity.endTime)) {
                        app.showMsg("活动结束时间不能为空");
                        return false;
                    }
                    if (activityApp.isEmpty($this.activity.coverCloudId)) {
                        app.showMsg("请上传活动封面");
                        return false;
                    }
                    if (activityApp.isEmpty($this.activity.activityClassifyId)) {
                        app.showMsg("活动分类不能为空");
                        return false;
                    }
                    // 参与范围
                    if (activityApp.isEmpty($this.participatedOrgs) || $this.participatedOrgs.length < 1) {
                        app.showMsg("请选择参与范围");
                        return false;
                    }
                    // 报名设置
                    if ($this.enableSignUp) {
                        if (activityApp.isEmpty($this.sign.signUp.startTime)) {
                            app.showMsg("报名开始时间不能为空");
                            return false;
                        }
                        if (activityApp.isEmpty($this.sign.signUp.endTime)) {
                            app.showMsg("报名结束时间不能为空");
                            return false;
                        }
                        if ($this.sign.signUp.limitPerson) {
                            // 启用人数限制
                            if ($this.sign.signUp.personLimit < 1) {
                                app.showMsg("报名限制的人数不能小于1");
                                return false;
                            }
                        }
                        if ($this.sign.signUp.fillInfo) {
                            if (activityApp.isEmpty($this.sign.signUp.fillInfoFormId)) {
                                app.showMsg("请配置填报信息");
                                return false;
                            }
                        }
                        if (activityApp.isEmpty($this.sign.signUp.btnName)) {
                            app.showMsg("报名按钮名称不能为空");
                            return false;
                        }
                    }
                    // 签到设置
                    if ($this.enableSignIn) {
                        // 签到方式
                        if ($this.sign.signIn.way == 2) {
                            // 位置签到
                            if (activityApp.isEmpty($this.sign.signIn.address)) {
                                app.showMsg("签到位置不能为空");
                                return false;
                            }
                        }
                        if (activityApp.isEmpty($this.sign.signIn.startTime)) {
                            app.showMsg("签到开始时间不能为空");
                            return false;
                        }
                        if (activityApp.isEmpty($this.sign.signIn.endTime)) {
                            app.showMsg("签到结束时间不能为空");
                            return false;
                        }
                        if ($this.sign.signIn.fillInfo) {
                            if (activityApp.isEmpty($this.sign.signIn.fillInfoFormId)) {
                                app.showMsg("请选择签到需要填写的表单");
                                return false;
                            }
                        }
                        if (activityApp.isEmpty($this.sign.signIn.btnName)) {
                            app.showMsg("签到按钮名称不能为空");
                            return false;
                        }
                    }
                    // 签退设置
                    if ($this.enableSignOut) {
                        // 签到方式
                        if ($this.sign.signOut.way == 2) {
                            // 位置签到
                            if (activityApp.isEmpty($this.sign.signOut.address)) {
                                app.showMsg("签退位置不能为空");
                                return false;
                            }
                        }
                        if (activityApp.isEmpty($this.sign.signOut.startTime)) {
                            app.showMsg("签退开始时间不能为空");
                            return false;
                        }
                        if (activityApp.isEmpty($this.sign.signOut.endTime)) {
                            app.showMsg("签退结束时间不能为空");
                            return false;
                        }
                        if ($this.sign.signOut.fillInfo) {
                            if (activityApp.isEmpty($this.sign.signOut.fillInfoFormId)) {
                                app.showMsg("请选择签退需要填写的表单");
                                return false;
                            }
                        }
                        if (activityApp.isEmpty($this.sign.signOut.btnName)) {
                            app.showMsg("签退按钮名称不能为空");
                            return false;
                        }
                    }
                    return true;
                },
                preStep: function () {
                    var $this = this;
                    var url = ctx + "/activity/" + $this.activity.id + "/edit";
                    window.location.replace(url);
                },
                // 下一步（创建活动）
                nextStep: function () {
                    var $this = this;
                    if (!$this.validateForm()) {
                        return;
                    }
                    // 创建活动
                    var url = ctx + "/api/activity/new";
                    var sign = $.extend({}, $this.sign);
                    if (!$this.enableSignUp) {
                        sign.signUp = null;
                    }
                    if (!$this.enableSignIn) {
                        sign.signIn = null;
                    } else {
                        var way = sign.signIn.way;
                        switch (way) {
                            case 1:
                            case 3:
                                sign.signIn.address = "";
                                sign.signIn.longitude = null;
                                sign.signIn.dimension = null;
                                sign.signIn.detailAddress = "";
                                break;
                            default:
                        }
                    }
                    if (!$this.enableSignOut) {
                        sign.signOut = null;
                    } else {
                        var way = sign.signOut.way;
                        switch (way) {
                            case 1:
                            case 3:
                                sign.signOut.address = "";
                                sign.signOut.longitude = null;
                                sign.signOut.dimension = null;
                                sign.signOut.detailAddress = "";
                                break;
                            default:
                        }
                    }
                    var params = {
                        activityJsonStr: activityApp.getJsonStr($this.activity),
                        participateScopeJsonStr: activityApp.getJsonStr($this.participatedOrgs),
                        signJsonStr: activityApp.getJsonStr(sign)
                    };
                    app.ajaxPostWithLoading(url, params, function (data) {
                        if (data.success) {
                            app.noticeActivityChange($this.activity.id);
                            var activityData = data.data;
                            $this.$set($this.activity, "id", activityData.id);
                            $this.$set($this.sign, "id", activityData.signId);
                            $this.filterOptionalTemplate();
                            $this.step = 2;
                        } else {
                            var errorMessage = data.message;
                            if (activityApp.isEmpty(errorMessage)) {
                                errorMessage = "创建活动失败";
                            }
                            app.showMsg(errorMessage);
                        }
                    }, function () {
                        app.showMsg("创建活动失败");
                    });
                },
                // 编辑活动提交
                save: function () {
                    var $this = this;
                    if (!$this.validateForm()) {
                        return;
                    }
                    var url = ctx + "/api/activity/edit";
                    var sign = $.extend({}, $this.sign);
                    if (!$this.enableSignUp) {
                        sign.signUp = null;
                    }
                    if (!$this.enableSignIn) {
                        sign.signIn = null;
                    }
                    if (!$this.enableSignOut) {
                        sign.signOut = null;
                    }
                    var params = {
                        activityJsonStr: activityApp.getJsonStr($this.activity),
                        participateScopeJsonStr: activityApp.getJsonStr($this.participatedOrgs),
                        signJsonStr: activityApp.getJsonStr(sign)
                    };
                    app.ajaxPostWithLoading(url, params, function (data) {
                        if (data.success) {
                            app.noticeActivityChange($this.activity.id);
                            var activityData = data.data;
                            $this.filterOptionalTemplate();
                            $this.$set($this.sign, "id", activityData.signId);
                            if (activityApp.isEmpty($this.activity.pageId)) {
                                $this.step = 2;
                            } else {
                                app.showMsg("修改活动成功", function () {
                                    window.close();
                                });
                            }
                        } else {
                            var errorMessage = data.message;
                            if (activityApp.isEmpty(errorMessage)) {
                                errorMessage = "修改活动失败";
                            }
                            app.showMsg(errorMessage);
                        }
                    }, function () {
                        app.showMsg("修改活动失败");
                    });
                },
                // 选中活动的日期范围
                selectActivityDate: function (obj) {
                    var $this = this;
                    $this.activity.startTime = obj[0];
                    $this.activity.endTime = obj[1];
                },
                // 选中报名的时间范围
                selectSignUpTime: function (obj) {
                    var $this = this;
                    $this.sign.signUp.startTime = obj[0];
                    $this.sign.signUp.endTime = obj[1];
                },
                // 选中签到的时间范围
                selectSignInTime: function (obj) {
                    var $this = this;
                    $this.sign.signIn.startTime = obj[0];
                    $this.sign.signIn.endTime = obj[1];
                },
                // 选中签退的时间范围
                selectSignOutTime: function (obj) {
                    var $this = this;
                    $this.sign.signOut.startTime = obj[0];
                    $this.sign.signOut.endTime = obj[1];
                },
                // 预览模板
                previewTemplate: function (index) {
                    var $this = this;
                    var webTemplate = $this.webTemplates[index];
                    window.open(webTemplate.previewUrl);
                },
                // 选择模板
                selectTemplate: function (index) {
                    var $this = this;
                    var webTemplate = $this.webTemplates[index];
                    $this.handleWebTemplateId = webTemplate.id;
                    var url = ctx + "/api/activity/" + $this.activity.id + "/bind/template/" + webTemplate.id;
                    app.ajaxPostWithLoading(url, {}, function (data) {
                        if (data.success) {
                            app.noticeActivityChange($this.activity.id);
                            var editUrl = data.data.editUrl;
                            $this.$set($this.activity, "webTemplateId", $this.handleWebTemplateId);
                            app.showMsg("选择模板成功", function () {
                                // 到编辑门户页面
                                window.location.replace(editUrl);
                            });
                        } else {
                            var errorMessage = data.message;
                            if (activityApp.isEmpty(errorMessage)) {
                                errorMessage = "选择模板失败";
                            }
                            app.showMsg(errorMessage);
                        }
                    }, function () {
                        app.showMsg("选择模板失败");
                    });
                },
                // 预览页面
                previePage: function () {
                    var $this = this;
                    window.open($this.activity.previewUrl);
                },
                // 配置页面
                configPage: function () {
                    var $this = this;
                    window.location.href = $this.activity.editUrl;
                },
                // 复制预览地址
                copyTemplatePreviewUrl: function () {
                    var $this = this;
                    $("#template-preview-url-input")[0].select();
                    document.execCommand("copy");
                    app.showMsg("复制成功");
                },
                // 表单
                toConfigForm: function () {
                    var $this = this;
                    var formId = "";
                    if (!activityApp.isEmpty($this.sign.signUp.fillInfoFormId)) {
                        formId = $this.sign.signUp.fillInfoFormId;
                    }
                    var url = "http://reading.chaoxing.com/qd/form/config?formId=" + formId;
                    $('body').addClass('scroll');
                    $this.formConfigLayerIndex = layer.open({
                        title: "表单配置",
                        skin: "create-class",
                        type: 2,
                        content: [url, "no"],
                        area: ["600px", "680px"],
                        btn: ["取消", "完成"],
                        btnAlign: "c",
                        yes: function (index) {
                            app.closeLayerPop(index);
                        },
                        btn2: function (index, layero) {
                            $("#layui-layer-iframe" + $this.formConfigLayerIndex)[0].contentWindow.submit();
                            return false;
                        },
                        end: function () {
                            $('body').removeClass('scroll');
                        }
                    })
                },
                closeFormConfigLayer: function (formId) {
                    var $this = this;
                    app.closeLayerPop($this.formConfigLayerIndex);
                    $this.$set($this.sign.signUp, "fillInfoFormId", formId);
                },
                // 过滤可选的模板
                filterOptionalTemplate: function () {
                    var $this = this;
                    var activityType = $this.activity.activityType;
                    var webTemplates = [];
                    $($this.webTemplates).each(function () {
                        if (this.activityType == activityType && !this.deleted) {
                            webTemplates.push(this);
                        }
                    });
                    $this.webTemplates = webTemplates;
                }
            }
        });

        /**
         * 关闭表单配置页面
         */
        function closeFormConfigLayer(formId) {
            activityVue.closeFormConfigLayer(formId);
        }
    </script>
</div>
</body>
</html>