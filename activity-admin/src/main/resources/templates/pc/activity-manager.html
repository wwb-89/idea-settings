<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org/">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" th:href="@{/pc/assets/lib/element-ui/lib/theme-chalk/index.css}">
    <link rel="stylesheet" th:href="@{/pc/assets/lib/layui/css/layui.css}">
    <link rel="stylesheet" th:href="@{/pc/assets/css/public.css}">
    <link rel="stylesheet" th:href="@{/pc/assets/css/dialog.css}">
    <link rel="stylesheet" th:href="@{/pc/assets/css/organizer-manage.css}">
    <link rel="stylesheet" th:href="@{/mobile/assets/lib/mescroll/mescroll.css}">
    <title>组织者管理</title>
    <style type="text/css">
        [v-cloak] {
            display: none;
        }
    </style>
</head>
<body >
<div class="manage-container" id="activity-manager-vue" v-cloak>
    <div class="manage-header">
        组织者管理
    </div>
    <div class="manage-content" id="manager-content">
        <div class="btn-add btn-size fl" @click="toAdd">
            <img th:src="@{/pc/assets/images/add-small.png}">
            <span>添加</span>
        </div>
        <div v-show="!removeBatchStatus()" class="btn-del-disable btn-size fl">批量移除</div>
        <div v-show="removeBatchStatus()" class="btn-del btn-size fl" @click="openDeleteBatchDialog()">批量移除</div>
        <div class="clear"></div>
        <table class="table-box">
            <thead>
            <tr>
                <th class="check-box">
                    <el-checkbox v-model="checkAllStatus" class="check-item-checkbox fl" @change="checkAllChange"></el-checkbox>
                </th>
                <th>姓名</th>
                <th>操作</th>
            </tr>
            </thead>
            <tbody>
            <tr v-for="(manager, index) of managers" :key="'manager-' + index">
                <th class="check-box">
                    <el-checkbox v-model="manager.checked" class="check-item-checkbox fl" @change="checkChangeHandle(manager)"></el-checkbox>
                </th>
                <th>{{manager.userName}}</th>
                <th>
                    <span v-if="false">权限设置</span>
                    <span @click="openDeleteDialog(manager)">移除</span>
                </th>
            </tr>
            </tbody>
        </table>
        <div class="no-content" v-if="managers.length == 0 && loaded">
            暂无内容
        </div>
    </div>

    <!-- 确认删除分类弹框 -->
    <div class="dailog-box3" v-show="deleteShow">
        <div class="dailog delete-dailog">
            <div class="warn"><img th:src="@{/pc/assets/images/warning.png}"></div>
            <span>移除后可重新添加。确定移除吗？</span>
            <div>
                <div class="normal-btn" @click="handleSave">保留</div>
                <div class="normal-btn after-sure" @click="deleteManager()">移除</div>
            </div>
        </div>
    </div>

    <!-- 确认删除分类弹框 -->
    <div class="dailog-box3 batch" v-show="deleteBatchShow">
        <div class="dailog delete-dailog">
            <div class="warn"><img th:src="@{/pc/assets/images/warning.png}"></div>
            <span>移除后可重新添加。确定批量移除吗？</span>
            <div>
                <div class="normal-btn" @click="handleSave">保留</div>
                <div class="normal-btn after-sure" @click="deleteBatchManager()">移除</div>
            </div>
        </div>
    </div>

    <!--添加弹框-->
    <div class="dailog-box1" v-show="addShow">
        <div class="dailog choose-dialog">
            <div class="header">
                <span>选择人员</span>
                <img th:src="@{/pc/assets/images/close.png}" class="close" @click="addShow = false">
            </div>
            <div class="body clear">
                <div class="choose-list fl mescroll" id="search-content" >
                    <div>
                        <div class="search">
                            <input class="search-ipt" type="text" placeholder="姓名" v-model.trim="sw" @input="swHandle()"  @keyup.enter="initSearchUsers()">
                            <i class="icon close" v-show="closeValue" @click="clearSearchKey()"></i>
                            <i class="icon search-icon"></i>
                        </div>
                        <div class="crumb" style="display: block;">
                            <ul class="clear" v-if="!sw">
                                <li class="back-item" v-for="(level, index) of levels" v-if="index < levels.length-1" @click="gotoFolder(level)">{{level.name}}{{' > '}}</li>
                                <li>{{levels[levels.length-1].name}}</li>
                            </ul>
                        </div>
                        <template v-if="!sw">
                            <div class="catalog-list" style="display: block;">
                                <template v-if="currentLevel.type === 1">
                                    <div class="catalog-item" v-for="(org, index) of orgs" :key="'org-' + index" @click="toLevel(org,2)">
                                        <div class="catalog-photo">
                                            <img th:src="@{/pc/assets/images/catalog1.png}">
                                        </div>
                                        <div class="catalog-title">{{org.name}}</div>
                                        <img class="right-img" th:src="@{/pc/assets/images/icon-right.png}">
                                    </div>
                                </template>
                                <template v-if="currentLevel.type >= 2">
                                    <template v-for="(l, index) of departments">
                                        <div class="catalog-item" @click="toLevel(l,3)">
                                            <div class="catalog-photo">
                                                <img th:src="@{/pc/assets/images/catalog1.png}">
                                            </div>
                                            <div class="catalog-title">
                                                {{l.name}}
                                            </div>
                                            <img class="right-img" th:src="@{/pc/assets/images/icon-right.png}">
                                        </div>
                                    </template>
                                </template>
                                <template v-if="currentLevel.type > 2">
                                    <div v-for="l of contacters" :class='{"catalog-item":true,"bgc-blue": l.checked}' :key="l.puid">
                                        <div class="catalog-photo">
                                            <img :src="'http://photo.chaoxing.com/p/'+l.puid+'_80'">
                                        </div>
                                        <div class="catalog-title">
                                            {{l.name}}
                                        </div>
                                        <el-checkbox class="right-check" v-model="l.checked" @change="changeCheckUser(l)"></el-checkbox>
                                    </div>
                                </template>
                            </div>
                        </template>
                        <template v-else>
                            <div class="catalog-list" style="display: block;">
                                <div v-for="(contacter, index) of contacters" :class='{"catalog-item":true,"bgc-blue": contacter.checked}' :key="contacter.puid">
                                    <div class="catalog-photo">
                                        <img :src="'http://photo.chaoxing.com/p/' + contacter.puid + '_80'">
                                    </div>
                                    <div class="catalog-title">
                                        {{contacter.name}}
                                    </div>
                                    <el-checkbox class="right-check" v-model="contacter.checked" @change="changeCheckUser(contacter)"></el-checkbox>
                                </div>
                            </div>
                        </template>
                        <div class="empty-content" style="display: none;">
                            无搜索结果
                        </div>
                    </div>
                </div>
                <div class="item-choosed fl">
                    <div class="choose-number">已选{{checkedContacters.length}}人</div>
                    <div class="catalog-list" style="display: block;">
                        <div class="catalog-item" v-for="(contacter, index) of checkedContacters" :key="'contacter-' + index">
                            <div class="catalog-photo">
                                <img :src="'http://photo.chaoxing.com/p/' + contacter.puid + '_80'">
                            </div>
                            <div class="catalog-title">
                                {{contacter.name}}
                            </div>
                            <div class="del-img" @click="deleteCheckedUser(contacter)"></div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="footer">
                <div class="normal-btn cancle" @click="addShow=false">取消</div>
                <div class="normal-btn before-sure" v-if="checkedContacters.length < 1">完成</div>
                <div class="normal-btn after-sure" v-else @click="addConcat">完成</div>
            </div>
        </div>
    </div>
</div>
</body>
<th:block th:replace="pc/include/common_js :: common_js(~{::script})">
    <script>
        Array.prototype.unshiftArray = function (array) {
            var that = this;
            $.each(array, function () {
                that.unshift(this);
            });
        }
    </script>
    <script type="text/javascript" th:src="@{/pc/assets/lib/jquery.nicescroll.min.js}"></script>
    <script type="text/javascript" th:src="@{/pc/assets/lib/element-ui/lib/index.js}"></script>
    <script type="text/javascript" th:src="@{/pc/assets/lib/layui/layui.js}"></script>
    <script th:src="@{/mobile/assets/lib/mescroll/mescroll.js}"></script>
    <script th:inline="javascript">
        activityManagerVue = new Vue({
            el: "#activity-manager-vue",
            data: {
                activityId: [[${activityId}]],
                managerUids: [[${managerUids}]],
                // 组织者
                managers: [],
                managerQueryParams: {
                    pageNum: 1,
                    pageSize: 10
                },
                loaded: false,
                orgs: [[${orgs}]],
                niceScroll: null,
                cur: {},
                levels: [{'type': 1, 'name': '全部', 'key': '', 'fid': ''}],
                currentLevel: {},
                levelMescroll: null,
                departments: [],
                contacters: [],
                sw: "",
                checkedContacters: [],
                checkAllStatus: false,
                dialogVisible: false,
                // 删除弹出框
                deleteShow: false,
                deleteBatchShow: false,
                //添加弹出框
                addShow: false,
                // 输入框清空按钮是否显示
                closeValue: false,
            },
            created: function () {
                var $this = this;
                // 解决跨域
                document.domain = "chaoxing.com";
                $this.currentLevel = $this.levels[0];
            },
            mounted: function () {
                var $this = this;
                $this.loadManagers();
            },
            methods: {
                loadManagers: function () {
                    var $this = this;
                    var url = ctx + "/api/activity/" + $this.activityId + "/manager/list";
                    app.ajaxPost(url, $this.managerQueryParams, function (data) {
                        if (data.success) {
                            var managers = data.data.records;
                            $(managers).each(function () {
                                this.checked = false;
                            });
                            $this.managers = managers;
                        } else {
                            var errorMessage = data.message;
                            if (activityApp.isEmpty(errorMessage)) {
                                errorMessage = "加载组织者失败";
                            }
                            app.showMsg(errorMessage);
                        }
                    }, function () {
                        app.showMsg("加载组织者失败");
                    });
                },
                initMescroll: function (mescrollId, callback) {
                    return new MeScroll(mescrollId, {
                        //上拉加载的配置项
                        up: {
                            callback: callback,
                            isBounce: false,
                            noMoreSize: 3,
                            htmlNodata: '<div class="loadMore loading"><p style="display: block" class="loadEndText"></p></div>',
                            lazyLoad: {
                                use: false
                            },
                            page: {
                                num: 1,
                                size: 10,
                                time: null
                            }
                        }
                    });
                },
                // 加载组织者
                getManagers: function (page) {
                    var $this = this;
                    var url = ctx + "/api/activity/" + $this.activityId + "/manager/list";
                    var params = {
                        page: page.num,
                        pageSize: page.size
                    };
                    app.ajaxPost(url, params, function (data) {
                        if (data.success) {
                            $this.loaded = true;
                            var managers = data.data.records;
                            $(managers).each(function () {
                                this.checked = false;
                            });
                            $this.managers.pushArray(managers);
                            $this.page = page.num;
                            $this.mescroll.endSuccess(data.data.length);
                        } else {
                            var errorMessage = data.message;
                            app.showMsg(errorMessage);
                        }
                    }, function () {
                        app.showMsg("加载失败");
                    });
                },
                initSearchUsers: function () {
                    var $this = this;
                    if ($this.sw != '' || $this.currentLevel.type > 2) {
                        if ($this.levelMescroll) {
                            $this.levelMescroll.resetUpScroll();
                        } else {
                            $this.levelMescroll = $this.initMescroll("search-content", $this.getUsers);
                        }
                    }
                },
                getUsers: function (page) {
                    var $this = this;
                    if ($this.sw) {
                        $this.searchUsers();
                    } else {
                        $this.getDeptMembers(page);
                    }
                },
                searchUsers: function () {
                    var $this = this;
                    var url = ctx + "/api/wfw/contacter/search";
                    var params = {
                        pageNum: 1,
                        pageSize: 1000,
                        sw: $this.sw
                    };
                    app.ajaxPost(url, params, function (data) {
                        if (data.success) {
                            $this.loaded = true;
                            var contacters = data.data.records;
                            $(contacters).each(function () {
                                this.checked = $this.isChecked(this.puid);
                                $this.contacters.push(this);
                            });
                            $this.levelMescroll.endBySize(contacters.length, contacters.length);
                            $this.$nextTick(function () {
                                $(".item-choosed,.choose-list").getNiceScroll().resize();
                            });
                        } else {
                            var errorMessage = data.message;
                            app.showMsg(errorMessage);
                        }
                    }, function () {
                        app.showMsg("加载失败");
                    });

                },
                listDepartment: function () {
                    var $this = this;
                    var url = ctx + "/api/wfw/org/" + $this.currentLevel.fid + "/department";
                    var params = {
                        pid: $this.currentLevel.key,
                        pageNum: 1,
                        pageSize: 1000
                    };
                    app.ajaxPost(url, params, function (data) {
                        $this.loaded = true;
                        if (data.success) {
                            $this.departments = [];
                            var departments = data.data.records;
                            $(departments).each(function () {
                                if (this.pid == $this.currentLevel.key) {
                                    $this.departments.push(this);
                                }
                            });
                            $this.$nextTick(function () {
                                $(".item-choosed,.choose-list").getNiceScroll().resize();
                            });
                        } else {
                            var errorMessage = data.message;
                            app.showMsg(errorMessage);
                        }
                    }, function () {
                        $this.loaded = true;
                        app.showMsg("加载失败");
                    });
                },
                getDeptMembers: function (page) {
                    var $this = this;
                    var url = ctx + "/api/wfw/department/" + $this.currentLevel.key + "/contacter";
                    app.ajaxPost(url, {
                        pageNum: page.num,
                        pageSizeSize: page.size
                    }, function (data) {
                        $this.loaded = true;
                        if (data.success) {
                            if (page.num == 1) {
                                $this.contacters = [];
                            }
                            var contacters = data.data.records;
                            $(contacters).each(function () {
                                this.checked = $this.isChecked(this.puid);
                                $this.contacters.push(this);
                            });
                            $this.page = page.num;
                            $this.levelMescroll.endBySize(contacters.length, data.data.total); //必传参数(当前页的数据个数, 总数据量)
                            $this.$nextTick(function () {
                                $(".item-choosed,.choose-list").getNiceScroll().resize();
                            });
                        } else {
                            var errorMessage = data.message;
                            app.showMsg(errorMessage);
                        }
                    }, function () {
                        $this.loaded = true;
                        app.showMsg("加载失败");
                    });
                },
                addConcat: function () {
                    var $this = this;
                    var managers = [];
                    $($this.checkedContacters).each(function () {
                        managers.push({
                            activityId: $this.activityId,
                            uid: this.puid,
                            userName: this.name
                        });
                    });
                    var url = ctx + "/api/activity/" + $this.activityId + "/manager/add/batch";
                    app.ajaxPostWithPayload(url, JSON.stringify(managers), function (data) {
                        if (data.success) {
                            $this.addShow = false;
                            app.showMsg("处理成功", function () {
                                window.location.reload();
                            });
                        } else {
                            var errorMessage = data.message;
                            app.showMsg(errorMessage);
                        }
                    }, function () {
                        app.showMsg("添加失败");
                    }, '添加');
                },
                openDeleteDialog: function (l) {
                    var $this = this;
                    $this.cur = l;
                    $this.deleteShow = true;
                },
                openDeleteBatchDialog: function (l) {
                    var $this = this;
                    $this.cur = l;
                    $this.deleteBatchShow = true;
                },
                deleteManager: function () {
                    var $this = this;
                    var url = ctx + "/api/activity/" + $this.activityId + "/manager/"+ $this.cur.uid +"/delete";
                    app.ajaxPost(url, {}, function (data) {
                        if (data.success) {
                            $this.managers.remove($this.cur);
                            $this.deleteShow = false;
                            $this.cur = {};
                            app.showMsg("移除成功")
                        } else {
                            var errorMessage = data.message;
                            app.showMsg(errorMessage);
                        }
                    }, function () {
                        app.showMsg("移除成功");
                    }, '移除');
                },
                deleteBatchManager: function () {
                    var $this = this;
                    var url = ctx + "/api/activity/" + $this.activityId + "/manager/delete/batch";
                    var uids = [];
                    $($this.managers).each(function () {
                        if (this.checked) {
                            uids.push(this.uid);
                        }
                    });
                    app.ajaxPostWithPayload(url, JSON.stringify(uids), function (data) {
                        if (data.success) {
                            app.showMsg("处理成功", function () {
                                window.location.reload();
                            });
                        } else {
                            var errorMessage = data.message;
                            app.showMsg(errorMessage);
                        }
                    }, function () {
                        app.showMsg("处理失败");
                    }, '');
                },
                toLevel: function (f, type) {
                    var $this = this;
                    var level = {};
                    if (type === 2) {
                        level.name = f.name;
                        level.key = "-1";
                        level.fid = f.fid;
                    } else {
                        level.name = f.name;
                        level.key = f.id;
                        level.fid = $this.levels[1].fid;
                    }
                    level.type = type;
                    $this.levels.push(level);
                    $this.gotoFolder(level);
                },
                gotoFolder: function (f) {
                    var $this = this;
                    let indexOf = $this.levels.indexOf(f);
                    $this.levels.splice(indexOf + 1, $this.levels.length);
                    $this.currentLevel = f;
                    if (f.type > 1) {
                        $this.listDepartment();
                        if (f.type > 2) {
                            if ($this.levelMescroll) {
                                $this.levelMescroll.resetUpScroll();
                            } else {
                                $this.levelMescroll = $this.initMescroll("search-content", $this.getUsers);
                            }
                        }
                    }
                    $this.$nextTick(function () {
                        $(".item-choosed,.choose-list").getNiceScroll().resize();
                    })

                },
                removeBatchStatus: function () {
                    var $this = this;
                    for (var i = 0; i < $this.managers.length; i++) {
                        if ($this.managers[i].checked) return true;
                    }
                    return false;
                },
                checkChangeHandle: function (l) {
                    var $this = this;
                    $this.checkAllStatus = true;
                    for (var i = 0; i < $this.managers.length; i++) {
                        if (!$this.managers[i].checked) {
                            $this.checkAllStatus = false;
                            break;
                        }
                    }
                },
                checkAllChange: function () {
                    var $this = this;
                    for (var i = 0; i < $this.managers.length; i++) {
                        $this.managers[i].checked = $this.checkAllStatus;
                    }
                },
                changeCheckUser: function (contacter) {
                    var $this = this;
                    if (contacter.checked) {
                        if ($this.managerUids.indexOf(contacter.puid) < 0) {
                            $this.checkedContacters.push(contacter);
                        }
                    } else {
                        if ($this.managerUids.indexOf(contacter.puid) > -1) {
                            contacter.checked = true;
                        }else{
                            $this.removeCheckedUser(contacter);
                        }
                    }
                },
                removeCheckedUser: function (l) {
                    var $this = this;
                    var index = -1;
                    for (let i = 0; i < $this.checkedContacters.length; i++) {
                        var check = $this.checkedContacters[i];
                        if (check.puid === l.puid) {
                            index = i;
                            break;
                        }
                    }
                    if (index > -1) {
                        $this.checkedContacters.splice(index, 1);
                    }
                },
                isChecked: function (uid) {
                    var $this = this;
                    var isChecked = false;
                    $($this.checkedContacters).each(function () {
                        if (this.puid == uid) {
                            isChecked = true;
                            return false;
                        }
                    });
                    if (!isChecked) {
                        $($this.managerUids).each(function () {
                            if (this == uid) {
                                isChecked = true;
                                return false;
                            }
                        });
                    }
                    return isChecked;
                },
                deleteCheckedUser: function (l) {
                    var $this = this;
                    $this.removeCheckedUser(l);
                    for (let i = 0; i < $this.contacters.length; i++) {
                        var check = $this.contacters[i];
                        if (check.puid === l.puid) {
                            check.checked = false;
                            break;
                        }
                    }
                    $this.$forceUpdate();
                },
                handleClose() {
                    this.dialogVisible = false;
                },
                // 提交事件
                submithandle: function () {
                    layer.msg('权限设置成功');
                    this.dialogVisible = false;
                },
                handleSave: function () {
                    this.deleteShow = false
                    this.deleteBatchShow = false
                },
                handleSure: function () {
                    layer.msg('移除成功');
                    this.deleteShow = false
                },
                // 监听添加弹框input
                swHandle: function () {
                    if (this.sw.trim() !== "") {
                        this.closeValue = true
                    } else {
                        this.closeValue = false
                    }
                    this.$nextTick(function () {
                        $(".item-choosed,.choose-list").getNiceScroll().resize();
                        this.contacters.splice(0, this.contacters.length);
                    })
                },
                // 清空输入框的值
                clearSearchKey: function () {
                    this.sw = "";
                    this.closeValue = false;
                    this.$nextTick(function () {
                        $(".item-choosed,.choose-list").getNiceScroll().resize();
                        this.initSearchUsers();
                    });
                },
                initNiceScroll: function () {
                    var $this = this;
                    if (activityApp.isEmpty($this.niceScroll)) {
                        $this.niceScroll = $(".item-choosed,.choose-list").niceScroll({
                            cursorborder: "",
                            cursorwidth: 8,
                            cursorcolor: "#DADADA",
                            boxzoom: false,
                            autohidemode: true
                        });
                        $(".item-choosed,.choose-list").getNiceScroll().resize();
                    }
                },
                toAdd: function () {
                    var $this = this;
                    $this.addShow = true;
                    $this.$nextTick(function () {
                        $this.initNiceScroll();
                    });
                },
            }
        });
    </script>
</th:block>
</html>