<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org/">
<head>
    <title>组织者管理</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" th:href="@{/pc/assets/lib/element-ui/lib/theme-chalk/index.css}">
    <link rel="stylesheet" th:href="@{/pc/assets/lib/layui/css/layui.css}">
    <link rel="stylesheet" th:href="@{/pc/assets/css/public.css}">
    <link rel="stylesheet" th:href="@{/pc/assets/css/dialog.css}">
    <link rel="stylesheet" th:href="@{/pc/assets/css/organizer-manage.css}">
    <link rel="stylesheet" th:href="@{/mobile/assets/lib/mescroll/mescroll.css}">
    <style type="text/css">
        [v-cloak] {
            display: none;
        }
    </style>
</head>

<body >
    <div class="manage-container" id="vue" v-cloak>
        <div class="manage-header">
            组织者管理
        </div>
        <div class="manage-content" id="manager-content">
            <div class="btn-add btn-size fl" @click="addDialog()">
                <img th:src="@{/pc/assets/images/add-small.png}">
                <span>添加</span>
            </div>
            <div v-show="!removeBatchStatus()" class="btn-del-disable btn-size fl">批量移除</div>
            <div v-show="removeBatchStatus()" class="btn-del btn-size fl" @click="openDeleteBatchDialog()">批量移除</div>
            <div class="clear"></div>
            <table class="table-box">
                <thead>
                    <tr>
                        <th class="check-box">
                            <el-checkbox v-model="checkAllStatus" class="check-item-checkbox fl"
                                @change="checkAllChange">
                            </el-checkbox>
                        </th>
                        <th>姓名</th>
                        <th>操作</th>
                    </tr>
                </thead>
                <tbody>
                    <tr v-for="l of list">
                        <th class="check-box">
                            <el-checkbox v-model="l.checked" class="check-item-checkbox fl"
                                @change="checkChangeHandle(l)">
                            </el-checkbox>
                        </th>
                        <th>{{l.userName}}</th>
                        <th>
                            <span @click="openWeightSetDialog(l)">权限设置</span>
                            <span @click="openDeleteDialog(l)">移除</span>
                        </th>
                    </tr>

                </tbody>
            </table>
            <div class="no-content" v-if="list.length == 0 && loaded">
                暂无内容
            </div>
        </div>

        <!-- 确认删除分类弹框 -->
        <div class="dailog-box3" v-show="deleteShow">
            <div class="dailog delete-dailog">
                <div class="warn"><img th:src="@{/pc/assets/images/warning.png}"></div>
                <span>移除后可重新添加。确定移除吗？</span>
                <div>
                    <div class="normal-btn" @click="handleSave">保留</div>
                    <div class="normal-btn after-sure" @click="deleteManager()">移除</div>
                </div>
            </div>
        </div>

        <!-- 确认删除分类弹框 -->
        <div class="dailog-box3 batch" v-show="deleteBatchShow">
            <div class="dailog delete-dailog">
                <div class="warn"><img th:src="@{/pc/assets/images/warning.png}"></div>
                <span>移除后可重新添加。确定批量移除吗？</span>
                <div>
                    <div class="normal-btn" @click="handleSave">保留</div>
                    <div class="normal-btn after-sure" @click="deleteBatchManager()">移除</div>
                </div>
            </div>
        </div>
        <!--选择人员弹框-->
        <div class="dailog-box1" v-show="addShow">
            <div class="dailog choose-dialog">
                <div class="header">
                    <span>选择人员</span>
                    <img class="close" th:src="@{/pc/assets/images/close.png}" @click="addShow = false">
                </div>
                <div class="body clear">
                    <div class="choose-list fl mescroll" id="search-content">
                        <div>
                        <div class="search">
                            <input class="search-ipt" type="text" placeholder="姓名" v-model="sw" @input="swHandle()" @keyup.enter="initSearchUsers()">
                            <i class="icon close" v-show="closeValue" @click="clearSearchKey()"></i>
                            <i class="icon search-icon"></i>
                        </div>
                        <div class="crumb" style="display: block;">
                            <ul class="clear" v-show="sw == ''">
                                <li class="back-item" v-for="(folder,index) of folders" v-if="index < folders.length-1" @click="gotoFolder(folder)">{{folder.name}}{{' > '}}</li>
                                <li>{{folders[folders.length-1].name}}</li>
                            </ul>
                        </div>
                        <template v-show="!sw">
                            <div class="catalog-list" style="display: block;">
                                <template v-show="curFolder.type === 1">
                                    <div class="catalog-item" v-for="(org, index) of orgs" :key="'org-' + index" @click="goFolder(f,2)">
                                        <div class="catalog-photo">
                                            <img th:src="@{/pc/assets/images/catalog1.png}">
                                        </div>
                                        <div class="catalog-title">{{org.name}}</div>
                                        <img class="right-img" th:src="@{/pc/assets/images/icon-right.png}">
                                    </div>
                                </template>
                                <template v-show="curFolder.type >= 2">
                                    <template v-for="l of depts">
                                        <div class="catalog-item" @click="goFolder(l,3)">
                                            <div class="catalog-photo">
                                                <img th:src="@{/pc/assets/images/catalog1.png}">
                                            </div>
                                            <div class="catalog-title">
                                                {{l.name}}
                                            </div>
                                            <img class="right-img" th:src="@{/pc/assets/images/icon-right.png}">
                                        </div>
                                    </template>
                                </template>
                                <template v-show="curFolder.type > 2">
                                    <div v-for="l of members" :class='{"catalog-item":true,"bgc-blue": l.checked}' :key="l.puid">
                                        <div class="catalog-photo">
                                            <img :src="'http://photo.chaoxing.com/p/'+l.puid+'_80'">
                                        </div>
                                        <div class="catalog-title">
                                            {{l.name}}
                                        </div>
                                        <el-checkbox class="right-check" v-model="l.checked" @change="changeCheckUser(l)"></el-checkbox>
                                    </div>
                                </template>
                            </div>
                        </template>
                        <template v-show="sw">
                            <div class="catalog-list" style="display: block;">
                                <div v-for="l of members" :class='{"catalog-item":true,"bgc-blue": l.checked}' :key="l.puid">
                                    <div class="catalog-photo">
                                        <img :src="'http://photo.chaoxing.com/p/'+l.puid+'_80'">
                                    </div>
                                    <div class="catalog-title">
                                        {{l.name}}
                                    </div>
                                    <el-checkbox class="right-check" v-model="l.checked" @change="changeCheckUser(l)"></el-checkbox>
                                </div>
                            </div>
                        </template>
                        <div class="empty-content" style="display: none;">
                            无搜索结果
                        </div>
                        </div>
                    </div>
                    <div class="item-choosed fl">
                        <div class="choose-number">已选{{checkedUsers.length}}人</div>
                        <div class="catalog-list" style="display: block;">
                            <div class="catalog-item" v-for="l of checkedUsers">
                                <div class="catalog-photo">
                                    <img :src="'http://photo.chaoxing.com/p/'+l.puid+'_80'">
                                </div>
                                <div class="catalog-title">
                                    {{l.name}}
                                </div>
                                <div class="del-img" @click="deleteCheckUser(l)"></div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="footer">
                    <div class="normal-btn cancle" @click="addShow=false">取消</div>
                    <div class="normal-btn before-sure" v-if="checkedUsers.length == 0">完成</div>
                    <div class="normal-btn after-sure" v-else @click="addConcat()">完成</div>
                </div>
            </div>
        </div>
    </div>
</body>
<th:block th:replace="pc/include/common_js :: common_js(~{::script})">
    <script>
        Array.prototype.unshiftArray = function (array) {
            var that = this;
            $.each(array, function () {
                that.unshift(this);
            });
        }
    </script>
    <script type="text/javascript" th:src="@{/pc/assets/lib/jquery.nicescroll.min.js}"></script>
    <script type="text/javascript" th:src="@{/pc/assets/lib/element-ui/lib/index.js}"></script>
    <script type="text/javascript" th:src="@{/pc/assets/lib/layui/layui.js}"></script>
    <script th:src="@{/mobile/assets/lib/mescroll/mescroll.js}"></script>
    <script th:inline="javascript">
        var vm = new Vue({
            el: '#vue',
            data: {
                activity: [[${activity}]],
                uid: [[${session._login_user_.uid}]],
                fid: [[${session._login_user_.fid}]],
                //辅助分页
                page: 1,
                mescroll: null,
                list: [],
                loaded: false,
                cur: {},
                folders: [{'type': 1, 'name': '全部', 'key': '', 'fid': ''}],
                curFolder: {},
                folderMescroll: null,
                depts: [],
                members: [],
                // 用户所属机构列表
                orgs: [[${orgs}]],
                // 搜索关键字
                sw: "",
                checkedUsers: [],

                checkAllStatus: false,

                dialogVisible: false,

                // 删除弹出框
                deleteShow: false,
                deleteBatchShow: false,
                //添加弹出框
                addShow: false,
                // 输入框清空按钮是否显示
                closeValue: false,
            },
            created: function () {
                var $this = this;
                // 解决跨域
                document.domain = "chaoxing.com";
                $this.curFolder = $this.folders[0];
            },
            mounted: function () {
                var $this = this;
                $this.initScroll();
                $this.mescroll = $this.initMescroll("body", $this.getManagers);
            },
            methods: {
                initMescroll: function (mescrollId,callback) {
                    //创建MeScroll对象,内部已默认开启下拉刷新,自动执行up.callback,刷新列表数据;
                    var mescroll = new MeScroll(mescrollId, {
                        //上拉加载的配置项
                        up: {
                            callback: callback, //上拉回调,此处可简写; 相当于 callback: function (page) { getListData(page); }
                            isBounce: false, //此处禁止ios回弹,解析(务必认真阅读,特别是最后一点): http://www.mescroll.com/qa.html#q10
                            noMoreSize: 3, //如果列表已无数据,可设置列表的总数量要大于半页才显示无更多数据;避免列表数据过少(比如只有一条数据),显示无更多数据会不好看; 默认5
                            /*   empty: {
                                tip: "暂无相关数据~", //提示
                            },*/
                            htmlNodata: '<div class="loadMore loading"><p style="display: block" class="loadEndText"></p></div>',
                            // htmlLoading:'<div class="loadMore loading"><p style="display: block" class="loadingText">正在加载中，请稍候...</p></div>',
                            lazyLoad: {
                                use: false // 是否开启懒加载,默认false
                            },
                            page: {
                                num: 1,
                                size: 10,
                                time: null
                            }
                        },
                        down:{
                            use:false,
                        }
                    });
                    return mescroll;
                },
                getManagers: function (page) {
                    var $this = this;
                    var url = ctx + "/activity/"+$this.activity.id +"/managers";
                    app.ajaxPost(url, {page: page.num, pageSize: page.size}, function (data) {
                        $this.loaded = true;
                        if (data.success) {
                            for (var i = 0; i < data.data.length; i++) {
                                var l = data.data[i];
                                l.checked = false;
                                $this.list.push(l);
                            }
                            $this.page = page.num;
                            $this.mescroll.endSuccess(data.data.length); //必传参数(当前页的数据个数, 总数据量)
                            $this.$nextTick(function () {

                            });

                        } else {
                            var errorMessage = data.message;
                            app.showMsg(errorMessage);
                        }
                    }, function () {
                        $this.loaded = true;
                        app.showMsg("加载失败");
                    });
                },

                initSearchUsers:function(){
                    var $this = this;
                    if($this.sw != '' || $this.curFolder.type > 2) {
                        if ($this.folderMescroll) {
                            $this.folderMescroll.resetUpScroll()
                        } else {
                            $this.folderMescroll = $this.initMescroll("search-content", $this.getUsers);
                        }
                    }
                },
                getUsers:function(page){
                    var $this = this;
                    if($this.sw != ''){
                        $this.searchUsers(page);
                    }else{
                        $this.getDeptMembers(page);
                    }
                },
                searchUsers:function(page){
                    var $this = this;
                    var url = ctx + "/api/wfw/contact/"+$this.uid +"/search";
                    app.ajaxPost(url, {page: page.num, pageSize: page.size,keyword:$this.sw}, function (data) {
                        $this.loaded = true;
                        if (data.success) {
                            if(page.num === 1){
                                $this.members.splice(0,$this.members.length);
                            }
                            var list = data.data.list;
                            for (let i = 0; i < list.length; i++) {
                                var l = list[i];
                                l.checked = $this.checkUser(l);
                                $this.members.push(l);
                            }
                            $this.page = page.num;
                            $this.folderMescroll.endBySize(data.data.list.length,data.data.allCount); //必传参数(当前页的数据个数, 总数据量)
                            $this.$nextTick(function () {
                                $(".item-choosed,.choose-list").getNiceScroll().resize();
                            });
                        } else {
                            var errorMessage = data.message;
                            app.showMsg(errorMessage);
                        }
                    }, function () {
                        $this.loaded = true;
                        app.showMsg("加载失败");
                    });
                },
                getDepts: function () {
                    var $this = this;
                    var url = ctx + "/api/wfw/contact/"+$this.curFolder.fid +"/depts";
                    app.ajaxPost(url, {page: 1, pageSize: 1000,pid:$this.curFolder.key}, function (data) {
                        $this.loaded = true;
                        if (data.success) {
                            $this.depts.splice(0,$this.depts.length);
                            for (var i = 0; i < data.data.length; i++) {
                                var dept = data.data[i];
                                if(dept.pid == $this.curFolder.key){
                                    $this.depts.push(dept);
                                }
                            }

                            $this.$nextTick(function () {
                                $(".item-choosed,.choose-list").getNiceScroll().resize();
                            });
                        } else {
                            var errorMessage = data.message;
                            app.showMsg(errorMessage);
                        }
                    }, function () {
                        $this.loaded = true;
                        app.showMsg("加载失败");
                    });
                },
                getDeptMembers: function (page) {
                    var $this = this;
                    var url = ctx + "/api/wfw/contact/dept/"+$this.curFolder.key +"/members";
                    app.ajaxPost(url, {page: page.num, pageSize: page.size,deptId:$this.curFolder.key}, function (data) {
                        $this.loaded = true;
                        if (data.success) {
                            if(page.num === 1){
                                $this.members.splice(0,$this.members.length);
                            }
                            var list = data.data.list;
                            for (let i = 0; i < list.length; i++) {
                                var l = list[i];
                                l.checked = $this.checkUser(l);
                                $this.members.push(l);
                            }
                            $this.page = page.num;
                            $this.folderMescroll.endBySize(data.data.list.length,data.data.allCount); //必传参数(当前页的数据个数, 总数据量)
                            $this.$nextTick(function () {
                                $(".item-choosed,.choose-list").getNiceScroll().resize();
                            });
                        } else {
                            var errorMessage = data.message;
                            app.showMsg(errorMessage);
                        }
                    }, function () {
                        $this.loaded = true;
                        app.showMsg("加载失败");
                    });
                },
                addConcat:function() {
                    var $this = this;
                    var users = $this.checkedUsers;
                    var managers = [];
                    for (var i = 0; i < users.length; i++) {
                        var user = users[i];
                        var manager = {};
                        manager.uid = user.puid;
                        manager.userName = user.name;
                        managers.push(manager);
                    }
                    var url = ctx + "/activity/" + $this.activity.id + "/add/batch/manager";
                    app.ajaxPostWithPayload(url, JSON.stringify(managers), function (data) {
                        if (data.success) {
                            $this.list.unshiftArray(data.data);
                            $this.checkedUsers.splice(0,$this.checkedUsers.length);
                            for (let i = 0; i < $this.members.length; i++) {
                                var l = $this.members[i];
                                l.checked = false;
                            }
                            $this.addShow = false;
                            $this.$nextTick(function () {
                                $(".item-choosed,.choose-list").getNiceScroll().resize();
                            });
                        } else {
                            var errorMessage = data.message;
                            app.showMsg(errorMessage);
                        }
                    }, function () {
                        app.showMsg("添加失败");
                    }, '添加');
                },
                openDeleteDialog:function(l){
                    var $this = this;
                    $this.cur = l;
                    $this.deleteShow = true;
                },
                openDeleteBatchDialog:function(l){
                    var $this = this;
                    $this.cur = l;
                    $this.deleteBatchShow = true;
                },
                deleteManager:function(){
                    var $this = this;
                    var url = ctx + "/activity/"+$this.activity.id +"/manager/delete/"+$this.cur.uid;
                    app.ajaxPost(url, {}, function (data) {
                        if (data.success) {
                            $this.list.remove($this.cur);
                            $this.deleteShow = false;
                            $this.cur = {};
                            app.showMsg("移除成功")
                        } else {
                            var errorMessage = data.message;
                            app.showMsg(errorMessage);
                        }
                    }, function () {
                        app.showMsg("移除成功");
                    },'移除');
                },
                deleteBatchManager:function(){
                    var $this = this;
                    var url = ctx + "/activity/"+$this.activity.id +"/manager/delete/batch";
                    var uids = [];
                    var checkeds = [];
                    for (var i = 0; i < $this.list.length; i++) {
                        var l = $this.list[i];
                        if(l.checked){
                            uids.push(l.uid);
                            checkeds.push(l);
                        }
                    }
                    app.ajaxPostWithPayload(url, JSON.stringify(uids), function (data) {
                        if (data.success) {
                            for (let i = 0; i < checkeds.length; i++) {
                                $this.list.remove(checkeds[i]);
                            }
                            $this.deleteBatchShow = false;
                            app.showMsg("移除成功")
                        } else {
                            var errorMessage = data.message;
                            app.showMsg(errorMessage);
                        }
                    }, function () {
                        app.showMsg("移除成功");
                    },'删除');
                },
                openWeightSetDialog:function(l){
                    app.showMsg("功能暂未开放")
                },
                goFolder:function(f,type){
                    var $this = this;
                    var folder = {};
                    if(type === 2){
                        folder.name = f.name;
                        folder.key = "-1";
                        folder.fid = f.fid;
                    }else{
                        folder.name = f.name;
                        folder.key = f.id;
                        folder.fid = $this.folders[1].fid;
                    }
                    folder.type = type;
                    $this.folders.push(folder);
                    $this.gotoFolder(folder);
                },
                gotoFolder:function(f) {
                    var $this = this;
                    let indexOf = $this.folders.indexOf(f);
                    $this.folders.splice(indexOf+1, $this.folders.length);
                    $this.curFolder = f;
                    if(f.type > 1){
                        $this.getDepts();
                        if (f.type > 2) {
                            if($this.folderMescroll){
                                $this.folderMescroll.resetUpScroll()
                            }else{
                                $this.folderMescroll = $this.initMescroll("search-content", $this.getUsers);
                            }
                        }
                    }
                    $this.$nextTick(function () {
                        $(".item-choosed,.choose-list").getNiceScroll().resize();
                    })

                },
                removeBatchStatus:function(){
                    var $this = this;
                    for (var i = 0; i < $this.list.length; i++) {
                        if($this.list[i].checked) return true;
                    }
                    return false;
                },
                checkChangeHandle: function (l) {
                    var $this = this;
                    $this.checkAllStatus = true;
                    for (var i = 0; i < $this.list.length; i++) {
                        if(!$this.list[i].checked) {
                            $this.checkAllStatus = false;
                            break;
                        }
                    }
                },
                checkAllChange: function () {
                    var $this = this;
                    for (var i = 0; i < $this.list.length; i++) {
                        $this.list[i].checked = $this.checkAllStatus;
                    }
                },

                changeCheckUser:function(l){
                    var $this = this;
                    if(l.checked){
                        $this.checkedUsers.push(l);
                    }else{
                        $this.removeCheckedUser(l);
                    }
                },
                removeCheckedUser:function(l){
                    var $this = this;
                    var index = -1;
                    for (let i = 0; i < $this.checkedUsers.length; i++) {
                        var check = $this.checkedUsers[i];
                        if(check.puid === l.puid){
                           index = i;
                           break;
                        }
                    }
                    if(index > -1){
                        $this.checkedUsers.splice(index,1);
                    }
                },
                checkUser:function(l){
                    var $this = this;
                    for (let i = 0; i < $this.checkedUsers.length; i++) {
                        var check = $this.checkedUsers[i];
                        if(check.puid === l.puid){
                            return true;
                        }
                    }
                    return false;
                },
                deleteCheckUser:function(l){
                    var $this = this;
                    $this.removeCheckedUser(l);
                    for (let i = 0; i < $this.members.length; i++) {
                        var check = $this.members[i];
                        if(check.puid === l.puid){
                            check.checked = false;
                            break;
                        }
                    }
                    $this.$forceUpdate();
                },
                handleClose(done) {
                    this.dialogVisible = false;
                },
                // 提交事件
                submithandle: function () {
                    layer.msg('权限设置成功');
                    this.dialogVisible = false;
                },
                handleSave: function () {
                    this.deleteShow = false
                    this.deleteBatchShow = false
                },
                handleSure: function () {
                    layer.msg('移除成功');
                    this.deleteShow = false
                },
                // 监听添加弹框input
                swHandle: function () {
                    if (this.sw.trim() !== "") {
                        this.closeValue = true
                    } else {
                        this.closeValue = false
                    }
                   this.$nextTick(function () {
                       $(".item-choosed,.choose-list").getNiceScroll().resize();
                       this.members.splice(0,this.members.length);
                   })
                },
                // 清空输入框的值
                clearSearchKey: function () {
                    this.sw = "";
                    this.closeValue = false;
                    this.$nextTick(function () {
                        $(".item-choosed,.choose-list").getNiceScroll().resize();
                        this.initSearchUsers();
                    })

                },
                initScroll: function () {
                    $(".item-choosed,.choose-list").niceScroll({
                        cursorborder: "",
                        cursorwidth: 8,
                        cursorcolor: "#DADADA",
                        boxzoom: false,
                        autohidemode: true
                    });
                    $(".item-choosed,.choose-list").getNiceScroll().resize();
                },
                addDialog:function () {
                    var $this = this;
                    $this.addShow = true;
                },
            }
        });
    </script>
</th:block>
</html>

