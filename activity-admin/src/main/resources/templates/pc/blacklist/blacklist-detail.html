<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org/">
<head>
	<title>黑名单</title>
	<meta charset="UTF-8">
	<meta name="renderer" content="webkit">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<link rel="stylesheet" href="/static/pc/assets/sign/assets/icomoon/style.css" th:href="@{/pc/assets/sign/assets/icomoon/style.css}">
	<link rel="stylesheet" href="/static/pc/assets/lib/element-ui/lib/theme-chalk/index.css" th:href="@{/pc/assets/lib/element-ui/lib/theme-chalk/index.css}">
	<link rel="stylesheet" href="/static/pc/assets/lib/zTree_v3/css/zTreeStyle/zTreeStyle.css" th:href="@{/pc/assets/lib/zTree_v3/css/zTreeStyle/zTreeStyle.css}">
	<link rel="stylesheet" href="/static/pc/assets/sign/assets/css/commonTable.css" th:href="@{/pc/assets/sign/assets/css/commonTable.css}">
	<link rel="stylesheet" href="/static/pc/assets/sign/assets/css/confirm_dialog.css" th:href="@{/pc/assets/sign/assets/css/confirm_dialog.css}">
	<link rel="stylesheet" href="/static/pc/assets/css/choose-dialog.css" th:href="@{/pc/assets/css/choose-dialog.css}">
	<link rel="stylesheet" href="/static/pc/assets/css/limits-manage.css" th:href="@{/pc/assets/css/limits-manage.css}">
	<link rel="stylesheet" href="/static/mobile/assets/lib/mescroll/mescroll.css" th:href="@{/mobile/assets/lib/mescroll/mescroll.css}">
	<link rel="stylesheet" href="/static/pc/assets/css/notice-setting.css" th:href="@{/pc/assets/css/notice-setting.css}">
	<style>
        [v-cloak] {
            display: none;
        }
	</style>
</head>
<body>
<div class="tab-page" id="vm" v-cloak>
	<div class="page-header" v-if="!embedded">{{market.name}}违约明细</div>
	<div style="display: block">
		<!-- 选项卡内容 -->
		<div class="tab-content-box">
			<div class="tab-item">
				<div class="operate-box">
					<!-- 操作栏 -->
					<div class="table-operate-box fs0">
						<el-button class="btn-customize" round @click="exportData">导出</el-button>
						<el-button class="btn-customize" round @click="exportRecord">导出记录</el-button>
						<div class="search-Box">
							<el-input placeholder="姓名/账号" icon="search" class="search" suffix-icon="el-icon-search" v-model.trim="sw" @keyup.enter.native="search"></el-input>
							<i class="icon-cancel btn-cancel fs16" v-show="sw" @click="clearSearch"></i>
						</div>
					</div>
					<!-- 计数栏 -->
					<div class="table-count-box fs12">
						<div class="count-info fl">
							<span class="color999">共 {{total}} 人</span>
						</div>
					</div>

				</div>
				<el-table v-if="tbodyHeight > 0" class="table-box" :data="blacklistDetails" :max-height="tbodyHeight" ref="blacklistTable" @sort-change="changeOrderField">
					<el-table-column align="left" fixed prop="userName" label="姓名" min-width="82"></el-table-column>
					<el-table-column align="left" prop="account" label="账号" min-width="120"></el-table-column>
					<el-table-column align="left" prop="activityName" label="活动名称" min-width="180"></el-table-column>
					<el-table-column align="left" prop="breachContent" label="违约记录" min-width="240"></el-table-column>
					<el-table-column align="left" sortable label="违约时间" min-width="80">
						<template slot-scope="scope">
							{{scope.row.createTimestamp | timestampFormat}}
						</template>
					</el-table-column>
				</el-table>
				<el-pagination class="fixPage" background layout="prev, pager, next, sizes" :total="total"  :page-sizes="[10, 20, 50, 100]" :page-size="queryParams.pageSize" @size-change="sizeChangeHandle" :current-page="queryParams.pageNum" @current-change="changePage" style="text-align: center;"></el-pagination>
			</div>
		</div>
	</div>
	<!--导出成功弹窗-->
	<vue-confirm-common ref="exportSuccessWindow" :message="'数据准备中，导出完成的数据会保存在“导出记录”中，请稍后下载'" :cancel="'完成'" :sure="'导出记录'" @callback="exportRecord"></vue-confirm-common>
</div>
<div th:replace="pc/include/common_js :: common_js(~{::script})">
	<script src="/static/pc/assets/lib/element-ui/lib/index.js" th:src="@{/pc/assets/lib/element-ui/lib/index.js}"></script>
	<script src="/static/pc/assets/lib/set-iframe-height-child.js" th:src="@{/pc/assets/lib/set-iframe-height-child.js}"></script>
	<script src="/static/mobile/assets/lib/mescroll/mescroll.js" th:src="@{/mobile/assets/lib/mescroll/mescroll.js}"></script>
	<script src="/static/pc/assets/component/confirm-common.js" th:src="@{/pc/assets/component/confirm-common.js}"></script>
	<script th:inline="javascript">
		var now = new Date();
		var nowTimestamp = now.getTime();
		vm = new Vue({
			el: '#vm',
			data: {
                market: [[${market}]],
				marketId: [[${marketId}]],
				blacklistDetails: [],
				loaded: false,
				// 总记录数
				total: 0,
				// 总页数
				pages: 0,
				sw: "",
				queryParams: {
					pageNum: 1,
					pageSize: 10,
					marketId: [[${marketId}]],
					sw: "",
					orderType: "DESC"
				},
				bodyHeight: $(window).height(),
				tbodyHeight: 0,
				operateUid: 0,
				embedded: activityApp.isEmbedded()
			},
			mounted: function () {
				var $this = this;
				var headH = $('.header-box').height();
				var operateH = $('.operate-box').height();
				$this.tbodyHeight = $this.bodyHeight - (headH + operateH + 48 + 16 + 32);
				$this.loadData();
			},
			methods: {
				// 处理分页大小变更
				sizeChangeHandle: function (val) {
					var $this = this;
					$this.queryParams.size = val;
					$this.loadData();
				},
				loadData: function () {
					var $this = this;
					var url = ctx + "/api/market/" + $this.marketId + "/blacklist/detail/page";
					$this.blacklistDetails = [];
					$this.loaded = true;
					app.ajaxPostWithLoading(url, $this.queryParams, function (data) {
						if (data.success) {
							$this.loaded = false;
							$this.blacklistDetails = data.data.records;
							$this.total = data.data.total;
							$this.pages = data.data.pages;
						} else {
							var message = data.message;
							if (activityApp.isEmpty(message)) {
								message = "加载黑名单失败";
							}
							app.showMsg(message);
						}
					}, function () {
						app.showMsg("加载黑名单失败");
					});
				},
				changePage: function (pageNum) {
					var $this = this;
					$this.queryParams.pageNum = pageNum;
					$this.loadData();
				},
				// 搜索
				search: function () {
					var $this = this;
					$this.queryParams.sw = $this.sw;
					$this.queryParams.pageNum = 1;
					$this.loadData();
				},
				// 清空搜索
				clearSearch: function () {
					var $this = this;
					$this.sw = "";
					if ($this.queryParams.sw != $this.sw) {
						$this.queryParams.sw = $this.sw;
						// 重新搜索
						$this.search();
					}
				},
				changeOrderField: function (column) {
					var $this = this;
					if ("descending" == column.order) {
						$this.queryParams.orderType = "DESC";
					} else {
						$this.queryParams.orderType = "ASC";
					}
					$this.loadData();
				},
				// 导出
				exportData: function () {
					var $this = this;
					var url = ctx + "/api/export";
					$this.loaded = false;
					var params = {
						queryParamStr: activityApp.getJsonStr($this.queryParams),
						exportType: "blacklist_detail"
					};
					app.ajaxPostWithLoading(url, params, function (data) {
						$this.loaded = true;
						if (data.success) {
							$this.$refs.exportSuccessWindow.show = true;
						} else {
							var errorMessage = data.message;
							if (activityApp.isEmpty(errorMessage)) {
								errorMessage = "导出失败";
							}
							app.showMsg(errorMessage);
						}
					}, function () {
						app.showMsg("导出失败");
					});
				},
				// 导出记录
				exportRecord: function () {
					window.open(ctx + '/export-record?exportType=blacklist_detail');
				}
			}
		})
	</script>
</div>
</body>
</html>