<!DOCTYPE html>
<html lang="en" class="html" xmlns:th="http://www.thymeleaf.org/">

<head>
    <meta charset="UTF-8">
    <title>报名设置</title>
    <link rel="stylesheet" href="/static/pc/assets/lib/layui/css/layui.css" th:href="@{/pc/assets/lib/layui/css/layui.css}">
    <link rel="stylesheet" href="/static/pc/assets/lib/element-ui/lib/theme-chalk/index.css" th:href="@{/pc/assets/lib/element-ui/lib/theme-chalk/index.css}">
    <link rel="stylesheet" href="/static/pc/assets/lib/zTree_v3/css/zTreeStyle/zTreeStyle.css" th:href="@{/pc/assets/lib/zTree_v3/css/zTreeStyle/zTreeStyle.css}">
    <link rel="stylesheet" href="/static/pc/assets/lib/webuploader/webuploader.css" th:href="@{/pc/assets/lib/webuploader/webuploader.css}">
    <link rel="stylesheet" href="/static/pc/assets/icomoon/style.css" th:href="@{/pc/assets/icomoon/style.css}">
    <link rel="stylesheet" href="/static/pc/assets/css/reset.css" th:href="@{/pc/assets/css/reset.css}">
    <link rel="stylesheet" href="/static/pc/assets/css/public.css" th:href="@{/pc/assets/css/public.css}">
    <link rel="stylesheet" href="/static/pc/assets/css/create.css" th:href="@{/pc/assets/css/create.css}">
    <link rel="stylesheet" href="/static/pc/assets/css/set.css" th:href="@{/pc/assets/css/set.css}">
    <style>
        body .create-class .layui-layer-btn0{
            width: 30px;
            height: 30px;
            border: 1px solid #82c3ff;
            border-radius: 15px;
            font-size: 13px;
            margin: 5px 10px 0 5px;
            color: #0084ff;
            background: #ffffff;
            line-height: 30px;
        }
        body .create-class .layui-layer-btn1{
            width: 30px !important;
            height: 30px !important;
            border: 1px solid #82c3ff !important;
            border-radius: 15px !important;
            font-size: 13px;
            margin: 5px 5px 0 10px;
            color: #ffffff;
            background: #0084ff;
            line-height: 30px;
        }
        .el-input--prefix .el-input__inner {
            padding-left: 30px!important;
        }
        .setForm .input-box .join-select {
            position: relative;
            min-height: 32px;
            margin-top: 8px;
            border: 1px solid #E9E9E9;
            border-radius: 2px;
            -webkit-box-sizing: border-box;
            -moz-box-sizing: border-box;
            box-sizing: border-box;
            padding-left: 10px;
            font-size: 14px;
            color: #cccccc;
            line-height: 32px;
        }

        .setForm .input-box .add-range {
            position: absolute;
            right: 6px;
            top: 6px;
            cursor: pointer;
        }

        .setForm .input-box .add-tags {
            padding-right: 26px;
            -webkit-box-sizing: border-box;
            -moz-box-sizing: border-box;
            box-sizing: border-box;
            font-size: 0;
            color: #333333;
            padding-top: 4px;
            line-height: 20px;
        }

        .setForm .input-box .add-tags span {
            display: inline-block;
            padding: 2px 6px;
            background: #F2F4F7;
            border-radius: 2px;
            line-height: 20px;
            margin-bottom: 4px;
            margin-right: 4px;
            font-size: 14px;
        }

        .setForm .input-box .add-tags span i {
            display: inline-block;
            vertical-align: middle;
            margin-left: 0;
            cursor: pointer;
            margin-bottom: 2px;
        }

        .setForm .form-item .item-tips {
            line-height: 20px;
            background: #F0F0F0;
            border-radius: 2px;
            color: #999999;
            font-size: 12px;
            padding: 0 4px;
            display: inline-block;
            border: none;
            margin: 6px 16px 0;
            font-weight: normal;
        }

        .setForm .form-item .select-form {
            margin-left: 122px;
        }

        .setForm .form-item .select-form .el-select {
            width: 120px;
        }


        [v-cloak]{
            display: none;
        }
    </style>
</head>
<body>
    <div id="signUpVue" v-cloak>
        <el-form class="setForm" style="padding: 0 24px" ref="form" onsubmit="return false;">
            <div v-for="(item, index) in signUpTemplateComponents">
                <div class="form-item">
                    <label class="label">{{item.name}}</label>
                    <div class="input-box">
                        <div class="set-box">
                            <el-switch v-model="signUpMap[item.id].enable" @change="signUpEnableChanged(item.id)"></el-switch>
                            <span class="tips">{{item.introduction}}</span>
                        </div>
                    </div>
                </div>
                <template v-if="signUpMap[item.id].enable" v-for="(it, idx) in item.children">
                    <div class="form-item" v-if="it.code == 'sign_up_time_scope'">
                        <label class="label cover"><img src="/static/pc/assets/images/required.png" th:src="@{/pc/assets/images/required.png}" class="required-img" v-if="it.required">{{it.name}}</label>
                        <div class="input-box">
                            <el-date-picker
                                    v-model="signUpMap[item.id] && signUpMap[item.id].startTime"
                                    type="datetime"
                                    format="yyyy-MM-dd HH:mm"
                                    value-format="timestamp"
                                    :clearable="false"
                                    :editable="false"
                                    :default-time="['00:00:00']"
                                    placeholder="开始时间">
                            </el-date-picker>
                            <span class="date-range-icon" style="line-height: 29px"><img src="/static/pc/assets/images/swap-right.png" th:src="@{/pc/assets/images/swap-right.png}"></span>
                            <el-date-picker
                                    v-model="signUpMap[item.id] && signUpMap[item.id].endTime"
                                    type="datetime"
                                    format="yyyy-MM-dd HH:mm"
                                    value-format="timestamp"
                                    :clearable="false"
                                    :editable="false"
                                    :default-time="['23:59:59']"
                                    placeholder="结束时间">
                            </el-date-picker>
                            <span class="tips" v-if="it.introduction">{{it.introduction}}</span>
                        </div>
                    </div>
                    <!--微服务参与范围-->
                    <div class="form-item flexStart" v-else-if="it.code == 'wfw_participation_scope'">
                        <label class="label"><img src="/static/pc/assets/images/required.png" th:src="@{/pc/assets/images/required.png}" class="required-img" v-if="it.required">{{it.name}}</label>
                        <div class="join-box">
                            <div :class="{'autoRange': (!signUpMap[item.id].enableWfwParticipateScope)}">
                                <el-radio-group v-model="signUpMap[item.id].wfwOrgScope" @change="wfwOrgScopeChange($event, item.id)" >
                                    <el-radio :label="scope.value" name="active-type" v-for="(scope,sidx) in scopeList" :key="'wfw-scope-' + sidx">{{scope.label}}</el-radio>
                                </el-radio-group>
                            </div>
                            <div class="join-select" v-show="signUpMap[item.id].enableWfwParticipateScope" style="margin-top: 12px;cursor: pointer;" @click="toAddSignUpParticipateScope(item.id, it)">
                                <img src="/static/pc/assets/images/add-circle.png" th:src="@{/pc/assets/images/add-circle.png}" class="add-range">
                                <span v-if="signUpMap[item.id].wfwParticipateScopes.length <= 0">请选择</span>
                                <div class="add-tags" v-else>
                                    <span v-for="(scope, scopeIndex) of signUpMap[item.id].wfwParticipateScopes">{{scope.externalName}}<i class="del_btn" @click="deleteSignUpParticipateScope(item.id, it, scopeIndex, $event)"></i></span>
                                </div>
                            </div>
                        </div>
                    </div>
                    <!--通讯录参与范围-->
                    <div class="form-item flexStart" v-else-if="it.code == 'contacts_participation_scope'">
                        <label class="label"><img src="/static/pc/assets/images/required.png" th:src="@{/pc/assets/images/required.png}" class="required-img" v-if="it.required">{{it.name}}</label>
                        <div class="join-box">
                            <div :class="{'autoRange': (!signUpMap[item.id].enableContactsParticipateScope)}">
                                <el-radio-group v-model="signUpMap[item.id].contactScope" @change="contactScopeChange($event, item.id)">
                                    <el-radio :label="scope.value" name="active-type" v-for="(scope,sidx) in scopeList" :key="'contacts-scope-' + sidx">{{scope.label}}</el-radio>
                                </el-radio-group>
                            </div>
                            <div class="join-select" v-show="signUpMap[item.id].enableContactsParticipateScope" style="cursor: pointer;" @click="toAddSignUpParticipateScope(item.id, it)">
                                <img src="/static/pc/assets/images/add-circle.png" th:src="@{/pc/assets/images/add-circle.png}" class="add-range">
                                <span v-if="signUpMap[item.id].contactsParticipateScopes.length <= 0">请选择</span>
                                <div class="add-tags" v-else>
                                    <span v-for="(scope, scopeIndex) of signUpMap[item.id].contactsParticipateScopes">{{scope.externalName}}<i class="del_btn" @click="deleteSignUpParticipateScope(item.id, it, scopeIndex, $event)"></i></span>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="form-item" v-else-if="it.code == 'sign_up_person_limit'">
                        <label class="label"><img src="/static/pc/assets/images/required.png" th:src="@{/pc/assets/images/required.png}" class="required-img" v-if="it.required">{{it.name}}</label>
                        <div class="input-box">
                            <div class="select-person-radio">
                                <el-radio v-model="signUpMap[item.id].limitPerson" :label="false" name="active-type">不限</el-radio>
                                <el-radio v-model="signUpMap[item.id].limitPerson" :label="true" name="active-type">自定义</el-radio>
                            </div>
                            <span class="tips" v-if="it.introduction">{{it.introduction}}</span>
                            <input v-show="signUpMap[item.id].limitPerson" v-model="signUpMap[item.id].personLimit" type="number" min="1" step="1" maxlength="10" placeholder="请输入正整数" class="person"><span class="person-span" v-show="signUpMap[item.id].limitPerson">人</span>
                        </div>
                    </div>
                    <!--报名填报信息-->
                    <div class="form-item sign-info" v-else-if="it.code == 'sign_up_fill_info'">
                        <label class="label">{{it.name}}</label>
                        <div class="input-box">
                            <div class="set-box">
                                <el-switch v-model="signUpMap[item.id].fillInfo" @change="formFillSwitchChange($event, it)"></el-switch>
                                <span class="tips" v-if="it.introduction">{{it.introduction}}</span>
                            </div>
                            <div class="radio-box" v-show="signUpMap[item.id].fillInfo && !signUpMap[item.id].fillInfoFormId">
                                <el-radio v-for="(wfwFormFillInfoType, index) of wfwFormFillInfoTypes" :key="'wfw-form-fill-info-type-' + index" v-model="signUpMap[item.id].formType" :label="wfwFormFillInfoType.value" name="active-type" @change="signUpFormTypeChange(item.id)">{{wfwFormFillInfoType.name}}</el-radio>
                                <!-- 万能表单 -->
                                <el-select v-if="signUpMap[item.id].formType == 'wfw_form' && showWfwFormSelect(item.id, it.signUpFillInfoType)"
                                           v-model="signUpMap[item.id].wfwFormTemplateId"
                                           placeholder="请选择"
                                           popper-class="fixed-select"
                                >
                                    <el-option
                                            v-for="opt in (it.signUpFillInfoType && it.signUpFillInfoType.templateOptions) || []"
                                            :key="opt.id"
                                            :label="opt.name"
                                            :value="opt.id"
                                            v-if="opt.type == 'normal'"
                                    >
                                    </el-option>
                                    <!--  注意这有俩个编辑，一个空的一个有数据的 -->
                                    <div class="setiing-absolute" @click="createFormFromNormal(item.id)"><i class="icon-plus-circle"></i>新建</div>
                                    <div slot="empty" class="no-content-self">
                                        <div class="no-con">暂无选项</div>
                                        <div class="setiing-absolute" @click=""><i class="icon-plus-circle"></i>编辑</div>
                                    </div>
                                </el-select>
                                <!-- 审批 -->
                                <el-select v-else-if="signUpMap[item.id].formType == 'approval' && showWfwFormSelect(item.id, it.signUpFillInfoType)"
                                           v-model="signUpMap[item.id].wfwFormTemplateId"
                                           placeholder="请选择"
                                           popper-class="fixed-select"
                                >
                                    <el-option
                                            v-for="opt in (it.signUpFillInfoType && it.signUpFillInfoType.templateOptions) || []"
                                            :key="opt.id"
                                            :label="opt.name"
                                            :value="opt.id"
                                            v-if="opt.type == 'approval'"
                                    ></el-option>
                                    <!--  注意这有俩个编辑，一个空的一个有数据的 -->
                                    <div class="setiing-absolute" @click="createFormFromNormal(item.id)"><i class="icon-plus-circle"></i>新建</div>
                                    <div slot="empty" class="no-content-self">
                                        <div class="no-con">暂无选项</div>
                                        <div class="setiing-absolute"><i class="icon-plus-circle"></i>编辑</div>
                                    </div>
                                </el-select>
                                <!--配置表单/审批-->
                                <a href="javascript:" class="set-box configurationForm" @click="fillInfoConfig(item.id)" v-show="signUpMap[item.id].wfwFormTemplateId || !showWfwFormSelect(item.id, it.signUpFillInfoType)">
                                    <img src="/static/pc/assets/images/setting.png" th:src="@{/pc/assets/images/setting.png}">
                                    <span class="tips set-information">配置{{signUpMap[item.id].formType == 'wfw_form' ? '表单' : '审批'}}</span>
                                </a>
                            </div>
                            <ul class="form-list" v-show="signUpMap[item.id].fillInfo && signUpMap[item.id].fillInfoFormId">
                                <li class="item">
                                    <div :class="{'left-box': true, 'type1': signUpMap[item.id].formType == 'approval'}"></div>
                                    <p class="title overHidden2">{{signUpMap[item.id].wfwFormName ? signUpMap[item.id].wfwFormName : '表单' }}</p>
                                    <a href="javascript:" v-show="signUpMap[item.id].formType != 'form' || signUpMap[item.id].fillInfoFormId > 60000" class="edit-btn" @click="fillInfoConfig(item.id)"></a>
                                    <a href="javascript:" v-show="signUpMap[item.id].formType != 'form' || signUpMap[item.id].fillInfoFormId > 60000" class="del-btn" @click="openWfwFormSwitchDialog(item.id)"></a>
                                </li>
                            </ul>
                        </div>
                    </div>
                    <div class="form-item" v-else-if="it.code == 'sign_up_public_list'">
                        <label class="label"><img src="/static/pc/assets/images/required.png" th:src="@{/pc/assets/images/required.png}" class="required-img" v-if="it.required">{{it.name}}</label>
                        <div class="input-box">
                            <div class="set-box">
                                <el-switch v-model="signUpMap[item.id].publicList"></el-switch>
                                <span class="tips" v-if="it.introduction">{{it.introduction}}</span>
                            </div>
                        </div>
                    </div>
                    <!--取消报名设置-->
                    <template v-else-if="it.code == 'sign_up_cancel_signed_up' && signUpMap[item.id].formType != 'approval'">
                        <div class="form-item">
                            <label class="label"><img src="/static/pc/assets/images/required.png" th:src="@{/pc/assets/images/required.png}" class="required-img" v-if="it.required">{{it.name}}</label>
                            <div class="input-box">
                                <div class="set-box">
                                    <el-switch v-model="signUpMap[item.id].endNotAllowCancel" @change="endNotAllowCancelChange(item.id)"></el-switch>
                                    <span class="tips" v-if="it.introduction">{{it.introduction}}</span>
                                </div>
                            </div>
                        </div>
                        <div class="form-item" v-show="signUpMap[item.id].endNotAllowCancel">
                            <label class="label"></label>
                            <div class="input-box" >
                                <div class="set-box">
                                    <el-radio-group v-model="signUpMap[item.id].notAllowCancelType">
                                        <el-radio v-for="(type, i) of notAllowCancelTypes" :key="'not-allow-cancel-type' + i" :label="type.value" @change="notAllowCancelTypeChange(item.id)">{{type.label}}</el-radio>
                                    </el-radio-group>
                                    <template v-if="signUpMap[item.id].notAllowCancelType == 'custom'">
                                        <el-date-picker
                                                style="margin-left: 10px"
                                                v-model="signUpMap[item.id].notAllowCancelTime"
                                                type="datetime"
                                                format="yyyy-MM-dd HH:mm"
                                                value-format="timestamp"
                                                :clearable="false"
                                                :editable="false"
                                                :default-time="['00:00:00']"
                                                placeholder="不可取消报名时间">
                                        </el-date-picker>&nbsp;&nbsp;后
                                    </template>
                                </div>
                            </div>
                        </div>
                    </template>
                    <div class="form-item" v-else-if="it.code == 'on_site_sign_up'">
                        <label class="label"><img src="/static/pc/assets/images/required.png" th:src="@{/pc/assets/images/required.png}" class="required-img" v-if="it.required">{{it.name}}</label>
                        <div class="input-box">
                            <div class="set-box">
                                <el-switch v-model="signUpMap[item.id].onSiteSignUp"></el-switch>
                                <span class="tips" v-if="it.introduction">{{it.introduction}}</span>
                            </div>
                        </div>
                    </div>
                    <div class="form-item align-start" v-else-if="it.code == 'sign_up_condition'">
                        <label class="label" style="line-height: 20px;">{{it.name}}</label>
                        <div class="input-box column">
                            <div class="set-box">
                                <el-switch v-model="signUpConditionMap[it.id].enable"></el-switch>
                                <el-tooltip style="position: relative; bottom: 3px" class="item-tips fl" effect="dark" disabled :content="signUpConditionTips(it.name, it.id)" placement="top">
                                    <el-button>报名条件</el-button>
                                </el-tooltip>
                                <span class="tips" v-if="it.introduction">{{it.introduction}}</span>
                            </div>
                            <div v-if="signUpConditionMap[it.id].enable && signUpConditionMap[it.id].allowSignedUp && signUpConditionMap[it.id].configOnActivity" class="set-box configurationForm" @click="toConfigSignUpDetails(it.id)">
                                <img src="/static/pc/assets/images/setting.png" th:src="@{/pc/assets/images/setting.png}">
                                <span class="tips set-information">配置明细</span>
                            </div>
                        </div>
                    </div>
                </template>
                <el-divider v-if="index !== signUpTemplateComponents.length - 1"></el-divider>
            </div>
            <div class="btn-box-margin">
                <button class="btn-main btn-width-80" @click="submitForm">保存</button>
            </div>
        </el-form>

        <!-- 报名参与范围弹窗 -->
        <vue-custom-participate-scope :dom-scope-id="'sign-up-participate-scope-tree'" ref="signUpParticipateScopeWindow" @sure-callback="sureSignUpParticipateScope"></vue-custom-participate-scope>
        <!--报名条件配置-->
        <vue-sign-up-condition ref="signUpConfigDialogWindow" @callback="confirmSignUpConditionDetails"></vue-sign-up-condition>
        <!--  切换填报形式提示弹窗 -->
        <div class="dailog-box1" v-show="showSwitchFormDialog">
            <div class="dailog delete-dailog width304">
                <div class="warn"><img src="/static/pc/assets/images/warning.png" th:src="@{/pc/assets/images/warning.png}" alt=""></div>
                <span>切换报名填报形式可能会导致报名数据误差</span>
                <div>
                    <div class="normal-btn" @click="cancelSwitchForm">取消</div>
                    <div class="normal-btn after-sure" @click="confirmSwitchForm">继续切换</div>
                </div>
            </div>
        </div>
        <!-- 警告类弹框 -->
        <el-dialog
                :visible.sync="DialogVisible"
                :show-close=false
                :center=true
                width="304px"
                class="warnDialog">
            <div class="warn"><img src="/static/pc/assets/images/warning.png" th:src="@{/pc/assets/images/warning.png}" alt=""></div>
            <p class="center-txt">还有编辑内容未保存，确定离开吗？</p>
            <span slot="footer" class="dialog-footer center-footer">
            <el-button class="btn-second-normal btn-width-80" @click="DialogVisible = false">继续编辑</el-button>
            <el-button class="btn-main"  @click="DialogVisible = false">离开</el-button>
          </span>
        </el-dialog>
    </div>
    <div th:replace="pc/include/common_js :: common_js(~{::script})">
        <script src="/static/pc/assets/lib/layui/layui.js" th:src="@{/pc/assets/lib/layui/layui.js}"></script>
        <script src="/static/pc/assets/lib/element-ui/lib/index.js" th:src="@{/pc/assets/lib/element-ui/lib/index.js}"></script>
        <script src="/static/pc/assets/lib/jquery.nicescroll.min.js" th:src="@{/pc/assets/lib/jquery.nicescroll.min.js}"></script>
        <script src="/static/pc/assets/lib/jqthumb.js" th:src="@{/pc/assets/lib/jqthumb.js}"></script>
        <script src="/static/pc/assets/js/common.js" th:src="@{/pc/assets/js/common.js}"></script>
        <script src="/static/pc/assets/component/vue-custom-participate-scope.js" th:src="@{/pc/assets/component/vue-custom-participate-scope.js}"></script>
        <script src="/static/pc/assets/component/sign-up-condition.js" th:src="@{/pc/assets/component/sign-up-condition.js}"></script>
        <script src="/static/pc/assets/js/create-active.js" th:src="@{/pc/assets/js/create-active.js}"></script>
        <script src="/static/pc/assets/js/main.js" th:src="@{/pc/assets/js/main.js}"></script>
        <script src="/static/pc/assets/lib/zTree_v3/js/jquery.ztree.core.js" th:src="@{/pc/assets/lib/zTree_v3/js/jquery.ztree.core.js}"></script>
        <script src="/static/pc/assets/lib/zTree_v3/js/jquery.ztree.excheck.js" th:src="@{/pc/assets/lib/zTree_v3/js/jquery.ztree.excheck.js}"></script>
        <script src="/static/pc/assets/lib/zTree_v3/js/jquery.ztree.exedit.js" th:src="@{/pc/assets/lib/zTree_v3/js/jquery.ztree.exedit.js}"></script>
        <script type="text/javascript" src="/static/pc/assets/lib/webuploader/webuploader.min.js" th:src="@{/pc/assets/lib/webuploader/webuploader.min.js}"></script>
        <script th:inline="javascript">
            vm = new Vue({
                el: '#signUpVue',
                data: {
                    mainDomain: [[${mainDomain}]],
                    wfwFormDomain: [[${wfwFormDomain}]],
                    signWebDomain: [[${signWebDomain}]],
                    activity: [[${activity}]],
                    sign: [[${sign}]],
                    signUpTemplateComponents: [[${signUpTemplateComponents}]],
                    templateComponentMap: {},
                    defaultSignUpBtnName: [[${marketSignUpConfig != null ? marketSignUpConfig.signUpBtnName : ""}]],
                    defaultSignUpKeyword: [[${marketSignUpConfig != null ? marketSignUpConfig.signUpKeyword : ""}]],
                    fid: [[${session._login_user_.fid}]],
                    // 报名: { originId: signUp }
                    signUpMap: {},
                    // 报名信息填写类型: { templateComponentId: signUpFillInfoType }
                    fillInfoTypeMap: {},
                    formStructureMap: {},   // 报名条件的表单结构map
                    // 报名条件
                    signUpConditionMap: {},
                    sucTplComponentIds: [[${sucTplComponentIds}]],
                    signUpConditions: [[${signUpConditions}]],
                    conditionEnums: [[${conditionEnums}]],
                    notAllowCancelTypes: [
                        {value: 'after_sign_up_end', label: '报名结束后'},
                        {value: 'after_activity_start', label: '活动开始后'},
                        {value: 'custom', label: '自定义'}
                    ],
                    scopeList: [
                        {value: 'no_limit', label: '不限'},
                        {value: 'only_self_unit', label: '仅本单位'},
                        {value: 'custom', label: '自定义'}
                    ],
                    // 万能表单填报信息类型
                    wfwFormFillInfoTypes: [
                        {name: "填写表单", value: "wfw_form"},
                        {name: "填写表单并审批", value: "approval"}
                    ],
                    // 报名参与范围
                    signUpParticipateWindowShow: false,
                    wfwGroups: [[${wfwGroups}]],
                    contactGroups: [[${contactGroups}]],
                    currWfwGroups: [],
                    signUpParticipateScopeTreeObj: null,
                    // 当前操作的对象
                    operateSignUpOriginId: -1,
                    // 当前选择的参与范围类型
                    currGroupType: '',
                    DialogVisible: false,
                    wfwFormConfigWindow: null,
                    // 给报名填报信息默认创建的万能表单
                    signUpFillInfoDefaultWfwFormMap: {},
                    // 切换表单填报弹框
                    showSwitchFormDialog: false,
                    // 临时存储原始formId数据
                    tempStoreOriginFormId: null
                },
                created: function () {
                    var $this = this;
                    // 解决跨域
                    document.domain = $this.mainDomain;
                    window.addEventListener("message", function (e) {
                        if (e.origin.indexOf($this.wfwFormDomain.replace(/http(|s):\/\//, "")) > -1) {
                            var { data } = activityApp.getJsonObject(e.data);
                            var originId = $this.operateSignUpOriginId;
                            $this.$set($this.signUpMap[originId], "openAddr", data.openAddr);
                            $this.$set($this.signUpMap[originId], "pcUrl", data.pcUrl);
                            $this.$set($this.signUpMap[originId], "wechatUrl", data.wechatUrl);
                            $this.$set($this.signUpMap[originId], "wfwFormName", data.name);
                            $this.$set($this.signUpMap[originId], "fillInfoFormId", data.formId);
                            $this.wfwFormConfigWindow.close();
                        } else {
                            try {
                                var data = activityApp.getJsonObject(e.data);
                                if ("sign_in_list" == data.type) {
                                    var signId = data.value;
                                    if (!$this.sign.id) {
                                        $this.$set($this.sign, "id", signId);
                                    }
                                    $this.countSignInNum();
                                    $this.showSignInListIframe = false;
                                    $this.$nextTick(function () {
                                        $(document).scrollTop($this.scrollHeight);
                                    });
                                }
                            } catch (e) {
                            }
                        }
                    });
                    // 表单字段map封装
                    var formFields = [[${formFieldStructures}]] || {};
                    var formIds = Object.keys(formFields);
                    $this.formStructureMap = {}
                    $(formIds).each(function (i) {
                        var formId = formIds[i];
                        if (formFields[formId]) {
                            var fieldNameCompObj = {};
                            $(formFields[formId]).each(function () {
                                fieldNameCompObj[this.name] = this;
                            });
                            $this.formStructureMap[formId] = fieldNameCompObj;
                        }
                    });
                    // 报名条件map封装
                    var sucTplComponentIds = $this.sucTplComponentIds || [];
                    $($this.signUpConditions).each(function () {
                        var _this = this;
                        $this.$set(_this, "enable", sucTplComponentIds.includes(_this.templateComponentId));
                        if (_this.activityConditionDetails) {
                            $(_this.activityConditionDetails).each(function () {
                                var fieldObj = $this.formStructureMap[_this.originIdentify];
                                $this.$set(this, "compt", fieldObj[this.fieldName].compt);
                                $this.$set(this, "options", fieldObj[this.fieldName].options || []);
                            })
                        }
                        $this.$set($this.signUpConditionMap, this.templateComponentId, _this);
                    });
                    $($this.signUpTemplateComponents).each(function() {
                        var _this = this;
                        $this.templateComponentMap[_this.id] = _this;

                        if (_this.children && _this.children.length > 0) {
                            $(_this.children).each(function () {
                                if (this.code == 'sign_up_fill_info' && this.signUpFillInfoType) {
                                    // 一个报名目前只有一个报名信息填写，故map的映射为 { signUpTplComponentId : signUpFillInfoType }
                                    $this.fillInfoTypeMap[_this.id] = this.signUpFillInfoType
                                }
                                $this.templateComponentMap[this.id] = this;
                            });
                        }
                    });

                    // 报名
                    $($this.sign.signUps).each(function (i) {
                        // 处理报名按钮名称和按钮关键字
                        this.btnName = $this.defaultSignUpBtnName ? $this.defaultSignUpBtnName : this.btnName;
                        this.keyword = $this.defaultSignUpKeyword ? $this.defaultSignUpKeyword : this.keyword;
                        if (!activityApp.isEmpty(this.id)) {
                            if (this.wfwParticipateScopes) {
                                $(this.wfwParticipateScopes).each(function () {
                                    if (this.leaf && $this.virtualNodeMap[this.externalId]) {
                                        this.virtualId = $this.virtualNodeMap[this.externalId].virtualId;
                                    } else {
                                        this.virtualId = this.externalId;
                                    }
                                });
                            }
                            if (this.contactsParticipateScopes) {
                                $(this.contactsParticipateScopes).each(function () {
                                    if (this.leaf && $this.virtualNodeMap[this.externalId]) {
                                        this.virtualId = $this.virtualNodeMap[this.externalId].virtualId;
                                    } else {
                                        this.virtualId = this.externalId;
                                    }
                                });
                            }
                        }
                        $this.$set($this.sign.signUps[i], "endNotAllowCancel", !this.endAllowCancel);
                        $this.initSignUpScope(i, this);
                        if (!this.endAllowCancel && !this.notAllowCancelType) {
                            $this.$set($this.sign.signUps[i], "notAllowCancelType", $this.notAllowCancelTypes[0].value);
                        }
                        $this.$set($this.sign.signUps[i], "enable", !this.deleted);

                        if (!activityApp.isEmpty($this.sign.signUps[i].startTime)) {
                            // 若报名签到非不限制
                            $this.$set($this.sign.signUps[i], "timeScope", [this.startTime, this.endTime]);
                        }
                        var tplComponentId = $this.sign.signUps[i].originId;
                        $this.$set($this.signUpMap, tplComponentId, $this.sign.signUps[i]);
                    });

                    $($this.signUpTemplateComponents).each(function (i) {
                        var originId = this.id;
                        if (!$this.signUpMap[originId]) {
                            // 新的报名
                            var signUp = signApp.newSignUp($this.templateComponentMap[originId]);
                            if (this.code == 'company_sign_up') {
                                signUp.fillInfo = true;
                                signUp.customSignUpType = "company";
                            }
                            var signUpChildrenComponents = this.children;
                            if (!activityApp.isEmpty(signUpChildrenComponents)) {
                                $(signUpChildrenComponents).each(function () {
                                    if ("sign_up_fill_info" == this.code) {
                                        var signUpFillInfoType = this.signUpFillInfoType;
                                        if (!activityApp.isEmpty(signUpFillInfoType)) {
                                            signUp.formType = signUpFillInfoType.type;
                                        }
                                    }
                                });
                            }
                            signUp.originId = originId;
                            signUp.deleted = true;
                            signUp.enable = !signUp.deleted;
                            $this.$set(signUp, "timeScope", [signUp.startTime, signUp.endTime]);
                            $this.$set($this.signUpMap, originId, signUp);
                        }
                    });
                },
                computed: {
                    // 虚拟节点map，即非叶子节点复制本身作为其叶子节点，该叶子节点即为虚拟节点
                    virtualNodeMap: function () {
                        var $this = this;
                        var nodeMap = {};
                        $($this.currWfwGroups).each(function () {
                            if (this.id !== this.virtualId) {
                                nodeMap[this.id] = this;
                            }
                        });
                        return nodeMap;
                    }
                },
                methods: {
                    // 创建报名万能表单
                    createSignUpWfwForm: function (signUpTplComponentId, newFormFromNormal) {
                        var $this =this;
                        var signUp = $this.signUpMap[signUpTplComponentId];
                        if (signUp.formType == 'wfw_form' || signUp.formType == 'approval') {
                            // 克隆新的表单
                            var url = ctx + "/api/wfw-form/create/from/wfw-form-template";
                            var params = {
                                fid: $this.fid,
                                uid: [[${session._login_user_.uid}]],
                                wfwFormTemplateId: signUp.wfwFormTemplateId,
                                signUpFormType: signUp.formType
                            };
                            app.ajaxPost(url, params, function (res) {
                                if (res.success) {
                                    var { formId, openAddr, pcUrl, wechatUrl, name } = res.data;
                                    $this.signUpFillInfoDefaultWfwFormMap[signUpTplComponentId] = {
                                        "openAddr": openAddr,
                                        "pcUrl": pcUrl,
                                        "wechatUrl": wechatUrl,
                                        "fillInfoFormId": formId,
                                        "wfwFormName": name
                                    };
                                    $this.setSignUpFormInfo(signUpTplComponentId);
                                    $this.toWfwFormConfig(signUpTplComponentId)
                                } else {
                                    var errorMessage = res.message;
                                    if (activityApp.isEmpty(errorMessage)) {
                                        errorMessage = "报名信息填写，创建填写表单失败";
                                    }
                                    app.showMsg(errorMessage);
                                }
                            }, function () {
                                app.showMsg("报名信息填写，创建填写表单失败");
                            });
                        }
                    },
                    setSignUpFormInfo: function (tplComponentId) {
                        var $this = this;
                        var form = $this.signUpFillInfoDefaultWfwFormMap[tplComponentId];
                        $this.$set($this.signUpMap[tplComponentId], "openAddr", form.openAddr);
                        $this.$set($this.signUpMap[tplComponentId], "pcUrl", form.pcUrl);
                        $this.$set($this.signUpMap[tplComponentId], "wechatUrl", form.wechatUrl);
                        $this.$set($this.signUpMap[tplComponentId], "wfwFormName", form.wfwFormName);
                        $this.$set($this.signUpMap[tplComponentId], "fillInfoFormId", form.fillInfoFormId);
                    },
                    initSignUpScope: function(i, signUp) {
                        var $this = this;
                        if (signUp.enableContactsParticipateScope) {
                            $this.$set($this.sign.signUps[i], "contactScope", "custom");
                        } else if (signUp.contactOnlySelfUnit) {
                            $this.$set($this.sign.signUps[i], "contactScope", "only_self_unit");
                        } else {
                            $this.$set($this.sign.signUps[i], "contactScope", "no_limit");
                        }
                        if (signUp.enableWfwParticipateScope) {
                            $this.$set($this.sign.signUps[i], "wfwOrgScope", "custom");
                        } else if (signUp.wfwOnlySelfUnit) {
                            $this.$set($this.sign.signUps[i], "wfwOrgScope", "only_self_unit");
                        } else {
                            $this.$set($this.sign.signUps[i], "wfwOrgScope", "no_limit");
                        }
                    },
                    signUpConditionTips: function (name, tplComponentId) {
                        var $this = this;
                        var signUpCondition = $this.signUpConditionMap[tplComponentId];
                        if (!signUpCondition.activityConditionDetails || signUpCondition.activityConditionDetails.length == 0) {
                            return '';
                        }
                        var conditionFields = [];
                        $(signUpCondition.activityConditionDetails).each(function () {
                            conditionFields.push(this.fieldName);
                        })
                        return '在' + name + '中，匹配' + conditionFields.join(',') + '的条件可进行报名';
                    },
                    initWfwGroups: function () {
                        var $this = this;
                        var nodeSoncountMap = {}
                        $($this.currWfwGroups).each(function () {
                            var _this = this;
                            _this.chkDisabled = false;
                            var actualSoncount = 0;
                            $($this.currWfwGroups).each(function () {
                                if (_this.id !== this.id && _this.id === this.gid) {
                                    actualSoncount++;
                                }
                            });
                            nodeSoncountMap[_this.id] = actualSoncount;
                        });

                        $($this.currWfwGroups).each(function () {
                            // 若一个非叶子节点无自身的虚拟叶子节点，则该节点不可选中
                            var nonLeaf = this.soncount && this.soncount !== 0;
                            if ((nonLeaf && !$this.virtualNodeMap[this.id]) || (this.id === this.virtualId && this.soncount !== nodeSoncountMap[this.id])) {
                                this.chkDisabled = true;
                            }
                        });
                    },
                    endNotAllowCancelChange: function (signUpTplComponentId) {
                        var $this = this;
                        if ($this.signUpMap[signUpTplComponentId].endNotAllowCancel && !$this.signUpMap[signUpTplComponentId].notAllowCancelType) {
                            $this.$set($this.signUpMap[signUpTplComponentId], "notAllowCancelType", $this.notAllowCancelTypes[0].value);
                            $this.$set($this.signUpMap[signUpTplComponentId], "notAllowCancelTime", null);
                        }
                    },
                    notAllowCancelTypeChange: function (signUpTplComponentId) {
                        var $this = this;
                        var value = $this.signUpMap[signUpTplComponentId].notAllowCancelType;
                        if (value == "custom" && !$this.signUpMap[signUpTplComponentId].notAllowCancelTime) {
                            $this.$set($this.signUpMap[signUpTplComponentId], "notAllowCancelTime", $this.activity.startTimeStamp);
                        }
                    },
                    signUpEnableChanged: function (tplComponentId) {
                        var $this = this;
                        $this.$set($this.signUpMap[tplComponentId], "deleted", !$this.signUpMap[tplComponentId].enable);
                    },
                    packageSignUpConditionEnable: function () {
                        var $this = this;
                        var keys = Object.keys($this.signUpConditionMap);
                        var sucTemplateComponentIds = [];
                        var signUpConditions = [];
                        if (keys.length == 0) {
                            return {
                                signUpConditionStr: '',
                                sucTemplateComponentIdStr: ''
                            };
                        }
                        for (var i = 0; i < keys.length; i++) {
                            var tplComponentId = keys[i];
                            var item = $this.signUpConditionMap[tplComponentId];
                            if (item.enable) {
                                sucTemplateComponentIds.push(tplComponentId);
                                if (item.allowSignedUp && item.configOnActivity) {
                                    $(item.activityConditionDetails).each(function () {
                                        // 条件是不限、为空、不为空, 清空value
                                        if (!this.condition || this.condition == 'empty' || this.condition == 'un_empty') {
                                            this.value = "";
                                        }
                                    });
                                    signUpConditions.push(item);
                                }
                            }
                        }
                        return {
                            signUpConditionStr: activityApp.getJsonStr(signUpConditions),
                            sucTemplateComponentIdStr:activityApp.getJsonStr(sucTemplateComponentIds)
                        }
                    },
                    packageSubmitSign: function () {
                        var $this = this;
                        var waitSubmitSignUps = [];
                        var signUpMap = $.extend({}, $this.signUpMap);
                        $.each(signUpMap, function (key, item) {
                            // 新增，且未开启报名，则不提交
                            if ((!item.id && !item.deleted) || item.id) {
                                item.endAllowCancel = !item.endNotAllowCancel;
                                waitSubmitSignUps.push(item);
                            }
                        });
                        return $.extend({}, $this.sign, { signUps: waitSubmitSignUps });
                    },
                    // 选中报名的时间范围
                    selectSignUpTime: function (tplComponentId, obj) {
                        var $this = this;
                        $this.$set($this.signUpMap[tplComponentId], "startTime", obj[0]);
                        $this.$set($this.signUpMap[tplComponentId], "endTime", obj[1]);
                    },
                    toAddSignUpParticipateScope: function(signUpTplComponentId, templateComponent){
                        var $this = this;
                        $this.operateSignUpOriginId = signUpTplComponentId;
                        $this.currGroupType = templateComponent.code == 'wfw_participation_scope' ? 'wfw' : 'contacts';
                        var groups = templateComponent.code == 'wfw_participation_scope' ? $this.wfwGroups : $this.contactGroups;
                        var signUp = $this.signUpMap[$this.operateSignUpOriginId];
                        var scopes = (signUp && ($this.currGroupType == 'wfw' ? signUp.wfwParticipateScopes : signUp.contactsParticipateScopes)) || [];
                        $this.$refs.signUpParticipateScopeWindow.showWindow(groups, scopes, $this.currGroupType);
                    },
                    // 确认选择报名参与范围
                    sureSignUpParticipateScope: function (scopes) {
                        var $this = this;
                        if ($this.currGroupType == 'contacts') {
                            $this.$set($this.signUpMap[$this.operateSignUpOriginId], "contactsParticipateScopes", scopes);
                        } else {
                            $this.$set($this.signUpMap[$this.operateSignUpOriginId], "wfwParticipateScopes", scopes);
                        }
                    },
                    deleteSignUpParticipateScope: function (signUpTplComponentId, templateComponent, scopeIndex, e) {
                        e.stopPropagation();
                        var $this = this;
                        if (templateComponent.code == 'wfw_participation_scope') {
                            $this.signUpMap[signUpTplComponentId].wfwParticipateScopes.splice(scopeIndex, 1);
                        } else {
                            $this.signUpMap[signUpTplComponentId].contactsParticipateScopes.splice(scopeIndex, 1);
                        }
                    },
                    validateForm: function () {
                        var $this = this;
                        // 报名验证
                        var signUpKeys = Object.keys($this.signUpMap);
                        for (var i = 0; i < signUpKeys.length; i++) {
                            var originId = signUpKeys[i];
                            var signUp = $this.signUpMap[originId];
                            var deleted = signUp.deleted;
                            var templateOptions = $this.fillInfoTypeMap[originId] && $this.fillInfoTypeMap[originId].templateOptions;
                            if (!deleted) {
                                if (activityApp.isEmpty(signUp.startTime)) {
                                    app.showMsg(signUp.name + "开始时间不能为空");
                                    return false;
                                }
                                if (activityApp.isEmpty(signUp.endTime)) {
                                    app.showMsg(signUp + "结束时间不能为空");
                                    return false;
                                }
                                if (signUp.startTime >= signUp.endTime) {
                                    app.showMsg(signUp + "开始时间必须小于结束时间");
                                    return false;
                                }
                                // 参与范围
                                var signUpTplComponent = $this.templateComponentMap[originId];
                                if (!signUpTplComponent) {
                                    continue;
                                }
                                for (var j = 0; j < signUpTplComponent.children.length; j++) {
                                    var child = signUpTplComponent.children[j];
                                    if (child.code == 'wfw_participation_scope') {
                                        if (signUp.enableWfwParticipateScope) {
                                            var participateScopes = signUp.wfwParticipateScopes;
                                            if (participateScopes.length < 1) {
                                                app.showMsg("请选择"+ signUp.name +"参与范围");
                                                return false;
                                            }
                                        }
                                    } else if (child.code == 'contacts_participation_scope') {
                                        if (signUp.enableContactsParticipateScope) {
                                            var participateScopes = signUp.contactsParticipateScopes;
                                            if (participateScopes.length < 1) {
                                                app.showMsg("请选择"+ signUp.name +"参与范围");
                                                return false;
                                            }
                                        }
                                    }

                                }
                                if (signUp.limitPerson) {
                                    // 启用人数限制
                                    if (signUp.personLimit < 1) {
                                        app.showMsg(signUp.name + "请输入正确的"+ signUp.name +"限制人数");
                                        return false;
                                    }
                                }
                                if (signUp.endNotAllowCancel) {
                                    if (activityApp.isEmpty(signUp.notAllowCancelType)) {
                                        app.showMsg("请选择"+ signUp.name +"不允许取消报名类型");
                                        return false;
                                    }
                                    if (signUp.notAllowCancelType == 'custom' && activityApp.isEmpty(signUp.notAllowCancelTime)) {
                                        app.showMsg("请选择"+ signUp.name +"不允许取消报名时间");
                                        return false;
                                    }
                                }
                                if (signUp.fillInfo) {
                                    var approvalNum = 0, wfwFormNum = 0;
                                    $(templateOptions).each(function () {
                                        if (this.type == 'normal') {
                                            wfwFormNum++;
                                        } else if (this.type == 'approval') {
                                            approvalNum++;
                                        }
                                    });
                                    if (activityApp.isEmpty(signUp.wfwFormTemplateId)) {
                                        if (signUp.formType == 'wfw_form' && wfwFormNum > 0) {
                                            app.showMsg("请选择" + signUp.name + "填报信息模板");
                                            return false;
                                        } else if (signUp.formType == 'approval' && approvalNum > 0) {
                                            app.showMsg("请选择" + signUp.name + "填报信息模板");
                                            return false;
                                        }
                                    }
                                }

                                if (activityApp.isEmpty(signUp.btnName)) {
                                    app.showMsg(signUp.name + "按钮名称不能为空");
                                    return false;
                                }
                            }
                        }
                        return true;
                    },
                    submitForm: function () {
                        var $this = this;
                        if (!$this.validateForm()) {
                            return;
                        }
                        var url = ctx + "/api/activity/setting/sign-up";
                        var sign = $this.packageSubmitSign();
                        var signUpConditionObj = $this.packageSignUpConditionEnable();
                        var params = {
                            activityId: $this.activity.id,
                            sucTemplateComponentIdStr: signUpConditionObj.sucTemplateComponentIdStr,
                            signUpConditionStr: signUpConditionObj.signUpConditionStr,
                            signJsonStr: activityApp.getJsonStr(sign)
                        };
                        app.ajaxPostWithLoading(url, params, function (data) {
                            if (data.success) {
                                app.showMsg("已保存", function () {
                                    window.location.reload();
                                });
                            } else {
                                var errorMessage = data.message;
                                if (activityApp.isEmpty(errorMessage)) {
                                    errorMessage = "保存失败";
                                }
                                app.showMsg(errorMessage);
                            }
                        }, function () {
                            app.showMsg("保存失败");
                        });
                    },
                    // 填报信息的开关改变
                    formFillSwitchChange: function (checked, component, signUpTplComponentId) {
                        // 企业报名必须开启
                        var $this = this;
                        var parentComponent = $this.templateComponentMap[component.pid];
                        if (!checked) {
                            if ("company_sign_up" == parentComponent.code) {
                                app.showMsg(parentComponent.name + "必须开启" + component.name);
                                $this.$set($this.signUpMap[component.pid], "fillInfo", true);
                            } else if ($this.signUpMap[signUpTplComponentId].formType == "approval") {
                                app.showMsg("审批必须开启" + component.name);
                                $this.$set($this.signUpMap[component.pid], "fillInfo", true);
                            }
                        }
                    },
                    wfwOrgScopeChange: function(value, tplComponentId) {
                        var $this = this;
                        $this.signUpMap[tplComponentId].wfwOnlySelfUnit = false;
                        $this.signUpMap[tplComponentId].enableWfwParticipateScope = false;
                        if (value == 'custom') {
                            $this.signUpMap[tplComponentId].enableWfwParticipateScope = true;
                        } else if (value == 'only_self_unit') {
                            $this.signUpMap[tplComponentId].wfwOnlySelfUnit = true;
                        }
                    },
                    contactScopeChange: function (value, tplComponentId) {
                        var $this = this;
                        $this.signUpMap[tplComponentId].contactOnlySelfUnit = false;
                        $this.signUpMap[tplComponentId].enableContactsParticipateScope = false;
                        if (value == 'custom') {
                            $this.signUpMap[tplComponentId].enableContactsParticipateScope = true;
                        } else if (value == 'only_self_unit') {
                            $this.signUpMap[tplComponentId].contactOnlySelfUnit = true;
                        }
                    },
                    createFormFromNormal: function (signUpTplComponentId) {
                        var $this = this;
                        $this.fillInfoConfig(signUpTplComponentId, true);
                    },
                    // 配置报名填报信息
                    fillInfoConfig: function (signUpTplComponentId, newFormFromNormal) {
                        var $this = this;
                        $this.operateSignUpOriginId = signUpTplComponentId;
                        var signUp = $this.signUpMap[signUpTplComponentId];
                        var formId = signUp.fillInfoFormId || '';
                        if (activityApp.isEmpty(formId)) {
                            $this.createSignUpWfwForm(signUpTplComponentId, newFormFromNormal);
                            return;
                        }
                        var formType = signUp.formType;
                        if ("wfw_form" == formType || "approval" == formType) {
                            // 配置万能表单
                            $this.toWfwFormConfig(signUpTplComponentId);
                        }
                    },
                    // 万能表单
                    toWfwFormConfig: function (signUpTplComponentId) {
                        var $this = this;
                        if ($this.wfwFormConfigWindow && !$this.wfwFormConfigWindow.closed) {
                            app.showMsg("请先关闭上一个填报信息配置页面");
                            return;
                        }
                        $this.operateSignUpOriginId = signUpTplComponentId;
                        var signUp = $this.signUpMap[signUpTplComponentId];
                        var url = ctx + "/api/wfw-form/build/edit-url";
                        var formId = signUp.fillInfoFormId || '';
                        if (activityApp.isEmpty(formId)) {
                            $this.setSignUpFormInfo(signUpTplComponentId);
                            formId = $this.signUpMap[signUpTplComponentId].fillInfoFormId;
                        }
                        var params = {
                            fid: $this.fid,
                            uid: [[${session._login_user_.uid}]],
                            formId: formId,
                            signUpFormType: signUp.formType
                        }
                        app.ajaxPost(url, params, function (res) {
                            if (res.success) {
                                $this.wfwFormConfigWindow = window.open(res.data);
                            } else {
                                var errorMessage = res.message;
                                if (activityApp.isEmpty(errorMessage)) {
                                    errorMessage = "获取表单配置地址失败";
                                }
                                app.showMsg(errorMessage);
                            }
                        }, function () {
                            app.showMsg("获取表单配置地址失败");
                        });
                    },
                    closeFormConfigLayer: function (formId) {
                        var $this = this;
                        app.closeLayerPop($this.formConfigLayerIndex);
                        $this.$set($this.signUpMap[$this.operateSignUpOriginId], "fillInfoFormId", formId);
                    },
                    // 表单
                    toConfigForm: function (tplComponentId) {
                        var $this = this;
                        $this.operateSignUpOriginId = tplComponentId;
                        var signUp = $this.signUpMap[tplComponentId];
                        var formId = "";
                        if (!activityApp.isEmpty(signUp.fillInfoFormId)) {
                            formId = signUp.fillInfoFormId;
                        }
                        var url = "//" + $this.signWebDomain.replace(/http(|s):\/\//, "") + "/form/config?formId=" + formId;
                        $('body').addClass('scroll');
                        $this.formConfigLayerIndex = layer.open({
                            title: "表单配置",
                            skin: "create-class",
                            type: 2,
                            content: [url, "no"],
                            area: ["600px", "580px"],
                            btn: ["取消", "完成"],
                            btnAlign: "c",
                            yes: function (index) {
                                var signUp = $this.signUpMap[tplComponentId];
                                if (signUp.fillInfo && activityApp.isEmpty(signUp.fillInfoFormId)) {
                                    $this.$set($this.signUpMap[tplComponentId], "fillInfo", false);
                                }
                                // 关闭表单填写
                                app.closeLayerPop(index);
                            },
                            btn2: function () {
                                $("#layui-layer-iframe" + $this.formConfigLayerIndex)[0].contentWindow.submit();
                                return false;
                            },
                            end: function () {
                                $('body').removeClass('scroll');
                            }
                        })
                    },
                    openWfwFormSwitchDialog: function (signUpTplComponentId) {
                        var $this= this;
                        $this.operateSignUpOriginId = signUpTplComponentId;
                        var signUp = $this.signUpMap[signUpTplComponentId];
                        var now = new Date().getTime();
                        if (signUp.startTime && signUp.startTime < now) {
                            $this.showSwitchFormDialog = true;
                        } else {
                            $this.confirmSwitchForm();
                        }
                    },
                    cancelSwitchForm: function () {
                        var $this = this;
                        $this.showSwitchFormDialog = false;
                        $this.operateSignUpOriginId = -1;
                    },
                    confirmSwitchForm: function () {
                        var $this = this;
                        var tplComponentId = $this.operateSignUpOriginId;
                        $this.signUpMap[tplComponentId].formType = $this.signUpMap[tplComponentId].formType == 'wfw_form' ? 'approval' : 'wfw_form';
                        $this.$set($this.signUpMap[tplComponentId], "openAddr", "");
                        $this.$set($this.signUpMap[tplComponentId], "pcUrl", "");
                        $this.$set($this.signUpMap[tplComponentId], "wechatUrl", "");
                        $this.$set($this.signUpMap[tplComponentId], "wfwFormName", "");
                        $this.$set($this.signUpMap[tplComponentId], "fillInfoFormId", "");
                        $this.signUpFillInfoDefaultWfwFormMap[tplComponentId] = null;

                        $this.cancelSwitchForm();
                    },
                    signUpFormTypeChange: function (signUpTplComponentId) {
                        var $this = this;
                        $this.$set($this.signUpMap[signUpTplComponentId], 'wfwFormTemplateId', '');
                    },
                    // 是否显示信息填报下拉
                    showWfwFormSelect: function (signUpTplComponentId, signUpFillInfoType) {
                        var $this = this;
                        var templateOptions = (signUpFillInfoType && signUpFillInfoType.templateOptions) || [];
                        var { formType } = $this.signUpMap[signUpTplComponentId];
                        var approvalNum = 0, wfwFormNum = 0;
                        $(templateOptions).each(function () {
                            if (this.type == 'normal') {
                                wfwFormNum++;
                            } else if (this.type == 'approval') {
                                approvalNum++;
                            }
                        });
                        return (formType == 'wfw_form' && wfwFormNum > 0) || (formType == 'approval' && approvalNum > 0);
                    },
                    toConfigSignUpDetails: function (signUpConditionTplComponentId) {
                        var $this = this;
                        $this.operationSucTplComponentId = signUpConditionTplComponentId;
                        var { originIdentify, activityConditionDetails, templateConditionDetails } = $this.signUpConditionMap[signUpConditionTplComponentId];
                        var fields = [];
                        if (!activityApp.isEmpty(originIdentify)) {
                            var fieldNameMap = $this.formStructureMap[originIdentify];
                            debugger
                            $(templateConditionDetails).each(function () {
                                var field = fieldNameMap[this.fieldName];
                                if (!fields.includes(field)) {
                                    fields.push(field);
                                }
                            });
                        }
                        $this.$refs.signUpConfigDialogWindow.showWindow(fields, activityConditionDetails, $this.conditionEnums);
                    },
                    confirmSignUpConditionDetails: function (conditionDetails, deleteDetailIds) {
                        var $this = this;
                        var tplComponentId = $this.operationSucTplComponentId;
                        $(conditionDetails).each(function () {
                            this.activityId = $this.activity.id || ''
                            this.templateComponentId = tplComponentId;
                        })
                        $this.signUpConditionMap[tplComponentId].activityConditionDetails = conditionDetails;
                        var tmpDeleteIds = $this.signUpConditionMap[tplComponentId].deleteDetailIds || [];
                        tmpDeleteIds.pushArray(deleteDetailIds);
                        $this.signUpConditionMap[tplComponentId].deleteDetailIds = tmpDeleteIds;
                    },
                }
            });
            /**
             * 关闭表单配置页面
             */
            function closeFormConfigLayer(formId) {
                vm.closeFormConfigLayer(formId);
            }
        </script>
    </div>
</body>
</html>