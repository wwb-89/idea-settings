<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org/">
<head>
	<title>用户统计</title>
	<meta charset="UTF-8">
	<meta name="renderer" content="webkit">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<link rel="stylesheet" href="/static/pc/assets/table-icomoon/style.css" th:href="@{/pc/assets/table-icomoon/style.css}">
	<link rel="stylesheet" href="/static/pc/assets/lib/element-ui/lib/theme-chalk/index.css" th:href="@{/pc/assets/lib/element-ui/lib/theme-chalk/index.css}">
	<link rel="stylesheet" href="/static/pc/assets/lib/zTree_v3_table/css/zTreeStyle/zTreeStyle.css" th:href="@{/pc/assets/lib/zTree_v3_table/css/zTreeStyle/zTreeStyle.css}" type="text/css">
	<link rel="stylesheet" href="/static/pc/assets/css/commonTable.css" th:href="@{/pc/assets/css/commonTable.css}">
	<link rel="stylesheet" href="/static/pc/assets/css/confirm_dialog.css" th:href="@{/pc/assets/css/confirm_dialog.css}">
	<style type="text/css">
		[v-cloak] {
			display: none;
        }
	</style>
</head>

<body>
<div id="stat-vue" v-cloak>
	<div>
		<div class="tab-content-box">
			<div class="tab-item">
				<!-- 查询栏 -->
				<div class="table-search-box fs0">
					<div class="popbtnInput">
						<input type="text" autocomplete="off" class="layui-input" readonly value="全部参与范围" @click="selectPopFunc">
					</div>
					<el-button class="btn-customize" round>查询</el-button>
				</div>
				<!-- 计数栏 -->
				<div class="table-count-box fs12">
					<div class="count-info fl">
						<span class="color999">共 100 人</span>
					</div>
					<div class="setting-box">
						<el-dropdown :hide-on-click="false" trigger="click">
							<el-tooltip class="item" effect="dark" content="显示字段" placement="top">
								<span class="icon-setting fs16"></span>
							</el-tooltip>
							<el-dropdown-menu slot="dropdown" class="set-dropdown">
								<div class="dropdown-lists">
									<el-dropdown-item v-for="(field, index) of configTableFieldDetails" :key="'field-' + field.id">
										<el-checkbox v-model="field.defaultChecked" :disabled="!field.allowUncheck"> {{field.name}}</el-checkbox>
										<el-tooltip v-if="field.defaultTop" class="item" effect="dark" content="取消固定列" placement="top">
											<i class="btn-fix icon-pinned fs16" @click="field.defaultTop = false"></i>
										</el-tooltip>
										<el-tooltip v-else class="item" effect="dark" content="固定列" placement="top">
											<i class="btn-fix icon-pin fs16" @click="field.defaultTop = true"></i>
										</el-tooltip>
									</el-dropdown-item>
								</div>
								<div class="bottom-btns fs14 colorBlue">
									<el-button type="text" class="btn-confirm" @click="configSubmit">确定</el-button>
									<el-button type="text" class="btn-reset" @click="resetConfig">重置</el-button>
								</div>
							</el-dropdown-menu>
						</el-dropdown>
					</div>
					<div class="clear"></div>
				</div>
				<el-table class="table-box" :data="tableTestData1" >
					<el-table-column v-for="(field, index) of showTableFieldDetails" :key="'filed-' + field.id" :align="field.align" :fixed="field.top" :sortable="field.sortable" :label="field.name" :min-width="field.minWidth">
						<template slot-scope="scope">
							<span>{{scope.row[field.code]}}</span>
						</template>
					</el-table-column>
				</el-table>
				<!--分页-->
				<el-pagination background layout="prev, pager, next" :total="200"></el-pagination>
			</div>
		</div>
	</div>
	<!-- 组织架构 -->
	<div class="dialog-box selectPop" v-show="ifSelectPop">
		<div class="dialog-wrap">
			<div class="header">
				<span class="color333">组织架构</span>
				<img src="/static/pc/assets/images/close.png" th:src="@{/pc/assets/images/close.png}" @click="ifSelectPop = false">
			</div>
			<div class="dialog-content">
				<!-- ztree内容 -->
				<div class="ztree-box">
					<div class="count-box fs14">
						<span class="color666">选择组织架构 </span>
					</div>
					<ul id="treeList" class="ztree"></ul>
				</div>
			</div>
			<div class="btns">
				<span class="btn inlineMiddle btn-border" @click="ifSelectPop = false">取消</span>
				<span class="btn inlineMiddle btn-normal">确定</span>
			</div>
		</div>
	</div>
</div>
<div th:replace="pc/include/common_js :: common_js(~{::script})">
	<script src="/static/pc/assets/lib/element-ui/lib/index.js" th:src="@{/pc/assets/lib/element-ui/lib/index.js}"></script>
	<script type="text/javascript" src="/static/pc/assets/lib/zTree_v3/js/jquery.ztree.core.js" th:src="@{/pc/assets/lib/zTree_v3/js/jquery.ztree.core.js}"></script>
	<script type="text/javascript" src="/static/pc/assets/lib/zTree_v3/js/jquery.ztree.excheck.js" th:src="@{/pc/assets/lib/zTree_v3/js/jquery.ztree.excheck.js}"></script>
	<script th:inline="javascript">
        vm = new Vue({
            el: "#stat-vue",
            data: {
                fid: [[${fid}]],
                tableFieldId: [[${tableFieldId}]],
                tableFieldDetails: [[${tableFieldDetails}]],
                orgTableFields: [[${orgTableFields}]],
	            // 表格显示的字段列表
	            showTableFieldDetails: [],
	            // 配置使用的字段列表
	            configTableFieldDetails: [],
                tableTestData1: [
                    {
                        name: '吴立',
                        account: '18272676793',
                        time: '2020-03-27 13:02',
                        applyType:'全部',
                        status: 0,
                        img: 'http://file.m.superlib.com/C/GEDEbook/cover/190801/TSYJ031442.jpg',
                    }
                ],
                search1: '',
                search: '',
                centerDialogVisible: false,
                selectNumber:0, //表格选中的人数
                inputlen: false, //输入框的清空按钮
                ifCenter: 'left',  //表格是否居中
                ifSelectPop: false, //参与范围的弹窗展示
                setting: {
                    view: {
                        showLine: false
                    },
                    check: {
                        enable: true
                    },
                    data: {
                        simpleData: {
                            enable: true
                        }
                    },
                    callback: {
                        onClick:  (e, treeId, treeNode)=> app.zTreeOnClick(e, treeId, treeNode),
                        onCheck: (e, treeId, treeNode)=> app.zTreeOnCheck(e, treeId, treeNode)
                    }
                },
                zNodes: [
                    { id:1, pId:0, name:"天津教育局天津教育局天津教育局（12）", open:true},
                    { id:11, pId:1, name:"二级二级二级", open:true},
                    { id:111, pId:11, name:"can check 1-1-1"},
                    { id:112, pId:11, name:"can check 1-1-2"},
                    { id:12, pId:1, name:"can check 1-2", open:true},
                    { id:121, pId:12, name:"can check 1-2-1"},
                    { id:122, pId:12, name:"can check 1-2-2"},
                    { id:2, pId:0, name:"can check 2", checked:true, open:true},
                    { id:21, pId:2, name:"can check 2-1"},
                    { id:22, pId:2, name:"can check 2-2", open:true},
                    { id:221, pId:22, name:"can check 2-2-1", checked:true},
                    { id:222, pId:22, name:"can check 2-2-2"},
                    { id:23, pId:2, name:"can check 2-3"}
                ],
                clearFlag: false,
            },
            created: function () {
				var $this = this;
				// 计算表格显示的字段列表
                if ($this.orgTableFields.length < 1) {
                    // 机构没有配置显示的字段。使用默认的
                    $($this.tableFieldDetails).each(function () {
                        if (this.defaultChecked) {
                            $this.showTableFieldDetails.push($.extend({}, this));
                        }
                    });
                } else {
                    $($this.orgTableFields).each(function () {
                        var orgTableField = this;
                        var tableFieldDetailId = orgTableField.tableFieldDetailId;
                        $($this.tableFieldDetails).each(function () {
                            if (tableFieldDetailId == this.id) {
                                var tableFieldDetail = $.extend({}, this);
                                tableFieldDetail.defaultChecked = true;
                                tableFieldDetail.defaultTop = orgTableField.top;
                                $this.showTableFieldDetails.push(tableFieldDetail);
                                return false;
                            }
                        });
                    });
                }
                $this.configTableFieldDetails = $this.calConfigTableFieldDetails();
            },
            mounted: function () {
                var $this = this;
                $.fn.zTree.init($("#treeList"), $this.setting, $this.zNodes);
            },
            methods: {
                calConfigTableFieldDetails: function () {
                    var $this = this;
                    var configTableFieldDetails = [];
                    $($this.tableFieldDetails).each(function () {
                        configTableFieldDetails.push($.extend({}, this));
                    });
                    if ($this.orgTableFields.length > 0) {
                        $(configTableFieldDetails).each(function () {
                            var configTableFieldDetail = this;
                            configTableFieldDetail.defaultChecked = false;
                            $($this.orgTableFields).each(function () {
                                if (configTableFieldDetail.id == this.tableFieldDetailId) {
                                    configTableFieldDetail.defaultChecked = true;
                                    configTableFieldDetail.defaultTop = this.top;
                                }
                            });
                        });
                    }
                    return configTableFieldDetails;
                },
	            // 重置配置
                resetConfig: function () {
                    var $this = this;
                    $this.configTableFieldDetails = $this.calConfigTableFieldDetails();
                },
	            // 封装提交的配置
                packageSubmitTableFieldDetails: function () {
                    var $this = this;
                    var orgTableFieldDetails = [];
                    var sequence = 1;
                    $($this.configTableFieldDetails).each(function () {
                        if (this.defaultChecked) {
                            var orgTableFieldDetail = {
	                            tableFieldDetailId: this.id,
	                            top: this.defaultTop,
	                            sequence: sequence++
                            }
                            orgTableFieldDetails.push(orgTableFieldDetail);

                        }
                    });
                    return orgTableFieldDetails;
                },
	            // 配置提交
                configSubmit: function () {
                    var $this = this;
                    var orgTableFieldDetails = $this.packageSubmitTableFieldDetails();
                    var url = ctx + "/api/org/" + $this.fid + "/table-field/" + $this.tableFieldId + "/config";
                    var params = {
                        orgTableFieldsStr: activityApp.getJsonStr(orgTableFieldDetails)
                    };
                    app.ajaxPostWithLoading(url, params, function (data) {
	                    window.location.reload();
                    }, function () {

                    });
                },
                clearInput(){
                    this.search1='';
                    this.inputlen = false;
                },
                selectPopFunc(){
                    this.ifSelectPop = true;
                    var $this = this;
                    $.fn.zTree.init($("#treeList"), $this.setting, $this.zNodes);
                    this.count();
                },
                zTreeOnClick: function(event, treeId, treeNode) {
                    console.log(treeNode.tId + ", " + treeNode.name);
                },
                zTreeOnCheck: function(e, treeId, treeNode) {
                    this.count();
                    if (this.clearFlag) {
                        this.clearCheckedOldNodes();
                    }
                },
                clearCheckedOldNodes() {
                    var zTree = $.fn.zTree.getZTreeObj("treeList"),
                        nodes = zTree.getChangeCheckedNodes();
                    for (var i=0, l=nodes.length; i<l; i++) {
                        nodes[i].checkedOld = nodes[i].checked;
                    }
                },
                count() {
                    var zTree = $.fn.zTree.getZTreeObj("treeList");
                    var checkCount = zTree.getCheckedNodes(true).length;
                    $("#checkCount").text(checkCount);

                },
            }
        })
	</script>
</div>
</body>
</html>