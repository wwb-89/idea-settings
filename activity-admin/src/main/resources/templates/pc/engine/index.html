<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org/">
<head>
    <title>字段设置</title>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="/static/pc/assets/lib/element-ui/lib/theme-chalk/index.css" th:href="@{/pc/assets/lib/element-ui/lib/theme-chalk/index.css}">
    <link rel="stylesheet" href="/static/pc/assets/icomoon/style.css" th:href="@{/pc/assets/icomoon/style.css}">
    <link rel="stylesheet" href="/static/pc/assets/css/public.css" th:href="@{/pc/assets/css/public.css}">
    <link rel="stylesheet" href="/static/pc/assets/css/engine-design.css" th:href="@{/pc/assets/css/engine-design.css}">
</head>
<body>
    <div class="field-setting" id="field-setting" v-cloak>
        <div class="top-con-light">
            <div class="name-txt">字段设置</div>
            <div class="look-div fr" @click="publish">
                <div class="btn-width80px-color2">发布</div>
            </div>
            <a href="https://mooc1.chaoxing.com/zt/218982272.html" target="_blank" style="display: inline-block; float: right; font-size: 13px; color: #999; line-height: 30px; margin-right: 36px;">操作说明</a>
        </div>
        <div class="content">
            <div class="w-900px info-box" style="display: block;">
                <form action="" id="drag-box">
                    <template v-for="(item, index) in templateComponents">
                        <div class="title sort-item" v-if="'partition' == item.code">
                            <i class="icon-drag" :pid-key="item.pid" :id-key="item.id"></i>
                            <div class="lable">{{item.name}}</div>
                            <div class="icon-div">
                                <i class="icon-edit" @click="openEditDialog(index, item)"></i>
                                <i class="icon-delete" @click="removeComponentAssociate1(index, item)"></i>
                            </div>
                            <div class="input-box">
                                <p class="tips second">{{item.introduction}}</p>
                            </div>
                        </div>
                        <div class="form-item sort-item" v-if="!['activity_address', 'partition', 'company_sign_up', 'sign_up', 'sign_in', 'sign_out'].includes(item.code)">
                            <i class="icon-drag" :pid-key="item.pid" :id-key="item.id"></i>
                            <div class="icon-div">
                                <i class="icon-edit" @click="openEditDialog(index, item)"></i>
                                <i class="icon-delete" @click="removeComponentAssociate1(index, item)"></i>
                            </div>
                            <label :class="{ label: true, required: item.required }">{{item.name}}</label>
                            <div class="input-box">
                                <!-- 活动名称：activity_name -->
                                <template v-if="item.code == 'activity_name'">
                                    <el-input type="text" placeholder="请填写" maxlength="20" show-word-limit readonly></el-input>
                                </template>
                                <!-- 主办方：activity_organisers -->
                                <template v-else-if="item.code == 'activity_organisers'">
                                    <el-input style="width: 400px" type="text" placeholder="请填写" maxlength="20" readonly></el-input>
                                </template>
                                <!-- 活动时间：activity_time_scope -->
                                <template v-else-if="item.code == 'activity_time_scope'">
                                    <el-date-picker type="daterange"
                                                    start-placeholder="开始时间"
                                                    end-placeholder="结束时间"
                                                    format="yyyy-MM-dd"
                                                    value-format="yyyy-MM-dd"
                                                    prefix-icon="disable"
                                                    clear-icon="disable"
                                                    unlink-panels
                                                    readonly>
                                        <img style="margin: 0 8px;" slot="range-separator" src="/static/pc/assets/images/swap-right.png" th:src="@{/pc/assets/images/swap-right.png}">
                                    </el-date-picker>
                                    <span class="date-piker-icon"><img src="/static/pc/assets/images/calendar.png" th:src="@{/pc/assets/images/calendar.png}"></span>
                                </template>
                                <!-- 活动封面：activity_cover -->
                                <template v-else-if="item.code == 'activity_cover'">
                                    <div class="img-box">
                                        <img src="/static/pc/assets/images/img.png" th:src="@{/pc/assets/images/img.png}" alt="" class="cover-img jqthumbImg">
                                    </div>
                                    <div class="font-box">
                                        <p>建议尺寸：1080x500</p>
                                        <p>大小：小于5M</p>
                                        <p>格式：jpg、png、gif</p>
                                        <div class="blue-border-btn upload">上传文件</div>
                                    </div>
                                </template>
                                <!-- 活动形式：activity_type -->
                                <template v-else-if="item.code == 'activity_type'">
                                    <div>
                                        <el-radio v-model="radioModel" label="1" name="active-type" class="radio-item" readonly>线下活动</el-radio>
                                        <el-radio label="2" name="active-type" class="radio-item" readonly>线上活动</el-radio>
                                    </div>
                                    <div class="address-box">
                                        <el-input type="text" placeholder="请输入活动地点" autocomplete="off" class="address-input" readonly></el-input>
                                        <img src="/static/pc/assets/images/location.png" th:src="@{/pc/assets/images/location.png}" alt="" class="address-icon">
                                        <el-input type="text" placeholder="详细地址，例：E5栋1308室" autocomplete="off" class="detaile-address" readonly></el-input>
                                    </div>
                                </template>
                                <!-- 活动类型：activity_classify -->
                                <template v-else-if="item.code == 'activity_classify'">
                                    <el-input type="text" v-model="activityType" placeholder="请选择" autocomplete="off" class="select-input" readonly></el-input>
                                    <img src="/static/pc/assets/images/yq-design/arrow-down-small.png" th:src="@{/pc/assets/images/yq-design/arrow-down-small.png}" alt="" class="arrow-down">
                                    <p class="tips first">{{item.introduction}}</p>
                                </template>
                                <template v-else-if="item.code == 'period'">
                                    <el-input type="number" min="0" step="0.1" v-model="scoreNum" placeholder="请输入" readonly></el-input>
                                    <span class="score">学时</span>
                                    <span class="tips first" v-if="item.introduction">{{item.introduction}}</span>
                                </template>
                                <template v-else-if="item.code == 'credit'">
                                    <el-input type="number" min="0" step="0.1" v-model="scoreNum" placeholder="请输入" readonly></el-input>
                                    <span class="score">first</span>
                                    <span class="tips first" v-if="item.introduction">{{item.introduction}}</span>
                                </template>
                                <template v-else-if="item.code == 'integral'">
                                    <el-input type="number" min="0" v-model="scoreNum"placeholder="请输入" readonly></el-input>
                                    <span class="score">分</span>
                                    <span class="tips first" v-if="item.introduction">{{item.introduction}}</span>
                                </template>
                                <template v-else-if="item.code == 'max_participate_time_length'">
                                    <el-input type="number" min="1" step="1" v-model="scoreNum" placeholder="不限" readonly></el-input>
                                    <span class="score">小时</span>
                                    <span class="tips first" v-if="item.introduction">{{item.introduction}}</span>
                                </template>
                                <template v-else-if="item.code == 'activity_rating'">
                                    <el-input type="text" placeholder="活动评价" readonly></el-input>
                                    <span class="tips third" v-if="item.introduction">{{item.introduction}}</span>
                                </template>
                                <!-- 标签：tags -->
                                <template v-else-if="item.code == 'tags'">
                                    <div class="type-item">
                                        <i class="add_btn"></i>新增
                                    </div>
                                </template>
                                <!-- 发布范围：activity_release_scope -->
                                <template v-else-if="item.code == 'activity_release_scope'">
                                    <div class="type-item">
                                        <div class="add_btn"></div>选择
                                    </div>
                                    <span class="tips third" v-if="item.introduction">{{item.introduction}}</span>
                                </template>
                                <!-- 定时发布：timing_release -->
                                <template v-else-if="item.code == 'timing_release'">
                                    <el-switch class="switch fl marginTop6" disabled></el-switch>
                                    <p class="tips third">{{item.introduction}}</p>
                                </template>
                                <!-- 考核管理：inspection_manage -->
                                <template v-else-if="item.code == 'inspection_config'">
                                    <el-switch class="switch fl marginTop6" disabled></el-switch>
                                    <p class="tips third">{{item.introduction}}</p>
                                </template>
                                <template v-else-if="item.code == 'work'">
                                    <el-switch class="switch fl marginTop6" disabled></el-switch>
                                    <p class="tips third">{{item.introduction}}</p>
                                </template>
                                <template v-else-if="item.code == 'group'">
                                    <el-switch class="switch fl marginTop6" disabled></el-switch>
                                    <p class="tips third">{{item.introduction}}</p>
                                </template>
                                <template v-else-if="item.code == 'reading'">
                                    <el-switch class="switch fl marginTop6" disabled></el-switch>
                                    <p class="tips third">{{item.introduction}}</p>
                                </template>
                                <template v-else-if="item.code == 'clazz_interaction'">
                                    <el-switch class="switch fl marginTop6" disabled></el-switch>
                                    <p class="tips third">{{item.introduction}}</p>
                                </template>
                                <template v-else-if="item.code == 'push_reminder'">
                                    <el-switch class="switch fl marginTop6" disabled></el-switch>
                                    <p class="tips third">{{item.introduction}}</p>
                                </template>
                                <!-- 简介：introduction -->
                                <template v-else-if="item.code == 'introduction'">
                                    <el-input type="text" placeholder="请填写" maxlength="20" show-word-limit readonly></el-input>
                                </template>
                                <template v-else-if="item.type == 'text' || item.type == 'int' || item.type == 'decimal'">
                                    <el-input type="text" placeholder="请填写" maxlength="20" show-word-limit readonly></el-input>
                                    <span class="tips third" v-if="item.introduction">{{item.introduction}}</span>
                                </template>
                                <template v-else-if="item.type == 'radio'">
                                    <div>
                                        <el-select disabled v-model="selectModel" placeholder="请选择">
                                            <el-option v-for="value in []" :key="value" :label="value" :value="value"></el-option>
                                        </el-select>
                                    </div>
                                    <span class="tips third" v-if="item.introduction">{{item.introduction}}</span>
                                </template>
                                <template v-else-if="item.type == 'checkbox'">
                                    <el-select disabled v-model="selectModel" placeholder="请选择">
                                        <el-option v-for="value in []" :key="value" :label="value" :value="value"></el-option>
                                    </el-select>
                                    <span class="tips third" v-if="item.introduction">{{item.introduction}}</span>
                                </template>
                                <!--证书设置-->
                                <template v-else-if="item.code == 'certificate'">
                                    <p class="tips third">{{item.introduction}}</p>
                                </template>
                            </div>
                        </div>
                        <!-- 特殊活动报名设置 -->
                        <template v-else-if="item.code == 'company_sign_up' || item.code == 'sign_up'">
                            <div class="form-item sort-item nopadding">
                                <div class="drag-box-inner">
                                    <div class="title sort-item">
                                        <i class="icon-drag" :pid-key="item.pid" :id-key="item.id"></i>
                                        <div class="lable">{{item.name}}</div>
                                        <div class="icon-div">
                                            <i class="icon-edit" @click="openEditDialog(index, item)"></i>
                                            <i class="icon-delete" @click="openSignUpRemoveDialog(index, item)"></i>
                                        </div>
                                        <div class="input-box">
                                            <el-switch v-model="switchModel" class="switch fl marginTop6" disabled></el-switch>
                                            <p class="tips second">{{item.introduction}}</p>
                                        </div>
                                    </div>
                                    <div id="drag-box-inner">
                                        <div class="form-item sort-item-inner" v-if="item.children && item.children.length > 0" v-for="(it, idx) in item.children">
                                            <i class="icon-drag-inner" :pid-key="it.pid" :id-key="it.id"></i>
                                            <div class="icon-div-inner">
                                                <i class="icon-edit" @click="openEditDialog1(index, idx, it)"></i>
                                                <i class="icon-delete" @click="removeComponentAssociate2(index, idx, it)"></i>
                                            </div>
                                            <label :class="{ label: true, required: it.required }">{{it.name}}</label>
                                            <div class="input-box">
                                                <template v-if="it.code == 'sign_up_time_scope'">
                                                    <el-date-picker type="daterange"
                                                                    start-placeholder="开始时间"
                                                                    end-placeholder="结束时间"
                                                                    format="yyyy-MM-dd"
                                                                    value-format="yyyy-MM-dd"
                                                                    prefix-icon="disable"
                                                                    clear-icon="disable"
                                                                    unlink-panels
                                                                    readonly>
                                                        <img style="margin: 0 8px;" slot="range-separator" src="/static/pc/assets/images/swap-right.png" th:src="@{/pc/assets/images/swap-right.png}">
                                                    </el-date-picker>
                                                    <span class="date-piker-icon"><img src="/static/pc/assets/images/calendar.png" th:src="@{/pc/assets/images/calendar.png}"></span>
                                                </template>
                                                <template v-else-if="it.code == 'wfw_participation_scope'">
                                                    <div class="type-item">
                                                        <div class="add_btn"></div>选择
                                                    </div>
                                                </template>
                                                <template v-else-if="it.code == 'contacts_participation_scope'">
                                                    <div class="type-item">
                                                        <div class="add_btn"></div>选择
                                                    </div>
                                                </template>
                                                <template v-else-if="it.code == 'sign_up_person_limit'">
                                                    <el-input type="text" v-model="person" placeholder="请选择" autocomplete="off" class="select-input" readonly></el-input>
                                                    <img src="/static/pc/assets/images/yq-design/arrow-down-small.png" th:src="@{/pc/assets/images/yq-design/arrow-down-small.png}" alt="" class="arrow-down">
                                                    <div class="person-box">
                                                        <el-input type="number" placeholder="请输入正整数" readonly></el-input>
                                                        <span class="person-span">人</span>
                                                    </div>
                                                </template>
                                                <template v-else-if="it.code == 'sign_up_fill_info'">
                                                    <el-switch class="switch fl marginTop6" disabled></el-switch>
                                                    <p class="tips third">{{it.introduction}}</p>
                                                </template>
                                                <template v-else-if="it.code == 'sign_up_review'">
                                                    <el-switch class="switch fl marginTop6" disabled></el-switch>
                                                    <p class="tips third">{{it.introduction}}</p>
                                                </template>
                                                <template v-else-if="it.code == 'sign_up_public_list'">
                                                    <el-switch class="switch fl marginTop6" disabled></el-switch>
                                                    <p class="tips third">{{it.introduction}}</p>
                                                </template>
                                                <template v-else-if="it.code == 'sign_up_cancel_signed_up'">
                                                    <el-switch class="switch fl marginTop6" disabled></el-switch>
                                                    <p class="tips third">{{it.introduction}}</p>
                                                </template>
                                                <template v-else-if="it.code == 'on_site_sign_up'">
                                                    <el-switch class="switch fl marginTop6" disabled></el-switch>
                                                    <p class="tips third">{{it.introduction}}</p>
                                                </template>
                                                <template v-else-if="it.code == 'sign_up_condition'">
                                                    <el-switch class="switch fl marginTop6" disabled></el-switch>
                                                    <p class="tips third">{{it.introduction}}</p>
                                                </template>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </template>
                        <!-- 签到设置 -->
                        <template v-else-if="item.code == 'sign_in'">
                            <div class="form-item sort-item nopadding">
                                <div class="drag-box-inner">
                                    <div class="title sort-item">
                                        <i class="icon-drag" :pid-key="item.pid" :id-key="item.id"></i>
                                        <div class="lable">签到设置</div>
                                        <div class="icon-div">
                                            <i class="icon-edit" @click="openEditDialog(index, item)"></i>
                                            <i class="icon-delete" @click="removeComponentAssociate1(index, item)"></i>
                                        </div>
                                        <div class="input-box">
                                            <el-switch v-model="switchModel" class="switch fl marginTop6" disabled></el-switch>
                                        </div>
                                    </div>
                                    <div class="form-item">
                                        <label class="label required">签到方式</label>
                                        <div class="input-box sign-in">
                                            <el-radio v-model="radioModel" label="1" class="radio-item" readonly>普通签到</el-radio>
                                            <el-radio label="2" class="radio-item">位置签到</el-radio>
                                            <el-radio label="3" class="radio-item">二维码签到</el-radio>
                                        </div>
                                    </div>
                                    <div class="form-item">
                                        <label class="label required">签到时间</label>
                                        <div class="input-box">
                                            <el-date-picker type="daterange"
                                                            start-placeholder="开始时间"
                                                            end-placeholder="结束时间"
                                                            format="yyyy-MM-dd"
                                                            value-format="yyyy-MM-dd"
                                                            prefix-icon="disable"
                                                            clear-icon="disable"
                                                            unlink-panels
                                                            readonly>
                                                <img style="margin: 0 8px;" slot="range-separator" src="/static/pc/assets/images/swap-right.png" th:src="@{/pc/assets/images/swap-right.png}">
                                            </el-date-picker>
                                            <span class="date-piker-icon"><img src="/static/pc/assets/images/calendar.png" th:src="@{/pc/assets/images/calendar.png}"></span>
                                        </div>
                                    </div>
                                    <div class="form-item">
                                        <label class="label">签到人员名单公开</label>
                                        <div class="input-box">
                                            <el-switch class="switch fl marginTop6" disabled></el-switch>
                                            <p class="tips third">开启后，所有人都能看到报名人员名单</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </template>
                        <!-- 签退设置 -->
                        <template v-else-if="item.code == 'sign_out'">
                            <div class="form-item sort-item nopadding">
                                <div class="drag-box-inner">
                                    <div class="title sort-item">
                                        <i class="icon-drag" :pid-key="item.pid" :id-key="item.id"></i>
                                        <div class="lable">签退设置</div>
                                        <div class="icon-div">
                                            <i class="icon-edit" @click="openEditDialog(index, item)"></i>
                                            <i class="icon-delete" @click="removeComponentAssociate1(index, item)"></i>
                                        </div>
                                        <div class="input-box">
                                            <el-switch v-model="switchModel" class="switch fl marginTop6" disabled></el-switch>
                                        </div>
                                    </div>
                                    <div class="form-item">
                                        <label class="label required">签退方式</label>
                                        <div class="input-box sign-in">
                                            <el-radio v-model="radioModel" label="1" class="radio-item" readonly>普通签退</el-radio>
                                            <el-radio label="2" class="radio-item">位置签退</el-radio>
                                            <el-radio label="3" class="radio-item">二维码签退</el-radio>
                                        </div>
                                    </div>
                                    <div class="form-item">
                                        <i class="icon-drag" :pid-key="item.pid" :id-key="item.id"></i>
                                        <label class="label required">签退时间</label>
                                        <div class="input-box">
                                            <el-date-picker type="daterange"
                                                            start-placeholder="开始时间"
                                                            end-placeholder="结束时间"
                                                            format="yyyy-MM-dd"
                                                            value-format="yyyy-MM-dd"
                                                            prefix-icon="disable"
                                                            clear-icon="disable"
                                                            unlink-panels
                                                            readonly>
                                                <img style="margin: 0 8px;" slot="range-separator" src="/static/pc/assets/images/swap-right.png" th:src="@{/pc/assets/images/swap-right.png}">
                                            </el-date-picker>
                                            <span class="date-piker-icon"><img src="/static/pc/assets/images/calendar.png" th:src="@{/pc/assets/images/calendar.png}"></span>
                                        </div>
                                    </div>
                                    <div class="form-item">
                                        <label class="label">签退名单公开</label>
                                        <div class="input-box">
                                            <el-switch class="switch fl marginTop6" disabled></el-switch>
                                            <p class="tips third">开启后，所有人都能看到报名人员名单</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </template>
                    </template>
                </form>
                <div class="add-circle" @click="openAddFieldDialog" id="add-circle"></div>
            </div>
        </div>
        <!--拖拽排序的提示-->
        <div id="dragBubble" class="bubble">拖动可排序</div>
        <!-- 确认删除模块弹框 -->
        <div class="dialog-mask" v-show="delDialog">
            <div class="dailog delete-dailog">
                <img src="/static/pc/assets/images/yq-design/warn.png" th:src="@{/pc/assets/images/yq-design/warn.png}" alt="">
                <p class="text">删除后，可重新添加。确定删除？</p>
                <div class="btn-box">
                    <div class="border-btn" @click="cancelRemoveSignUpRemove">保留</div>
                    <div class="normal-btn" @click="confirmSignUpRemove">删除</div>
                </div>
            </div>
        </div>
        <!-- 添加字段弹窗 -->
        <div class="dialog-mask" v-show="addFieldDialog">
            <div class="dailog add-field" style="width: 550px">
                <div class="header">
                    <span>添加字段</span>
                    <i class="close" @click="closeAddFieldDialog"></i>
                </div>
                <div class="body">
                    <!-- tab -->
                    <div class="item-tab">
                        <ul class="item-list">
                            <li :class="{active: activeCpTypeIndex == index}" v-for="(item, index) in componentTypeList" @click="changeComponentType(index)">{{item.name}}</li>
                        </ul>
                    </div>
                    <div class="field-title">
                        <span class="txt1">基础字段</span>
                        <span class="txt2">{{activeCpTypeName == '基本信息' ? '一个模板只能添加一次' : '管理报名组件，一个报名下的功能只能添加一次'}}</span>
                    </div>
                    <template v-for="(item, index) in (componentTypeList[activeCpTypeIndex] && componentTypeList[activeCpTypeIndex].basicCompts) || []">
                        <div class="field-item aready-add" v-if="!item.checked">
                            <p class="field overHidden1">{{item.name}}</p>
                            <el-tooltip v-show="item.introduction" class="tooltip" effect="dark" :content="item.introduction" placement="top">
                                <i class="icon-info"></i>
                            </el-tooltip>
                            <div class="fr add-btn">
                                <i class="icon-add" @click="addBasicComponentAssociate(index, item)"></i>
                            </div>
                        </div>
                    </template>
                    <div class="field-title">
                        <span class="txt1">高级字段</span>
                    </div>
                    <template v-for="(item, index) in (componentTypeList[activeCpTypeIndex] && componentTypeList[activeCpTypeIndex].advanceCompts) || []">
                        <div class="field-item" :style="index % 2 == 0 ? {'margin-right': '24px'} : {'margin-right': '0px'}" @click="addAdvanceComponentAssociate(item)">
                            <p class="field overHidden1">{{item.name || ((item.type == 'text' || item.type == 'int' || item.type == 'decimal') ? '自定义输入' : '自定义选择')}}</p>
                        </div>
                    </template>
                </div>
                <div class="footer">
                    <div class="btn-box">
                        <div class="normal-btn" @click="closeAddFieldDialog">完成</div>
                    </div>
                </div>
            </div>
        </div>
        <!-- 文本字段弹窗 -->
        <div class="dialog-mask" v-show="textDialog">
            <div class="dailog text-field">
                <div class="header">
                    <span>{{dialogTitle}}</span>
                    <i class="close" @click="initEditData"></i>
                </div>
                <div class="body">
                    <el-form class="form" label-width="72px">
                        <el-input v-model="addEditItem.name" type="text" placeholder="标题" maxlength="8" show-word-limit class="marginBottom24"></el-input>
                        <el-input v-model="addEditItem.introduction" type="text" placeholder="辅助说明" maxlength="40" show-word-limit class="marginBottom24"></el-input>
                        <template v-if="addEditItem.type == 'text' || addEditItem.type == 'int' || addEditItem.type == 'decimal'">
                            <el-form-item label="类型" class="marginBottom20">
                            <el-select v-model="addEditItem.type" placeholder="请选择">
                                <el-option
                                        v-for="item in [{label: '文本', value: 'text'}, {label: '整数', value: 'int'}, {label: '小数', value: 'decimal'}]"
                                        :key="item.value"
                                        :label="item.label"
                                        :value="item.value"
                                >
                                </el-option>
                                </el-select>
                            </el-form-item>
                        </template>
                        <template v-if="addEditItem.code == 'activity_release_scope'">
                            <el-form-item label="数据来源" class="marginBottom20">
                                <el-select v-model="addEditItem.dataOrigin" placeholder="请选择">
                                    <el-option
                                            v-for="item in [{label: '区域架构', value: ''}, {label: '接口', value: 'interface'}]"
                                            :key="item.value"
                                            :label="item.label"
                                            :value="item.value"
                                    >
                                    </el-option>
                                </el-select>
                            </el-form-item>
                            <el-form-item label="接口地址" class="marginBottom20" v-show="addEditItem.dataOrigin == 'interface'">
                                <el-input v-model="addEditItem.originIdentify" type="text" placeholder="接口地址" class="marginBottom24"></el-input>
                            </el-form-item>
                        </template>
                        <div class="switch-box" v-show="addEditItem.code != 'sign_up' && addEditItem.code != 'company_sign_up' && addEditItem.code != 'partition'">
                            <label class="label">必填项</label>
                            <el-switch class="switch" v-model="addEditItem.required"></el-switch>
                        </div>
                    </el-form>
                </div>
                <div class="footer">
                    <div class="btn-box">
                        <div class="border-btn" @click="initEditData">取消</div>
                        <div :class="{'normal-btn': true, disable: addEditItem.code != 'partition' && !addEditItem.name}" @click="confirmEditText">确定</div>
                    </div>
                </div>
            </div>
        </div>
        <!-- 选择字段弹窗 -->
        <div class="dialog-mask" v-show="chooseDialog">
            <div class="dailog choose-field">
                <div class="header">
                    <span>{{dialogTitle}}</span>
                    <i class="close" @click="initEditData"></i>
                </div>
                <div class="body">
                    <el-form class="form" label-width="72px">
                        <el-input v-model="addEditItem.name" type="text" placeholder="标题" maxlength="8" show-word-limit class="marginBottom24"></el-input>
                        <el-input v-model="addEditItem.introduction" type="text" placeholder="辅助说明" maxlength="40" show-word-limit class="marginBottom24"></el-input>
                        <el-form-item label="数据来源" class="marginBottom20">
                            <el-select v-model="addEditItem.dataOrigin" placeholder="请选择" @change="changeDataOrigin">
                                <el-option
                                        v-for="item in [{label: '自定义', value: 'custom'}, {label: '表单', value: 'form'}]"
                                        :key="item.value"
                                        :label="item.label"
                                        :value="item.value"
                                >
                                </el-option>
                            </el-select>
                        </el-form-item>
                        <template v-if="addEditItem.dataOrigin == 'form'">
                            <el-form-item label="选择表单" class="marginBottom20">
                                <el-select v-model="addEditItem.originIdentify" placeholder="请选择" @change="loadWfwFormFields">
                                    <el-option
                                            v-for="item in wfwForms"
                                            :key="item.id"
                                            :label="item.name"
                                            :value="item.id"
                                    >
                                    </el-option>
                                </el-select>
                            </el-form-item>
                            <el-form-item label="选择字段" class="marginBottom20">
                                <el-select v-model="addEditItem.fieldFlag" placeholder="请选择">
                                    <el-option
                                            v-for="(item, index) in wfwFormFields"
                                            :key="index"
                                            :label="item.name"
                                            :value="item.name"
                                    >
                                    </el-option>
                                </el-select>
                            </el-form-item>
                        </template>
                        <template v-if="addEditItem.dataOrigin == 'custom'">
                            <div class="choose-box">
                                <div class="input-box" v-for="(item,index) in addEditItem.componentFields">
                                    <label class="label">选项{{index + 1}}</label>
                                    <el-input v-model="item.fieldName" type="text" placeholder="请输入" class="weight348"></el-input>
                                    <i :class="{'del-circle': true, 'disable': addEditItem.componentFields && addEditItem.componentFields.length <= 1}" @click="delEditItemFields(index)"></i>
                                </div>
                            </div>
                            <div class="add-option" @click="addEditItemFields">
                                <i></i>添加选项
                            </div>
                        </template>
                        <div class="switch-box">
                            <label class="label">必填项</label>
                            <el-switch class="switch" v-model="addEditItem.required"></el-switch>
                            <label class="label">允许多选</label>
                            <el-switch class="switch" v-model="addEditItem.type" active-value="checkbox" inactive-value="radio"></el-switch>
                        </div>
                    </el-form>
                </div>
                <div class="footer">
                    <div class="btn-box">
                        <div class="border-btn" @click="initEditData">取消</div>
                        <div :class="{'normal-btn': true, disable: !addEditItem.name}" @click="confirmChooseEdit">确定</div>
                    </div>
                </div>
            </div>
        </div>
        <!-- 报名条件-->
        <div class="dialog-mask" v-show="signUpConditionDialog">
            <div class="dailog">
                <div class="header">
                    <span>报名条件</span>
                    <i class="close" @click="signUpConditionDialog = false"></i>
                </div>
                <div class="body">
                    <el-form ref="form"  label-width="72px">
                        <el-input v-model="addEditItem.name" type="text" placeholder="标题（必填）" maxlength="8" show-word-limit class="marginBottom20"></el-input>
                        <el-input v-model="addEditItem.introduction" type="text" placeholder="说明" maxlength="40" show-word-limit class="marginBottom20"></el-input>
                        <el-form-item label="数据来源" class="marginBottom20">
                            <el-select v-model="innerAddEditItem.originIdentify" placeholder="请选择关联表单" @change="loadWfwFormFields">
                                <el-option v-for="item in wfwForms"
                                           :key="item.id"
                                           :label="item.name"
                                           :value="item.id"
                                >
                                </el-option>
                            </el-select>
                        </el-form-item>
                        <div class="marginBottom20">
                            <p class="tips marginBottom8">报名用户</p>
                            <div class="three" style="display: flex">
                                <el-select v-model="innerAddEditItem.fieldName" placeholder="请选择"  class="width186" style="width: 150px; margin-right: 10px">
                                    <el-option  v-for="(item, index) in wfwFormFields"
                                                v-if="item.compt == 'belonger' || item.compt == 'contact'"
                                                :key="index"
                                                :label="item.name"
                                                :value="item.name"
                                    >
                                    </el-option>
                                </el-select>
                                <el-select v-model="innerAddEditItem.allowSignedUp" placeholder="" class="width150" style="width: 120px">
                                    <el-option label="存在" :value="true"></el-option>
                                    <el-option label="不存在" :value="false"></el-option>
                                </el-select>
                                <span>时，可以报名</span>
                            </div>
                        </div>
                        <template v-if="innerAddEditItem.allowSignedUp">
                            <div class="marginBottom20 display-flex">
                                <label>设置条件</label>
                                <el-switch v-model="innerAddEditItem.configOnActivity" class="margin-auto" inactive-text="活动发起时配置字段值"></el-switch>
                            </div>
                            <div class="condition-box">
                                <div class="condition-item" v-for="(item, index) in innerAddEditItem.templateConditionDetails">
                                    <el-select v-model="item.fieldName" placeholder="请选择" @change="conditionFieldChange">
                                        <el-option  v-for="(it, idx) in wfwFormFields"
                                                    v-if="it.compt != 'belonger' && it.compt != 'contact'"
                                                    :key="idx"
                                                    :label="it.name"
                                                    :value="it.name"
                                        >
                                        </el-option>
                                    </el-select>
                                    <template v-if="!innerAddEditItem.configOnActivity">
                                        <el-select v-model="item.condition" placeholder="请选择">
                                            <el-option  v-for="(it, idx) in conditionEnums"
                                                        :key="idx"
                                                        :label="it.name"
                                                        :value="it.value"
                                            >
                                            </el-option>
                                        </el-select>
                                        <template v-if="item.condition != 'empty' && item.condition != 'un_empty'">
                                            <el-select v-if="currFormField.type == 'select'" v-model="item.value" placeholder="请选择" style="width: 152px">
                                                <el-option  v-for="(it, index) in currFormField.options"
                                                            :key="index"
                                                            :label="it"
                                                            :value="it"
                                                >
                                                </el-option>
                                            </el-select>
                                            <el-input v-else v-model="item.value" placeholder="请输入"></el-input>
                                        </template>
                                    </template>
                                    <i class="icon-minus-circle" @click="removeConditionDetail(index)"></i>
                                </div>
                                <div class="add-box" style="cursor: pointer" @click="addConditionDetail"><i class="icon-plus-circle"></i>添加条件</div>
                            </div>
                        </template>
                    </el-form>
                </div>
                <div class="footer">
                    <div class="btn-box">
                        <div class="border-btn" @click="signUpConditionDialog = false">取消</div>
                        <div class="normal-btn " @click="confirmChildrenComponentEdit('sign_up_condition')">确定</div>
                    </div>
                </div>
            </div>
        </div>
        <!-- 报名信息填写-->
        <div class="dialog-mask" v-show="fillInfoDialog">
            <div class="dailog">
                <div class="header">
                    <span>报名信息</span>
                    <i class="close" @click="fillInfoDialog = false"></i>
                </div>
                <div class="body">
                    <el-form ref="form"  label-width="72px">
                        <el-input v-model="addEditItem.name" type="text" placeholder="标题（必填）" maxlength="8" show-word-limit class="marginBottom20"></el-input>
                        <el-input v-model="addEditItem.introduction" type="text" placeholder="说明" maxlength="40" show-word-limit class="marginBottom20"></el-input>
                        <el-form-item label="表单模板" class="marginBottom20">
                            <el-select v-model="innerAddEditItem.wfwFormTemplateId" placeholder="请选择关联表单">
                                <el-option v-for="item in wfwFormTemplates"
                                           :key="item.id"
                                           :label="item.name"
                                           :value="item.id"
                                >
                                </el-option>
                            </el-select>
                        </el-form-item>
                        <el-form-item label="审批模板" class="marginBottom20">
                            <el-select v-model="innerAddEditItem.wfwFormApprovalTemplateId" placeholder="请选择关联审批">
                                <el-option v-for="item in wfwFormApprovalTemplates"
                                           :key="item.id"
                                           :label="item.name"
                                           :value="item.id"
                                >
                                </el-option>
                            </el-select>
                        </el-form-item>
                    </el-form>
                </div>
                <div class="footer">
                    <div class="btn-box">
                        <div class="border-btn" @click="fillInfoDialog = false">取消</div>
                        <div class="normal-btn " @click="confirmChildrenComponentEdit('sign_up_fill_info')">确定</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div th:replace="pc/include/common_js :: common_js(~{::script})">
        <script src="/static/pc/assets/lib/jquery.min.js" th:src="@{/pc/assets/lib/jquery.min.js}"></script>
        <script src="/static/pc/assets/lib/vue.js" th:src="@{/pc/assets/lib/vue.js}"></script>
        <script src="/static/pc/assets/lib/element-ui/lib/index.js" th:src="@{/pc/assets/lib/element-ui/lib/index.js}"></script>
        <script src="/static/pc/assets/lib/drag/sortTable.js" th:src="@{/pc/assets/lib/drag/sortTable.js}"></script>
        <script src="/static/pc/assets/lib/jqthumb.min.js" th:src="@{/pc/assets/lib/jqthumb.min.js}"></script>
        <script th:inline="javascript">
            var uuid = function () {
                return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function (c) {
                    var r = Math.random() * 16 | 0,
                        v = c == 'x' ? r : (r & 0x3 | 0x8);
                    return v.toString(16);
                });
            }
            vm = new Vue({
                el: '#field-setting',
                data: {
                    fid: [[${fid}]],
                    marketId: [[${marketId}]],
                    currTemplateId: [[${templateId}]],
                    templateInfo: [[${templateInfo}]],
                    wfwForms: [],
                    wfwFormFields: [],
                    wfwFormTypes: [
                        {label: "万能表单", value: "wfw_form"}
                    ],
                    wfwFormTemplates: [[${wfwFormTemplates}]],
                    wfwFormApprovalTemplates: [[${wfwFormApprovalTemplates}]],
                    // 源模板id
                    originTemplateId: null,
                    template: {},
                    components: [],
                    templateComponents: [], //  展示的模板组件集合
                    customComponentIds: [], // 添加的自定义组件id集合(真实id)
                    delTemplateComponentIds: [],    // 待提交后台删除的templateComponentId集合
                    // 父组件id：子组件列表
                    pidChildrenMap: {},
                    currMaxSequence: 0,
                    componentTypeList: [],
                    activeCpTypeIndex: 0,
                    activeCpTypeName: '基本信息',
                    loaded: false,

                    // 大组件删除时用到的临时变量
                    currRemoveItemIndex: null,
                    currRemoveItem: null,

                    currEditIndex: null,    //  当前编辑index，仅限pid为0的组件
                    innerCurrEditIndex: null,   // 编辑报名内组件时，存储报名index
                    fieldIndex: null,   //  当前新增的字段index，仅限basicComponent基础字段

                    isAddComponent: false,  // 是否新增组件
                    addEditItem: {},    // 弹窗编辑实体(text, choose)
                    innerAddEditItem: {},   // 子组件弹窗编辑实体(sign_up_condition, sign_up_fill_info)

                    closeBeforeAddField: false, // 关闭编辑之前是否是添加字段弹框状态
                    dialogTitle: '',    // 弹窗标题
                    delDialog:false,    // 是否确定删除弹框开关
                    addFieldDialog: false,   // 添加字段弹窗开关
                    textDialog: false,   // 文本输入弹窗开关
                    chooseDialog: false, //  选择组件弹窗开关
                    signUpConditionDialog: false, //  报名条件弹窗开关
                    fillInfoDialog: false,  // 报名信息填写弹窗开关
                    defaultTextComponent: {
                        pid: 0,
                        name: '',
                        required: true,
                        templateId: [[${templateId}]],
                        type: 'text'
                    },
                    defaultChooseComponent: {
                        pid: 0,
                        name: '',
                        required: true,
                        templateId: [[${templateId}]],
                        dataOrigin: 'custom',
                        originIdentify: '',
                        fieldFlag: '',
                        type: 'radio',
                        componentFields: [{
                            componentId: '',
                            fieldName: '',
                            sequence: 1
                        }]
                    },
                    // uncheckCode
                    nonDefaultCheckedCodes: ["wfw_participation_scope", "sign_up_condition"],
                    defaultRequiredCodes: ["sign_up_time_scope"],
                    conditionEnums: [[${conditionEnums}]],
                    currFormField: { type: 'input', options: []},
                    // v-model 临时变量
                    scoreNum: 0,
                    baomingzhe:'报名者',
                    radioModel:'1',
                    selectModel: [],
                    activityType:'创新创业',
                    person:'自定义人数',
                    inputModel:'',
                    switchModel: true
                },
                created: function () {
                    var $this = this;
                    $([[${wfwForms}]]).each(function () {
                        this.id = this.id.toString();
                        $this.wfwForms.push(this);
                    });
                    $this.initData();
                },
                mounted: function () {
                    var $this = this;
                    $this.$nextTick(function () {
                        $this.init();
                        $this.fixRightEndBtnStyle();
                        $this.handleJqthumb();
                        $this.initMouseEnterField();
                    })
                },
                methods:{
                    initData: function () {
                        var $this = this;
                        var {template, components, templateComponents} = $this.templateInfo;
                        $this.originTemplateId = template.originTemplateId || template.id;
                        $this.template = template;
                        $(components).each(function () {
                            this.checked = !!($this.nonDefaultCheckedCodes.indexOf(this.code) == -1 && this.pid);
                            // 填充父-子列表映射map数据
                            if (!$this.pidChildrenMap[this.pid]) {
                                $this.pidChildrenMap[this.pid] = [];
                            }
                            $this.pidChildrenMap[this.pid].push(this);
                        });
                        $this.components = components;
                        $(templateComponents).each(function () {
                            $this.innerAttrSupplement(this);
                        });
                        $this.packageTemplateComponents(templateComponents);
                        $this.initComponentTypeList(templateComponents);
                    },
                    // 根据关联关系，处理展示出来的模板组件
                    packageTemplateComponents: function(templateComponents) {
                        var $this = this;
                        var tmpArr = $.extend(true, [], templateComponents);
                        $this.templateComponents = [];
                        // 封装处理展示的templateComponents，并把子组件放入父组件中
                        $(tmpArr).each(function () {
                            var _this = this;
                            if (!_this.pid || _this.pid == 0) {
                                $this.templateComponents.push(_this);
                            }
                            $(tmpArr).each(function () {
                                if (this.pid && this.pid != 0 && _this.id == this.pid) {
                                    if (!_this.children) {
                                        $this.$set(_this, 'children', []);
                                    }
                                    _this.children.push(this);
                                }
                            });
                        });
                    },
                    // 初始化组件类型列表
                    initComponentTypeList: function (templateComponents) {
                        var $this = this;
                        var typeMap = {
                            '0': { type: 'basic_info', name: '基本信息', virtualId: 0, basicCompts: $this.pidChildrenMap[0] || [], advanceCompts: [] }
                        };
                        // 获取已选中的组件id
                        var checkComponentIds = [], tplPids = [];
                        $(templateComponents).each(function () {
                            if (this.pid && this.pid != 0 && tplPids.indexOf(this.pid) == -1) tplPids.push(this.pid);
                            if (checkComponentIds.indexOf(this.componentId) == -1) checkComponentIds.push(this.componentId);
                        });
                        var mainTplComponents = $.grep(templateComponents, function(item) { return tplPids.indexOf(item.id) != -1; });
                        $(mainTplComponents).each(function () {
                            typeMap[this.id] = { type: this.code, name: this.name, virtualId: this.id, basicCompts: $this.pidChildrenMap[this.componentId] || [], advanceCompts: [] }
                        });
                        $.each(typeMap, function (key, item) {
                            var basicCompts = [], advanceCompts = [];
                            $(item.basicCompts).each(function () {
                                this.checked = checkComponentIds.indexOf(this.id) != -1;
                                $this.distributeCompt(this, basicCompts, advanceCompts)
                            });
                            item.basicCompts = basicCompts;
                            item.advanceCompts = advanceCompts;
                            if (key == '0') {
                                item.advanceCompts.push($this.defaultTextComponent, $this.defaultChooseComponent);
                            }
                            $this.componentTypeList.push(item);
                        });
                    },
                    // 创建默认数据
                    createNewTemplateComponent: function (component) {
                        var $this = this;
                        var componentType = $this.componentTypeList[$this.activeCpTypeIndex];
                        ++$this.currMaxSequence;
                        return {
                            id: uuid(),
                            pid: componentType.virtualId,
                            templateId: $this.currTemplateId,
                            componentId: component.id,
                            name: component.name,
                            introduction: component.introduction,
                            required: component.required,
                            sequence: $this.currMaxSequence,
                            code: component.code,
                            type: component.type,
                            dataOrigin: component.dataOrigin,
                            originIdentify: component.originIdentify,
                            fieldFlag: component.fieldFlag
                        };
                    },
                    getInitSignUpCondition: function () {
                        return { fid: this.fid, originIdentify: '', fieldName: '', allowSignedUp: false, configOnActivity: false, templateConditionDetails: [] }
                    },
                    getInitSignUpFillInfoType: function () {
                        return { type: 'form', wfwFormTemplateId: '' }
                    },

                    // 内部属性的判断补充初始化
                    innerAttrSupplement: function (templateComponent) {
                        var $this = this;
                        if (templateComponent.code == 'sign_up_condition' && !templateComponent.signUpCondition) {
                            templateComponent.signUpCondition = $this.getInitSignUpCondition();
                        } else if (templateComponent.code == 'sign_up_fill_info' && !templateComponent.signUpFillInfoType) {
                            templateComponent.signUpFillInfoType = $this.getInitSignUpFillInfoType();
                        }
                    },
                    changeComponentType: function (index) {
                        var $this = this;
                        $this.activeCpTypeIndex = index;
                        $this.activeCpTypeName = $this.componentTypeList[index].name;
                    },
                    changeDataOrigin: function (value) {
                        var $this = this;
                        if (value == 'custom' && !$this.addEditItem.componentFields) {
                            $this.$set($this.addEditItem, 'componentFields', [{
                                componentId: $this.addEditItem.id,
                                fieldName: '',
                                sequence: 1
                            }]);
                        }
                    },
                    loadWfwFormFields: function (formId) {
                        var $this = this;
                        var url = ctx + "/api/wfw-form/" + formId + "/field?fid=" + $this.fid;
                        // 置空
                        $this.wfwFormFields = [];
                        app.ajaxGet(url, function (res) {
                            if (res.success) {
                                $this.resetWfwFormFieldSelected(res.data)
                                $this.wfwFormFields = res.data
                            } else {
                                var errorMessage = res.message;
                                if (activityApp.isEmpty(errorMessage)) {
                                    errorMessage = "加载表单字段失败";
                                }
                                app.showMsg(errorMessage);
                            }
                        }, function () {
                            app.showMsg("加载表单字段失败");
                        });
                    },
                    // 打开添加字段弹框
                    openAddFieldDialog: function () {
                        var $this = this;
                        $this.addFieldDialog = true;
                        $this.closeBeforeAddField = true;
                    },
                    // 关闭添加字段弹框
                    closeAddFieldDialog: function () {
                        var $this = this; $this.addFieldDialog = false; $this.closeBeforeAddField = false;
                    },
                    // 基础字段添加到模板 --> 基础字段 or 报名子组件
                    addBasicComponentAssociate: function (index, item) {
                        var $this = this;
                        $this.fieldIndex = index;
                        $this.isAddComponent = true;
                        if (item.code == 'activity_release_scope' || item.code == 'company_sign_up') {
                            $this.openTextDialog(item);
                        } else if (item.code == 'sign_up_fill_info') {
                            $this.setDialogTitle(item, '报名信息填写')
                            $this.addFieldDialog = false;
                            $this.fillInfoDialog = true;
                            $this.addEditItem = $this.createNewTemplateComponent(item);
                            $this.innerAddEditItem = $this.getInitSignUpFillInfoType();
                        } else {
                            var newTemplateComponent = $this.createNewTemplateComponent(item);
                            if (item.pid == 0) {
                                $this.templateComponents.push(newTemplateComponent);
                            } else {
                                $this.addSignUpChildComponentAssociate(newTemplateComponent);
                            }
                            $this.handleJqthumb();
                            $this.setBasicComptChecked(index);
                            $this.isAddComponent = false;
                        }
                    },
                    // 高级字段添加
                    addAdvanceComponentAssociate: function (item) {
                        var $this = this;
                        $this.isAddComponent = true;
                        if (item.code == 'sign_up' || item.code == 'partition' || item.type == 'text' || item.type == 'int' || item.type == 'decimal') {
                            $this.openTextDialog(item)
                        } else if (item.code == 'sign_up_condition') {
                            $this.setDialogTitle(item, '报名条件')
                            $this.addFieldDialog = false;
                            $this.signUpConditionDialog = true;
                            $this.addEditItem = $this.createNewTemplateComponent(item);
                            $this.innerAddEditItem = $this.getInitSignUpCondition();
                        } else if (item.type == 'radio' || item.type == 'checkbox') {
                            $this.openChooseEditDialog(item);
                        }
                    },
                    setDialogTitle: function (item, defaultTitle) {
                        var $this = this;
                        // 不存在componentId， 则item为component
                        if (!item.componentId) {
                            $this.dialogTitle = (item && item.name) || defaultTitle;
                            return ;
                        }
                        var component = $.grep($this.components, function (it) { return it.id == item.componentId; })[0];
                        $this.dialogTitle = (component && component.name) || defaultTitle;

                    },
                    // 字段弹框中的index
                    setBasicComptChecked: function (index) {
                        if (!index && index != 0) {
                            return;
                        }
                        var $this = this;
                        var componentType = $this.componentTypeList[$this.activeCpTypeIndex];
                        $this.$set(componentType.basicCompts[index], 'checked', true);
                    },
                    cancelBasicComptChecked: function (virtualId, targetComponentId) {
                        var $this = this;
                        var componentType = $.grep($this.componentTypeList, function (it) {
                            return it.virtualId == virtualId;
                        })[0];
                        $(componentType.basicCompts).each(function () {
                            if (this.id == targetComponentId) {
                                this.checked = false;
                            }
                        });
                    },
                    // 分配组件
                    distributeCompt: function (component, basicCompts, advanceCompts) {
                        if (component.multi) {
                            advanceCompts.push(component);
                        } else {
                            basicCompts.push(component);
                        }
                    },
                    // 新增报名组件
                    addSignUpComponentAssociate: function () {
                        var $this = this;
                        var signUpId = $this.addEditItem.id, signUpComponentId = $this.addEditItem.componentId
                        var basicCompts = [], advanceCompts = [], tplComponentChildren = [], childIdx = 1;
                        // 拷贝一份子组件出来
                        $($.extend(true, [], $this.pidChildrenMap[signUpComponentId])).each(function () {
                            if (this.checked) {
                                var childTplComponent = {
                                    id: uuid(),
                                    pid: signUpId,
                                    templateId: $this.currTemplateId,
                                    componentId: this.id,
                                    name: this.name,
                                    introduction: this.introduction,
                                    required: $this.defaultRequiredCodes.indexOf(this.code) != -1,
                                    sequence: childIdx++,
                                    code: this.code,
                                    type: this.type
                                };
                                $this.innerAttrSupplement(childTplComponent);
                                tplComponentChildren.push(childTplComponent);
                            }
                            $this.distributeCompt(this, basicCompts, advanceCompts)
                        });
                        $this.$set($this.addEditItem, 'children', tplComponentChildren);
                        $this.templateComponents.push($this.addEditItem);
                        // 将报名添加到分类中
                        $this.componentTypeList.push({
                            name: $this.addEditItem.name,
                            type: $this.addEditItem.code,
                            virtualId: $this.addEditItem.id,
                            basicCompts: basicCompts,
                            advanceCompts: advanceCompts
                        });
                        app.showMsg("添加成功");
                    },
                    // 报名子组件的添加
                    addSignUpChildComponentAssociate: function (templateComponent) {
                        var $this = this;
                        $($this.templateComponents).each(function () {
                            if (this.id == templateComponent.pid) {
                                if (!this.children) {
                                    $this.$set(this, 'children', [])
                                }
                                this.children.push(templateComponent);
                                return false;
                            }
                        });
                        if (templateComponent.code == 'sign_up_fill_info') {
                            $this.setBasicComptChecked($this.fieldIndex);
                        }
                    },
                    // 打开文本字段弹窗
                    openTextDialog: function (item, index) {
                        var $this = this;
                        $this.setDialogTitle(item, "自定义输入")
                        $this.addFieldDialog = false;
                        $this.textDialog = true;
                        if (item.code == 'activity_release_scope' && !item.dataOrigin) {
                            item.dataOrigin = '';
                            item.originIdentify = '';
                        }
                        if ($this.isAddComponent) {
                            // type存在时，则为自定义文本；type不存在时，则可能为activity_release_scope、sign_up、company_sign_up等
                            $this.addEditItem = !item.type ? $this.createNewTemplateComponent(item) : $this.createDefaultEditItem(item.type)
                            return;
                        }
                        // 编辑操作
                        $this.currEditIndex = index;
                        $this.addEditItem = (item.type == 'text' || item.type == 'int' || item.type == 'decimal')
                            ? $.extend({}, $.grep($this.components, function (it) { return it.id == item.componentId; })[0])
                            : $this.addEditItem = $.extend({}, item);
                    },
                    // 打开选择字段弹窗
                    openChooseEditDialog: function (item, index) {
                        var $this = this;
                        $this.setDialogTitle(item, "自定义选择");
                        $this.addFieldDialog = false;
                        $this.chooseDialog = true;
                        if ($this.isAddComponent) {
                            $this.addEditItem = $this.createDefaultEditItem(item.type, item.dataOrigin, true);
                            return;
                        }
                        $this.currEditIndex = index;
                        var cmp = $.grep($this.components, function (it) { return it.id == item.componentId; })[0];
                        $this.addEditItem = $.extend({}, cmp);
                        if ($this.addEditItem.originIdentify) {
                            $this.loadWfwFormFields($this.addEditItem.originIdentify)
                        }
                    },
                    // 主界面编辑时用到的统一弹窗方法
                    // index -> templateComponents[index], item -> templateComponent
                    openEditDialog: function (index, item) {
                        var $this = this;
                        if (item.type == 'radio' || item.type == 'checkbox') {
                            $this.openChooseEditDialog(item, index);
                        } else {
                            $this.openTextDialog(item, index);
                        }
                    },
                    // 报名组件中的编辑
                    // index -> templateComponents[index], idx -> templateComponents[index].children[idx]， item -> templateComponent
                    openEditDialog1: function (index, idx, item) {
                        var $this = this;
                        if (item.code == 'sign_up_condition' || item.code == 'sign_up_fill_info') {
                            $this.openChildComponentDialog(index, item, idx);
                        } else {    // 这里只存在报名的系统组件，不存在自定义组件
                            $this.innerCurrEditIndex = idx;
                            $this.openTextDialog(item, index);
                        }
                    },
                    // 打开报名条件弹窗， 当 idx为undefined 时，是添加模板关联组件处新增报名条件， 此时 item: Component, 反之为 TemplateComponent
                    openChildComponentDialog: function (index, item, idx) {
                        var $this = this;
                        $this.addFieldDialog = false;
                        if (item.code == 'sign_up_condition') {
                            $this.setDialogTitle(item, '报名条件')
                            $this.signUpConditionDialog = true;
                        } else if (item.code == 'sign_up_fill_info') {
                            $this.setDialogTitle(item, '报名信息填写')
                            $this.fillInfoDialog = true;
                        }
                        $this.addEditItem = $.extend({}, $this.templateComponents[index].children[idx]);
                        if (item.code == "sign_up_condition") {
                            $this.innerAddEditItem = $this.addEditItem.signUpCondition;
                            if ($this.innerAddEditItem.originIdentify) {
                                $this.loadWfwFormFields($this.innerAddEditItem.originIdentify)
                            }
                        } else if (item.code == "sign_up_fill_info") {
                            $this.innerAddEditItem = $this.addEditItem.signUpFillInfoType;
                        }
                        $this.currEditIndex = index;
                        $this.innerCurrEditIndex = idx;
                    },
                    confirmEditText: function () {
                        var $this = this;
                        if (!$this.addEditItem.name && $this.addEditItem.code != 'partition') {
                            app.showMsg("字段标题未填");
                            return;
                        }
                        if ($this.addEditItem.code == 'activity_release_scope' && $this.addEditItem.dataOrigin == 'interface' && activityApp.isEmpty($this.addEditItem.originIdentify)) {
                            app.showMsg("发布范围接口地址未填");
                            return;
                        }
                        if ($this.addEditItem.type == 'text' || $this.addEditItem.type == 'int' || $this.addEditItem.type == 'decimal') {
                            // 自定义文本组件新增、编辑，需要处理
                            $this.submitCustomComponent($this.addEditItem)
                            return;
                        }
                        if ($this.isAddComponent) {
                            if ($this.addEditItem.code == 'activity_release_scope' || $this.addEditItem.code == 'partition') {
                                $this.templateComponents.push($this.addEditItem);
                            } else if ($this.addEditItem.code == 'sign_up' || $this.addEditItem.code == 'company_sign_up') {
                                $this.addSignUpComponentAssociate();
                            }
                            $this.setBasicComptChecked($this.fieldIndex)
                            $this.initEditData();
                            return;
                        }
                        if ($this.innerCurrEditIndex || $this.innerCurrEditIndex == 0) {
                            $this.templateComponents[$this.currEditIndex].children[$this.innerCurrEditIndex] = $.extend({}, $this.addEditItem);
                            $this.initEditData();
                            return;
                        }
                        // 普通文本编辑，不提交结果
                        $this.templateComponents[$this.currEditIndex] = $.extend({}, $this.addEditItem);
                        // 如果是报名，需要更新类型列表的名字
                        if ($this.addEditItem.code == 'sign_up' || $this.addEditItem.code == 'company_sign_up') {
                            var componentType = $.grep($this.componentTypeList, function (it, index) {
                                return it.virtualId == $this.addEditItem.id;
                            })[0];
                            componentType.name = $this.addEditItem.name;
                        }
                        $this.initEditData();
                    },
                    confirmChooseEdit: function () {
                        var $this = this;
                        if (!$this.addEditItem.name) {
                            return;
                        }
                        if ($this.addEditItem.dataOrigin == 'custom') {
                            $this.addEditItem.originIdentify = null;
                            $this.addEditItem.fieldFlag = null;
                        } else {
                            $this.addEditItem.componentFields = null;
                        }
                        // 自定义选择组件，需要实时处理
                        $this.submitCustomComponent($this.addEditItem);
                    },
                    confirmChildrenComponentEdit: function (code) {
                        var $this = this;
                        if (code == "sign_up_condition") {
                            var validCondition = $this.validateSignUpCondition();
                            if (!validCondition) {
                                return;
                            }
                            $this.addEditItem.signUpCondition = $this.innerAddEditItem;
                        } else if (code == "sign_up_fill_info") {
                            $this.addEditItem.signUpFillInfoType = $this.innerAddEditItem;
                        }
                        if ($this.isAddComponent) {
                            $this.addSignUpChildComponentAssociate($this.addEditItem);
                            app.showMsg("已添加");
                        } else {
                            $this.templateComponents[$this.currEditIndex].children[$this.innerCurrEditIndex] = $.extend({}, $this.addEditItem);
                        }
                        $this.initEditData();
                    },
                    // 校验报名条件填写内容是否合格
                    validateSignUpCondition: function () {
                        var $this = this;
                        if (!$this.innerAddEditItem.allowSignedUp) {
                            // xxx, 不存在
                            $this.innerAddEditItem.configOnActivity = false;
                            $this.innerAddEditItem.templateConditionDetails = [];
                            return true;
                        }
                        var templateConditionDetails = $this.innerAddEditItem.templateConditionDetails;
                        if ($this.innerAddEditItem.configOnActivity) {
                            if (templateConditionDetails && templateConditionDetails.length > 0) {
                                $(templateConditionDetails).each(function () {
                                    this.condition = '';
                                    this.value = '';
                                });
                            }
                            return true;
                        }
                        for (var i = 0; i < templateConditionDetails.length; i++) {
                            if (!templateConditionDetails[i].fieldName) {
                                app.showMsg("请选择条件字段")
                                return false;
                            }
                            if (!templateConditionDetails[i].condition) {
                                app.showMsg(templateConditionDetails[i].fieldName + "条件不能为空")
                                return false;
                            }
                        }
                        return true;
                    },
                    // 配置页面基础信息关联移除操作 --> 主要针对 pid = 0 item : templateComponent
                    removeComponentAssociate1: function (index, item) {
                        var $this = this;
                        if (typeof item.id == 'number') {
                            $this.delTemplateComponentIds.push(item.id);
                        }
                        // 移除展示模板组件关联记录
                        $this.templateComponents.splice(index, 1);
                        // 如果是报名组件，则需要继续移除它的子组件
                        if (item.code == 'sign_up' || item.code == 'company_sign_up') {
                            $(item.children).each(function () {
                                if (typeof this.id == 'number') {
                                    $this.delTemplateComponentIds.push(this.id);
                                }
                            });
                            // 也需要移除分类中的列表
                            $this.componentTypeList = $.grep($this.componentTypeList, function (it) {
                                return it.virtualId != item.id;
                            });
                            return;
                        }
                        // 非报名组件
                        $this.cancelBasicComptChecked(0, item.componentId);
                        $this.handleJqthumb();
                    },
                    // 配置页面报名信息关联移除操作 --> 主要针对 pid != 0
                    // index -> templateComponents[index], idx -> templateComponents[index].children[idx]  item -> templateComponent
                    removeComponentAssociate2: function (index, idx, item) {
                        var $this = this;
                        // 移除展示模板组件关联记录
                        var id = $this.templateComponents[index].children[idx].id;
                        if (typeof id == 'number') {
                            $this.delTemplateComponentIds.push(id);
                        }
                        $this.templateComponents[index].children.splice(idx, 1);
                        $this.$forceUpdate();   // 层级过深，删除双向绑定失效，通过forceUpdate重新渲染

                        $this.cancelBasicComptChecked(item.pid, item.componentId);
                    },
                    // 打开报名组件删除确认弹窗 item : templateComponent
                    openSignUpRemoveDialog: function (index, item) {
                        var $this = this;
                        $this.delDialog = true;
                        $this.currRemoveItem = item;
                        $this.currRemoveItemIndex = index;
                    },
                    // 保留
                    cancelRemoveSignUpRemove: function () {
                        var $this = this;
                        $this.delDialog = false;
                        $this.currRemoveItem = null;
                        $this.currRemoveItemIndex = null;
                    },
                    // 确定删除
                    confirmSignUpRemove: function () {
                        var $this = this;
                        $this.removeComponentAssociate1($this.currRemoveItemIndex, $this.currRemoveItem);
                        $this.currRemoveItem = null;
                        $this.currRemoveItemIndex = null;
                        $this.delDialog = false;
                    },
                    createDefaultEditItem: function (type, dataOrigin, initComponentFields) {
                        return {
                            pid: 0,
                            name: '',
                            required: true,
                            templateId: [[${templateId}]],
                            dataOrigin: dataOrigin,
                            originIdentify: '',
                            fieldFlag: '',
                            type: type,
                            componentFields: !initComponentFields ? null : [{
                                componentId: '',
                                fieldName: '',
                                sequence: 1
                            }]
                        }
                    },
                    addEditItemFields: function () {
                        var $this = this;
                        var fieldsLength = $this.addEditItem.componentFields.length;
                        $this.addEditItem.componentFields.push({
                            componentId: $this.addEditItem.id,
                            fieldName: '',
                            sequence: fieldsLength + 1
                        });
                    },
                    delEditItemFields: function (index) {
                        var $this = this;
                        if ($this.addEditItem.componentFields.length > 1) {
                            $this.addEditItem.componentFields.splice(index, 1);
                        }
                    },
                    initEditData: function () {
                        var $this = this;
                        // 初始化编辑
                        $this.isAddComponent = false;
                        $this.textDialog = false;
                        $this.chooseDialog = false;
                        $this.signUpConditionDialog = false;
                        $this.fillInfoDialog = false;
                        $this.dialogTitle = "";
                        $this.currEditIndex = null;
                        $this.fieldIndex = null;
                        $this.innerCurrEditIndex = null;
                        $this.addEditItem = {};
                        $this.innerAddEditItem = {};
                        // 回到添加字段页面
                        $this.addFieldDialog = $this.closeBeforeAddField;
                    },
                    submitCustomComponent: function (waitSubmitItem) {
                        var $this = this;
                        var url = ctx + "/api/activity/engine/component/submit";
                        var isAdd = !waitSubmitItem.id;
                        app.ajaxPost(url, { componentStr: activityApp.getJsonStr(waitSubmitItem) }, function (res) {
                            if (res.success) {
                                var component = res.data
                                if (isAdd) {
                                    // 针对数据新增之后处理
                                    $this.addedComponent(component);
                                } else {
                                    // 针对数据更新之后处理
                                    component.checked = true;
                                    $this.editedComponent(component);
                                }
                                $this.initEditData();
                            } else {
                                var errorMessage = res.message;
                                if (activityApp.isEmpty(errorMessage)) {
                                    errorMessage = "保存自定义组件失败";
                                }
                                app.showMsg(errorMessage);
                            }
                        }, function () {
                            app.showMsg("保存自定义组件失败");
                        });
                    },
                    // 自定义组件新增后续处理
                    addedComponent: function (component) {
                        var $this = this;
                        component.checked = true;
                        $this.components.push(component);
                        var componentType = $.grep($this.componentTypeList, function (it) { return it.virtualId == 0; })[0];
                        componentType.basicCompts.push(component);
                        $this.addBasicComponentAssociate(componentType.basicCompts.length - 1, component);
                        $this.customComponentIds.push(component.id);
                    },
                    // 自定义组件更新后续处理
                    editedComponent: function (component) {
                        var $this = this;
                        var componentType = $.grep($this.componentTypeList, function (it) { return it.virtualId == 0; })[0];
                        var components = componentType.basicCompts, i;
                        for (i = 0; i < components.length; i++) {
                            if (components[i].id == component.id) {
                                components[i] = component;
                                break;
                            }
                        }
                        for (i = 0; i < $this.components.length; i++) {
                            if ($this.components[i].id == component.id) {
                                $this.components[i] = component;
                                break;
                            }
                        }
                        var updatedAttrs = {
                            name: component.name,
                            introduction: component.introduction,
                            required: component.required,
                            code: component.code,
                            type: component.type,
                            dataOrigin: component.dataOrigin,
                            originIdentify: component.originIdentify,
                            fieldFlag: component.fieldFlag
                        };
                        $this.templateComponents[$this.currEditIndex] = $.extend({}, $this.templateComponents[$this.currEditIndex], updatedAttrs);
                    },
                    // 返回
                    returnBack: function () {
                        window.location.reload();
                    },
                    // 排序
                    sortTplComponent: function () {
                        var $this = this;
                        var sortedMap = {}, insideSortedMap= {}, sequenceMap = {};
                        var sequence = 0;
                        $.each($(".icon-drag[id-key]"), function () {
                            var idKey = $(this).attr("id-key");
                            sortedMap[idKey] = sequence;
                            sequence++;
                        });
                        $.each($(".icon-drag-inner[id-key]"), function () {
                            var idKey = $(this).attr("id-key");
                            var pidKey = $(this).attr("pid-key");
                            if (!insideSortedMap[pidKey]) {
                                insideSortedMap[pidKey] = {};
                                sequenceMap[pidKey] = 0;
                            }
                            insideSortedMap[pidKey][idKey] = sequenceMap[pidKey];
                            sequenceMap[pidKey]++;
                        });
                        $.each($this.templateComponents, function () {
                            var _this = this;
                            _this.sequence = sortedMap[_this.id];
                            if (_this.children) {
                                $.each(_this.children, function () {
                                    this.sequence = insideSortedMap[_this.id][this.id];
                                });
                            }
                        });
                    },
                    // 发布数据
                    publish: function () {
                        var $this = this;
                        var submitData = $this.packageData();
                        var url = ctx + "/api/activity/engine/market/" + $this.marketId + "/template/publish";
                        var param = {
                            fid: $this.fid,
                            templateInfoStr: activityApp.getJsonStr(submitData)
                        }
                        app.ajaxPost(url, param, function (res) {
                            if (res.success) {
                                app.showMsg("发布成功", function () {
                                    $this.closePage();
                                });
                            } else {
                                var errorMessage = res.message;
                                if (activityApp.isEmpty(errorMessage)) {
                                    errorMessage = "发布失败";
                                }
                                app.showMsg(errorMessage);
                            }
                        }, function () {
                            app.showMsg("发布失败");
                        });
                    },
                    closePage: function () {
                        window.close();
                    },
                    packageData: function () {
                        var $this = this;
                        var template = $.extend({}, $this.template, { originTemplateId: $this.originTemplateId });
                        var templateComponents = [];
                        // 进行排序
                        $this.sortTplComponent();
                        $($this.templateComponents).each(function () {
                            var _this = this;
                            var newChildren;
                            if (_this.children) {
                                newChildren = [];
                                $(_this.children).each(function () {
                                    var childId = this.id && typeof this.id == 'string' && this.id.indexOf('-') != -1 ? null : this.id;
                                    var childPId = this.pid && typeof this.pid == 'string' && this.pid.indexOf('-') != -1 ? null : this.pid;
                                    newChildren.push({
                                        id: childId,
                                        templateId: $this.currTemplateId,
                                        componentId: this.componentId,
                                        pid: childPId,
                                        name: this.name,
                                        introduction: this.introduction,
                                        required: this.required,
                                        sequence: this.sequence,
                                        children: this.children,
                                        signUpCondition: this.signUpCondition,
                                        signUpFillInfoType: this.signUpFillInfoType
                                    })
                                })
                            }
                            var tmpId = _this.id && typeof _this.id == 'string' && _this.id.indexOf('-') != -1 ? null : _this.id;
                            var tmpPid = _this.pid && typeof _this.pid == 'string' && _this.pid.indexOf('-') != -1 ? null : _this.pid;
                            templateComponents.push({
                                id: tmpId,
                                templateId: $this.currTemplateId,
                                componentId: _this.componentId,
                                pid: tmpPid,
                                name: _this.name,
                                introduction: _this.introduction,
                                required: _this.required,
                                sequence: _this.sequence,
                                type: _this.type,
                                dataOrigin: _this.dataOrigin,
                                originIdentify: _this.originIdentify,
                                fieldFlag: _this.fieldFlag,
                                children: newChildren
                            });
                        });
                        return {
                            template: template,
                            customComponentIds: $this.customComponentIds,
                            templateComponents: templateComponents,
                            delTemplateComponentIds: $this.delTemplateComponentIds
                        }
                    },
                    init: function () {
                        var $this = this;
                        $("#drag-box").sortable({
                            scroll: true,
                            axis: "y",
                            delay: 300,
                            handle: ".icon-drag",
                            start: function (e1, e2) {
                                $("#dragBubble").hide()
                            }
                        });
                        $("#drag-box-inner").sortable({
                            scroll: true,
                            axis: "y",
                            delay: 300,
                            handle: ".icon-drag-inner",
                            start: function (e1, e2) {
                                // $("#dragBubble").hide()
                            }
                        });
                        $('.icon-drag').on('mouseenter', function (e) {
                            var $event = $(e.target);
                            var top = $event.offset().top - 39;
                            var left = $event.offset().left - 40;
                            $('#dragBubble').css({
                                top: top,
                                left: left
                            }).show()
                        })
                        $('.icon-drag').on('mouseleave', function (e) {
                            $('#dragBubble').hide()
                        })
                    },
                    initMouseEnterField: function () {
                        var $this = this;
                        $this.$nextTick(function () {
                            $('.field-item').mouseenter(function() {
                                if($(this).hasClass('aready-add')){
                                    $(this).find('.remove').show()
                                    $(this).find('.aready').hide()
                                }
                            });
                            $('.field-item').mouseleave(function() {
                                if($(this).hasClass('aready-add')){
                                    $(this).find('.remove').hide()
                                    $(this).find('.aready').show()
                                }
                            });
                        });
                    },
                    // 调整右下角加号位置
                    fixRightEndBtnStyle: function () {
                        /* 右下角加号的位置 */
                        var right = $('.w-900px.info-box').offset().left + 50
                        $('#add-circle').css('right', right)
                        $(window).resize(function () {
                            var right = $('.w-900px.info-box').offset().left + 50
                            $('#add-circle').css('right', right)
                        })
                    },
                    handleJqthumb: function () {
                        $('.jqthumbImg').jqthumb({
                            width: '100%',
                            height: '100%'
                        });
                    },
                    showToast(){
                        $('.toast-box').fadeIn();
                        setTimeout(function () {
                            $('.toast-box').fadeOut();
                        }, 1500)
                    },
                    addConditionDetail: function () {
                        var $this = this;
                        var tplComponentId = typeof $this.addEditItem.id == 'number' ? $this.addEditItem.id : ''
                        $this.innerAddEditItem.templateConditionDetails.push({
                            templateComponentId: tplComponentId,
                            fieldName: '',
                            condition: '',
                            value: ''
                        })
                    },
                    resetWfwFormFieldSelected: function (wfwFormFields) {
                        var $this = this;
                        if (!wfwFormFields) {
                            return;
                        }
                        var existFieldNames = [];
                        var conditionDetails = $this.innerAddEditItem && $this.innerAddEditItem.templateConditionDetails;
                        if (conditionDetails) {
                            $(conditionDetails).each(function () {
                                existFieldNames.push(this.fieldName);
                            });
                        }
                        $(wfwFormFields).each(function() {
                            this.selected = existFieldNames.includes(this.name);
                        });
                    },
                    conditionFieldChange: function (value) {
                        var $this = this;
                        $this.resetWfwFormFieldSelected($this.wfwFormFields);

                        var fields = $.grep($this.wfwFormFields, function(item) { return item.name == value; });
                        var field = (fields && fields[0]) || {}
                        if (field.compt == 'selectbox') {
                            $this.currFormField.type = 'select';
                            $this.currFormField.options = field.options || [];
                            return;
                        }
                        $this.currFormField.type = 'input';
                        $this.currFormField.options = [];
                    },
                    removeConditionDetail: function (index) {
                        var $this = this;
                        $this.innerAddEditItem.templateConditionDetails.splice(index, 1);
                    }
                }
            })
        </script>
    </div>
</body>
</html>