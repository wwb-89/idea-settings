<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org/">
<head>
    <title>字段设置</title>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="/static/pc/assets/lib/element-ui/lib/theme-chalk/index.css" th:href="@{/pc/assets/lib/element-ui/lib/theme-chalk/index.css}">
    <link rel="stylesheet" href="/static/pc/assets/css/public.css" th:href="@{/pc/assets/css/public.css}">
    <link rel="stylesheet" href="/static/pc/assets/css/engine-design.css" th:href="@{/pc/assets/css/engine-design.css}">
</head>
<body>
    <div class="field-setting" id="field-setting" v-cloak>
        <div class="top-con">
            <div class="go-back white-border-btn" v-if="loaded && currTemplateId" @click="returnBack"><i></i><span>返回</span></div>
            <div class="step-box">
                <img src="/static/pc/assets/images/yq-design/step2-active.png" th:src="@{/pc/assets/images/yq-design/step2-active.png}" alt="">
                <img src="/static/pc/assets/images/yq-design/step3-normal.png" th:src="@{/pc/assets/images/yq-design/step3-normal.png}" alt="">
            </div>
            <div class="look-div fr">
<!--                <div class="btn-width80px-color1">预览</div>-->
                <div class="btn-width80px-color2" v-if="loaded && currTemplateId" @click="publish">发布</div>
            </div>
        </div>
        <div class="content">
            <div class="w-900px choose-mould" v-show="!loaded || !currTemplateId">
                <p class="title">请选择模版</p>
                <ul class="mould">
                    <li class="mould-item" v-for="template in templates" @click="templateChange(template.id)">
                        <div class="img-box"><img src="/static/pc/assets/images/yq-design/cover.png" th:src="@{/pc/assets/images/yq-design/cover.png}" alt=""></div>
                        <p>{{template.name}}</p>
                    </li>
                </ul>
            </div>
            <div class="w-900px info-box" style="display: block;" v-show="currTemplateId && loaded">
                <form action="" id="drag-box">
                    <!-- 基本信息 -->
                    <div class="title">
                        <div class="lable">基本信息</div>
                    </div>
                    <template v-for="(item, index) in showTemplateComponents">
                        <div class="form-item sort-item" v-if="!['activity_address', 'company_sign_up', 'sign_up', 'sign_in', 'sign_out', 'work', 'introduction'].includes(item.code)">
                            <i class="icon-drag"></i>
                            <div class="icon-div">
                                <i class="icon-edit" @click="openEditDialog(index, item)"></i>
                                <i class="icon-delete" v-show="!item.required" @click="removeComponent1(index, item)"></i>
                            </div>
                            <label :class="{ label: true, required: item.required }">{{item.name}}</label>
                            <div class="input-box">
                                <!-- 活动名称：activity_name -->
                                <el-input v-if="item.code == 'activity_name'" type="text" placeholder="请填写" maxlength="20" show-word-limit readonly></el-input>
                                <!-- 主办方：activity_organisers -->
                                <el-input v-else-if="item.code == 'activity_organisers'" style="width: 400px" type="text" placeholder="请填写主办方" maxlength="20" readonly></el-input>
                                <!-- 活动时间：activity_time_scope -->
                                <template v-else-if="item.code == 'activity_time_scope'">
                                    <el-date-picker type="daterange"
                                                    start-placeholder="开始时间"
                                                    end-placeholder="结束时间"
                                                    format="yyyy-MM-dd"
                                                    value-format="yyyy-MM-dd"
                                                    prefix-icon="disable"
                                                    clear-icon="disable"
                                                    unlink-panels
                                                    readonly>
                                        <img style="margin: 0 8px;" slot="range-separator" src="/static/pc/assets/images/swap-right.png" th:src="@{/pc/assets/images/swap-right.png}">
                                    </el-date-picker>
                                    <span class="date-piker-icon"><img src="/static/pc/assets/images/calendar.png" th:src="@{/pc/assets/images/calendar.png}"></span>
                                </template>
                                <!-- 活动封面：activity_cover -->
                                <template v-else-if="item.code == 'activity_cover'">
                                    <div class="img-box">
                                        <img src="/static/pc/assets/images/img.png" th:src="@{/pc/assets/images/img.png}" alt="" class="cover-img jqthumbImg">
                                    </div>
                                    <div class="font-box">
                                        <p>建议尺寸：1080x500</p>
                                        <p>大小：小于5M</p>
                                        <p>格式：jpg、png、gif</p>
                                        <div class="blue-border-btn upload">上传文件</div>
                                    </div>
                                </template>
                                <!-- 活动形式：activity_type -->
                                <template v-else-if="item.code == 'activity_type'">
                                    <div>
                                        <el-radio v-model="radio1" label="1" name="active-type" class="radio-item" readonly>线下活动</el-radio>
                                        <el-radio label="2" name="active-type" class="radio-item" readonly>线上活动</el-radio>
                                    </div>
                                    <div class="address-box">
                                        <el-input type="text" placeholder="请输入活动地点" autocomplete="off" class="address-input" readonly></el-input>
                                        <img src="/static/pc/assets/images/location.png" th:src="@{/pc/assets/images/location.png}" alt="" class="address-icon">
                                        <el-input type="text" placeholder="详细地址，例：E5栋1308室" autocomplete="off" class="detaile-address" readonly></el-input>
                                    </div>
                                </template>
                                <!-- 活动类型：activity_classify -->
                                <template v-else-if="item.code == 'activity_classify'">
                                    <el-input type="text" v-model="activityType" placeholder="请选择" autocomplete="off" class="select-input" readonly></el-input>
                                    <img src="/static/pc/assets/images/yq-design/arrow-down-small.png" th:src="@{/pc/assets/images/yq-design/arrow-down-small.png}" alt="" class="arrow-down">
                                    <p class="tips first">{{item.introduction}}</p>
                                </template>
                                <!-- 标签：tags -->
                                <template v-else-if="item.code == 'tags'">
                                    <div class="type-item">
                                        <i class="add_btn"></i>新增
                                    </div>
                                </template>
                                <!-- 发布范围：activity_release_scope -->
                                <template v-else-if="item.code == 'activity_release_scope'">
                                    <div class="type-item">
                                        <div class="add_btn"></div>选择
                                    </div>
                                </template>
                                <!-- 定时发布：timing_release -->
                                <template v-else-if="item.code == 'timing_release'">
                                    <el-switch class="switch fl marginTop6" disabled></el-switch>
                                    <p class="tips third">开启后，可以按照设置的时间自动发布活动</p>
                                </template>
                                <!-- 简介：introduction -->
<!--                                <template v-else-if="item.code == 'introduction'">-->
<!--                                    <div class="wrap ueditor">-->
<!--                                        <script type="text/plain" id="container" name="content"></script>-->
<!--                                    </div>-->
<!--                                </template>-->
                            </div>
                        </div>
                        <!-- 特殊活动报名设置 -->
                        <template v-else-if="item.code == 'company_sign_up' || item.code == 'sign_up'">
                            <div class="title sort-item">
                                <i class="icon-drag"></i>
                                <div class="lable">{{item.name}}</div>
                                <div class="icon-div">
                                    <i class="icon-edit" @click="openEditDialog(index, item)"></i>
                                    <i class="icon-delete" @click="removeComponent2(index, item)"></i>
                                </div>
                                <div class="input-box">
                                    <el-switch v-model="delivery1" class="switch fl marginTop6" disabled></el-switch>
                                    <p class="tips second">{{item.introduction}}</p>
                                </div>
                            </div>
                            <div class="form-item sort-item" v-if="item.children && item.children.length > 0" v-for="(it, idx) in item.children">
                                <i class="icon-drag"></i>
                                <div class="icon-div">
                                    <i class="icon-edit" @click="openEditDialog(index, it, idx)"></i>
                                    <i class="icon-delete" v-show="!it.required" @click="removeComponent3(index, idx, it)"></i>
                                </div>
                                <label :class="{ label: true, required: it.required }">{{it.name}}</label>
                                <div class="input-box">
                                    <template v-if="it.code == 'sign_up_time_scope'">
                                        <el-date-picker type="daterange"
                                                        start-placeholder="开始时间"
                                                        end-placeholder="结束时间"
                                                        format="yyyy-MM-dd"
                                                        value-format="yyyy-MM-dd"
                                                        prefix-icon="disable"
                                                        clear-icon="disable"
                                                        unlink-panels
                                                        readonly>
                                            <img style="margin: 0 8px;" slot="range-separator" src="/static/pc/assets/images/swap-right.png" th:src="@{/pc/assets/images/swap-right.png}">
                                        </el-date-picker>
                                        <span class="date-piker-icon"><img src="/static/pc/assets/images/calendar.png" th:src="@{/pc/assets/images/calendar.png}"></span>
                                    </template>
                                    <template v-else-if="it.code == 'wfw_participation_scope'">
                                        <div class="type-item">
                                            <div class="add_btn"></div>选择
                                        </div>
                                    </template>
                                    <template v-else-if="it.code == 'contacts_participation_scope'">
                                        <div class="type-item">
                                            <div class="add_btn"></div>选择
                                        </div>
                                    </template>
                                    <template v-else-if="it.code == 'sign_up_person_limit'">
                                        <el-input type="text" v-model="person" placeholder="请选择" autocomplete="off" class="select-input" readonly></el-input>
                                        <img src="/static/pc/assets/images/yq-design/arrow-down-small.png" th:src="@{/pc/assets/images/yq-design/arrow-down-small.png}" alt="" class="arrow-down">
                                        <div class="person-box">
                                            <el-input type="number" placeholder="请输入正整数" readonly></el-input>
                                            <span class="person-span">人</span>
                                        </div>
                                    </template>
                                    <template v-else-if="it.code == 'sign_up_fill_info'">
                                        <el-switch class="switch fl marginTop6" disabled></el-switch>
                                        <p class="tips third">开启后，报名者需填写信息</p>
                                    </template>
                                    <template v-else-if="it.code == 'sign_up_review'">
                                        <el-switch class="switch fl marginTop6" disabled></el-switch>
                                        <p class="tips third">开启后，参与需发起人审核</p>
                                    </template>
                                    <template v-else-if="it.code == 'sign_up_public_list'">
                                        <el-switch class="switch fl marginTop6" disabled></el-switch>
                                        <p class="tips third">开启后，所有人都能看到报名人员名单</p>
                                    </template>
                                    <template v-else-if="it.code == 'sign_up_cancel_signed_up'">
                                        <el-switch class="switch fl marginTop6" disabled></el-switch>
                                        <p class="tips third">开启后，报名结束后参与者不能取消报名</p>
                                    </template>
                                </div>
                            </div>
                        </template>
                        <!-- 签到设置 -->
                        <template v-else-if="item.code == 'sign_in'">
                            <div class="title sort-item">
                                <i class="icon-drag"></i>
                                <div class="lable">签到设置</div>
                                <div class="icon-div">
                                    <i class="icon-edit" @click="openEditDialog(index, item)"></i>
                                    <i class="icon-delete" @click="removeComponent1(index, item)"></i>
                                </div>
                                <div class="input-box">
                                    <el-switch v-model="delivery1" class="switch fl marginTop6" disabled></el-switch>
                                </div>
                            </div>
                            <div class="form-item sort-item">
                                <i class="icon-drag"></i>
                                <div class="icon-div">
                                    <i class="icon-edit"></i>
                                    <i class="icon-delete"></i>
                                </div>
                                <label class="label required">签到方式</label>
                                <div class="input-box sign-in">
                                    <el-radio v-model="radio1" label="1" class="radio-item" readonly>普通签到</el-radio>
                                    <el-radio label="2" class="radio-item">位置签到</el-radio>
                                    <el-radio label="3" class="radio-item">二维码签到</el-radio>
                                    <!-- 如果勾选可多选 -->
                                    <!-- <el-checkbox-group v-model="radio1" disabled>
                                        <el-checkbox label="普通签到"></el-checkbox>
                                        <el-checkbox label="位置签到"></el-checkbox>
                                        <el-checkbox label="二维码签到"></el-checkbox>
                                    </el-checkbox-group> -->
                                </div>
                            </div>
                            <div class="form-item sort-item">
                                <i class="icon-drag"></i>
                                <div class="icon-div">
                                    <i class="icon-edit"></i>
                                </div>
                                <label class="label required">签到时间</label>
                                <div class="input-box">
                                    <el-date-picker type="daterange"
                                                    start-placeholder="开始时间"
                                                    end-placeholder="结束时间"
                                                    format="yyyy-MM-dd"
                                                    value-format="yyyy-MM-dd"
                                                    prefix-icon="disable"
                                                    clear-icon="disable"
                                                    unlink-panels
                                                    readonly>
                                        <img style="margin: 0 8px;" slot="range-separator" src="/static/pc/assets/images/swap-right.png" th:src="@{/pc/assets/images/swap-right.png}">
                                    </el-date-picker>
                                    <span class="date-piker-icon"><img src="/static/pc/assets/images/calendar.png" th:src="@{/pc/assets/images/calendar.png}"></span>
                                </div>
                            </div>
                            <div class="form-item sort-item">
                                <i class="icon-drag"></i>
                                <div class="icon-div">
                                    <i class="icon-edit"></i>
                                    <i class="icon-delete"></i>
                                </div>
                                <label class="label">签到人员名单公开</label>
                                <div class="input-box">
                                    <el-switch class="switch fl marginTop6" disabled></el-switch>
                                    <p class="tips third">开启后，所有人都能看到报名人员名单</p>
                                </div>
                            </div>
                        </template>
                        <!-- 签退设置 -->
                        <template v-else-if="item.code == 'sign_out'">
                            <div class="title sort-item">
                                <i class="icon-drag"></i>
                                <div class="lable">签退设置</div>
                                <div class="icon-div">
                                    <i class="icon-edit" @click="openEditDialog(index, item)"></i>
                                    <i class="icon-delete" @click="removeComponent1(index, item)"></i>
                                </div>
                                <div class="input-box">
                                    <el-switch v-model="delivery1" class="switch fl marginTop6" disabled></el-switch>
                                </div>
                            </div>
                            <div class="form-item sort-item">
                                <i class="icon-drag"></i>
                                <div class="icon-div">
                                    <i class="icon-edit"></i>
                                    <i class="icon-delete"></i>
                                </div>
                                <label class="label required">签退方式</label>
                                <div class="input-box sign-in">
                                    <el-radio v-model="radio1" label="1" class="radio-item" readonly>普通签退</el-radio>
                                    <el-radio label="2" class="radio-item">位置签退</el-radio>
                                    <el-radio label="3" class="radio-item">二维码签退</el-radio>
                                </div>
                            </div>
                            <div class="form-item sort-item">
                                <i class="icon-drag"></i>
                                <div class="icon-div">
                                    <i class="icon-edit"></i>
                                </div>
                                <label class="label required">签退时间</label>
                                <div class="input-box">
                                    <el-date-picker type="daterange"
                                                    start-placeholder="开始时间"
                                                    end-placeholder="结束时间"
                                                    format="yyyy-MM-dd"
                                                    value-format="yyyy-MM-dd"
                                                    prefix-icon="disable"
                                                    clear-icon="disable"
                                                    unlink-panels
                                                    readonly>
                                        <img style="margin: 0 8px;" slot="range-separator" src="/static/pc/assets/images/swap-right.png" th:src="@{/pc/assets/images/swap-right.png}">
                                    </el-date-picker>
                                    <span class="date-piker-icon"><img src="/static/pc/assets/images/calendar.png" th:src="@{/pc/assets/images/calendar.png}"></span>
                                </div>
                            </div>
                            <div class="form-item sort-item">
                                <i class="icon-drag"></i>
                                <div class="icon-div">
                                    <i class="icon-edit"></i>
                                    <i class="icon-delete"></i>
                                </div>
                                <label class="label">签退名单公开</label>
                                <div class="input-box">
                                    <el-switch class="switch fl marginTop6" disabled></el-switch>
                                    <p class="tips third">开启后，所有人都能看到报名人员名单</p>
                                </div>
                            </div>
                        </template>
                        <!-- 作品征集 -->
                        <template v-else-if="item.code == 'work'">
                            <div class="title sort-item">
                                <i class="icon-drag"></i>
                                <div class="lable">作品征集</div>
                                <div class="icon-div">
                                    <i class="icon-edit" @click="openEditDialog(index, item)"></i>
                                    <i class="icon-delete" @click="removeComponent1(index, item)"></i>
                                </div>
                            </div>
                            <div class="form-item">
                                <i class="icon-drag"></i>
                                <label class="label">{{item.name}}</label>
                                <div class="input-box">
                                    <el-switch class="switch fl marginTop6" disabled></el-switch>
                                    <p class="tips third">开启后，参与者可以在活动中提交作品，管理员在征集模块中进行审核评分推优等操作</p>
                                </div>
                            </div>
                        </template>
                    </template>

                </form>
                <div class="add-circle" @click="addFieldDialog = true" id="add-circle"></div>
            </div>
        </div>
        <!--拖拽排序的提示-->
        <div id="dragBubble" class="bubble">拖动可排序</div>
        <!-- 确认删除模块弹框 -->
        <div class="dialog-mask" v-show="delDialog">
            <div class="dailog delete-dailog">
                <img src="/static/pc/assets/images/yq-design/warn.png" th:src="@{/pc/assets/images/yq-design/warn.png}" alt="">
                <p class="text">删除后，可重新添加。确定删除？</p>
                <div class="btn-box">
                    <div class="border-btn" @click="cancelRemoveComponent">保留</div>
                    <div class="normal-btn" @click="confirmRemove">删除</div>
                </div>
            </div>
        </div>
        <!-- 添加字段弹窗 -->
        <div class="dialog-mask" v-show="addFieldDialog">
            <div class="dailog add-field">
                <div class="header">
                    <span>添加字段</span>
                    <i class="close" @click="addFieldDialog=false"></i>
                </div>
                <div class="body">
                    <div class="down-list">
                        <p class="down-btn">
                            <span>{{activeCpTypeName}}</span>
                            <i class="down-icon"></i>
                        </p>
                        <ul class="item-list">
                            <li v-for="(item, index) in componentTypeList" @click="changeComponentType(index)">{{item.name}}</li>
                        </ul>
                    </div>
                    <!-- todo style 有问题 -->
                    <div :class="{'field-item': true, 'aready-add': item.checked && !item.multi }"
                         style="width: 214px"
                         v-for="(item, index) in  componentTypeList && componentTypeList[activeCpTypeIndex] && componentTypeList[activeCpTypeIndex].components || []"
                    >
                        <p class="field overHidden1">{{item.name}}</p>
                        <el-tooltip class="tooltip" effect="dark" :content="item.introduction" placement="top">
                            <i class="icon-info"></i>
                        </el-tooltip>
                        <div class="fr add-btn">
                            <i class="icon-add" v-if="item.code == 'sign_up_condition'" @click="addSignUpCondition(index, item)"></i>
                            <i class="icon-add" v-else-if="item.multi" @click="addComponent(index, item)"></i>
                            <template v-else>
                                <i class="icon-add" v-show="!item.checked" @click="addComponent(index, item)"></i>
                                <span class="aready" v-show="item.checked">已添加</span>
                                <span class="remove" style="display: none;" @click="removeComponent(index, item, $event)">移除</span>
                            </template>
                        </div>
                    </div>
                    <template>
                        <div class="field-item" style="width: 214px" @click="addCustomTextField">
                            <p class="field overHidden1">文本字段</p>
                            <el-tooltip class="tooltip" effect="dark" content="说明文字单行效果" placement="top">
                                <i class="icon-info"></i>
                            </el-tooltip>
                        </div>
                        <div class="field-item" style="width: 214px" @click="addCustomChooseField">
                            <p class="field overHidden1">选择字段</p>
                            <el-tooltip class="tooltip" effect="dark" content="说明文字单行效果" placement="top">
                                <i class="icon-info"></i>
                            </el-tooltip>
                        </div>
                        <div class="field-item" style="width: 214px" @click="addFieldDialog=false,partitionDialog=true">
                            <p class="field overHidden1">分区</p>
                            <el-tooltip class="tooltip" effect="dark" content="说明文字单行效果" placement="top">
                                <i class="icon-info"></i>
                            </el-tooltip>
                        </div>
                    </template>
                </div>
                <div class="footer">
                    <div class="btn-box">
                        <div class="normal-btn" @click="addFieldDialog = false">完成</div>
                    </div>
                </div>
            </div>
        </div>
        <!-- 文本字段弹窗 -->
        <div class="dialog-mask" v-show="textDialog">
            <div class="dailog text-field">
                <div class="header">
                    <span>文本字段</span>
                    <i class="close" @click="textDialog=false"></i>
                </div>
                <div class="body">
                    <div class="form">
                        <el-input v-model="currEditItem.name" type="text" placeholder="标题" maxlength="8" show-word-limit class="marginBottom24"></el-input>
                        <el-input v-model="currEditItem.introduction" type="text" placeholder="辅助说明" maxlength="40" show-word-limit class="marginBottom24"></el-input>
                        <div class="switch-box" v-show="currEditItem.code != 'sign_up' || currEditItem.code != 'company_sign_up'">
                            <label class="label">必填项</label>
                            <el-switch class="switch" v-model="currEditItem.required"></el-switch>
                        </div>
                    </div>
                </div>
                <div class="footer">
                    <div class="btn-box">
                        <div class="border-btn" @click="textDialog = false">取消</div>
                        <div class="normal-btn" @click="confirmTextEdit">确定</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 选择字段弹窗 -->
        <div class="dialog-mask" v-show="chooseDialog"> 
            <div class="dailog choose-field">
                <div class="header">
                    <span>选择字段</span>
                    <i class="close" @click="chooseDialog = false"></i>
                </div>
                <div class="body">
                    <el-form class="form" label-width="72px">
                        <el-input v-model="currEditItem.name" type="text" placeholder="标题" maxlength="8" show-word-limit class="marginBottom24"></el-input>
                        <el-input v-model="currEditItem.introduction" type="text" placeholder="辅助说明" maxlength="40" show-word-limit class="marginBottom24"></el-input>
                        <el-form-item label="数据来源" class="marginBottom20">
                            <el-select v-model="currEditItem.dataOrigin" placeholder="请选择">
                                <el-option
                                        v-for="item in [{label: '自定义', value: 'custom'}, {label: '表单', value: 'form'}]"
                                        :key="item.value"
                                        :label="item.label"
                                        :value="item.value"
                                >
                                </el-option>
                            </el-select>
                        </el-form-item>
                        <template v-if="currEditItem.dataOrigin == 'form'">
                            <el-form-item label="选择表单" class="marginBottom20">
                                <el-select v-model="currEditItem.originIdentify" placeholder="请选择" @change="selectForm">
                                    <el-option
                                            v-for="item in wfwForms"
                                            :key="item.id"
                                            :label="item.name"
                                            :value="item.id"
                                    >
                                    </el-option>
                                </el-select>
                            </el-form-item>
                            <el-form-item label="选择字段" class="marginBottom20">
                                <el-select v-model="currEditItem.fieldFlag" placeholder="请选择">
                                    <el-option
                                            v-for="(item, index) in wfwFormFields"
                                            :key="index"
                                            :label="item.name"
                                            :value="item.name"
                                    >
                                    </el-option>
                                </el-select>
                            </el-form-item>
                        </template>
                        <template v-if="currEditItem.dataOrigin == 'custom'">
                            <div class="choose-box">
                                <div class="input-box" v-for="(item,index) in currEditItem.fieldList">
                                    <label class="label">选项{{index + 1}}</label>
                                    <el-input v-model="item.fieldName" type="text" placeholder="请输入" class="weight348"></el-input>
                                    <i :class="{'del-circle': true, 'disable': currEditItem.fieldList && currEditItem.fieldList.length <= 1}" @click="delEditItemFields(index)"></i>
                                </div>
                            </div>
                            <div class="add-option" @click="addEditItemFields">
                                <i></i>添加选项
                            </div>
                        </template>
                        <div class="switch-box">
                            <label class="label">必填项</label>
                            <el-switch class="switch" v-model="currEditItem.required"></el-switch>
                            <label class="label">允许多选</label>
                            <el-switch class="switch" v-model="currEditItem.type" active-value="checkbox" inactive-value="radio"></el-switch>
                        </div>
                    </el-form>
                </div>
                <div class="footer">
                    <div class="btn-box">
                        <div class="border-btn" @click="chooseDialog = false">取消</div>
                        <div class="normal-btn" @click="submitCustomComponent">确定</div>
                        <!-- <div class="normal-btn">确定</div> -->
                    </div>
                </div>
            </div>
        </div>

        <!-- 分区弹窗 -->
        <div class="dialog-mask" v-show="partitionDialog">
            <div class="dailog">
                <div class="header">
                    <span>分区</span>
                    <i class="close" @click="partitionDialog=false"></i>
                </div>
                <div class="body">
                    <div class="custom-box">
                        <span>分区组件可以区隔配置项目</span>
                    </div>
                    <div class="form">
                        <el-input v-model="title" type="text" placeholder="标题" maxlength="8" show-word-limit class="marginBottom24"></el-input>
                        <el-input v-model="explain" type="text" placeholder="辅助说明" maxlength="40" show-word-limit class="marginBottom24"></el-input>
                        <div class="switch-box">
                            <label class="label">允许关闭</label>
                            <el-switch class="switch" v-model="switch1"></el-switch>
                        </div>
                    </div>
                </div>
                <div class="footer">
                    <div class="btn-box">
                        <div class="border-btn">取消</div>
                        <div class="normal-btn disable">确定</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 报名条件-->
        <div class="dialog-mask" v-show="signUpDialog">
            <div class="dailog">
                <div class="header">
                    <span>报名条件</span>
                    <i class="close" @click="signUpDialog = false"></i>
                </div>
                <div class="body">
                    <el-form ref="form"  label-width="72px">
                        <el-input v-model="currSUConditionTplComponent.name" type="text" placeholder="标题（必填）" maxlength="8" show-word-limit class="marginBottom20"></el-input>
                        <el-input v-model="currSUConditionTplComponent.introduction" type="text" placeholder="说明" maxlength="40" show-word-limit class="marginBottom20"></el-input>
                        <el-form-item label="数据来源" class="marginBottom20">
                            <el-select v-model="currSUConditionTplComponent.signUpCondition.originIdentify" placeholder="请选择关联表单" @change="selectForm">
                                <el-option v-for="item in wfwForms"
                                        :key="item.id"
                                        :label="item.name"
                                        :value="item.id"
                                >
                                </el-option>
                            </el-select>
                        </el-form-item>
                        <div class="marginBottom20">
                            <p class="tips marginBottom8">报名用户</p>
                            <div class="three">
                                <el-select v-model="baomingzhe" placeholder="" class="width186">
                                    <el-option label="报名者" value="1"></el-option>
                                </el-select>
                                <span>等于</span>
                                <el-select v-model="currSUConditionTplComponent.signUpCondition.fieldName" placeholder="请选择"  class="width186">
                                    <el-option  v-for="(item, index) in wfwFormFields"
                                                :key="index"
                                                :label="item.name"
                                                :value="item.name"
                                    >
                                </el-option>
                                </el-select>
                            </div>
                        </div>
                        <div class="marginBottom20">
                            <p class="tips marginBottom8">判断条件</p>
                            <div class="three">
                                <el-select v-model="currSUConditionTplComponent.signUpCondition.allowSignedUp" placeholder="" class="width150">
                                    <el-option label="不为空" :value="false"></el-option>
                                    <el-option label="为空" :value="true"></el-option>
                                </el-select>
                                <span>时，可以报名</span>
                            </div>
                        </div>
                    </el-form>
                </div>
                <div class="footer">
                    <div class="btn-box">
                        <div class="border-btn" @click="signUpDialog = false">取消</div>
                        <div class="normal-btn " @click="confirmSignUpCondition">确定</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div th:replace="pc/include/common_js :: common_js(~{::script})">
        <script src="/static/pc/assets/lib/jquery.min.js" th:src="@{/pc/assets/lib/jquery.min.js}"></script>
        <script src="/static/pc/assets/lib/vue.js" th:src="@{/pc/assets/lib/vue.js}"></script>
        <script src="/static/pc/assets/lib/element-ui/lib/index.js" th:src="@{/pc/assets/lib/element-ui/lib/index.js}"></script>
        <script src="/static/pc/assets/lib/drag/sortTable.js" th:src="@{/pc/assets/lib/drag/sortTable.js}"></script>
        <script src="/static/pc/assets/lib/jqthumb.min.js" th:src="@{/pc/assets/lib/jqthumb.min.js}"></script>
<!--        <script src="https://noteyd.chaoxing.com/res/plugin/ueditor4thirdparty/rich.text.util.js"></script>-->
<!--        <script type="text/javascript">-->
        <script th:inline="javascript">
            var uuid = function () {
                return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function (c) {
                    var r = Math.random() * 16 | 0,
                        v = c == 'x' ? r : (r & 0x3 | 0x8);
                    return v.toString(16);
                });
            }
            vm = new Vue({
                el: '#field-setting',
                data: {
                    fid: [[${fid}]],
                    templates: [[${templates}]],
                    wfwForms: [[${wfwForms}]],
                    wfwFormFields: [],
                    currTemplateId: null,
                    template: {},
                    components: [],
                    componentMap: {},
                    // 父组件id：子组件列表
                    pidChildrenMap: {},
                    templateComponents: [],
                    showTemplateComponents: [],
                    componentTypeList: [],
                    activeCpTypeIndex: 0,
                    activeCpTypeName: '基本信息',
                    loaded: false,
                    delDialog:false,
                    // 大组件删除时用到的临时变量
                    currRemoveItemIndex: null,
                    currRemoveItem: null,
                    // 组件编辑弹窗所用到的临时变量
                    currEditItem: {},
                    currEditIndex: null,
                    // 编辑报名内组件时，存储报名index
                    currEditSignUpInsideIndex: null,
                    // 是否添加自定义组件
                    customAdd: false,
                    customComponentIds: [],
                    // 报名条件
                    currComponent: {},
                    currSUConditionTplComponent: {
                        signUpCondition: {}
                    },

                    radio1:'1',
                    activityType:'创新创业',
                    delivery1:'',
                    delivery2:false,
                    person:'自定义人数',
                    title:'',
                    explain:'',
                    switch1:false,
                    switch2:false,
                    name:'活动名称',
                    switch3:true,
                    type:'活动类型',
                    time:'活动时间',
                    type1:'线上活动',
                    type2:'线下活动',
                    textDialog:false,
                    addFieldDialog:false,
                    chooseDialog:false,
                    partitionDialog:false,

                    switchDialog:false,
                    signUpDialog:false,
                    AssociationForm:'',
                    baomingzhe:'报名者',
                    shijian:'',
                    zhuangtai:'不为空',
                },
                mounted: function () {
                    var $this = this;
                    $this.init();
                    // app.initUEditor("");
                },
                methods:{
                    init: function () {
                        $(function(){
                            $("#drag-box").sortable({
                                scroll: true,
                                axis: "y",
                                dalay: 300,
                                handle: ".icon-drag",
                                start: function () {
                                    $("#dragBubble").hide()
                                },
                            });
                            $('.icon-drag').on('mouseenter', function (e) {
                                var $event = $(e.target);
                                var top = $event.offset().top - 39;
                                var left = $event.offset().left - 40;
                                $('#dragBubble').css({
                                    top: top,
                                    left: left
                                }).show()
                            })
                            $('.icon-drag').on('mouseleave', function (e) {
                                $('#dragBubble').hide()
                            })
                        })
                    },
                    initMouseEnterField: function () {
                        var $this = this;
                        $this.$nextTick(function () {
                            $('.field-item').mouseenter(function() {
                                if($(this).hasClass('aready-add')){
                                    $(this).find('.remove').show()
                                    $(this).find('.aready').hide()
                                }
                            });
                            $('.field-item').mouseleave(function() {
                                if($(this).hasClass('aready-add')){
                                    $(this).find('.remove').hide()
                                    $(this).find('.aready').show()
                                }
                            });
                        });
                    },
                    // 调整右下角加号位置
                    fixRightEndBtnStyle: function () {
                        /* 右下角加号的位置 */
                        var right = $('.w-900px.info-box').offset().left + 50
                        $('#add-circle').css('right', right)
                        $(window).resize(function () {
                            var right = $('.w-900px.info-box').offset().left + 50
                            $('#add-circle').css('right', right)
                        })
                    },
                    templateChange: function (templateId) {
                        var $this = this;
                        $this.currTemplateId = templateId;
                        $this.loadTemplateInfo();
                    },
                    // 选择模板，加载对应组件、模板组件数据
                    loadTemplateInfo: function () {
                        var $this = this;
                        var url = ctx + "/api/activity/engine/info?templateId=" + $this.currTemplateId;
                        $this.loaded = false;
                        app.ajaxPost(url, {}, function (res) {
                            $this.loaded = true;
                            if (res.success) {
                                var { template, components, templateComponents } = res.data
                                $this.template = template;
                                // 置空componentMap
                                $this.componentMap = {};
                                // 初始化父节点对应子节点列表
                                $this.pidChildrenMap = {};
                                var checkedComponentIds = [];
                                $(templateComponents).each(function () {
                                    checkedComponentIds.push(this.componentId);
                                });
                                $(components).each(function () {
                                    $this.componentMap[this.id] = this;
                                    this.virtualId = this.id;
                                    this.virtualPid = this.pid;
                                    // 新增是否选中属性，默认true
                                    this.checked = true;
                                    // 填充父节点对应子节点列表数据
                                    if (!$this.pidChildrenMap[this.pid]) {
                                        $this.pidChildrenMap[this.pid] = [];
                                    }
                                    $this.pidChildrenMap[this.pid].push(this);
                                });
                                $this.components = components;
                                $this.templateComponents = templateComponents;
                                $this.calShowComponents();
                                $this.initComponentTypeList();
                                $this.$nextTick(function () {
                                    $this.fixRightEndBtnStyle();
                                    $('.jqthumbImg').jqthumb({
                                        width: '100%',
                                        height: '100%'
                                    });
                                    $this.initMouseEnterField();
                                })
                            } else {
                                var errorMessage = res.message;
                                if (activityApp.isEmpty(errorMessage)) {
                                    errorMessage = "加载模板数据失败";
                                }
                                app.showMsg(errorMessage);
                            }
                        }, function () {
                            $this.loaded = true;
                            app.showMsg("加载模板数据失败");
                        });
                    },
                    // 根据关联关系，处理展示出来的模板组件
                    calShowComponents: function() {
                        var $this = this;
                        var tmpTplComponents = [];
                        // 处理封装补充 tmpTplComponents 数据
                        $($this.templateComponents).each(function () {
                            var componentId = this.componentId;
                            var componentItem = $this.componentMap[componentId];
                            // 封装component 详情到 templateComponent里面
                            this.code = componentItem.code;
                            this.type = componentItem.type;
                            this.virtualId = this.id;
                            this.virtualPid = this.pid;
                            tmpTplComponents.push(this);
                        });

                        $this.showTemplateComponents = [];
                        // 封装处理展示的templateComponents，并把子组件放入父组件中
                        $(tmpTplComponents).each(function () {
                            var _this = this;
                            if (!this.virtualPid || this.virtualPid == 0) {
                                $this.showTemplateComponents.push(_this);
                            }
                            $(tmpTplComponents).each(function () {
                                if (this.virtualPid && this.virtualPid != 0 && _this.virtualId == this.virtualPid) {
                                    if (!_this.children) {
                                        $this.$set(_this, 'children', []);
                                    }
                                    _this.children.push(this);
                                }
                            });
                        });
                    },
                    // 初始化组件类型列表
                    initComponentTypeList: function () {
                        var $this = this;
                        // tplCpCpIdMap =>   templateComponent 的  { pid : componentId }
                        var tplCpCpIdMap = {};
                        // pidComponentIdsMap =>   templateComponent 的  pid : [componentId, ....]
                        var pidComponentIdsMap = {};
                        // 先根据templateComponent关系中，按 pid 分块组件
                        $($this.templateComponents).each(function () {
                            tplCpCpIdMap[this.id] = this.componentId;
                            if (!pidComponentIdsMap[this.pid]) {
                                pidComponentIdsMap[this.pid] = [];
                            }
                            pidComponentIdsMap[this.pid].push(this.componentId);
                        })
                        var tplCpPids = Object.keys(pidComponentIdsMap);
                        $(tplCpPids).each(function (i) {
                            var tplCpPid = tplCpPids[i];
                            var componentId = tplCpCpIdMap[tplCpPid];
                            var components = []
                            if (tplCpPid == 0) {
                                components = $.extend(true, [], $this.pidChildrenMap[0]);
                            } else {
                                components = $.extend(true, [], $this.pidChildrenMap[componentId]);
                            }
                            $(components).each(function () {
                                this.checked = pidComponentIdsMap[tplCpPid].indexOf(this.id) != -1;
                            })
                            var parent = $this.componentMap[componentId];
                            var newType = {
                                type: tplCpPid == 0 ? 'basic_info' : parent.code,
                                name: tplCpPid == 0 ? '基本信息' : parent.name,
                                virtualId: tplCpPid,
                                components: components
                            }
                            $this.componentTypeList.push(newType);
                        });
                    },
                    changeComponentType: function (index) {
                        var $this = this;
                        $this.activeCpTypeIndex = index;
                        $this.activeCpTypeName = $this.componentTypeList[index].name;
                    },
                    // 新增组件
                    addComponent: function (index, item) {
                        var $this = this;
                        var templateComponentLength = $this.templateComponents.length;
                        var newTemplateComponent = {
                            templateId: $this.currTemplateId,
                            componentId: item.id,
                            name: item.name,
                            pid: 0,
                            introduction: item.introduction,
                            required: item.required,
                            sequence: templateComponentLength + 1,
                            code: item.code,
                            virtualId: item.virtualId,
                            virtualPid: item.virtualPid
                        };
                        // 可重复添加组件(目前报名块、报名条件)
                        if (item.multi) {
                            if (item.code == 'company_sign_up' || item.code == 'sign_up') {
                                $this.addSignUpComponent(item, newTemplateComponent);
                            }
                        } else {
                            var componentType = $this.componentTypeList[$this.activeCpTypeIndex];
                            var components = componentType.components;
                            $this.$set(components[index], 'checked', true);

                            newTemplateComponent.virtualPid = componentType.virtualId;
                            $this.templateComponents.push(newTemplateComponent);
                            if (item.pid == 0) {
                                $this.showTemplateComponents.push(newTemplateComponent);
                            } else {
                                $($this.showTemplateComponents).each(function () {
                                    if (this.componentId == item.pid) {
                                        if (!this.children) {
                                            $this.$set(this, 'children', [])
                                        }
                                        this.children.push(newTemplateComponent);
                                        return false;
                                    }
                                });
                            }
                        }
                        $this.$nextTick(function () {
                            $('.jqthumbImg').jqthumb({
                                width: '100%',
                                height: '100%'
                            });
                        });
                    },
                    // 新增报名组件
                    addSignUpComponent: function (component, newSignUpTemplateComponent) {
                        var $this = this;
                        var templateComponentLength = $this.templateComponents.length;
                        // 生成虚拟id
                        var newPid = uuid();
                        newSignUpTemplateComponent.virtualId = newPid;
                        // 拷贝一份子组件出来
                        var newComponents = $.extend(true, [], $this.pidChildrenMap[component.id]);
                        var newChildTemplateComponents = [];
                        var childIdx = 1;
                        $(newComponents).each(function () {
                            var newId = uuid();
                            this.virtualId = newId;
                            this.virtualPid = newPid;
                            if (this.checked) {
                                newChildTemplateComponents.push({
                                    templateId: $this.currTemplateId,
                                    componentId: this.id,
                                    name: this.name,
                                    introduction: this.introduction,
                                    required: this.required,
                                    sequence: templateComponentLength + childIdx,
                                    component: this,
                                    code: this.code,
                                    virtualId: newId,
                                    virtualPid: newPid
                                });
                                childIdx++;
                            }
                        });
                        newSignUpTemplateComponent.children = newChildTemplateComponents;
                        $this.templateComponents.pushArray(newChildTemplateComponents);
                        $this.showTemplateComponents.push(newSignUpTemplateComponent);
                        // 将报名添加到分类中
                        var code = component.code;
                        var name = component.name;
                        $this.componentTypeList.push({
                            type: code,
                            name: name,
                            virtualId: newPid,
                            components: newComponents
                        })
                    },
                    // 移除组件
                    removeComponent: function (index, item, e) {
                        var $this = this;
                        var components = $this.componentTypeList[$this.activeCpTypeIndex].components;
                        var target = e.target;
                        // 样式改变
                        $(target).hide();
                        $this.$set(components[index], 'checked', false)
                        $this.templateComponents = $.grep($this.templateComponents, function (it) {
                            return it.componentId != item.virtualId;
                        });
                        // 基本信息的移除
                        if (item.virtualPid == 0) {
                            $this.showTemplateComponents = $.grep($this.showTemplateComponents, function (it) {
                                return it.componentId != item.virtualId;
                            });
                        } else { // 报名组件信息的移除
                            $($this.showTemplateComponents).each(function () {
                                var _this = this;
                                if (_this.componentId == item.virtualPid) {
                                    if (_this.children) {
                                        _this.children = $.grep(_this.children, function (it, index) {
                                            return it.componentId != item.virtualId;
                                        });
                                    }
                                    return false;
                                }
                            });
                        }
                    },
                    // 配置页面基础信息删除按钮
                    removeComponent1: function (index, item) {
                        var $this = this;
                        // 移除展示模板组件关联记录
                        $this.showTemplateComponents.splice(index, 1);
                        $this.templateComponents = $.grep($this.templateComponents, function (it, index) {
                            return it.virtualId != item.virtualId;
                        });
                        if (item.code == 'sign_up' || item.code == 'company_sign_up') {
                            // 继续移除子组件
                            $this.templateComponents = $.grep($this.templateComponents, function (it, index) {
                                return it.virtualPid != item.virtualId;
                            });
                            $this.componentTypeList = $.grep($this.componentTypeList, function (it, index) {
                                return it.virtualId != item.virtualId;
                            });
                        } else {
                            var componentType = $.grep($this.componentTypeList, function (it, index) {
                                return it.virtualId == item.virtualPid;
                            })[0];
                            var components = componentType.components;
                            $(components).each(function () {
                                if (this.virtualId == item.componentId) {
                                    this.checked = false;
                                }
                            });
                            $this.$nextTick(function () {
                                $('.jqthumbImg').jqthumb({
                                    width: '100%',
                                    height: '100%'
                                });
                            });
                        }
                    },
                    removeComponent2: function (index, item) {
                        var $this = this;
                        $this.delDialog = true;
                        $this.currRemoveItem = item;
                        $this.currRemoveItemIndex = index;
                    },
                    removeComponent3: function (index, idx, item) {
                        var $this = this;
                        // console.log($this.showTemplateComponents[index].children)  todo
                        $this.showTemplateComponents[index].children.splice(idx, 1);
                        // console.log($this.showTemplateComponents[index].children)
                        $this.templateComponents = $.grep($this.templateComponents, function (it, index) {
                            return it.virtualId != item.virtualId;
                        });

                        var virtualPid = item.virtualPid;
                        var componentType = $.grep($this.componentTypeList, function (it, index) {
                            return it.virtualId == virtualPid;
                        })[0];
                        var components = componentType.components;
                        $(components).each(function () {
                            if (this.virtualId == item.componentId) {
                                this.checked = false;
                            }
                        });
                    },
                    cancelRemoveComponent: function () {
                        var $this = this;
                        $this.delDialog = false;
                        $this.currRemoveItem = null;
                        $this.currRemoveItemIndex = null;
                    },
                    confirmRemove: function () {
                        var $this = this;
                        $this.removeComponent1($this.currRemoveItemIndex, $this.currRemoveItem);
                        $this.currRemoveItem = null;
                        $this.currRemoveItemIndex = null;
                        $this.delDialog = false;
                    },
                    openEditDialog: function (index, item, idx) {
                        var $this = this;
                        $this.currEditIndex = index;
                        $this.currEditSignUpInsideIndex = idx;
                        $this.currEditItem = $.extend({}, item);

                        if (item.code == 'sign_up_condition') {
                            $this.chooseDialog = true
                        } else if(item.type == 'radio' || item.type == 'checkbox') {
                            // 更新组件
                            $this.currEditItem = $.extend({}, $.grep($this.components, function (it) {
                                return it.id == item.componentId;
                            })[0]);
                            $this.chooseDialog = true;
                        } else {
                            $this.textDialog = true;
                        }
                    },
                    confirmEditResult: function () {
                        var $this = this;
                        $($this.templateComponents).each(function () {
                            if (this.virtualId == $this.currEditItem.virtualId && this.virtualPid == $this.currEditItem.virtualPid) {
                                $.extend(this, $this.currEditItem);
                                return false;
                            }
                        });
                        if ($this.currEditSignUpInsideIndex || $this.currEditSignUpInsideIndex == 0) {
                            $this.$set($this.showTemplateComponents[$this.currEditIndex].children, $this.currEditSignUpInsideIndex, $this.currEditItem);
                        } else {
                            $this.showTemplateComponents[$this.currEditIndex] = $this.currEditItem;
                        }
                        if ($this.currEditItem.code == 'sign_up_condition') {

                        } else if($this.currEditItem.type == 'radio' || $this.currEditItem.type == 'checkbox') {
                            $this.chooseDialog = false
                        } else {
                            $this.textDialog = false;
                        }
                        $this.currEditItem = {};
                        $this.currEditIndex = null;
                        $this.currEditSignUpInsideIndex = null;
                    },
                    addCustomTextField: function () {
                        var $this = this;
                        $this.addFieldDialog = false;
                        $this.textDialog = true;
                        $this.customAdd = true;
                        $this.currEditItem = {
                            name: '',
                            required: true,
                            templateId: $this.currTemplateId,
                            pid: 0,
                            type: 'text'
                        }
                    },
                    confirmTextEdit: function () {
                        var $this = this;
                        if ($this.customAdd) {
                            // 提交，新增自定义组件
                            $this.submitCustomComponent()
                            return;
                        }
                        $this.confirmEditResult();

                    },
                    addSignUpCondition: function (index, item) {
                        var $this = this;
                        $this.addFieldDialog=false;
                        $this.signUpDialog=true;

                        $this.currComponent = $.extend({}, item);
                        $this.currSUConditionTplComponent = {
                            name: '',
                            introduction: '',
                            signUpCondition: {
                                originIdentify: '',
                                fieldName: '',
                                allowSignedUp: false
                            }
                        }
                    },
                    confirmSignUpCondition: function () {
                        var $this = this;
                        var templateComponentLength = $this.templateComponents.length;
                        $this.currSUConditionTplComponent = $.extend($this.currSUConditionTplComponent, {
                            templateId: $this.currTemplateId,
                            componentId: $this.currComponent.id,
                            required: $this.currComponent.required,
                            sequence: templateComponentLength + 1,
                            code: $this.currComponent.code,
                        });
                        // 可重复添加组件(目前报名块、报名条件)
                        var componentType = $this.componentTypeList[$this.activeCpTypeIndex];
                        $this.currSUConditionTplComponent.pid = componentType.virtualId;
                        $this.currSUConditionTplComponent.virtualPid = componentType.virtualId;
                        $this.templateComponents.push($this.currSUConditionTplComponent);
                        $($this.showTemplateComponents).each(function () {
                            if (this.componentId == $this.currComponent.pid) {
                                if (!this.children) {
                                    $this.$set(this, 'children', [])
                                }
                                this.children.push($this.currSUConditionTplComponent);
                                return false;
                            }
                        });

                        $this.currComponent = {};
                        $this.currSUConditionTplComponent = {
                            signUpCondition: {}
                        };
                        $this.signUpDialog = false;
                    },
                    addCustomChooseField: function () {
                        var $this = this;
                        $this.addFieldDialog = false;
                        $this.chooseDialog = true
                        $this.customAdd = true;
                        $this.currEditItem = {
                            name: '',
                            required: true,
                            templateId: $this.currTemplateId,
                            dataOrigin: 'custom',
                            fieldList: [{
                                componentId: $this.currEditItem.id,
                                fieldName: '',
                                sequence: 1
                            }],
                            pid: 0,
                            type: 'radio'
                        }
                    },
                    selectForm: function (value) {
                        var $this = this;
                        var url = ctx + "/api/wfw-form/" + value + "/field?fid=" + $this.fid;
                        // 置空
                        $this.wfwFormFields = [];
                        app.ajaxGet(url, function (res) {
                            if (res.success) {
                                $this.wfwFormFields = res.data
                            } else {
                                var errorMessage = res.message;
                                if (activityApp.isEmpty(errorMessage)) {
                                    errorMessage = "加载表单字段失败";
                                }
                                app.showMsg(errorMessage);
                            }
                        }, function () {
                            app.showMsg("加载表单字段失败");
                        });

                    },
                    submitCustomComponent: function () {
                        var $this = this;
                        var url = ctx + "/api/activity/engine/component/submit";
                        var isAdd = !$this.currEditItem.id;
                        app.ajaxPost(url, { componentStr: activityApp.getJsonStr($this.currEditItem) }, function (res) {
                            if (res.success) {
                                var component = res.data
                                if (isAdd) {
                                    $this.addedComponent(component);
                                } else {
                                    $this.editedComponent(component);
                                }
                                $this.currEditItem = {};

                                $this.chooseDialog = false;
                                $this.textDialog = false;

                                $this.customAdd = false;
                            } else {
                                var errorMessage = res.message;
                                if (activityApp.isEmpty(errorMessage)) {
                                    errorMessage = "保存自定义组件失败";
                                }
                                app.showMsg(errorMessage);
                            }
                        }, function () {
                            app.showMsg("保存自定义组件失败");
                        });
                    },
                    addedComponent: function (component) {
                        var $this = this;
                        component.checked = true;
                        component.virtualId = component.id;
                        component.virtualPid = component.pid;
                        $this.componentTypeList[component.pid].components.push(component);
                        var newTemplateComponent = {
                            templateId: $this.currTemplateId,
                            componentId: component.id,
                            name: component.name,
                            introduction: component.introduction,
                            required: component.required,
                            sequence: $this.templateComponents.length + 1,
                            component: component,
                            code: component.code,
                            type: component.type,
                            pid: 0
                        };
                        $this.showTemplateComponents.push(newTemplateComponent);
                        $this.templateComponents.push(newTemplateComponent);
                        $this.customComponentIds.push(component.id);
                    },
                    editedComponent: function (component) {
                        var $this = this;
                        component.virtualId = component.id;
                        component.virtualPid = component.pid;
                        var components = $this.componentTypeList[component.pid].components;
                        var i;
                        for (i = 0; i < components.length; i++) {
                            if (components[i].id == component.id) {
                                components[i] = component;
                                break;
                            }
                        }
                        var updatedAttrs = {
                            name: component.name,
                            introduction: component.introduction,
                            required: component.required,
                            code: component.code,
                            type: component.type,
                            component: component
                        };

                        $this.showTemplateComponents[$this.currEditIndex] = $.extend({}, $this.showTemplateComponents[$this.currEditIndex], updatedAttrs);
                        for (i = 0; i < $this.templateComponents.length; i++) {
                            if ($this.templateComponents[i].componentId == component.id) {
                                $this.templateComponents[i] = $.extend({}, $this.templateComponents[i], updatedAttrs);
                                break;
                            }
                        }
                    },
                    // 返回
                    returnBack: function () {
                        window.location.reload();
                    },
                    // 发布数据
                    publish: function () {
                        var $this = this;
                        var submitData = $this.packageData();
                        var url = ctx + "/api/activity/engine/publish";
                        var param = {
                            fid: $this.fid,
                            templateInfoStr: activityApp.getJsonStr(submitData)
                        }
                        app.ajaxPost(url, param, function (res) {
                            if (res.success) {
                                app.showMsg("发布成功", function () {
                                    window.location.reload();
                                });
                            } else {
                                var errorMessage = res.message;
                                if (activityApp.isEmpty(errorMessage)) {
                                    errorMessage = "发布失败";
                                }
                                app.showMsg(errorMessage);
                            }
                        }, function () {
                            app.showMsg("发布失败");
                        });
                    },
                    packageData: function () {
                        var $this = this;
                        var template = $.extend({}, $this.template);
                        var templateComponents = [];
                        $($this.showTemplateComponents).each(function () {
                            var _this = this;
                            var newChildren;
                            if (_this.children) {
                                newChildren = [];
                                $(_this.children).each(function () {
                                    newChildren.push({
                                        templateId: $this.currTemplateId,
                                        componentId: this.componentId,
                                        pid: this.pid,
                                        name: this.name,
                                        introduction: this.introduction,
                                        required: this.required,
                                        sequence: this.sequence,
                                        children: this.children,
                                        signUpCondition: this.signUpCondition
                                    })
                                })
                            }
                            templateComponents.push({
                                templateId: $this.currTemplateId,
                                componentId: _this.componentId,
                                pid: _this.pid,
                                name: _this.name,
                                introduction: _this.introduction,
                                required: _this.required,
                                sequence: _this.sequence,
                                children: newChildren
                            });
                        });
                        return {
                            template: template,
                            customComponentIds: $this.customComponentIds,
                            templateComponents: templateComponents
                        }
                    },
                    addEditItemFields: function () {
                        var $this = this;
                        var fieldsLength = $this.currEditItem.fieldList.length;
                        $this.currEditItem.fieldList.push({
                            componentId: $this.currEditItem.id,
                            fieldName: '',
                            sequence: fieldsLength + 1
                        });
                    },
                    delEditItemFields: function (index) {
                        var $this = this;
                        if ($this.currEditItem.fieldList.length > 1) {
                            $this.currEditItem.fieldList.splice(index, 1);
                        }
                    },
                    addOption1: function(){
                        this.option1.push({title: ''})
                    },
                    delOption1: function(index){
                        if(this.delclick){
                            this.option1.splice(index,1);
                        }
                    },
                    addOption2: function(){
                        this.option2.push({title: ''})
                    },
                    delOption2: function(index){
                        this.option2.splice(index,1);
                    }
                }
            })
        </script>
        <!--            RichTextUitl.loadEditorProfile();-->
        <!--        </script>-->
    </div>
<!--    <div th:replace="pc/include/note_editor :: note_editor"></div>-->
</body>
</html>