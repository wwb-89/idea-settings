<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org/">
<head>
    <meta charset="UTF-8">
    <title th:text="${isClone != null && isClone ? '复制活动' : (activity == null ? '创建活动' : '编辑活动')}">创建活动</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="/static/pc/assets/lib/element-ui/lib/theme-chalk/index.css" th:href="@{/pc/assets/lib/element-ui/lib/theme-chalk/index.css}">
    <link rel="stylesheet" href="/static/pc/assets/lib/zTree_v3/css/zTreeStyle/zTreeStyle.css" th:href="@{/pc/assets/lib/zTree_v3/css/zTreeStyle/zTreeStyle.css}">
    <link rel="stylesheet" href="/static/pc/assets/css/reset.css" th:href="@{/pc/assets/css/reset.css}">
    <link rel="stylesheet" href="/static/pc/assets/icomoon/style.css" th:href="@{/pc/assets/icomoon/style.css}">
    <link rel="stylesheet" href="/static/pc/assets/lib/Swiper-3.4.2/dist/css/swiper.min.css" th:href="@{/pc/assets/lib/Swiper-3.4.2/dist/css/swiper.min.css}">
    <link rel="stylesheet" href="/static/pc/assets/css/public.css" th:href="@{/pc/assets/css/public.css}">
    <link rel="stylesheet" href="/static/pc/assets/css/create.css" th:href="@{/pc/assets/css/create.css}">
    <link rel="stylesheet" href="/static/pc/assets/lib/webuploader/webuploader.css" th:href="@{/pc/assets/lib/webuploader/webuploader.css}">
    <link rel="stylesheet" href="/static/pc/assets/css/messageContent.css" th:href="@{/pc/assets/css/messageContent.css}">
    <link rel="stylesheet" th:href="|${noteDomain}/res/css/pc/note/richtext_detail.css|">
    <style>
        body .create-class .layui-layer-btn0{
            width: 30px;
            height: 30px;
            border: 1px solid #82c3ff;
            border-radius: 15px;
            font-size: 13px;
            margin: 5px 10px 0 5px;
            color: #0084ff;
            background: #ffffff;
            line-height: 30px;
        }
        body .create-class .layui-layer-btn1{
            width: 30px !important;
            height: 30px !important;
            border: 1px solid #82c3ff !important;
            border-radius: 15px !important;
            font-size: 13px;
            margin: 5px 5px 0 10px;
            color: #ffffff;
            background: #0084ff;
            line-height: 30px;
        }
        .btn-box .webuploader-element-invisible {
            display: none;
        }
        .btn-box .webuploader-pick {
            color: #0084FF!important;
            background: unset!important;
            padding: unset!important;
        }
        .el-select, .el-input {
            height: auto;
        }
        .setForm .form-item .item-tips {
            line-height: 20px;
            background: #F0F0F0;
            border-radius: 2px;
            color: #999999;
            font-size: 12px;
            padding: 0 4px;
            display: inline-block;
            border: none;
            margin: 6px 16px 0;
            font-weight: normal;
        }

        .setForm .form-item .select-form {
            margin-left: 122px;
        }

        .setForm .form-item .select-form .el-select {
            width: 120px;
        }

        .flexStart .label {
            line-height: 32px;
        }

        [v-cloak] {
            display: none;
        }
    </style>
</head>

<body>
<div class="page" id="activity-vue" v-cloak>
    <div v-show="!showSignInListIframe && !showFormCollectionIframe">
        <!-- 创建/编辑活动头部 -->
        <div class="top flex" id="create">
            <div class="go-back" @click="returnBack">
                <template v-if="isEmbedded">
                    <i class="icon-back"></i><span>返回</span>
                </template>
            </div>
            <div class="name-txt">{{isClone ? '复制' : activity.id ? '设置' : '新建'}}</div>

            <button v-if="activity.id" type="button" class="btn-second-normal btn-width-80 margin-left-auto" @click="editSubmit(true)">保存</button>
            <button v-else type="button" class="btn-second-normal btn-width-80 margin-left-auto" @click="addSubmit(true)">保存</button>
            <button v-if="!activity.released" type="button" class="create-btn btn-width-80" @click="release">发布</button>
        </div>
        <!-- 创建活动头部 -->
        <div v-show="templateComponents && activity">
            <div class="info box" v-for="(tplComponents, tplIdx) in tplComponentPartitions" data-name="template-component-partition" :data-index="tplIdx">
                <form action="" onsubmit="return false;">
                    <template v-for="(item, index) in tplComponents">
                        <div class="title" v-if="item.code == 'partition'">{{item.name}}</div>
                        <div class="form-item" v-if="item.code == 'activity_name'" data-name="template-component" :data-id="item.id">
                            <label class="label"><img src="/static/pc/assets/images/required.png" th:src="@{/pc/assets/images/required.png}" class="required-img" v-if="item.required">{{item.name}}</label>
                            <div class="input-box">
                                <el-input type="text" placeholder="请填写" v-model.trim="activity.name" maxlength="50" show-word-limit></el-input>
                                <span class="tips" v-if="item.introduction">{{item.introduction}}</span>
                            </div>
                        </div>
                        <!--活动时间-->
                        <div class="form-item" v-else-if="item.code == 'activity_time_scope'" data-name="template-component" :data-id="item.id">
                            <label class="label"><img src="/static/pc/assets/images/required.png" th:src="@{/pc/assets/images/required.png}" class="required-img" v-if="item.required">{{item.name}}</label>
                            <div class="input-box">
                                <el-date-picker
                                        v-model="activity.startTimeStamp"
                                        type="datetime"
                                        format="yyyy-MM-dd HH:mm"
                                        value-format="timestamp"
                                        :clearable="false"
                                        :editable="false"
                                        placeholder="开始时间">
                                </el-date-picker>
                                <span class="date-range-icon"><img src="/static/pc/assets/images/swap-right.png" th:src="@{/pc/assets/images/swap-right.png}"></span>
                                <el-date-picker
                                        v-model="activity.endTimeStamp"
                                        type="datetime"
                                        format="yyyy-MM-dd HH:mm"
                                        value-format="timestamp"
                                        :clearable="false"
                                        :editable="false"
                                        placeholder="结束时间">
                                </el-date-picker>
                                <span class="tips" v-if="item.introduction">{{item.introduction}}</span>
                            </div>
                        </div>
                        <!--活动封面-->
                        <div class="form-item align-start" v-else-if="item.code == 'activity_cover'" data-name="template-component" :data-id="item.id">
                            <label class="label cover"><img src="/static/pc/assets/images/required.png" th:src="@{/pc/assets/images/required.png}" class="required-img" v-if="item.required">{{item.name}}</label>
                            <div class="input-box">
                                <div class="img-box">
                                    <img :src="activity | getCloudImgUrl(cloudDomain)" class="cover-img jqthumbImg">
                                </div>
                                <div class="font-box">
                                    <span>大小：小于5M</span>
                                    <span>格式：jpg、png、gif</span>
                                    <div class="btn-box">
                                        <button id="cover-upload-btn" class="cancle-btn upload" style="line-height: normal">上传文件</button>
                                        <div class="cancle-btn picture-btn" @click="pictureShow = true">图片库</div>
                                    </div>
                                </div>
                                <span class="tips" v-if="item.introduction">{{item.introduction}}</span>
                            </div>
                        </div>
                        <!--主办方-->
                        <div class="form-item" v-else-if="item.code == 'activity_organisers'" data-name="template-component" :data-id="item.id">
                            <label class="label"><img src="/static/pc/assets/images/required.png" th:src="@{/pc/assets/images/required.png}" class="required-img" v-if="item.required">{{item.name}}</label>
                            <div class="input-box" style="width: 400px;">
                                <el-input type="text" placeholder="请填写" v-model.trim="activity.organisers" maxlength="20"></el-input>
                                <span class="tips" v-if="item.introduction">{{item.introduction}}</span>
                            </div>
                        </div>
                        <!--活动形式-->
                        <template v-else-if="item.code == 'activity_type'">
                            <div data-name="template-component" :data-id="item.id">
                                <div class="form-item">
                                    <label class="label"><img src="/static/pc/assets/images/required.png" th:src="@{/pc/assets/images/required.png}" class="required-img" v-if="item.required">{{item.name}}</label>
                                    <div class="input-box">
                                        <el-radio v-for="(activityType, index) of activityTypes" :key="'activity-type-' + index" v-model="activity.activityType" :label="activityType.value" name="active-type" v-if="activityType.value != 'other' || showOtherActivityType">{{activityType.name}}</el-radio>
                                        <span class="tips" v-if="item.introduction">{{item.introduction}}</span>
                                    </div>
                                </div>
                                <div class="form-item" v-show="activity.activityType == 'offline' || activity.activityType == 'other'">
                                    <label class="label">位置</label>
                                    <div class="input-box">
                                        <input type="text" readonly required lay-verify="required" v-model.trim="activity.address" placeholder="请选择地点" autocomplete="off" class="layui-input name show-addr" style="cursor: pointer;" @click="showActivityMap">
                                        <img src="/static/pc/assets/images/location.png" th:src="@{/pc/assets/images/location.png}" class="length icon">
                                        <input type="text" v-model.trim="activity.detailAddress" lay-verify="required" placeholder="详细地址，例：E5栋1308室" autocomplete="off" class="layui-input name show-addr-detailed">
                                    </div>
                                </div>
                            </div>
                        </template>
                        <!--活动类型-->
                        <div class="form-item" v-else-if="item.code == 'activity_classify'" data-name="template-component" :data-id="item.id">
                            <label class="label"><img src="/static/pc/assets/images/required.png" th:src="@{/pc/assets/images/required.png}" class="required-img" v-if="item.required">{{item.name}}</label>
                            <div class="input-box">
                                <el-select v-model="activity.activityClassifyId" placeholder="请选择" v-if="strict != 1" popper-class="fixed-select">
                                    <el-option v-for="(classify, index) of activityClassifies" :key="'classify-' + index" :label="classify.name" :value="classify.id"></el-option>
                                    <!-- 注意这有俩个编辑，一个空的一个有数据的，我已经尽力了，只有这样能实现-->
                                    <div v-if="activityClassifies.length > 0" class="setiing-absolute" @click="toConfigClassify()"><i class="icon-setting"></i>编辑</div>
                                    <div v-else slot="empty" class="no-content-self">
                                        <div class="no-con">暂无{{item.name}}</div>
                                        <div class="setiing-absolute" @click="toConfigClassify()"><i class="icon-setting"></i>编辑</div>
                                    </div>
                                </el-select>
                                <el-select v-model="activity.activityClassifyId" placeholder="请选择" v-else>
                                    <el-option v-for="(classify, index) of activityClassifies" :key="'classify-' + index" :label="classify.name" :value="classify.id"></el-option>
                                    <!-- 注意这有俩个编辑，一个空的一个有数据的，我已经尽力了，只有这样能实现-->
                                    <div v-if="activityClassifies.length < 1" slot="empty" class="no-content-self">
                                        <div class="no-con">暂无{{item.name}}</div>
                                    </div>
                                </el-select>
                            </div>
                        </div>
                        <!--积分-->
                        <div class="form-item" v-else-if="item.code == 'integral'" data-name="template-component" :data-id="item.id">
                            <label class="label"><img src="/static/pc/assets/images/required.png" th:src="@{/pc/assets/images/required.png}" class="required-img" v-if="item.required">{{item.name}}</label>
                            <div class="input-box setForm">
                                <input type="number" v-model.trim="activity.integral" min="0" placeholder="请输入" class="score-input">
                                <span class="score">分</span>
                                <span class="tips" v-if="item.introduction">{{item.introduction}}</span>
                            </div>
                        </div>
                        <!--学时-->
                        <div class="form-item" v-else-if="item.code == 'period'" data-name="template-component" :data-id="item.id">
                            <label class="label"><img src="/static/pc/assets/images/required.png" th:src="@{/pc/assets/images/required.png}" class="required-img" v-if="item.required">{{item.name}}</label>
                            <div class="input-box setForm">
                                <input type="number" min="0" step="0.1" v-model.trim="activity.period" @blur="periodChange" placeholder="请输入" class="score-input">
                                <span class="score">学时</span>
                                <span class="tips" v-if="item.introduction">{{item.introduction}}</span>
                            </div>
                        </div>
                        <!--学分-->
                        <div class="form-item" v-else-if="item.code == 'credit'" data-name="template-component" :data-id="item.id">
                            <label class="label"><img src="/static/pc/assets/images/required.png" th:src="@{/pc/assets/images/required.png}" class="required-img" v-if="item.required">{{item.name}}</label>
                            <div class="input-box setForm">
                                <input type="number" min="0" step="0.1" v-model.trim="activity.credit" @blur="creditChange" placeholder="请输入" class="score-input">
                                <span class="score">学分</span>
                                <span class="tips" v-if="item.introduction">{{item.introduction}}</span>
                            </div>
                        </div>
                        <!--参与时长上限-->
                        <div class="form-item" v-else-if="item.code == 'max_participate_time_length'" data-name="template-component" :data-id="item.id">
                            <label class="label"><img src="/static/pc/assets/images/required.png" th:src="@{/pc/assets/images/required.png}" class="required-img" v-if="item.required">{{item.name}}</label>
                            <div class="input-box setForm">
                                <input type="number" min="1" step="1" v-model.trim="activity.timeLengthUpperLimit" placeholder="不限" class="score-input">
                                <span class="score">小时</span>
                                <span class="tips" v-if="item.introduction">{{item.introduction}}</span>
                            </div>
                        </div>
                        <!--发布范围-->
                        <div class="form-item last marginTop16" v-else-if="item.code == 'activity_release_scope'" data-name="template-component" :data-id="item.id">
                            <label class="label"><img src="/static/pc/assets/images/required.png" th:src="@{/pc/assets/images/required.png}" class="required-img" v-if="item.required">{{item.name}}</label>
                            <div class="input-box wrap">
                                <el-select v-if="item.dataOrigin == 'interface'" multiple v-model="releaseClassIds" placeholder="请选择" style="width: 45%" :loading="classDataLoading" :loading-text="'加载中'" @focus="loadReleaseClassData(item.originIdentify)">
                                    <el-option v-for="value in classList" :key="value.id" :label="value.name" :value="value.id"></el-option>
                                </el-select>
                                <template v-else>
                                    <!--添加范围后显示后面这项-->
                                    <div v-show="participatedOrgs.length < 1">
                                        <div class="type-item add" @click="toAddParticipateScope(item.name)">
                                            <div class="add_btn"></div>
                                            添加
                                        </div>
                                    </div>
                                    <div class="already_add" v-show="participatedOrgs.length > 0" @click="toAddParticipateScope(item.name)">
                                        <div>
                                            已选择{{participatedOrgs.length}}个单位
                                        </div>
                                        <img src="/static/pc/assets/images/edit-3.png" th:src="@{/pc/assets/images/edit-3.png}">
                                    </div>
                                </template>
                                <span class="tips" v-if="item.introduction" v-html="item.introduction">按照区域架构选择活动范围</span>
                            </div>
                        </div>
                        <!--签到-->
                        <div class="form-item align-start" v-else-if="item.code == 'sign_in_out'" data-name="template-component" :data-id="item.id">
                            <label class="label">{{item.name}}</label>
                            <div class="input-box wrap">
                                <div class="already_add" @click="toSignInList">
                                    <div>
                                        {{signInNum == 0 ? '添加签到' : ('已发布' + signInNum + '个签到')}}
                                    </div>
                                    <img src="/static/pc/assets/images/edit-3.png" th:src="@{/pc/assets/images/edit-3.png}">
                                </div>
                                <span class="tips" v-if="item.introduction">{{item.introduction}}</span>
                            </div>
                        </div>
                        <div class="form-item align-start" v-else-if="item.code == 'form_collection'" data-name="template-component" :data-id="item.id">
                            <label class="label">{{item.name}}</label>
                            <div class="input-box wrap">
                                <div class="already_add" @click="toFormCollectionList">
                                    <div>
                                        {{formCollectionNum == 0 ? '添加表单采集' : ('已发布' + formCollectionNum + '个表单采集')}}
                                    </div>
                                    <img src="/static/pc/assets/images/edit-3.png" th:src="@{/pc/assets/images/edit-3.png}">
                                </div>
                                <span class="tips" v-if="item.introduction">{{item.introduction}}</span>
                            </div>
                        </div>
                        <!--作品征集设置-->
                        <div class="form-item align-start" v-else-if="item.code == 'work'" data-name="template-component" :data-id="item.id">
                            <label class="label">{{item.name}}</label>
                            <div class="input-box column">
                                <div class="set-box">
                                    <el-switch v-model="activity.openWork" class="examine-switch"></el-switch>
                                    <span class="tips" v-if="item.introduction">{{item.introduction}}</span>
                                </div>
                                <div class="set-box configurationForm" v-show="activity.openWork" @click="workManage">
                                    <img src="/static/pc/assets/images/setting.png" th:src="@{/pc/assets/images/setting.png}">
                                    <span class="tips set-information">规则设置</span>
                                </div>
                            </div>
                        </div>
                        <!--考核-->
                        <div class="form-item align-start" v-else-if="item.code == 'inspection_config'" data-name="template-component" :data-id="item.id">
                            <label class="label">{{item.name}}</label>
                            <div class="input-box column">
                                <div class="set-box">
                                    <el-switch v-model="activity.openInspectionConfig" class="examine-switch"></el-switch>
                                    <span class="tips" v-if="item.introduction">{{item.introduction}}</span>
                                </div>
                                <div class="set-box configurationForm" v-show="activity.openInspectionConfig" @click="toInspectionConfig">
                                    <img src="/static/pc/assets/images/setting.png" th:src="@{/pc/assets/images/setting.png}">
                                    <span class="tips set-information">考核配置</span>
                                </div>
                            </div>
                        </div>
                        <!--小组设置-->
                        <div class="form-item align-start" v-else-if="item.code == 'group'" data-name="template-component" :data-id="item.id">
                            <label class="label">{{item.name}}</label>
                            <div class="input-box column">
                                <div class="set-box">
                                    <el-switch v-model="activity.openGroup" class="examine-switch"></el-switch>
                                    <span class="tips" v-if="item.introduction">{{item.introduction}}</span>
                                </div>
                            </div>
                        </div>
                        <!--阅读设置-->
                        <div class="form-item align-start" v-else-if="item.code == 'reading'" data-name="template-component" :data-id="item.id">
                            <label class="label">{{item.name}}</label>
                            <div class="input-box column">
                                <div class="set-box">
                                    <el-switch v-model="activity.openReading" class="examine-switch"></el-switch>
                                    <span class="tips" v-if="item.introduction">{{item.introduction}}</span>
                                </div>
                                <div class="set-box configurationForm" v-show="activity.openReading" @click="readManage">
                                    <img src="/static/pc/assets/images/setting.png" th:src="@{/pc/assets/images/setting.png}">
                                    <span class="tips set-information">配置书单</span>
                                </div>
                            </div>
                        </div>
                        <!--班级互动-->
                        <div class="form-item align-start" v-else-if="item.code == 'clazz_interaction'" data-name="template-component" :data-id="item.id">
                            <label class="label">{{item.name}}</label>
                            <div class="input-box column">
                                <div class="set-box">
                                    <el-switch v-model="activity.openClazzInteraction" class="examine-switch"></el-switch>
                                    <span class="tips" v-if="item.introduction">{{item.introduction}}</span>
                                </div>
                            </div>
                        </div>
                        <!--推送提醒-->
                        <div class="form-item align-start" v-else-if="item.code == 'push_reminder'" data-name="template-component" :data-id="item.id">
                            <label class="label">{{item.name}}</label>
                            <div class="input-box column">
                                <div class="set-box">
                                    <el-switch v-model="activity.openPushReminder" class="examine-switch"></el-switch>
                                    <span class="tips" v-if="item.introduction">{{item.introduction}}</span>
                                </div>
                                <div class="set-box configurationForm" v-show="activity.openPushReminder" @click="toPushReminderConfig">
                                    <img src="/static/pc/assets/images/setting.png" th:src="@{/pc/assets/images/setting.png}">
                                    <span class="tips set-information">编辑提醒内容</span>
                                </div>
                            </div>
                        </div>
                        <!--证书设置-->
                        <div class="form-item align-start" v-else-if="item.code == 'certificate'" data-name="template-component" :data-id="item.id">
                            <label class="label">{{item.name}}</label>
                            <div class="input-box column">
                                <div class="set-box configurationForm" style="margin-top: 0px;" @click="certificateEdit">
                                    <img src="/static/pc/assets/images/setting.png" th:src="@{/pc/assets/images/setting.png}">
                                    <span class="tips set-information">模版设置</span>
                                </div>
                            </div>
                        </div>
                        <!--标签-->
                        <div class="form-item cancel-margin marginTop16" v-else-if="item.code == 'tags'" data-name="template-component" :data-id="item.id">
                            <label class="label">{{item.name}}</label>
                            <div class="input-box wrap">
                                <el-select v-model="activity.tagNames" style="width: 698px;" multiple filterable allow-create default-first-option placeholder="选择或新建" no-data-text="输入后新建">
                                    <el-option v-for="(tag, index) of tags" :key="tag.name" :label="tag.name" :value="tag.name"></el-option>
                                </el-select>
                                <span class="tips" v-if="item.introduction">{{item.introduction}}</span>
                            </div>
                        </div>
                        <!--评价-->
                        <div v-else-if="item.code == 'activity_rating'" data-name="template-component" :data-id="item.id">
                            <div class="form-item">
                                <label class="label">{{item.name}}</label>
                                <div class="input-box">
                                    <el-switch v-model="activity.openRating" class="examine-switch"></el-switch>
                                    <span class="tips" v-if="item.introduction">{{item.introduction}}</span>
                                </div>
                            </div>
                            <div class="form-item" v-show="activity.openRating">
                                <label class="label">评价需审核</label>
                                <div class="input-box">
                                    <el-switch v-model="activity.ratingNeedAudit" class="examine-switch"></el-switch>
                                    <span>开启后，审核后的评价才能展示在评价列表</span>
                                </div>
                            </div>
                        </div>
                        <!--定时发布-->
                        <template v-else-if="item.code == 'timing_release'">
                            <div data-name="template-component" :data-id="item.id">
                                <div class="form-item">
                                    <label class="label">{{item.name}}</label>
                                    <div class="input-box">
                                        <el-switch v-model="activity.timingRelease" class="examine-switch"></el-switch>
                                        <span class="tips" v-if="item.introduction">{{item.introduction}}</span>
                                    </div>
                                </div>
                                <div class="form-item" v-show="activity.timingRelease">
                                    <label class="label"></label>
                                    <div class="input-box">
                                        <el-date-picker v-model="activity.timingReleaseTimeStamp"
                                                        type="datetime"
                                                        placeholder="发布时间"
                                                        format="yyyy-MM-dd HH:mm"
                                                        value-format="timestamp"
                                                        prefix-icon="disable"
                                                        :clearable="false"
                                                        :editable="false"
                                                        :picker-options="timingReleasePickerOption">
                                        </el-date-picker>
                                        <span class="date-piker-icon" style="left: 192px;">
                                    <img src="/static/pc/assets/images/calendar.png" th:src="@{/pc/assets/images/calendar.png}">
                                </span>
                                    </div>
                                </div>
                            </div>
                        </template>
                        <!--简介-->
                        <div class="form-item align-start" style="margin-bottom: 0px;" v-else-if="item.code == 'introduction'" data-name="template-component" :data-id="item.id">
                            <label class="label">{{item.name}}</label>
                            <div class="input-box">
                                <!-- 笔记编辑器 -->
                                <div class="wrap ueditor">
                                    <script type="text/plain" id="container" name="content"></script>
                                </div>
                                <span class="tips" v-if="item.introduction">{{item.introduction}}</span>
                            </div>
                        </div>
                        <!--报名设置列表-->
                        <div v-else-if="signUpMap[item.id] && (item.code == 'sign_up' || item.code =='company_sign_up')" data-name="template-component" :data-id="item.id">
                            <div class="set-box">
                                <div class="title set">{{item.name}}</div>
                                <el-switch v-model="signUpMap[item.id].enable" class="section-switch" @change="signUpEnableChanged(item.id)"></el-switch>
                            </div>
                            <!-- 点击参与设置 -->
                            <form action="" onsubmit="return false;" class="setForm" v-show="!signUpMap[item.id].deleted">
                                <template v-for="(it, idx) in item.children">
                                    <!--报名时间-->
                                    <div class="form-item" v-if="it.code == 'sign_up_time_scope'">
                                        <label class="label"><img src="/static/pc/assets/images/required.png" th:src="@{/pc/assets/images/required.png}" class="required-img" v-if="it.required">{{it.name}}</label>
                                        <div class="input-box">
                                            <el-date-picker
                                                    v-model="signUpMap[item.id] && signUpMap[item.id].startTime"
                                                    type="datetime"
                                                    format="yyyy-MM-dd HH:mm"
                                                    value-format="timestamp"
                                                    :clearable="false"
                                                    :editable="false"
                                                    :default-time="['00:00:00']"
                                                    placeholder="开始时间">
                                            </el-date-picker>
                                            <span class="date-range-icon"><img src="/static/pc/assets/images/swap-right.png" th:src="@{/pc/assets/images/swap-right.png}"></span>
                                            <el-date-picker
                                                    v-model="signUpMap[item.id] && signUpMap[item.id].endTime"
                                                    type="datetime"
                                                    format="yyyy-MM-dd HH:mm"
                                                    value-format="timestamp"
                                                    :clearable="false"
                                                    :editable="false"
                                                    :default-time="['23:59:59']"
                                                    placeholder="结束时间">
                                            </el-date-picker>
                                            <span class="tips" v-if="it.introduction">{{it.introduction}}</span>
                                        </div>
                                    </div>
                                    <!--参与角色限制-->
                                    <div class="form-item" v-else-if="it.code == 'sign_up_role_limit'" style="flex-wrap: wrap">
                                        <label class="label"><img src="/static/pc/assets/images/required.png" th:src="@{/pc/assets/images/required.png}" class="required-img" v-if="it.required">{{it.name}}</label>
                                        <div class="input-box">
                                            <el-switch v-model="signUpMap[item.id].openRoleLimit"></el-switch>
                                            <span class="tips" v-if="it.introduction">{{it.introduction}}</span>
                                        </div>
                                        <div class="join-box" style="margin-left: 115px;margin-top: 12px;">
                                            <div class="join-select" v-show="signUpMap[item.id].openRoleLimit">
                                                <img src="/static/pc/assets/images/add-circle.png" th:src="@{/pc/assets/images/add-circle.png}" class="add-range" @click="toAddSignUpParticipateRole(item.id, it)">
                                                <span v-if="signUpMap[item.id].roleParticipateScopes.length < 1">请选择</span>
                                                <div class="add-tags" v-else>
                                                    <span v-for="(role, roleIndex) of signUpMap[item.id].roleParticipateScopes">{{role.name}}<i class="del_btn" @click="deleteSignUpParticipateRole(item.id, it, roleIndex)"></i></span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <!--微服务参与范围-->
                                    <div class="form-item flexStart" v-else-if="it.code == 'wfw_participation_scope'">
                                        <label class="label"><img src="/static/pc/assets/images/required.png" th:src="@{/pc/assets/images/required.png}" class="required-img" v-if="it.required">{{it.name}}</label>
                                        <div class="join-box">
                                            <div :class="{'autoRange': (!signUpMap[item.id].enableWfwParticipateScope)}">
                                                <el-radio-group v-model="signUpMap[item.id].wfwOrgScope" @change="wfwOrgScopeChange($event, item.id)" >
                                                    <el-radio :label="scope.value" name="active-type" v-for="(scope,sidx) in scopeList" :key="'wfw-scope-' + sidx">{{scope.label}}</el-radio>
                                                </el-radio-group>
                                            </div>
                                            <div class="join-select" v-show="signUpMap[item.id].enableWfwParticipateScope" style="margin-top: 12px;">
                                                <img src="/static/pc/assets/images/add-circle.png" th:src="@{/pc/assets/images/add-circle.png}" class="add-range" @click="toAddSignUpParticipateScope(item.id, it)">
                                                <span v-if="signUpMap[item.id].wfwParticipateScopes.length <= 0">请选择</span>
                                                <div class="add-tags" v-else>
                                                    <span v-for="(scope, scopeIndex) of signUpMap[item.id].wfwParticipateScopes">{{scope.externalName}}<i class="del_btn" @click="deleteSignUpParticipateScope(item.id, it, scopeIndex)"></i></span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <!--通讯录参与范围-->
                                    <div class="form-item flexStart" v-else-if="it.code == 'contacts_participation_scope'">
                                        <label class="label"><img src="/static/pc/assets/images/required.png" th:src="@{/pc/assets/images/required.png}" class="required-img" v-if="it.required">{{it.name}}</label>
                                        <div class="join-box">
                                            <div :class="{'autoRange': (!signUpMap[item.id].enableContactsParticipateScope)}">
                                                <el-radio-group v-model="signUpMap[item.id].contactScope" @change="contactScopeChange($event, item.id)">
                                                    <el-radio :label="scope.value" name="active-type" v-for="(scope,sidx) in scopeList" :key="'contacts-scope-' + sidx">{{scope.label}}</el-radio>
                                                </el-radio-group>
                                            </div>
                                            <div class="join-select" v-show="signUpMap[item.id].enableContactsParticipateScope">
                                                <img src="/static/pc/assets/images/add-circle.png" th:src="@{/pc/assets/images/add-circle.png}" class="add-range" @click="toAddSignUpParticipateScope(item.id, it)">
                                                <span v-if="signUpMap[item.id].contactsParticipateScopes.length <= 0">请选择</span>
                                                <div class="add-tags" v-else>
                                                    <span v-for="(scope, scopeIndex) of signUpMap[item.id].contactsParticipateScopes">{{scope.externalName}}<i class="del_btn" @click="deleteSignUpParticipateScope(item.id, it, scopeIndex)"></i></span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <!--报名人数限制-->
                                    <div class="form-item" v-else-if="it.code == 'sign_up_person_limit'">
                                        <label class="label"><img src="/static/pc/assets/images/required.png" th:src="@{/pc/assets/images/required.png}" class="required-img" v-if="it.required">{{it.name}}</label>
                                        <div class="input-box">
                                            <div class="select-person-radio">
                                                <el-radio v-model="signUpMap[item.id].limitPerson" :label="false" name="active-type">不限</el-radio>
                                                <el-radio v-model="signUpMap[item.id].limitPerson" :label="true" name="active-type">自定义</el-radio>
                                            </div>
                                            <span class="tips" v-if="it.introduction">{{it.introduction}}</span>
                                            <input v-show="signUpMap[item.id].limitPerson" v-model="signUpMap[item.id].personLimit" type="number" min="1" step="1" maxlength="10" placeholder="请输入正整数" class="person"><span class="person-span" v-show="signUpMap[item.id].limitPerson">人</span>
                                        </div>
                                    </div>
                                    <!--报名填报信息-->
                                    <div class="form-item align-start" v-else-if="it.code == 'sign_up_fill_info'">
                                        <label class="label" style="line-height: 20px;"><img src="/static/pc/assets/images/required.png" th:src="@{/pc/assets/images/required.png}" class="required-img" v-if="it.required">{{it.name}}</label>
                                        <div class="input-box column">
                                            <div class="set-box">
                                                <el-switch v-model="signUpMap[item.id].fillInfo" @change="formFillSwitchChange($event, it)"></el-switch>
                                                <span class="tips" v-if="it.introduction">{{it.introduction}}</span>
                                            </div>
                                            <div v-if="signUpMap[item.id].formType == 'form'" class="set-box configurationForm" v-show="signUpMap[item.id].fillInfo" @click="toConfigForm(item.id)">
                                                <img src="/static/pc/assets/images/setting.png" th:src="@{/pc/assets/images/setting.png}">
                                                <span class="tips set-information">配置表单</span>
                                            </div>
                                            <!--万能表单-->
                                            <div v-else-if="signUpMap[item.id].formType == 'wfw_form' && signUpMap[item.id].fillInfoFormId" class="set-box configurationForm" v-show="signUpMap[item.id].fillInfo" @click="toWfwFormConfig(item.id)">
                                                <img src="/static/pc/assets/images/setting.png" th:src="@{/pc/assets/images/setting.png}">
                                                <span class="tips set-information">配置表单</span>
                                            </div>
                                            <!--审批-->
                                            <div v-else-if="signUpMap[item.id].formType == 'approval' && signUpMap[item.id].fillInfoFormId" class="set-box configurationForm" v-show="signUpMap[item.id].fillInfo" @click="toApprovalConfig(item.id)">
                                                <img src="/static/pc/assets/images/setting.png" th:src="@{/pc/assets/images/setting.png}">
                                                <span class="tips set-information">配置审批</span>
                                            </div>
                                            <!--未选择使用万能表单/审批的时候-->
                                            <div v-if="!signUpMap[item.id].fillInfoFormId" class="set-box configurationForm" v-show="signUpMap[item.id].fillInfo">
                                                <div class="input-box">
                                                    <el-radio v-for="(wfwFormFillInfoType, index) of wfwFormFillInfoTypes" :key="'wfw-form-fill-info-type-' + index" v-model="signUpMap[item.id].formType" :label="wfwFormFillInfoType.value" name="active-type">{{wfwFormFillInfoType.name}}</el-radio>
                                                    <span class="tips" v-if="item.introduction">{{item.introduction}}</span>
                                                    <!--配置表单/审批-->
                                                    <div style="display: flex;" @click="fillInfoConfig(item.id)">
                                                        <img src="/static/pc/assets/images/setting.png" th:src="@{/pc/assets/images/setting.png}">
                                                        <span class="tips set-information">配置{{signUpMap[item.id].formType == 'wfw_form' ? '表单' : '审批'}}</span>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <!--报名名单公开-->
                                    <div class="form-item" v-else-if="it.code == 'sign_up_public_list'">
                                        <label class="label"><img src="/static/pc/assets/images/required.png" th:src="@{/pc/assets/images/required.png}" class="required-img" v-if="it.required">{{it.name}}</label>
                                        <div class="input-box">
                                            <el-switch v-model="signUpMap[item.id].publicList"></el-switch>
                                            <span class="tips" v-if="it.introduction">{{it.introduction}}</span>
                                        </div>
                                    </div>
                                    <!--限制取消报名-->
                                    <template v-else-if="it.code == 'sign_up_cancel_signed_up' && signUpMap[item.id].formType != 'approval'">
                                        <div class="form-item">
                                            <label class="label"><img src="/static/pc/assets/images/required.png" th:src="@{/pc/assets/images/required.png}" class="required-img" v-if="it.required">{{it.name}}</label>
                                            <div class="input-box">
                                                <el-switch v-model="signUpMap[item.id].endNotAllowCancel" @change="endNotAllowCancelChange(item.id)"></el-switch>
                                                <span class="tips" v-if="it.introduction">{{it.introduction}}</span>
                                            </div>
                                        </div>
                                        <div class="form-item" v-show="signUpMap[item.id].endNotAllowCancel">
                                            <label class="label"></label>
                                            <div class="input-box" >
                                                <el-radio-group v-model="signUpMap[item.id].notAllowCancelType">
                                                    <el-radio v-for="(type, i) of notAllowCancelTypes" :key="'not-allow-cancel-type' + i" :label="type.value" @change="notAllowCancelTypeChange(item.id)">{{type.label}}</el-radio>
                                                </el-radio-group>
                                                <template v-if="signUpMap[item.id].notAllowCancelType == 'custom'">
                                                    <el-date-picker
                                                            style="margin-left: 10px"
                                                            v-model="signUpMap[item.id].notAllowCancelTime"
                                                            type="datetime"
                                                            format="yyyy-MM-dd HH:mm"
                                                            value-format="timestamp"
                                                            :clearable="false"
                                                            :editable="false"
                                                            :default-time="['00:00:00']"
                                                            placeholder="不可取消报名时间">
                                                    </el-date-picker>&nbsp;&nbsp;后
                                                </template>
                                            </div>
                                        </div>
                                    </template>
                                    <div class="form-item" v-else-if="it.code == 'on_site_sign_up'">
                                        <label class="label"><img src="/static/pc/assets/images/required.png" th:src="@{/pc/assets/images/required.png}" class="required-img" v-if="it.required">{{it.name}}</label>
                                        <div class="input-box">
                                            <el-switch v-model="signUpMap[item.id].onSiteSignUp"></el-switch>
                                            <span class="tips" v-if="it.introduction">{{it.introduction}}</span>
                                        </div>
                                    </div>
                                    <div class="form-item align-start" v-else-if="it.code == 'sign_up_condition'">
                                        <label class="label" style="line-height: 20px;"><img src="/static/pc/assets/images/required.png" th:src="@{/pc/assets/images/required.png}" class="required-img" v-if="it.required">{{it.name}}</label>
                                        <div class="input-box column">
                                            <div class="set-box">
                                                <el-switch v-model="signUpConditionMap[it.id].enable"></el-switch>
                                                <el-tooltip class="item-tips fl" effect="dark" disabled :content="signUpConditionTips(it.name, it.id)" placement="top">
                                                    <el-button>报名条件</el-button>
                                                </el-tooltip>
                                                <span class="tips" v-if="it.introduction">{{it.introduction}}</span>
                                            </div>
                                            <div v-if="signUpConditionMap[it.id].enable && signUpConditionMap[it.id].allowSignedUp && signUpConditionMap[it.id].configOnActivity" class="set-box configurationForm" @click="toConfigSignUpDetails(it.id)">
                                                <img src="/static/pc/assets/images/setting.png" th:src="@{/pc/assets/images/setting.png}">
                                                <span class="tips set-information">配置明细</span>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="form-item" v-if="false">
                                        <label class="label position"><img src="/static/pc/assets/images/required.png" th:src="@{/pc/assets/images/required.png}" class="required-img">按钮名称</label>
                                        <div class="input-box btn-name">
                                            <el-input type="text" v-model.trim="signUpMap[item.id].btnName" placeholder="请输入内容" maxlength="6" show-word-limit></el-input>
                                        </div>
                                    </div>
                                </template>
                            </form>
                        </div>
                        <!--自定义应用配置-->
                        <div class="form-item align-start" v-else-if="item.type == 'custom_app'" data-name="template-component" :data-id="item.id">
                            <label class="label">{{item.name}}</label>
                            <div class="input-box column">
                                <div class="set-box">
                                    <el-switch v-model="customAppEnableMap[item.id]" class="examine-switch"></el-switch>
                                    <span class="tips" v-if="item.introduction">{{item.introduction}}</span>
                                </div>
                            </div>
                        </div>
                        <div :class="{'form-item': true, 'align-start': item.type == 'rich_text'}" v-else-if="inputTypes.indexOf(item.type) != -1" data-name="template-component" :data-id="item.id">
                            <label class="label"><img src="/static/pc/assets/images/required.png" th:src="@{/pc/assets/images/required.png}" class="required-img" v-if="item.required">{{item.name}}</label>
                            <template v-if="item.type == 'rich_text'">
                                <div class="input-box column">
                                    <!-- 富文本编辑器 -->
                                    <div class="set-box configurationForm" style="margin-top: 0" @click="toEditCustomRichText(item.id)">
                                        <img src="/static/pc/assets/images/setting.png" th:src="@{/pc/assets/images/setting.png}">
                                        <span class="tips set-information">编辑内容</span>
                                    </div>
                                </div>
                            </template>
                            <div v-else :class="{'input-box': true, 'setForm': item.type == 'int' || item.type == 'decimal'}">
                                <el-input v-if="item.type == 'text'" type="text" placeholder="请填写" v-model.trim="activityComponentValueMap[item.id].value"></el-input>
                                <input v-else type="number" v-model.trim="activityComponentValueMap[item.id].value" :step="item.type == 'decimal' ? 0.1 : 1" placeholder="请输入" class="score-input" @change="inputDataParseByType($event, item.id, item.type)">
                                <span class="tips" v-if="item.introduction">{{item.introduction}}</span>
                            </div>
                        </div>
                        <div class="form-item" v-else-if="item.type == 'radio'" data-name="template-component" :data-id="item.id">
                            <label class="label"><img src="/static/pc/assets/images/required.png" th:src="@{/pc/assets/images/required.png}" class="required-img" v-if="item.required">{{item.name}}</label>
                            <div class="input-box">
                                <el-select v-if="item.dataOrigin == 'form'" v-model="activityComponentValueMap[item.id].value" placeholder="请选择">
                                    <el-option v-for="value in item.fieldValues" :key="value" :label="value" :value="value"></el-option>
                                </el-select>
                                <el-select v-if="item.dataOrigin == 'custom'" v-model="activityComponentValueMap[item.id].value" placeholder="请选择">
                                    <el-option v-for="ckItem in item.componentFields" :key="ckItem.id" :label="ckItem.fieldName" :value="ckItem.fieldName"></el-option>
                                </el-select>
                                <span class="tips" v-if="item.introduction">{{item.introduction}}</span>
                            </div>
                        </div>
                        <div class="form-item" v-else-if="item.type == 'checkbox'" data-name="template-component" :data-id="item.id">
                            <label class="label"><img src="/static/pc/assets/images/required.png" th:src="@{/pc/assets/images/required.png}" class="required-img" v-if="item.required">{{item.name}}</label>
                            <div class="input-box">
                                <el-select v-if="item.dataOrigin == 'form'" multiple v-model="activityComponentValueMap[item.id].value" placeholder="请选择">
                                    <el-option v-for="value in item.fieldValues" :key="value" :label="value" :value="value"></el-option>
                                </el-select>
                                <el-select v-if="item.dataOrigin == 'custom'" multiple v-model="activityComponentValueMap[item.id].value" placeholder="请选择">
                                    <el-option v-for="ckItem in item.componentFields" :key="ckItem.id" :label="ckItem.fieldName" :value="ckItem.fieldName"></el-option>
                                </el-select>
                                <span class="tips" v-if="item.introduction">{{item.introduction}}</span>
                            </div>
                        </div>
                    </template>
                </form>
            </div>
            <!--当前使用的模版-->
            <div class="info box" v-if="activity.id && activity.webTemplateId && !isReselectConfig">
                <div class="set-box">
                    <div class="title">页面设置</div>
                </div>
                <div class="item-box" v-if="usedWebTemplate">
                    <div class="page-demo">
                        <img :src="usedWebTemplate.coverUrl" class="jqthumbImg">
                    </div>
                    <div class="pageset-right">
                        <div class="copy-box">
                            <a type="text" class="copy-link" :href="activity.previewUrl" target="_blank">{{activity.previewUrl}}</a>
                            <a href="javascript:" class="copy" @click="copyTemplatePreviewUrl">复制</a>
                        </div>
                        <button type="button" class="cancle-btn btn-main" @click="configPage">页面配置</button>
                        <button type="button" class="cancle-btn" @click="reselectTemplate">重新选择页面</button>
                    </div>
                </div>
            </div>
            <!--展示页 || 重新选择展示页-->
            <div class="info box" v-if="!activity.id || isReselectConfig">
                <div class="form-item align-start">
                    <label class="label">展示页面</label>
                    <div class="input-box display-block">
                        <p class="tips first">请选择你的活动呈现页面</p>
                        <div class="picture-list" style="background: #F7F8FA;position: relative">
                            <div class="swiper-container">
                                <div class="swiper-wrapper">
                                    <div v-for="(webTemplate, index) of webTemplates" :class="{'swiper-slide': true, active: (operateWebTemplateId == webTemplate.id) }" :key="'web-templates' + index" v-if="!webTemplate.deleted" @click="selectTemplate(index)">
                                        <div class="img-box">
                                            <img :src="webTemplate.coverUrl" class="img">
                                            <div class="check_"></div>
                                            <div class="zoom" @click="previewTemplate(index, $event)"></div>
                                        </div>
                                        <p class="overHidden1">{{webTemplate.name}}</p>
                                    </div>
                                </div>
                            </div>
                            <div class="swiper-pagination"></div>
                            <div class="swiper-next"><i class="icon-arrows-right"></i></div>
                            <div class="swiper-prev"><i class="icon-arrows-left"></i></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <!-- 新增活动分类和自定义选项的弹出框 -->
        <div class="dailog-box1" v-show="addEditActivityClassifyWindowShow">
            <div class="dailog">
                <div class="header">
                    <span>{{activityClassifyTitle}}</span>
                    <div @click="addEditActivityClassifyWindowShow = false">
                        <img src="/static/pc/assets/images/close.png" th:src="@{/pc/assets/images/close.png}" class="close">
                    </div>
                </div>
                <div class="body">
                    <el-input type="text" class="fenlei-input" v-model.trim="addEditActivityClassify.name" placeholder="请输入" maxlength="10" show-word-limit></el-input>
                </div>
                <div class="footer">
                    <div class="normal-btn cancle" @click="addEditActivityClassifyWindowShow = false">取消</div>
                    <div :class="{'normal-btn': true, 'before-sure': !addEditActivityClassify.name, 'after-sure': addEditActivityClassify.name}" @click="addEditActivityClassifySubmit">确定</div>
                </div>
            </div>
        </div>
        <!-- 图片库弹窗 start -->
        <div class="dailog-box1" v-show="pictureShow">
            <div class="dailog picture-dialog">
                <div class="header">
                    <span>图片库</span>
                    <img src="/static/pc/assets/images/close.png" th:src="@{/pc/assets/images/close.png}" @click="pictureShow = false" class="close">
                </div>
                <div class="body">
                    <div class="picture-box">
                        <!-- 选中的图片加上 current 类名-->
                        <div :class="{'item-box': true, current: activePicIndex == index }" v-for="(cloudId, index) in pictureCloudIds" @click="activePicIndex = index">
                            <div class="img-box">
                                <img :src="cloudDomain + '/star3/origin/' + cloudId" alt="" class="jqthumbImg">
                            </div>
                            <i class="select-pic"></i>
                        </div>
                    </div>
                </div>
                <div class="footer">
                    <div class="normal-btn cancle" @click="cancelPicSelect">取消</div>
                    <div class="normal-btn after-sure" @click="confirmPicSelect">确定</div>
                </div>
            </div>
        </div>
        <!-- 图片库弹窗 end -->
        <!-- 编辑提醒内容弹窗 -->
        <div class="dialog-box5" v-if="remindContentShow">
            <div class="dailog dialog-wrap edit-remind">
                <div class="header">
                    <span class="color333">编辑提醒内容</span>
                    <img src="/static/pc/assets/images/close.png" th:src="@{/pc/assets/images/close.png}" class="close" @click="remindContentShow = false">
                </div>
                <div class="dialog-content">
                    <form action="">
                        <div class="form-items">
                            <label class="label">接收人</label>
                            <div class="items receive-box">
                                <!-- 点击添加弹窗和参与范围弹窗一样 -->
                                <div class="add-receive" @click="toAddPushRemindScope"><img src="/static/pc/assets/images/add-circle.png" th:src="@{/pc/assets/images/add-circle.png}" alt=""></div>
                                <ul class="add-box" style="height: 28px">
                                    <li v-for="(scope, scopeIndex) of activityPushReminder.receiveScopes" :key="'receiver-scope-' + scopeIndex">
                                        <span>{{scope.externalName}}</span>
                                        <i class="del-btn" @click=""></i>
                                    </li>
                                </ul>
                            </div>
                        </div>
                        <div class="form-items">
                            <label class="label">发送时间</label>
                            <div class="items">
                                <span class="tips-txt">活动发布时</span>
                            </div>
                        </div>
                        <div class="form-items">
                            <label class="label">内容</label>
                            <el-input class="resize-none" type="textarea" :autosize="{ minRows: 5, maxRows: 5}"
                                      placeholder="请输入内容" v-model="activityPushReminder.content" maxlength="500" show-word-limit>
                            </el-input>
                        </div>
                    </form>
                </div>
                <div class="footer">
                    <div class="btn btn-border" @click="remindContentShow = false">取消</div>
                    <!-- 当前弹窗值不为空时加上 btn-normal 类-->
                    <div class="btn btn-normal" @click="confirmReminderDialog">完成</div>
                </div>
            </div>
        </div>
        <!-- 删除分类弹窗 -->
        <vue-confirm ref="deleteClassifyWindow" :message="'确认删除此' + activityClassifyTitle" :cancel="'保留'" :sure="'删除'" @callback="deleteClassifySubmit"></vue-confirm>
        <!-- 活动地图弹窗 -->
        <vue-map ref="activityMap" :map-dom-id="'activity-map'" :title="'设置地点'" @callback="activityAddressSure"></vue-map>
        <!-- 活动发布范围弹窗 -->
        <vue-activity-participate-scope :fid="fid" :title="releaseScopeTitle" ref="activityParticipateScopeWindow" @callback="updateParticipatedOrgs"></vue-activity-participate-scope>
        <!--报名参与角色-->
        <sign-up-participate-role :dom-id="'sign-up-participate-role-tree'" :fid="fid" :area-code="areaCode" ref="signUpParticipateRoleWindow" @callback="sureSignUpParticipateRole"></sign-up-participate-role>
        <!-- 报名参与范围弹窗 -->
        <vue-custom-participate-scope :dom-scope-id="'sign-up-participate-scope-tree'" ref="signUpParticipateScopeWindow" @sure-callback="sureSignUpParticipateScope"></vue-custom-participate-scope>
        <!-- 通知提醒范围弹窗 -->
        <vue-custom-participate-scope :dom-scope-id="'reminder-scope-tree'" ref="reminderParticipateScopeWindow" @sure-callback="sureReminderReceiverScope"></vue-custom-participate-scope>
        <!--报名条件配置-->
        <vue-sign-up-condition ref="signUpConfigDialogWindow" @callback="confirmSignUpConditionDetails"></vue-sign-up-condition>
        <!--自定义富文本-->
        <vue-rich-text ref="richTextEditDialogWindow" @callback="confirmRichTextEdit"></vue-rich-text>
        <!--预览url复制容器-->
        <input type="text" id="template-preview-url-input" v-model.trim="activity.previewUrl" style="position: absolute; top: -100px; height: 1px;">
        <!--活动是线下但是没有选择地点的提示-->
        <vue-confirm ref="offlineEmptyAddressWindow" :message="'未填写位置信息，展示页面中的地图位置可能不准确'" :cancel="'取消'" :sure="'继续保存'" @callback="ignoreOfflineEmptyAddress"></vue-confirm>
        <!--重新选择门户模版-->
        <vue-confirm ref="reSelectWebTemplateWindow" :message="'重新选择展示页面可能会导致部分数据丢失'" :cancel="'取消'" :sure="'继续'" @callback="sureReSelectWebTemplate"></vue-confirm>
    </div>
    <div v-show="showSignInListIframe">
        <div class="top flex">
            <div class="go-back" @click="getSignId">
                <template>
                    <i class="icon-back"></i><span>返回</span>
                </template>
            </div>
            <div class="name-txt">编辑签到</div>
        </div>
        <iframe id="sign-in-list" src="" width="100%" style="border: 0; background-color: #fff; margin-top: 10px;"></iframe>
    </div>
    <div v-show="showFormCollectionIframe">
        <div class="top flex">
            <div class="go-back" @click="getFormCollectionSignId">
                <template>
                    <i class="icon-back"></i><span>返回</span>
                </template>
            </div>
            <div class="name-txt">编辑表单采集</div>
        </div>
        <iframe id="form-collection-list" src="" width="100%" style="border: 0; background-color: #fff; margin-top: 10px;"></iframe>
    </div>
    <!--分类组件弹窗-->
    <div class="dailog-box2" v-show="classifyWindowShow">
        <div class="dailog choose-field">
            <div class="header">
                <span>{{activityClassifyTitle}}</span>
                <img src="/static/pc/assets/images/close.png" th:src="@{/pc/assets/images/close.png}" class="close" @click="classifyWindowShow = false">
            </div>
            <div class="body" style="max-height: 400px;">
                <div class="form">
                    <div class="choose-box word-drag-inner" id="word-drag-inner">
                        <div class="sort-item" name="classify" :data-id="classify.id" v-for="(classify, index) of activityClassifies" :key="'edit-classify-' + index">
                            <i class="icon-drag-inner icon-drag"></i>
                            <label class="label">{{activityClassifyTitle}}{{index + 1}}</label>
                            <el-input v-model.trim="classify.name" type="text" :disabled="!classify.owner" placeholder="请输入" class="weight318" maxlength="10" show-word-limit @blur="addEditClassifySubmit(index)"></el-input>
                            <i class="icon-minus-circle" v-if="classify.owner" @click="toDeleteClassify(index)"></i>
                        </div>
                    </div>
                    <div class="add-option" style="display: inline-block;">
                        <span @click="toAddClassify"><i class="icon-plus-circle"></i>添加{{activityClassifyTitle}}</span>
                    </div>
                </div>
            </div>
            <div class="footer">
                <div class="normal-btn cancle" @click="classifyWindowShow = false">取消</div>
                <div class="normal-btn after-sure" @click="classifyWindowShow = false">确定</div>
            </div>
        </div>
    </div>
</div>
<div th:replace="pc/include/common_js :: common_js(~{::script})">
    <script src="//api.map.baidu.com/api?v=3.0&ak=aG5nWGO5m5tkVhBHGuVppoIRfKbyp5H3"></script>
    <script th:src="|${noteDomain}/res/plugin/ueditor4thirdparty/rich.text.util.js|"></script>
    <script type="text/javascript">
        RichTextUitl.loadEditorProfile();
    </script>
    <script src="/static/pc/assets/lib/zTree_v3/js/jquery.ztree.core.js" th:src="@{/pc/assets/lib/zTree_v3/js/jquery.ztree.core.js}"></script>
    <script src="/static/pc/assets/lib/zTree_v3/js/jquery.ztree.excheck.min.js" th:src="@{/pc/assets/lib/zTree_v3/js/jquery.ztree.excheck.min.js}"></script>
    <script src="/static/pc/assets/lib/zTree_v3/js/jquery.ztree.exedit.js" th:src="@{/pc/assets/lib/zTree_v3/js/jquery.ztree.exedit.js}"></script>
    <script src="/static/pc/assets/lib/element-ui/lib/index.js" th:src="@{/pc/assets/lib/element-ui/lib/index.js}"></script>
    <script src="/static/pc/assets/lib/webuploader/webuploader.js" th:src="@{/pc/assets/lib/webuploader/webuploader.js}"></script>
    <script src="/static/pc/assets/lib/Swiper-3.4.2/dist/js/swiper.min.js" th:src="@{/pc/assets/lib/Swiper-3.4.2/dist/js/swiper.min.js}"></script>
    <script src="/static/pc/assets/component/map.js" th:src="@{/pc/assets/component/map.js}"></script>
    <script src="/static/pc/assets/component/sign-map.js" th:src="@{/pc/assets/component/sign-map.js}"></script>
    <script src="/static/pc/assets/component/activity-participate-scope.js" th:src="@{/pc/assets/component/activity-participate-scope.js}"></script>
    <script src="/static/pc/assets/component/vue-custom-participate-scope.js" th:src="@{/pc/assets/component/vue-custom-participate-scope.js}"></script>
    <script src="/static/pc/assets/component/sign-up-participate-role.js" th:src="@{/pc/assets/component/sign-up-participate-role.js}"></script>
    <script src="/static/pc/assets/component/sign-up-condition.js" th:src="@{/pc/assets/component/sign-up-condition.js}"></script>
    <script src="/static/pc/assets/component/rich-text.js" th:src="@{/pc/assets/component/rich-text.js}"></script>
    <script src="/static/pc/assets/component/confirm.js" th:src="@{/pc/assets/component/confirm.js}"></script>
    <script src="/static/pc/assets/lib/jqthumb.min.js" th:src="@{/pc/assets/lib/jqthumb.min.js}"></script>
    <script src="/static/pc/assets/lib/set-iframe-height-parent.js" th:src="@{/pc/assets/lib/set-iframe-height-parent.js}"></script>
    <script src="/static/pc/assets/lib/set-iframe-height-child.js" th:src="@{/pc/assets/lib/set-iframe-height-child.js}"></script>
    <script src="/static/pc/assets/lib/iframeResizer.contentWindow.min.js" th:src="@{/pc/assets/lib/iframeResizer.contentWindow.min.js}"></script>
    <script src="/static/pc/assets/lib/drag/sortTable.js" th:src="@{/pc/assets/lib/drag/sortTable.js}"></script>
    <script th:inline="javascript">
        vm = new Vue({
            el: "#activity-vue",
            data: {
                mainDomain: [[${mainDomain}]],
                signWebDomain: [[${signWebDomain}]],
                workDomain: [[${workDomain}]],
                xueyaDomain: [[${xueyaDomain}]],
                cloudDomain: [[${cloudDomain}]],
                wfwFormDomain: [[${wfwFormDomain}]],
                isClone: [[${isClone}]],
                uid: [[${session._login_user_.uid}]],
                fid: [[${session._login_user_.fid}]],
                areaCode: [[${areaCode}]],
                templateId: [[${templateId}]],
                marketId: [[${marketId}]],
                defaultSignUpBtnName: [[${marketSignUpConfig != null ? marketSignUpConfig.signUpBtnName : ""}]],
                defaultSignUpKeyword: [[${marketSignUpConfig != null ? marketSignUpConfig.signUpKeyword : ""}]],
                activity: [[${activity}]],
                templateComponents: [[${templateComponents}]],
                tplComponentPartitions: [],
                templateComponentMap: {},
                needInitEditor: false,
                inputTypes: ['text', 'int', 'decimal', 'rich_text'],
                isEmbedded: activityApp.isEmbedded(),
                // 是否重新选择模版
                isReselectConfig: false,
                // 使用的模版
                usedWebTemplate: [[${usedWebTemplate}]],
                // 模板列表
                webTemplates: [[${webTemplates}]],
                activityTypes: [[${activityTypes}]],
                activityClassifies: [[${activityClassifies}]],
                currGroupType: 'wfw',
                // 文件上传
                uploader: null,
                // 新增修改活动分类弹窗的显示
                addEditActivityClassifyWindowShow: false,
                addEditActivityClassifyIndex: null,
                addEditActivityClassify: {
                    classifyId: null,
                    name: ""
                },
                deleteActivityClassifyId: null,
                // 标签
                tags: [[${tags}]],
                // 发布类型(org: 机构发布， class: 班级发布)
                releaseType: "org",
                classList: [],
                // 参与班级id列表
                releaseClassIds: [[${releaseClassIds}]],
                // 参与机构列表
                participatedOrgs: [[${participatedOrgs}]],
                // 处理的模板id
                operateWebTemplateId: "",
                activityComponentValueMap: {},
                // 签到报名相关
                sign: [[${sign}]],
                // 报名: { originId: signUp }
                signUpMap: {},
                // 报名信息填写类型: { templateComponentId: signUpFillInfoType }
                fillInfoTypeMap: {},
                customAppEnableTplComponentIds: [[${customAppEnableTplComponentIds}]],
                customAppEnableMap: {},
                signUpConditionMap: {},
                formStructureMap: {},   // 报名条件的表单结构map
                sucTplComponentIds: [[${sucTplComponentIds}]],
                signUpConditions: [[${signUpConditions}]],
                conditionEnums: [[${conditionEnums}]],
                // 当前操作的报名条件模板组件id
                operationSucTplComponentId: '',
                notAllowCancelTypes: [
                    {value: 'after_sign_up_end', label: '报名结束后'},
                    {value: 'after_activity_start', label: '活动开始后'},
                    {value: 'custom', label: '自定义'}
                ],
                scopeList: [
                    {value: 'no_limit', label: '不限'},
                    {value: 'only_self_unit', label: '仅本单位'},
                    {value: 'custom', label: '自定义'}
                ],
                // 万能表单填报信息类型
                wfwFormFillInfoTypes: [
                    {name: "填写表单", value: "wfw_form"},
                    {name: "填写表单并审批", value: "approval"}
                ],
                // 表单
                formConfigLayerIndex: "",
                // 报名参与范围
                signUpParticipateWindowShow: false,
                wfwGroups: [[${wfwGroups}]],
                contactGroups: [[${contactGroups}]],
                activityPushReminder: null,
                remindContentShow: false,

                // 活动标示
                activityFlag: [[${activityFlag}]],
                // 当前操作的对象
                operateTplComponentId: null,
                operateSignUpOriginId: -1,
                strict: [[${strict}]],
                // 活动封面上传中
                activityCoverUploading: false,
                timingReleasePickerOption: {
                    disabledDate: function (time) {
                        return activityApp.isBeforeToday(time.getTime());
                    }
                },
                activePicIndex: -1,
                pictureCloudIds: activityApp.default_cover_cloud_id_repo,
                pictureShow: false,
                showSignInListIframe: false,
                showFormCollectionIframe: false,
                scrollHeight: 0,
                signInNum: 0,
                formCollectionNum: 0,
                // 报名填报万能表单窗口
                wfwFormConfigWindow: null,
                // 考核管理配置窗口
                inspectionConfigWindow: null,
                releaseScopeTitle: "",
                activityClassifyTitle: "分类",
                // 班级
                classDataLoading: false,
                // 需要显示其他类型的活动市场id列表
                showOtherActivityType: activityApp.showOtherActivityType([[${marketId}]]),
                isCreator: [[${activity == null || activity.createUid == session._login_user_.uid}]],
                // 给报名填报信息默认创建的万能表单
                signUpFillInfoDefaultWfwFormMap: {},
                // 分类显示组件
                classifyShowComponents: [[${classifyShowComponents}]],
                classifyShowComponentsMap: {},
                allHideTemplateComponentIds: [],
                curHideTemplateComponentIds: [],
                classifyWindowShow: false,
                operateClassifyIndex: null,
            },
            created: function () {
                var $this = this;
                // 解决跨域
                document.domain = $this.mainDomain;
                window.addEventListener("message", function (e) {
                    if (e.origin.indexOf($this.wfwFormDomain.replace(/http(|s):\/\//, "")) > -1) {
                        var { data } = activityApp.getJsonObject(e.data);
                        var originId = $this.operateSignUpOriginId;
                        $this.$set($this.signUpMap[originId], "openAddr", data.openAddr);
                        $this.$set($this.signUpMap[originId], "pcUrl", data.pcUrl);
                        $this.$set($this.signUpMap[originId], "wechatUrl", data.wechatUrl);
                        $this.$set($this.signUpMap[originId], "fillInfoFormId", data.formId);
                        $this.wfwFormConfigWindow.close();
                    } else {
                        try {
                            var data = activityApp.getJsonObject(e.data);
                            if ("sign_in_list" == data.type) {
                                var signId = data.value;
                                if (!$this.sign.id) {
                                    $this.$set($this.sign, "id", signId);
                                }
                                $this.countSignInNum();
                                $this.showSignInListIframe = false;
                                $this.$nextTick(function () {
                                    $(document).scrollTop($this.scrollHeight);
                                });
                            } else if ("form_collection_list" == data.type) {
                                var signId = data.value;
                                if (!$this.sign.id) {
                                    $this.$set($this.sign, "id", signId);
                                }
                                $this.countFormCollectionNum();
                                $this.showFormCollectionIframe = false;
                                $this.$nextTick(function () {
                                    $(document).scrollTop($this.scrollHeight);
                                })
                            } else if ("inspection_config" == data.type) {
                                $this.activity.inspectionConfigId = data.inspectionConfigId;
                            }
                        } catch (e) {
                        }
                    }
                });
                // 表单字段map封装
                var formFields = [[${formFieldStructures}]] || {}
                var formIds = Object.keys(formFields);
                $this.formStructureMap = {}
                $(formIds).each(function (i) {
                    var formId = formIds[i];
                    if (formFields[formId]) {
                        var fieldNameCompObj = {};
                        $(formFields[formId]).each(function () {
                            fieldNameCompObj[this.name] = this;
                        });
                        $this.formStructureMap[formId] = fieldNameCompObj;
                    }
                });
                // 报名条件map封装
                var sucTplComponentIds = $this.sucTplComponentIds || [];
                $($this.signUpConditions).each(function () {
                    var _this = this;
                    $this.$set(_this, "enable", sucTplComponentIds.includes(_this.templateComponentId));
                    if (_this.activityConditionDetails) {
                        $(_this.activityConditionDetails).each(function () {
                            var fieldObj = $this.formStructureMap[_this.originIdentify];
                            $this.$set(this, "compt", fieldObj[this.fieldName].compt);
                            $this.$set(this, "options", fieldObj[this.fieldName].options || []);
                        })
                    }
                    $this.$set($this.signUpConditionMap, this.templateComponentId, _this);
                });
                // 启用的自定义应用模板组件id列表
                var customAppEnableTplComponentIds = $this.customAppEnableTplComponentIds || [];
                var partitionIndexs = [];
                // 前一个是不是特殊分区（报名属于特殊分区）
                var isPreSpecialPartition = false;
                $($this.templateComponents).each(function(i) {
                    var _this = this;
                    $this.templateComponentMap[_this.id] = _this;
                    if (this.code == 'introduction') {
                        $this.needInitEditor = true;
                    }
                    if ($this.releaseType == "org" && this.code == 'activity_release_scope' && this.dataOrigin == 'interface') {
                        $this.releaseType = "class";
                    }
                    if (_this.children && _this.children.length > 0) {
                        $(_this.children).each(function () {
                            if (this.code == 'sign_up_fill_info' && this.signUpFillInfoType) {
                                // 一个报名目前只有一个报名信息填写，故map的映射为 { signUpTplComponentId : signUpFillInfoType }
                                $this.fillInfoTypeMap[_this.id] = this.signUpFillInfoType;
                            }
                            $this.templateComponentMap[this.id] = this;
                        });
                    }
                    var isPartition = this.code == 'sign_up' || this.code == 'company_sign_up' || this.code == 'partition';
                    if (isPartition) {
                        partitionIndexs.push(i);
                    } else if (isPreSpecialPartition) {
                        partitionIndexs.push(i);
                    }
                    if (this.code == 'sign_up' || this.code == 'company_sign_up') {
                        isPreSpecialPartition = true;
                    } else {
                        isPreSpecialPartition = false;
                    }
                    if (this.code == "activity_classify") {
                        $this.activityClassifyTitle = this.name;
                    }
                    if (this.type == 'custom_app') {
                        $this.$set($this.customAppEnableMap, _this.id, customAppEnableTplComponentIds.includes(_this.id));
                    }
                });
                $(partitionIndexs).each(function (i) {
                    $this.tplComponentPartitions.push($this.templateComponents.slice(i == 0 ? 0 : partitionIndexs[i], i == partitionIndexs.length - 1 ? $this.templateComponents.length : partitionIndexs[i + 1]));
                });
                if (activityApp.isEmpty($this.activity)) {
                    $this.releaseClassIds = [];
                    // 新增活动
                    // 第一个分类的id
                    var firstActivityClassifyId = $this.activityClassifies[0] && $this.activityClassifies[0].id;
                    $this.activity = {
                        id: null,
                        name: "",
                        startTimeStamp: null,
                        endTimeStamp: null,
                        coverCloudId: activityApp.getDefaultCoverCloudId(),
                        coverUrl: "",
                        organisers: [[${session._login_user_.orgName}]],
                        activityType: "offline",
                        address: "",
                        detailAddress: "",
                        longitude: "",
                        dimension: "",
                        activityClassifyId: firstActivityClassifyId,
                        period: 0.0,
                        credit: 0.0,
                        timeLengthUpperLimit: null,
                        timingRelease: false,
                        timingReleaseTimeStamp: "",
                        openAudit: false,
                        openRating: false,
                        ratingNeedAudit: false,
                        integral: 0.0,
                        openWork: false,
                        openReading: false,
                        openClazzInteraction: false,
                        openPushReminder: false,
                        originType: "",
                        origin: "",
                        templateId: $this.templateId,
                        marketId: $this.marketId,
                        introduction: "",
                        webTemplateId: '',
                        // 目前数据接收实体没有以下字段
                        activityFlag: $this.activityFlag,
                        openGroup: false,
                        openInspectionConfig: false,
                        inspectionConfigId: null,
                        // 关联的标签id列表
                        tagIds: [],
                        // 选择的标签名称列表
                        tagNames: []
                    };
                    // 展示模板页面 初始化默认选择第一个
                    var firstWebTemplate = $this.webTemplates && $this.webTemplates[0];
                    $this.operateWebTemplateId = firstWebTemplate && firstWebTemplate.id;
                    $this.activity.webTemplateId = firstWebTemplate && firstWebTemplate.id;
                } else {
                    $this.marketId = $this.activity.marketId;
                    // 修改活动
                    if ($this.activity.activityComponentValues) {
                        $($this.activity.activityComponentValues).each(function () {
                            var componentField = $.extend({}, this);
                            var tplComponentItem = $this.templateComponentMap[this.templateComponentId];
                            if (!tplComponentItem) {
                                return true;
                            }
                            if (componentField.value && tplComponentItem.type == 'checkbox') {
                                componentField.value = componentField.value.split(',');
                            }
                            $this.$set($this.activityComponentValueMap, this.templateComponentId, componentField);
                        });
                    }
                    $this.operateWebTemplateId = $this.activity.webTemplateId;
                    // 处理标签
                    var tagIds = $this.activity.tagIds;
                    tagIds = activityApp.isEmpty(tagIds) ? [] : tagIds;
                    var tagNames = [];
                    $($this.tags).each(function () {
                        if (tagIds.indexOf(this.id) > -1) {
                            tagNames.push(this.name);
                        }
                    });
                    $this.$set($this.activity, "tagNames", tagNames);
                }
                $this.initActivityPushReminder();
                $this.newCertificate();
                $this.$set($this.activity, "timeScope", [$this.activity.startTimeStamp, $this.activity.endTimeStamp]);
                $($this.activityTypes).each(function (i) {
                    if ($this.activity.activityType == this.value) {
                        $this.$set($this.activityTypes[i], "selected", true);
                    } else {
                        $this.$set($this.activityTypes[i], "selected", false);
                    }
                });
                var selectedActivityClassifyId = $this.activity.activityClassifyId;
                $($this.activityClassifies).each(function (i) {
                    if (this.id == selectedActivityClassifyId) {
                        $this.$set($this.activityClassifies[i], "selected", true);
                    } else {
                        $this.$set($this.activityClassifies[i], "selected", false);
                    }
                });
                if (!$this.isClone && activityApp.isEmpty($this.sign.id)) {
                    // 生成新的报名签到
                    $this.sign = signApp.newSign();
                    // 根据模板组件关联关系，初始化数据
                    $($this.templateComponents).each(function () {
                        if (this.code == 'sign_up' || this.code == 'company_sign_up') {
                            var signUp = signApp.newSignUp(this, $this.defaultSignUpBtnName, $this.defaultSignUpKeyword);
                            if (this.code == 'company_sign_up') {
                                signUp.fillInfo = true;
                                signUp.customSignUpType = "company";
                            }
                            var signUpChildrenComponents = this.children;
                            if (!activityApp.isEmpty(signUpChildrenComponents)) {
                                $(signUpChildrenComponents).each(function () {
                                    if ("sign_up_fill_info" == this.code) {
                                        var signUpFillInfoType = this.signUpFillInfoType;
                                        if (!activityApp.isEmpty(signUpFillInfoType)) {
                                            signUp.formType = signUpFillInfoType.type;
                                        }
                                    }
                                });
                            }
                            signUp.originId = this.id;
                            $this.$set($this.signUpMap, this.id, signUp);
                        } else if ((this.type == 'radio' || this.type == 'checkbox' || $this.inputTypes.indexOf(this.type) != -1) && !$this.activityComponentValueMap[this.id]) {
                            $this.$set($this.activityComponentValueMap, this.id, {
                                templateComponentId: this.id,
                                templateId: this.templateId,
                                componentId: this.componentId,
                                value: this.type == 'checkbox' ? [] : ''
                            });
                        }
                    });
                } else {
                    if (!$this.isClone) {
                        $this.countSignInNum();
                    }
                    // 报名签到
                    var signUpTplComponentIds = [];
                    $($this.templateComponents).each(function () {
                        if (this.code == 'sign_up' || this.code == 'company_sign_up') {
                            signUpTplComponentIds.push(this.id);
                        } else if ((this.type == 'radio' || this.type == 'checkbox' || $this.inputTypes.indexOf(this.type) != -1) && !$this.activityComponentValueMap[this.id]) {
                            $this.$set($this.activityComponentValueMap, this.id, {
                                templateComponentId: this.id,
                                templateId: this.templateId,
                                componentId: this.componentId,
                                value: this.type == 'checkbox' ? [] : ''
                            });
                        }
                    });
                    // 报名
                    $($this.sign.signUps).each(function (i) {
                        $this.$set($this.sign.signUps[i], "endNotAllowCancel", !this.endAllowCancel);
                        $this.initSignUpScope(i, this);
                        if (!this.endAllowCancel && !this.notAllowCancelType) {
                            $this.$set($this.sign.signUps[i], "notAllowCancelType", $this.notAllowCancelTypes[0].value);
                        }
                        if (($this.isClone || !activityApp.isEmpty(this.id)) && signUpTplComponentIds.indexOf(this.originId) != -1) {
                            if (this.wfwParticipateScopes) {
                                var wfwVirtualNodeMap = $this.getVirtualNodeMap($this.wfwGroups);
                                $(this.wfwParticipateScopes).each(function () {
                                    if (this.leaf && wfwVirtualNodeMap[this.externalId]) {
                                        this.virtualId = wfwVirtualNodeMap[this.externalId].virtualId;
                                    } else {
                                        this.virtualId = this.externalId;
                                    }
                                });
                            }
                            if (this.contactsParticipateScopes) {
                                var contactsVirtualNodeMap = $this.getVirtualNodeMap($this.contactGroups);
                                $(this.contactsParticipateScopes).each(function () {
                                    if (this.leaf && contactsVirtualNodeMap[this.externalId]) {
                                        this.virtualId = contactsVirtualNodeMap[this.externalId].virtualId;
                                    } else {
                                        this.virtualId = this.externalId;
                                    }
                                });
                            }
                            var tplComponentId = $this.sign.signUps[i].originId;
                            $this.$set($this.signUpMap, tplComponentId, $this.sign.signUps[i]);
                        }
                    });

                    $($this.templateComponents).each(function () {
                        var originId = this.id;
                        if (this.code == 'sign_up' || this.code == 'company_sign_up') {
                            if (!$this.signUpMap[originId]) {
                                var signUp = signApp.newSignUp($this.templateComponentMap[originId], $this.defaultSignUpBtnName, $this.defaultSignUpKeyword);
                                signUp.originId = originId;
                                if (this.code == 'company_sign_up') {
                                    signUp.fillInfo = true;
                                    signUp.customSignUpType = "company";
                                }
                                var signUpChildrenComponents = this.children;
                                if (!activityApp.isEmpty(signUpChildrenComponents)) {
                                    $(signUpChildrenComponents).each(function () {
                                        if ("sign_up_fill_info" == this.code) {
                                            var signUpFillInfoType = this.signUpFillInfoType;
                                            if (!activityApp.isEmpty(signUpFillInfoType)) {
                                                signUp.formType = signUpFillInfoType.type;
                                            }
                                        }
                                    });
                                }
                                signUp.deleted = true;
                                $this.$set($this.signUpMap, originId, signUp);
                            }
                        }
                    });
                }
                $.each($this.signUpMap, function (key, item) {
                    item.enable = !item.deleted;
                    item.btnName = $this.defaultSignUpBtnName ? $this.defaultSignUpBtnName : item.btnName;
                    item.keyword = $this.defaultSignUpKeyword ? $this.defaultSignUpKeyword : item.keyword;
                    if (!activityApp.isEmpty(item.startTime)) {
                        // 若报名签到非不限制
                        $this.$set(item, "timeScope", [item.startTime, item.endTime]);
                    }
                    if (activityApp.isEmpty($this.sign.id)) {
                        // 仅在新增的时候，根据signUpTplComponentId 初始化formType
                        var formType = $this.fillInfoTypeMap[item.originId] && $this.fillInfoTypeMap[item.originId].type;
                        item.formType = formType || 'form';
                    }
                    $this.createSignUpWfwForm(item.originId);
                });
                if (activityApp.isEmpty($this.participatedOrgs)) {
                    $this.participatedOrgs = [];
                }
                // 分类显示组件map封装
                $this.packageClassifyShowComponentsMap();
            },
            mounted: function () {
                var $this = this;
                // 初始化笔记编辑器
                if ($this.needInitEditor) {
                    app.initUEditor($this.activity.introduction);
                }
                $this.initUploader();
                $this.handleImg();
                $this.swiperInit()
                setTimeout(function () {
                    window.onscroll = function () {
                        var scrollTop = document.getElementById('edui1_toolbarbox').getBoundingClientRect().top;
                        if (scrollTop <= 50) {
                            $('#edui1_toolbarbox').attr('style', 'position:fixed;top:50px;z-index:2;width:900px;');
                        } else {
                            $('#edui1_toolbarbox').attr('style', '');
                        }
                    }
                }, 1000);
                $("#word-drag-inner").sortable({
                    scroll: true,
                    axis: "y",
                    dalay: 300,
                    handle: ".icon-drag-inner",
                    update: function (event, ui) {
                        var changedClassifyIds = [];
                        $("div[name='classify']").each(function () {
                            var id = $(this).data("id");
                            if (id) {
                                changedClassifyIds.push(id);
                            }
                        });
                        var url = ctx + "/api/market/" + $this.marketId + "/classify/sort";
                        if (!$this.marketId) {
                            url = ctx + "/api/market/" + $this.fid + "/classify/sort";
                        }
                        var params = {
                            classifyIds: changedClassifyIds
                        };
                        app.ajaxPostWithLoading(url, params, function (data) {
                            if (data.success) {
                                // 重新调整activityClassifies
                                var activityClassifies = [];
                                $(changedClassifyIds).each(function () {
                                    var classifyId = this;
                                    $($this.activityClassifies).each(function () {
                                        if (this.id == classifyId) {
                                            activityClassifies.push(this);
                                        }
                                    });
                                });
                                $this.activityClassifies = activityClassifies;
                            } else {
                                var message = data.message;
                                if (activityApp.isEmpty(message)) {
                                    message = "排序失败";
                                }
                                app.showMsg(message);
                            }
                        }, function () {
                            app.showMsg("排序失败");
                        });
                    },
                });
            },
            computed: {
                canConfirmReminder: function () {
                    var $this = this;
                    var reminder = $this.activityPushReminder;
                    return reminder && !activityApp.isEmpty(reminder.content) && reminder.receiveScopes && reminder.receiveScopes.length > 0;
                }
            },
            watch: {
                // 作品征集开关
                "activity.openWork": function () {
                    var $this = this;
                    if (!$this.activity.workId && $this.activity.openWork) {
                        // 创建作品征集
                        $this.addWork();
                    }
                },
                // 阅读设置开关
                "activity.openReading": function () {
                    var $this = this;
                    if (!$this.activity.readingId && $this.activity.openReading) {
                        // 创建作品征集
                        $this.addReading();
                    }
                },
                // 活动分类
                "activity.activityClassifyId": function () {
                    var $this = this;
                    // 处理组件的显示隐藏
                    var classifyId = $this.activity.activityClassifyId;
                    var showTemplateComponentIds = $this.classifyShowComponentsMap[classifyId];
                    if (!showTemplateComponentIds) {
                        showTemplateComponentIds = [];
                    }
                    var curHideTemplateComponentIds = [];
                    $($this.allHideTemplateComponentIds).each(function () {
                        var templateComponentId = parseInt(this);
                        if (showTemplateComponentIds.indexOf(templateComponentId) < 0) {
                            curHideTemplateComponentIds.push(templateComponentId);
                        }
                    });
                    $this.curHideTemplateComponentIds = curHideTemplateComponentIds;
                    $this.showOrHideComponent();
                }
            },
            methods: {
                // 使用jquery循环来显示隐藏
                showOrHideComponent: function () {
                    var $this = this;
                    $this.$nextTick(function () {
                        $("div[data-name='template-component']").each(function () {
                            var templateComponentId = $(this).data("id");
                            if ($this.curHideTemplateComponentIds.indexOf(templateComponentId) < 0) {
                                $(this).show();
                            } else {
                                $(this).hide();
                            }
                        });
                        $("div[data-name='template-component-partition']").each(function () {
                            var partitionIndex = $(this).data("index");
                            var existShowTemplateComponent = false;
                            var templateComponents = $this.tplComponentPartitions[partitionIndex];
                            $(templateComponents).each(function () {
                                if ($this.curHideTemplateComponentIds.indexOf(this.id) < 0) {
                                    existShowTemplateComponent = true;
                                    return false;
                                }
                            });
                            if (existShowTemplateComponent) {
                                $(this).show();
                            } else {
                                $(this).hide();
                            }
                        });
                    });
                },
                // 分类显示组件map封装
                packageClassifyShowComponentsMap: function () {
                    var $this = this;
                    var classifyShowComponentsMap = {};
                    $($this.classifyShowComponents).each(function () {
                        var classifyId = this.classifyId;
                        var templateComponentIds = classifyShowComponentsMap[classifyId];
                        if (!templateComponentIds) {
                            templateComponentIds = [];
                        }
                        // 统一使用字符串
                        var templateComponentId = this.templateComponentId;
                        templateComponentIds.push(templateComponentId);
                        if ($this.allHideTemplateComponentIds.indexOf(templateComponentId) < 0) {
                            $this.allHideTemplateComponentIds.push(templateComponentId);
                        }
                        classifyShowComponentsMap[classifyId] = templateComponentIds;
                    });
                    $this.classifyShowComponentsMap = classifyShowComponentsMap;
                    var showTemplateComponentIds = $this.classifyShowComponentsMap[$this.activity.activityClassifyId];
                    if (!showTemplateComponentIds) {
                        showTemplateComponentIds = [];
                    }
                    $($this.allHideTemplateComponentIds).each(function () {
                        var templateComponentId = parseInt(this);
                        if (showTemplateComponentIds.indexOf(templateComponentId) < 0) {
                            $this.curHideTemplateComponentIds.push(templateComponentId);
                        }
                    });
                    $this.showOrHideComponent();
                },
                swiperInit:function (){
                    new Swiper('.swiper-container', {
                        slidesPerView: 3,
                        pagination: '.swiper-pagination',
                        nextButton: '.swiper-next',
                        prevButton: '.swiper-prev',
                        paginationClickable: true,
                        spaceBetween: 24,
                    });
                },
                // 创建报名万能表单
                createSignUpWfwForm: function (signUpTplComponentId) {
                    var $this =this;
                    var signUp = $this.signUpMap[signUpTplComponentId];
                    // 判断报名的表单是否存在，不存在则创建表单
                    if (signUp.formType == 'wfw_form' && activityApp.isEmpty(signUp.fillInfoFormId)) {
                        // 克隆新的表单
                        var wfwFormTemplateId = $this.fillInfoTypeMap[signUpTplComponentId] && $this.fillInfoTypeMap[signUpTplComponentId].wfwFormTemplateId;
                        var url = ctx + "/api/wfw-form/create/from/wfw-form-template";
                        var params = {
                            fid: $this.fid,
                            uid: [[${session._login_user_.uid}]],
                            wfwFormTemplateId: wfwFormTemplateId
                        };
                        app.ajaxPost(url, params, function (res) {
                            if (res.success) {
                                var {formId, openAddr, pcUrl, wechatUrl} = res.data;
                                $this.signUpFillInfoDefaultWfwFormMap[signUpTplComponentId] = {
                                    "openAddr": openAddr,
                                    "pcUrl": pcUrl,
                                    "wechatUrl": wechatUrl,
                                    "fillInfoFormId": formId
                                };
                            } else {
                                var errorMessage = res.message;
                                if (activityApp.isEmpty(errorMessage)) {
                                    errorMessage = "报名信息填写，创建填写表单失败";
                                }
                                app.showMsg(errorMessage);
                            }
                        }, function () {
                            app.showMsg("报名信息填写，创建填写表单失败");
                        });
                    }
                },
                // 获取虚拟节点map，即非叶子节点复制本身作为其叶子节点，该叶子节点即为虚拟节点
                getVirtualNodeMap: function (groups) {
                    var $this = this;
                    var nodeMap = {};
                    $(groups).each(function () {
                        if (this.id !== this.virtualId) {
                            nodeMap[this.id] = this;
                        }
                    });
                    return nodeMap;
                },
                initSignUpScope: function(i, signUp) {
                    var $this = this;
                    if (signUp.enableContactsParticipateScope) {
                        $this.$set($this.sign.signUps[i], "contactScope", "custom");
                    } else if (signUp.contactOnlySelfUnit) {
                        $this.$set($this.sign.signUps[i], "contactScope", "only_self_unit");
                    } else {
                        $this.$set($this.sign.signUps[i], "contactScope", "no_limit");
                    }
                    if (signUp.enableWfwParticipateScope) {
                        $this.$set($this.sign.signUps[i], "wfwOrgScope", "custom");
                    } else if (signUp.wfwOnlySelfUnit) {
                        $this.$set($this.sign.signUps[i], "wfwOrgScope", "only_self_unit");
                    } else {
                        $this.$set($this.sign.signUps[i], "wfwOrgScope", "no_limit");
                    }
                },
                signUpConditionTips: function (name, tplComponentId) {
                    var $this = this;
                    var signUpCondition = $this.signUpConditionMap[tplComponentId];
                    if (!signUpCondition.activityConditionDetails || signUpCondition.activityConditionDetails.length == 0) {
                        return '';
                    }
                    var conditionFields = [];
                    $(signUpCondition.activityConditionDetails).each(function () {
                        conditionFields.push(this.fieldName);
                    })
                    return '在' + name + '中，匹配' + conditionFields.join(',') + '的条件可进行报名';
                },
                endNotAllowCancelChange: function (signUpTplComponentId) {
                    var $this = this;
                    if ($this.signUpMap[signUpTplComponentId].endNotAllowCancel && !$this.signUpMap[signUpTplComponentId].notAllowCancelType) {
                        $this.$set($this.signUpMap[signUpTplComponentId], "notAllowCancelType", $this.notAllowCancelTypes[0].value);
                        $this.$set($this.signUpMap[signUpTplComponentId], "notAllowCancelTime", null);
                    }
                },
                notAllowCancelTypeChange: function (signUpTplComponentId) {
                    var $this = this;
                    var value = $this.signUpMap[signUpTplComponentId].notAllowCancelType;
                    if (value == "custom" && !$this.signUpMap[signUpTplComponentId].notAllowCancelTime) {
                        $this.$set($this.signUpMap[signUpTplComponentId], "notAllowCancelTime", $this.activity.startTimeStamp);
                    }
                },
                periodChange: function () {
                    var $this = this;
                    var period = $this.activity.period;
                    if (activityApp.isEmpty(period)) {
                        period = 0;
                    } else {
                        period = parseFloat(period).toFixed(1);
                    }
                    $this.$set($this.activity, "period", period);
                },
                creditChange: function () {
                    var $this = this;
                    var credit = $this.activity.credit;
                    if (activityApp.isEmpty(credit)) {
                        credit = 0;
                    } else {
                        credit = parseFloat(credit).toFixed(1);
                    }
                    $this.$set($this.activity, "credit", credit);
                },
                cancelPicSelect: function () {
                    var $this = this;
                    $this.pictureShow = false;
                    $this.activePicIndex = 0;
                },
                confirmPicSelect: function () {
                    var $this = this;
                    var cloudId = $this.pictureCloudIds[$this.activePicIndex];
                    $this.$set($this.activity, "coverUrl", $this.cloudDomain + "/star3/origin/" + cloudId + ".jpg");
                    $this.$set($this.activity, "coverCloudId", cloudId);
                    $this.$nextTick(function () {
                        $this.handleImg();
                    });
                    $this.cancelPicSelect();
                },
                signUpEnableChanged: function (tplComponentId) {
                    var $this = this;
                    $this.$set($this.signUpMap[tplComponentId], "deleted", !$this.signUpMap[tplComponentId].enable);
                },
                handleImg: function () {
                    $('.jqthumbImg').jqthumb({
                        width: '100%',
                        height: '100%'
                    });
                },
                // 初始化文件上传
                initUploader: function () {
                    var $this = this;
                    $this.uploader = WebUploader.create({
                        // swf文件路径
                        swf: ctx + "/pc/assets/lib/webuploader/Uploader.swf",
                        // 文件接收服务端。
                        server: ctx + "/api/upload/img",
                        // 选择文件的按钮。可选。
                        // 内部根据当前运行是创建，可能是input元素，也可能是flash.
                        pick: "#cover-upload-btn",
                        // 不压缩image, 默认如果是jpeg，文件上传前会压缩一把再上传！
                        resize: false,
                        auto: true,
                        duplicate: true,
                        // 只允许选择图片文件。
                        accept: {
                            title: 'Images',
                            extensions: 'gif,jpg,jpeg,bmp,png',
                            mimeTypes: 'image/*'
                        }
                    });
                    $this.uploader.on("startUpload", function (file, response) {
                        // 上传完成
                        $this.activityCoverUploading = true;
                    });
                    $this.uploader.on("uploadSuccess", function (file, response) {
                        if (response.success) {
                            var data = response.data;
                            data = activityApp.getJsonObject(data);
                            var result = data.result;
                            if (result == 1) {
                                var cloudId = data.objectid;
                                $this.$set($this.activity, "coverUrl", "");
                                $this.$set($this.activity, "coverCloudId", cloudId);
                                $this.$nextTick(function () {
                                    $this.handleImg();
                                });
                            } else {
                                app.showMsg("上传失败");
                            }
                        } else {
                            var errorMessage = response.message;
                            if (activityApp.isEmpty(errorMessage)) {
                                errorMessage = "上传失败";
                            }
                            app.showMsg(errorMessage);
                        }
                    });
                    $this.uploader.on("uploadComplete", function (file, response) {
                        // 上传完成
                        $this.activityCoverUploading = false;
                    });
                    $this.uploader.on("uploadError", function (file, reason) {
                        app.showMsg(reason);
                    });
                },
                // 修改活动类型
                changeActivityType: function (index) {
                    var $this = this;
                    var activityType = $this.activityTypes[index];
                    $this.activity.activityType = activityType.value;
                },
                // 加载发布班级数据
                loadReleaseClassData: function (dataUrl) {
                    var $this = this;
                    var pattern = /^(https?:\/\/(([a-zA-Z0-9]+-?)+[a-zA-Z0-9]+\.)+[a-zA-Z]+)(:\d+)?(\/.*)?(\?.*)?(#.*)?$/;
                    if (!pattern.test(dataUrl)) {
                        app.showMsg("发布班级数据接口地址非法");
                        return;
                    }
                    if ($this.classDataLoading) {
                        return;
                    }
                    $this.classDataLoading = true;
                    var url = ctx + "/api/third-party/query/teaching/clazz";
                    dataUrl = $this.packageReleaseClassUrl(dataUrl);
                    app.ajaxPost(url, {url: dataUrl}, function (data) {
                        if (data.success) {
                            $this.classList = data.data;
                            var finalReleaseClassIds = [];
                            $(data.data).each(function () {
                                if ($this.releaseClassIds.indexOf(this.id) != -1) {
                                    finalReleaseClassIds.push(this.id);
                                }
                            });
                            $this.releaseClassIds = finalReleaseClassIds;
                        } else {
                            var errorMessage = data.message;
                            if (activityApp.isEmpty(errorMessage)) {
                                errorMessage = "获取班级列表失败";
                            }
                            app.showMsg(errorMessage);
                        }
                        $this.classDataLoading = false;
                    }, function () {
                        $this.classDataLoading = false;
                        app.showMsg("获取班级列表失败");
                    });
                },
                packageReleaseClassUrl: function (dataUrl) {
                    var $this = this;
                    if (dataUrl.indexOf("?") == -1) {
                        dataUrl += "?fid=" + $this.fid + "&uid=" + $this.uid;
                        return dataUrl;
                    }
                    var paramSplitIndex = dataUrl.indexOf("?"),
                            originUrl = dataUrl.substring(0, paramSplitIndex),
                            params = dataUrl.substring(paramSplitIndex + 1).split("&");
                    var existUid = false, existFid = false;
                    $(params).each(function (i) {
                        if (!existUid && params[i].indexOf("uid=") != -1) {
                            existUid = true
                        } else if (!existFid && params[i].indexOf("fid=") != -1) {
                            existFid = true;
                        }
                    });
                    if (!existUid) {
                        params.push("uid=" + $this.uid);
                    }
                    if (!existFid) {
                        params.push("fid=" + $this.fid);
                    }
                    return originUrl + "?" + params.join("&")
                },
                // 显示发布范围弹窗
                toAddParticipateScope: function (title) {
                    var $this = this;
                    $this.releaseScopeTitle = title;
                    $this.$refs.activityParticipateScopeWindow.showWindow($this.participatedOrgs);
                },
                // 更新发布范围的机构
                updateParticipatedOrgs: function () {
                    var $this = this;
                    $this.participatedOrgs = $this.$refs.activityParticipateScopeWindow.selectedOrgs;
                },
                // 显示百度地图
                showActivityMap: function () {
                    var $this = this;
                    $this.$refs.activityMap.showMap($this.activity.longitude, $this.activity.dimension, $this.activity.address);
                },
                // 确定活动地址
                activityAddressSure: function () {
                    var $this = this;
                    $this.activity.address = $this.$refs.activityMap.address;
                    $this.activity.longitude = $this.$refs.activityMap.lng;
                    $this.activity.dimension = $this.$refs.activityMap.lat;
                },
                toAddActivityClassify: function () {
                    var $this = this;
                    $this.addEditActivityClassify = $this.marketId ? {
                        marketId: $this.marketId,
                        name: ""
                    } : {
                        fid: $this.fid,
                        name: ""
                    };
                    $this.addEditActivityClassifyWindowShow = true;
                },
                toEditActivityClassify: function (index, e) {
                    e.stopPropagation();
                    var $this = this;
                    var activityClassify = $this.activityClassifies[index];
                    $this.addEditActivityClassifyIndex = index;
                    $this.addEditActivityClassify = $this.marketId ? {
                        classifyId: activityClassify.id,
                        name: activityClassify.name,
                        marketId: $this.marketId
                    } : {
                        classifyId: activityClassify.id,
                        name: activityClassify.name,
                        fid: $this.fid,
                    };
                    $this.addEditActivityClassifyWindowShow = true;
                },
                addEditActivityClassifySubmit: function () {
                    var $this = this;
                    if (activityApp.isEmpty($this.addEditActivityClassify.name)) {
                        return;
                    }
                    var isAdd = activityApp.isEmpty($this.addEditActivityClassify.classifyId);
                    var tips = "新增";
                    var orgUrl = ctx + "/api/org/" + $this.fid + "/classify/add";
                    var marketUrl = ctx + "/api/market/" + $this.marketId + "/classify/add";
                    if (!isAdd) {
                        orgUrl = ctx + "/api/org/" + $this.fid + "/classify/edit";
                        marketUrl = ctx + "/api/market/" + $this.marketId + "/classify/update";
                        tips = "修改";
                    }
                    var url = $this.marketId ? marketUrl : orgUrl;
                    var params = $this.marketId ? {
                        classifyId: $this.addEditActivityClassify.classifyId,
                        name: $this.addEditActivityClassify.name,
                        marketId: $this.marketId
                    } : {
                        classifyId: $this.addEditActivityClassify.classifyId,
                        name: $this.addEditActivityClassify.name,
                        fid: $this.fid
                    };
                    app.ajaxPostWithLoading(url, params, function (data) {
                        if (data.success) {
                            var data = data.data;
                            data.owner = true;
                            if (isAdd) {
                                data.selected = false;
                                $this.activityClassifies.push(data);
                            } else {
                                data.selected = this.selected;
                                $this.activityClassifies.splice($this.addEditActivityClassifyIndex, 1, data);
                                $this.addEditActivityClassifyIndex = null;
                            }
                            $this.addEditActivityClassifyWindowShow = false;
                        } else {
                            var errorMessage = data.message;
                            if (activityApp.isEmpty(errorMessage)) {
                                errorMessage = tips + $this.activityClassifyTitle + "失败";
                            }
                            app.showMsg(errorMessage);
                        }
                    }, function () {
                        app.showMsg(tips + $this.activityClassifyTitle + "失败");
                    });
                },
                toDeleteActivityClassify: function (index, e) {
                    e.stopPropagation();
                    var $this = this;
                    var activityClassify = $this.activityClassifies[index];
                    $this.deleteActivityClassifyId = activityClassify.id;
                    $this.$refs.deleteClassifyWindow.show = true;
                },
                getSingleTemplateComponentByCode: function (code) {
                    var $this = this;
                    var templateComponet = null;
                    $($this.templateComponents).each(function () {
                        if (this.code == code) {
                            templateComponet = this;
                            return false;
                        }
                    });
                    return templateComponet;
                },
                // 验证输入
                validateForm: function (validateOfflineAddress) {
                    var $this = this;
                    var activityNameTemplateComponent = $this.getSingleTemplateComponentByCode("activity_name");
                    if (activityNameTemplateComponent && activityApp.isEmpty($this.activity.name)) {
                        app.showMsg("活动名称不能为空");
                        return false;
                    }
                    var activityTimeScopeTemplateComponent = $this.getSingleTemplateComponentByCode("activity_time_scope");
                    if (activityTimeScopeTemplateComponent) {
                        if (activityApp.isEmpty($this.activity.startTimeStamp)) {
                            app.showMsg("活动开始时间不能为空");
                            return false;
                        }
                        if (activityApp.isEmpty($this.activity.endTimeStamp)) {
                            app.showMsg("活动结束时间不能为空");
                            return false;
                        }
                        if ($this.activity.startTimeStamp >= $this.activity.endTimeStamp) {
                            app.showMsg("活动开始时间必须小于结束时间");
                            return false;
                        }
                    }
                    if (activityApp.isEmpty($this.activity.coverCloudId)) {
                        app.showMsg("请上传封面");
                        return false;
                    }
                    // 定时发布
                    if ($this.activity.timingRelease && activityApp.isEmpty($this.activity.timingReleaseTimeStamp)) {
                        app.showMsg("请选择发布时间");
                        return false;
                    }
                    if (activityApp.isEmpty($this.activity.webTemplateId)) {
                        app.showMsg("请选择展示页");
                        return false;
                    }
                    if ($this.activity.openPushReminder) {
                        var content = $this.activity.activityPushReminder && $this.activity.activityPushReminder.content;
                        var scopes = $this.activity.activityPushReminder && $this.activity.activityPushReminder.receiveScopes;
                        if (activityApp.isEmpty(content)) {
                            app.showMsg("请填写提醒内容");
                            return false;
                        }
                        if (scopes && scopes.length < 1) {
                            app.showMsg("请选择提醒范围");
                            return false;
                        }
                    }
                    // 自定义组件的校验
                    var customComponentValueValid = $this.validateCustomComponentValues();
                    if (!customComponentValueValid) {
                        return false;
                    }
                    // 报名验证
                    var signUpKeys = Object.keys($this.signUpMap);
                    for (var i = 0; i < signUpKeys.length; i++) {
                        var originId = signUpKeys[i];
                        var signUp = $this.signUpMap[originId];
                        var deleted = signUp.deleted;
                        if (!deleted) {
                            if (activityApp.isEmpty(signUp.startTime)) {
                                app.showMsg(signUp.name + "开始时间不能为空");
                                return false;
                            }
                            if (activityApp.isEmpty(signUp.endTime)) {
                                app.showMsg(signUp.name + "结束时间不能为空");
                                return false;
                            }
                            if (signUp.startTime >= signUp.endTime) {
                                app.showMsg(signUp.name + "开始时间必须小于结束时间");
                                return false;
                            }
                            // 参与角色
                            var openRoleLimit = signUp.openRoleLimit;
                            if (openRoleLimit && signUp.roleParticipateScopes.length < 1) {
                                app.showMsg(signUp.name + "的角色范围不能为空");
                                return false;
                            }
                            // 参与范围
                            var signUpTplComponent = $this.templateComponentMap[originId];
                            if (!signUpTplComponent) {
                                continue;
                            }
                            for (var j = 0; j < signUpTplComponent.children.length; j++) {
                                if (signUpTplComponent.children[j].code == 'wfw_participation_scope') {
                                    if (signUp.enableWfwParticipateScope) {
                                        var participateScopes = signUp.wfwParticipateScopes;
                                        if (participateScopes.length < 1) {
                                            app.showMsg("请选择"+ signUp.name +"参与范围");
                                            return false;
                                        }
                                    }
                                } else if (signUpTplComponent.children[j].code == 'contacts_participation_scope') {
                                    if (signUp.enableContactsParticipateScope) {
                                        var participateScopes = signUp.contactsParticipateScopes;
                                        if (participateScopes.length < 1) {
                                            app.showMsg("请选择"+ signUp.name +"参与范围");
                                            return false;
                                        }
                                    }
                                }

                            }

                            if (signUp.limitPerson) {
                                // 启用人数限制
                                if (signUp.personLimit < 1) {
                                    app.showMsg(signUp.name + "请输入正确的" + signUp.name + "限制人数");
                                    return false;
                                }
                            }
                            if (signUp.endNotAllowCancel) {
                                if (activityApp.isEmpty(signUp.notAllowCancelType)) {
                                    app.showMsg("请选择" + signUp.name + "不允许取消报名类型");
                                    return false;
                                }
                                if (signUp.notAllowCancelType == 'custom' && activityApp.isEmpty(signUp.notAllowCancelTime)) {
                                    app.showMsg("请选择" + signUp.name + "不允许取消报名时间");
                                    return false;
                                }
                            }

                            if (signUp.fillInfo) {
                                if (activityApp.isEmpty(signUp.fillInfoFormId)) {
                                    app.showMsg("请配置" + signUp.name + "填报信息");
                                    return false;
                                }
                            } else {
                                // 给没有开启报名填报信息的报名设置万能表单
                                if (activityApp.isEmpty(signUp.fillInfoFormId)) {
                                    var wfwFormInfo = $this.signUpFillInfoDefaultWfwFormMap[originId];
                                    $this.$set($this.signUpMap[originId], "formType", "wfw_form");
                                    $this.$set($this.signUpMap[originId], "openAddr", wfwFormInfo.openAddr);
                                    $this.$set($this.signUpMap[originId], "pcUrl", wfwFormInfo.pcUrl);
                                    $this.$set($this.signUpMap[originId], "wechatUrl", wfwFormInfo.wechatUrl);
                                    $this.$set($this.signUpMap[originId], "fillInfoFormId", wfwFormInfo.fillInfoFormId);
                                }
                            }

                            if (activityApp.isEmpty(signUp.btnName)) {
                                app.showMsg(signUp.name + "按钮名称不能为空");
                                return false;
                            }
                        }
                    }
                    // 离线地址验证：根据选择的门户模版的形式来验证
                    if (validateOfflineAddress) {
                        var webTemplateId = $this.operateWebTemplateId;
                        var webTemplate = null;
                        $($this.webTemplates).each(function () {
                            if (this.id == webTemplateId) {
                                webTemplate = this;
                                return false;
                            }
                        });
                        if (webTemplate != null) {
                            if ("offline" == webTemplate.activityType && activityApp.isEmpty($this.activity.address)) {
                                $this.$refs.offlineEmptyAddressWindow.show = true;
                                return false;
                            }
                        }
                    }
                    return true;
                },
                // 自定义组件的校验
                validateCustomComponentValues: function () {
                    var $this = this;
                    if ($this.activityComponentValueMap) {
                        var customComponentRequiredMap = {};
                        $($this.templateComponents).each(function () {
                            if (this.type == "checkbox" || $this.inputTypes.indexOf(this.type) != -1) {
                                customComponentRequiredMap[this.id] = this;
                            }
                        });
                        var tplComponentIds = Object.keys($this.activityComponentValueMap);
                        for (var i = 0; i < tplComponentIds.length; i++) {
                            var tplComponentId = parseInt(tplComponentIds[i]);
                            var customTplComponent = customComponentRequiredMap[tplComponentId];
                            var required = customTplComponent && customTplComponent.required;
                            var componentValue = $this.activityComponentValueMap[tplComponentId];
                            // 需要额外判断是不是隐藏的
                            var hide = $this.curHideTemplateComponentIds.indexOf(tplComponentId) > -1;
                            if (required && activityApp.isEmpty(componentValue && componentValue.value) && !hide) {
                                app.showMsg(customTplComponent && customTplComponent.name + "不能为空");
                                return false;
                            }
                        }
                    }
                    return true;
                },
                packageCustomAppEnable: function () {
                    var $this = this;
                    var customAppEnableTplComponentIds = [];
                    var customAppEnableKeys = Object.keys($this.customAppEnableMap);
                    if (customAppEnableKeys.length > 0) {
                        for (var k = 0; k < customAppEnableKeys.length; k++) {
                            var tplComponentId = customAppEnableKeys[k];
                            if ($this.customAppEnableMap[tplComponentId]) {
                                customAppEnableTplComponentIds.push(tplComponentId);
                            }
                        }
                    }
                    $this.activity.customAppEnableTplComponentIds = customAppEnableTplComponentIds;
                },
                packageSignUpConditionEnable: function () {
                    var $this = this;
                    var keys = Object.keys($this.signUpConditionMap);
                    $this.activity.sucTemplateComponentIds = [];
                    $this.activity.signUpConditions = [];
                    if (keys.length == 0) {
                        return;
                    }
                    for (var i = 0; i < keys.length; i++) {
                        var tplComponentId = keys[i];
                        var item = $this.signUpConditionMap[tplComponentId];
                        if (item.enable) {
                            $this.activity.sucTemplateComponentIds.push(tplComponentId);
                            if (item.allowSignedUp && item.configOnActivity) {
                                $(item.activityConditionDetails).each(function () {
                                    // 条件是不限、为空、不为空, 清空value
                                    if (!this.condition || this.condition == 'empty' || this.condition == 'un_empty') {
                                        this.value = "";
                                    }
                                });
                                $this.activity.signUpConditions.push(item);
                            }
                        }
                    }
                },
                packageSubmitSign: function () {
                    var $this = this;
                    var waitSubmitSignUps = [];
                    var signUpMap = $.extend({}, $this.signUpMap);
                    $.each(signUpMap, function (key, item) {
                        // 新增，且未开启报名，则不提交
                        if ((!item.id && !item.deleted) || item.id) {
                            // 取消报名设置
                            item.endAllowCancel = !item.endNotAllowCancel;
                            waitSubmitSignUps.push(item);
                        }
                    });
                    return $.extend({}, $this.sign, { signUps: waitSubmitSignUps });
                },
                ignoreOfflineEmptyAddress: function () {
                    var $this = this;
                    if (activityApp.isEmpty($this.activity.id) || $this.isClone) {
                        // 新增
                        $this.addSubmit(false);
                    } else {
                        $this.editSubmit(false);
                    }
                },
                // 发布
                release: function () {
                    var $this = this;
                    if ($this.activity.id) {
                        $this.editSubmit(true, true);
                    } else {
                        $this.addSubmit(true, true);
                    }
                },
                // 下一步（创建活动）
                addSubmit: function (validateOfflineAddress, release) {
                    var $this = this;
                    if (!$this.validateForm(validateOfflineAddress)) {
                        return;
                    }
                    if ($this.activityCoverUploading) {
                        app.showMsg("正在上传封面");
                        return;
                    }
                    // 创建活动
                    var url = ctx + "/api/activity/new";
                    var sign = $this.packageSubmitSign();
                    $this.activity.introduction = app.getUEditorContent();
                    $this.packageSignUpConditionEnable();
                    $this.packageCustomAppEnable();
                    $this.activity.activityComponentValues = [];
                    $.each($this.activityComponentValueMap, function (key, item) {
                        item.value = item.value && item.value instanceof Array ? item.value.join(',') : item.value;
                        $this.activity.activityComponentValues.push(item);
                    });
                    var participateScopeJsonStr = $this.releaseType == "org" ? activityApp.getJsonStr($this.participatedOrgs) : null;
                    var releaseClassIdJsonStr = $this.releaseType == "class" ? activityApp.getJsonStr($this.releaseClassIds) : null;
                    var params = {
                        activityJsonStr: activityApp.getJsonStr($this.activity),
                        participateScopeJsonStr: participateScopeJsonStr,
                        releaseClassIdJsonStr: releaseClassIdJsonStr,
                        signJsonStr: activityApp.getJsonStr(sign),
                        isClone: $this.isClone,
                        release: release ? true : false
                    }
                    var action = "创建";
                    if (release) {
                        action = "发布";
                    }
                    app.ajaxPostWithLoading(url, params, function (data) {
                        if (data.success) {
                            app.noticeActivityChange($this.activity.id);
                            var activityId = data.data;
                            $this.$set($this.activity, "id", activityId);
                            app.showMsg(action + "成功", function () {
                                $this.returnBack();
                            });
                        } else {
                            var errorMessage = data.message;
                            if (activityApp.isEmpty(errorMessage)) {
                                errorMessage = action + "失败";
                            }
                            app.showMsg(errorMessage);
                        }
                    }, function () {
                        app.showMsg(action + "失败");
                    });
                },
                // 编辑活动提交
                editSubmit: function (validateOfflineAddress, release) {
                    var $this = this;
                    if (!$this.validateForm(validateOfflineAddress)) {
                        return;
                    }
                    if ($this.activityCoverUploading) {
                        app.showMsg("正在上传封面");
                        return;
                    }
                    // 修改活动
                    var url = ctx + "/api/activity/edit";
                    var sign = $this.packageSubmitSign();
                    $this.packageSignUpConditionEnable();
                    $this.packageCustomAppEnable();
                    $this.activity.activityComponentValues = [];
                    $.each($this.activityComponentValueMap, function (key, item) {
                        item.value = item.value && item.value instanceof Array ? item.value.join(',') : item.value;
                        $this.activity.activityComponentValues.push(item);
                    });
                    $this.activity.introduction = app.getUEditorContent();
                    var participateScopeJsonStr = $this.releaseType == "org" ? activityApp.getJsonStr($this.participatedOrgs) : null;
                    var releaseClassIdJsonStr = $this.releaseType == "class" ? activityApp.getJsonStr($this.releaseClassIds) : null;
                    var params = {
                        activityJsonStr: activityApp.getJsonStr($this.activity),
                        participateScopeJsonStr: participateScopeJsonStr,
                        releaseClassIdJsonStr: releaseClassIdJsonStr,
                        signJsonStr: activityApp.getJsonStr(sign),
                        release: release ? true : false
                    };
                    var action = "修改";
                    if (release) {
                        action = "发布";
                    }
                    app.ajaxPostWithLoading(url, params, function (data) {
                        if (data.success) {
                            app.noticeActivityChange($this.activity.id);
                            var activityData = data.data;
                            $this.$set($this.sign, "id", activityData.signId);
                            app.showMsg(action + "成功", function () {
                                $this.returnBack();
                            });
                        } else {
                            var errorMessage = data.message;
                            if (activityApp.isEmpty(errorMessage)) {
                                errorMessage = action + "失败";
                            }
                            app.showMsg(errorMessage);
                        }
                    }, function () {
                        app.showMsg(action + "失败");
                    });
                },
                returnBack: function () {
                    var $this = this;
                    if ($this.isEmbedded) {
                        window.history.back();
                    } else {
                        window.opener.postMessage(activityApp.getJsonStr({}), "*");
                        window.close();
                    }
                },
                // 预览模板
                previewTemplate: function (index, e) {
                    var $this = this;
                    e.stopPropagation();
                    var webTemplate = $this.webTemplates[index];
                    window.open(webTemplate.previewUrl);
                },
                // 选择模板
                selectTemplate: function (index) {
                    var $this = this;
                    var webTemplate = $this.webTemplates[index];
                    $this.operateWebTemplateId = webTemplate.id;
                    $this.activity.webTemplateId = webTemplate.id;
                },
                // 预览页面
                previePage: function () {
                    var $this = this;
                    window.open($this.activity.previewUrl);
                },
                // 配置页面
                configPage: function () {
                    var $this = this;
                    window.open($this.activity.editUrl);
                },
                // 复制预览地址
                copyTemplatePreviewUrl: function () {
                    var $this = this;
                    $("#template-preview-url-input")[0].select();
                    document.execCommand("copy");
                    app.showMsg("复制成功");
                },
                toConfigSignUpDetails: function (signUpConditionTplComponentId) {
                    var $this = this;
                    $this.operationSucTplComponentId = signUpConditionTplComponentId;
                    var { originIdentify, activityConditionDetails } = $this.signUpConditionMap[signUpConditionTplComponentId];
                    var fields = [];
                    if (!activityApp.isEmpty(originIdentify)) {
                        var fieldNameMap = $this.formStructureMap[originIdentify];
                        $(activityConditionDetails).each(function () {
                            var field = fieldNameMap[this.fieldName];
                            if (!fields.includes(field)) {
                                fields.push(field);
                            }
                        });
                    }
                    $this.$refs.signUpConfigDialogWindow.showWindow(fields, activityConditionDetails, $this.conditionEnums);
                },
                confirmSignUpConditionDetails: function (conditionDetails, deleteDetailIds) {
                    var $this = this;
                    var tplComponentId = $this.operationSucTplComponentId;
                    $(conditionDetails).each(function () {
                        this.activityId = $this.activity.id || ''
                        this.templateComponentId = tplComponentId;
                    })
                    $this.signUpConditionMap[tplComponentId].activityConditionDetails = conditionDetails;
                    var tmpDeleteIds = $this.signUpConditionMap[tplComponentId].deleteDetailIds || [];
                    tmpDeleteIds.pushArray(deleteDetailIds);
                    $this.signUpConditionMap[tplComponentId].deleteDetailIds = tmpDeleteIds;
                },
                // 确定自定义富文本编辑，回填数据
                confirmRichTextEdit: function (content, cloudIds) {
                    var $this = this;
                    cloudIds = cloudIds || [];
                    $this.$set($this.activityComponentValueMap[$this.operateTplComponentId], "value", content);
                    $this.$set($this.activityComponentValueMap[$this.operateTplComponentId], "cloudIds", cloudIds.join(','));
                },
                // 表单
                toConfigForm: function (tplComponentId) {
                    var $this = this;
                    $this.operateSignUpOriginId = tplComponentId;
                    var signUp = $this.signUpMap[tplComponentId];
                    var formId = "";
                    if (!activityApp.isEmpty(signUp.fillInfoFormId)) {
                        formId = signUp.fillInfoFormId;
                    }
                    var url = "//"+ $this.signWebDomain.replace(/http(|s):\/\//, "") + "/form/config?formId=" + formId;
                    $('body').addClass('scroll');
                    $this.formConfigLayerIndex = layer.open({
                        title: "表单配置",
                        skin: "create-class",
                        type: 2,
                        content: [url, "no"],
                        area: ["600px", "580px"],
                        btn: ["取消", "完成"],
                        btnAlign: "c",
                        yes: function (index) {
                            var signUp = $this.signUpMap[tplComponentId];
                            if (signUp.fillInfo && activityApp.isEmpty(signUp.fillInfoFormId)) {
                                $this.$set($this.signUpMap[tplComponentId], "fillInfo", false);
                            }
                            // 关闭表单填写
                            app.closeLayerPop(index);
                        },
                        btn2: function () {
                            $("#layui-layer-iframe" + $this.formConfigLayerIndex)[0].contentWindow.submit();
                            return false;
                        },
                        end: function () {
                            $('body').removeClass('scroll');
                        }
                    })
                },
                // 万能表单
                toWfwFormConfig: function (signUpTplComponentId) {
                    var $this = this;
                    if ($this.wfwFormConfigWindow && !$this.wfwFormConfigWindow.closed) {
                        app.showMsg("请先关闭上一个填报信息配置页面");
                        return;
                    }
                    $this.operateSignUpOriginId = signUpTplComponentId;
                    var signUp = $this.signUpMap[signUpTplComponentId];
                    var url = ctx + "/api/wfw-form/build/edit-url";
                    var formId = signUp.fillInfoFormId || '';
                    if (activityApp.isEmpty(formId)) {
                        var form = $this.signUpFillInfoDefaultWfwFormMap[signUpTplComponentId];
                        $this.$set($this.signUpMap[signUpTplComponentId], "openAddr", form.openAddr);
                        $this.$set($this.signUpMap[signUpTplComponentId], "pcUrl", form.pcUrl);
                        $this.$set($this.signUpMap[signUpTplComponentId], "wechatUrl", form.wechatUrl);
                        formId = form.fillInfoFormId;
                        $this.$set($this.signUpMap[signUpTplComponentId], "fillInfoFormId", formId);
                    }
                    var wfwFormTemplateId = $this.fillInfoTypeMap[signUpTplComponentId] && $this.fillInfoTypeMap[signUpTplComponentId].wfwFormTemplateId;
                    var params = {
                        fid: $this.fid,
                        uid: [[${session._login_user_.uid}]],
                        formId: formId,
                        wfwFormTemplateId: wfwFormTemplateId
                    }
                    app.ajaxPost(url, params, function (res) {
                        if (res.success) {
                            $this.wfwFormConfigWindow = window.open(res.data);
                        } else {
                            var errorMessage = res.message;
                            if (activityApp.isEmpty(errorMessage)) {
                                errorMessage = "获取表单配置地址失败";
                            }
                            app.showMsg(errorMessage);
                        }
                    }, function () {
                        app.showMsg("获取表单配置地址失败");
                    });
                },
                // 审批
                toApprovalConfig: function (signUpTplComponentId) {
                    var $this = this;
                    if ($this.wfwFormConfigWindow && !$this.wfwFormConfigWindow.closed) {
                        app.showMsg("请先关闭上一个填报信息配置页面");
                        return;
                    }
                    $this.operateSignUpOriginId = signUpTplComponentId;
                    var signUp = $this.signUpMap[signUpTplComponentId];
                    var url = ctx + "/api/wfw-form/approval/build/edit-url";
                    var formId = signUp.fillInfoFormId || '';
                    var wfwFormTemplateId = $this.fillInfoTypeMap[signUpTplComponentId] && $this.fillInfoTypeMap[signUpTplComponentId].wfwFormApprovalTemplateId;
                    var params = {
                        fid: $this.fid,
                        uid: [[${session._login_user_.uid}]],
                        formId: formId,
                        wfwFormTemplateId: wfwFormTemplateId
                    }
                    app.ajaxPost(url, params, function (res) {
                        if (res.success) {
                            $this.wfwFormConfigWindow = window.open(res.data);
                        } else {
                            var errorMessage = res.message;
                            if (activityApp.isEmpty(errorMessage)) {
                                errorMessage = "获取表单配置地址失败";
                            }
                            app.showMsg(errorMessage);
                        }
                    }, function () {
                        app.showMsg("获取表单配置地址失败");
                    });
                },
                closeFormConfigLayer: function (formId) {
                    var $this = this;
                    app.closeLayerPop($this.formConfigLayerIndex);
                    $this.$set($this.signUpMap[$this.operateSignUpOriginId], "fillInfoFormId", formId);
                },
                toAddSignUpParticipateScope: function(signUpTplComponentId, templateComponent){
                    var $this = this;
                    $this.operateSignUpOriginId = signUpTplComponentId;
                    $this.currGroupType = templateComponent.code == 'wfw_participation_scope' ? 'wfw' : 'contacts';
                    var groups = templateComponent.code == 'wfw_participation_scope' ? $this.wfwGroups : $this.contactGroups;
                    var signUp = $this.signUpMap[$this.operateSignUpOriginId];
                    var scopes = (signUp && ($this.currGroupType == 'wfw' ? signUp.wfwParticipateScopes : signUp.contactsParticipateScopes)) || [];
                    $this.$refs.signUpParticipateScopeWindow.showWindow(groups, scopes, $this.currGroupType);
                },
                toAddSignUpParticipateRole: function (signUpTplComponentId, templateComponent) {
                    var $this = this;
                    $this.operateSignUpOriginId = signUpTplComponentId;
                    var signUp = $this.signUpMap[$this.operateSignUpOriginId];
                    var roleParticipateScopes = signUp.roleParticipateScopes;
                    var roles = [];
                    $(roleParticipateScopes).each(function () {
                        roles.push(this.role);
                    });
                    $this.$refs.signUpParticipateRoleWindow.showWindow(roles);
                },
                // 确认选择报名参与范围
                sureSignUpParticipateScope: function (scopes) {
                    var $this = this;
                    if ($this.currGroupType == 'contacts') {
                        $this.$set($this.signUpMap[$this.operateSignUpOriginId], "contactsParticipateScopes", scopes);
                    } else {
                        $this.$set($this.signUpMap[$this.operateSignUpOriginId], "wfwParticipateScopes", scopes);
                    }
                },
                sureSignUpParticipateRole: function (roles) {
                    var $this = this;
                    $this.$set($this.signUpMap[$this.operateSignUpOriginId], "roleParticipateScopes", roles);
                },
                sureReminderReceiverScope: function (scopes) {
                    var $this = this;
                    $this.$set($this.activityPushReminder, "receiveScopes", scopes);
                },
                confirmReminderDialog: function () {
                    var $this = this;
                    if (activityApp.isEmpty($this.activityPushReminder.content)) {
                        app.showMsg("请填写提醒内容");
                        return;
                    }
                    if ($this.activityPushReminder.receiveScopes && $this.activityPushReminder.receiveScopes.length < 1) {
                        app.showMsg("请选择提醒范围");
                        return;
                    }
                    $this.remindContentShow = false;
                    // 将数据拷贝
                    $this.activity.activityPushReminder = $.extend({}, $this.activityPushReminder);
                },
                deleteSignUpParticipateScope: function (signUpTplComponentId, templateComponent, scopeIndex) {
                    var $this = this;
                    if (templateComponent.code == 'wfw_participation_scope') {
                        $this.signUpMap[signUpTplComponentId].wfwParticipateScopes.splice(scopeIndex, 1);
                    } else {
                        $this.signUpMap[signUpTplComponentId].contactsParticipateScopes.splice(scopeIndex, 1);
                    }
                },
                deleteSignUpParticipateRole: function (signUpTplComponentId, templateComponent, index) {
                    var $this = this;
                    $this.signUpMap[signUpTplComponentId].roleParticipateScopes.splice(index, 1);
                },
                // 创建作品征集
                addWork: function () {
                    var $this = this;
                    var url = ctx + "/api/work/new";
                    var params = {
                        uid: $this.activity.createUid,
                        fid: $this.activity.createFid
                    };
                    app.ajaxPostWithLoading(url, params, function (data) {
                        if (data.success) {
                            $this.activity.workId = data.data;
                        } else {
                            var message = data.message;
                            if (activityApp.isEmpty(message)) {
                                message = "开启作品征集失败";
                            }
                            app.showMsg(message, function () {
                                $this.$set($this.activity, "openWork", false);
                            });
                        }
                    }, function () {
                        app.showMsg("开启作品征集失败", function () {
                            $this.$set($this.activity, "openWork", false);
                        });
                    });
                },
                // 创建阅读
                addReading: function () {
                    var $this = this;
                    var url = ctx + "/api/reading/new?activityName=" + $this.activity.name;
                    app.ajaxPostWithLoading(url, {}, function (res) {
                        if (res.success) {
                            $this.activity.readingId = res.data.id;
                            $this.activity.readingModuleId = res.data.modulesId;
                        } else {
                            var message = res.message;
                            if (activityApp.isEmpty(message)) {
                                message = "开启阅读失败";
                            }
                            app.showMsg(message, function () {
                                $this.$set($this.activity, "openReading", false);
                            });
                        }
                    }, function () {
                        app.showMsg("开启阅读失败", function () {
                            $this.$set($this.activity, "openReading", false);
                        });
                    });
                },
                // 作品征集管理
                workManage: function () {
                    var $this = this;
                    var url = activityApp.getWorkManageUrl($this.activity.workId, $this.workDomain);
                    window.open(url);
                },
                // 阅读书单管理
                readManage: function () {
                    var $this = this;
                    var url = activityApp.getReadingBookManageUrl($this.activity.readingId, $this.activity.readingModuleId, $this.xueyaDomain);
                    window.open(url);
                },
                toEditCustomRichText: function (tplComponentId) {
                    var $this = this;
                    $this.operateTplComponentId = tplComponentId;
                    var { value, cloudIds } = $this.activityComponentValueMap[tplComponentId];
                    var title = $this.templateComponentMap[tplComponentId] && $this.templateComponentMap[tplComponentId].name;
                    var cloudIdList = activityApp.isEmpty(cloudIds) ? [] : cloudIds.split(',');
                    $this.$refs.richTextEditDialogWindow.showWindow($this.cloudDomain, title, value || '', cloudIdList);
                },
                toPushReminderConfig: function () {
                    var $this = this;
                    $this.remindContentShow = true
                    $this.activityPushReminder = $.extend({}, $this.activity.activityPushReminder);
                },
                toAddPushRemindScope: function () {
                    var $this = this;
                    $this.$refs.reminderParticipateScopeWindow.showWindow($this.contactGroups, $this.activityPushReminder.receiveScopes, 'contacts');
                },
                // 签到列表管理页
                toSignInList: function () {
                    var $this = this;
                    var signId = $this.sign.id;
                    var url = "";
                    if (signId) {
                        url = "//" + $this.signWebDomain.replace(/http(|s):\/\//, "") + "/manage/sign-in/list?signId=" + signId + "&back=true";
                    } else {
                        url = "//" + $this.signWebDomain.replace(/http(|s):\/\//, "") + "/manage/sign-in/list/new?back=true";
                    }
                    $("#sign-in-list").attr("src", url);
                    $this.showSignInListIframe = true;
                    $("#sign-in-list").css("min-height", $(window).height());
                    // 记录滚动条高度后重置滚动条
                    $this.scrollHeight = $(document).scrollTop();
                    $(document).scrollTop(0);
                },
                // 表单采集管理页面
                toFormCollectionList: function () {
                    var $this = this;
                    var signId = $this.sign.id;
                    var url = "";
                    if (signId) {
                        url = "//" + $this.signWebDomain.replace(/http(|s):\/\//, "") + "/manage/form-collection/list?signId=" + signId + "&back=true";
                    } else {
                        url = "//" + $this.signWebDomain.replace(/http(|s):\/\//, "") + "/manage/form-collection/list/new?back=true";
                    }
                    $("#form-collection-list").attr("src", url);
                    $this.showFormCollectionIframe = true;
                    $("#form-collection-list").css("min-height", $(window).height());
                    // 记录滚动条高度后重置滚动条
                    $this.scrollHeight = $(document).scrollTop();
                    $(document).scrollTop(0);
                },
                // 获取报名签到id
                getSignId: function () {
                    $("#sign-in-list")[0].contentWindow.postMessage(activityApp.getJsonStr({type: "get_sign_id"}), "*");
                },
                // 获取报名签到id
                getFormCollectionSignId: function () {
                    $("#form-collection-list")[0].contentWindow.postMessage(activityApp.getJsonStr({type: "get_sign_id"}), "*");
                },
                // 获取签到数量
                countSignInNum: function () {
                    var $this = this;
                    var url = ctx + "/api/sign/" + $this.sign.id + "/sign-in/num";
                    app.ajaxPost(url, {}, function (data) {
                        if (data.success) {
                            $this.signInNum = data.data;
                        } else {
                            var message = data.message;
                            if (activityApp.isEmpty(message)) {
                                message = "获取已发布签到数量失败";
                            }
                            app.showMsg(message);
                        }
                    }, function () {
                        app.showMsg("获取已发布签到数量失败");
                    });
                },
                // 获取表单采集数量
                countFormCollectionNum: function () {
                    var $this = this;
                    var url = ctx + "/api/sign/" + $this.sign.id + "/form-collection/num";
                    app.ajaxPost(url, {}, function (data) {
                        if (data.success) {
                            $this.formCollectionNum = data.data;
                        } else {
                            var message = data.message;
                            if (activityApp.isEmpty(message)) {
                                message = "获取表单采集数量失败";
                            }
                            app.showMsg(message);
                        }
                    }, function () {
                        app.showMsg("获取表单采集数量失败");
                    });
                },
                // 重新选择模版
                reselectTemplate: function () {
                    var $this = this;
                    $this.$refs.reSelectWebTemplateWindow.show = true;
                },
                sureReSelectWebTemplate: function () {
                    var $this = this;
                    $this.isReselectConfig = true;
                    $this.$nextTick(function () {
                        $this.swiperInit();
                    })
                },
                toInspectionConfig: function () {
                    var $this = this;
                    if ($this.inspectionConfigWindow && !$this.inspectionConfigWindow.closed) {
                        app.showMsg("请先关闭上一个填报信息配置页面");
                        return;
                    }
                    var url = ctx + '/activity/inspection/config';
                    if ($this.isClone && activityApp.isEmpty($this.activity.inspectionConfigId)) {
                        url += '?activityId=' + $this.activity.originActivityId + '&isClone=true';
                    } else if (!activityApp.isEmpty($this.activity.inspectionConfigId)) {
                        url += '?configId=' + $this.activity.inspectionConfigId;
                    }
                    $this.inspectionConfigWindow = window.open(url);
                },
                // 填报信息的开关改变
                formFillSwitchChange: function (checked, component) {
                    // 企业报名、审批表单必须开启
                    var $this = this;
                    var parentComponent = $this.templateComponentMap[component.pid];
                    if (!checked) {
                        if ("company_sign_up" == parentComponent.code) {
                            app.showMsg(parentComponent.name + "必须开启" + component.name);
                            $this.$set($this.signUpMap[component.pid], "fillInfo", true);
                        } else if ($this.signUpMap[parentComponent.id].formType == "approval") {
                            app.showMsg("审批必须开启" + component.name);
                            $this.$set($this.signUpMap[component.pid], "fillInfo", true);
                        }
                    }
                },
                wfwOrgScopeChange: function(value, tplComponentId) {
                    var $this = this;
                    $this.signUpMap[tplComponentId].wfwOnlySelfUnit = false;
                    $this.signUpMap[tplComponentId].enableWfwParticipateScope = false;
                    if (value == 'custom') {
                        $this.signUpMap[tplComponentId].enableWfwParticipateScope = true;
                    } else if (value == 'only_self_unit') {
                        $this.signUpMap[tplComponentId].wfwOnlySelfUnit = true;
                    }
                },
                contactScopeChange: function (value, tplComponentId) {
                    var $this = this;
                    $this.signUpMap[tplComponentId].contactOnlySelfUnit = false;
                    $this.signUpMap[tplComponentId].enableContactsParticipateScope = false;
                    if (value == 'custom') {
                        $this.signUpMap[tplComponentId].enableContactsParticipateScope = true;
                    } else if (value == 'only_self_unit') {
                        $this.signUpMap[tplComponentId].contactOnlySelfUnit = true;
                    }
                },
                // 自定义输入整型、小数数据处理
                inputDataParseByType: function (e, tplComponentId, type) {
                    var $this = this;
                    var value = e && e.target && e.target.value;
                    if (typeof value == 'undefined' || value == null) {
                        return;
                    }
                    if (type == 'int') {
                        $this.activityComponentValueMap[tplComponentId].value = parseInt(value);
                    } else if (type == 'decimal') {
                        $this.activityComponentValueMap[tplComponentId].value = parseFloat(value);
                    }
                },
                initActivityPushReminder: function () {
                    var $this = this;
                    if (!$this.activity.activityPushReminder) {
                        $this.activity.activityPushReminder = {
                            receiveScope: '',
                            receiveScopes: [],
                            content: '有新的活动，快来看看吧!'
                        };
                    }
                    if ($this.activity.activityPushReminder.receiveScopes) {
                        var contactsVirtualNodeMap = $this.getVirtualNodeMap($this.contactGroups);
                        $($this.activity.activityPushReminder.receiveScopes).each(function () {
                            if (this.leaf && contactsVirtualNodeMap[this.externalId]) {
                                this.virtualId = contactsVirtualNodeMap[this.externalId].virtualId;
                            } else {
                                this.virtualId = this.externalId;
                            }
                        });
                    }
                    $this.activityPushReminder = $.extend({}, $this.activity.activityPushReminder);

                },
                // 创建证书
                newCertificate: function () {
                    var $this = this;
                    var certificateTemplateId = $this.activity.certificateTemplateId;
                    if (!activityApp.isEmpty(certificateTemplateId)) {
                        return;
                    }
                    var url = ctx + "/api/certificate/new";
                    app.ajaxPost(url, {}, function (data) {
                        if (data.success) {
                            $this.activity.certificateTemplateId = data.data;
                        } else {
                            var message = data.message;
                            if (activityApp.isEmpty(message)) {
                                message = "创建证书模版失败";
                            }
                            app.showMsg(message);
                        }
                    }, function () {
                        app.showMsg("创建证书模版失败");
                    });
                },
                // 证书编辑
                certificateEdit: function () {
                    var $this = this;
                    var url = ctx + "/api/certificate/config";
                    var certificateTemplateId = $this.activity.certificateTemplateId;
                    if (activityApp.isEmpty(certificateTemplateId)) {
                        app.showMsg("未创建证书模版");
                        return;
                    }
                    var uid = $this.activity.createUid;
                    var fid = $this.activity.createFid;
                    var params = {
                        uid: uid,
                        fid: fid,
                        templateId: certificateTemplateId
                    };
                    app.ajaxPostWithLoading(url, params, function (data) {
                        if (data.success) {
                            var configUrl = data.data;
                            window.open(configUrl);
                        } else {
                            var message = data.message;
                            if (activityApp.isEmpty(message)) {
                                message = "获取证书配置地址失败";
                            }
                            app.showMsg(message);
                        }
                    }, function () {
                        app.showMsg("获取证书配置地址失败");
                    });
                },
                // 配置报名填报信息
                fillInfoConfig: function (signUpTplComponentId) {
                    var $this = this;
                    var signUp = $this.signUpMap[signUpTplComponentId];
                    var formType = signUp.formType;
                    if ("wfw_form" == formType) {
                        // 配置万能表单
                        $this.toWfwFormConfig(signUpTplComponentId);
                    } else {
                        // 配置审批
                        $this.toApprovalConfig(signUpTplComponentId);
                    }
                },
                toConfigClassify: function () {
                    var $this = this;
                    var activityClassifies = []
                    $($this.activityClassifies).each(function () {
                        if (this.id) {
                            activityClassifies.push(this);
                        }
                    });
                    if (activityClassifies < 1) {
                        // 默认添加一个
                        activityClassifies.push({
                            classifyId: null,
                            name: "",
                            owner: true
                        });
                    }
                    $this.activityClassifies = activityClassifies;
                    $this.classifyWindowShow = true;
                },
                toAddClassify: function () {
                    var $this = this;
                    var classify = {
                        classifyId: null,
                        name: "",
                        owner: true
                    };
                    $this.activityClassifies.push(classify);
                },
                addEditClassifySubmit: function (index) {
                    var $this = this;
                    var addEditClassify = $this.activityClassifies[index];
                    if (activityApp.isEmpty(addEditClassify.name)) {
                        app.showMsg("名称不能为空");
                        return;
                    }
                    $this.operateClassifyIndex = index;
                    var isAdd = activityApp.isEmpty(addEditClassify.id);
                    var tips = "新增";
                    var url = ctx + "/api/market/" + $this.marketId + "/classify/add";
                    if (!$this.marketId) {
                        url = ctx + "/api/org/" + $this.fid + "/classify/add";
                    }
                    if (!isAdd) {
                        tips = "修改";
                        url = ctx + "/api/market/" + $this.marketId + "/classify/update";
                        if (!$this.marketId) {
                            url = ctx + "/api/org/" + $this.fid + "/classify/edit";
                        }
                    }
                    var params = {
                        classifyId: addEditClassify.id,
                        name: addEditClassify.name,
                        marketId: $this.marketId
                    };
                    app.ajaxPostWithLoading(url, params, function (data) {
                        if (data.success) {
                            var data = data.data;
                            data.owner = true;
                            $this.activityClassifies.splice($this.operateClassifyIndex, 1, data);
                        } else {
                            var message = data.message;
                            if (activityApp.isEmpty(message)) {
                                message = tips + $this.addEditItem.name + "失败";
                            }
                            app.showMsg(message);
                        }
                    }, function () {
                        app.showMsg(tips + $this.addEditItem.name + "失败");
                    });
                },
                toDeleteClassify: function (index) {
                    var $this = this;
                    $this.operateClassifyIndex = index;
                    $this.$refs.deleteClassifyWindow.show = true;
                },
                deleteClassifySubmit: function () {
                    var $this = this;
                    var classify = $this.activityClassifies[$this.operateClassifyIndex];
                    if (!classify.id) {
                        // 直接删除
                        $this.activityClassifies.splice($this.operateClassifyIndex, 1);
                    }
                    var url = ctx + "/api/market/" + $this.marketId + "/classify/" + classify.id + "/delete";
                    if (!$this.marketId) {
                        url = ctx + "/api/org/" + $this.fid + "/classify/" + classify.id + "/delete";
                    }
                    app.ajaxPostWithLoading(url, {}, function (data) {
                        if (data.success) {
                            $this.$refs.deleteClassifyWindow.show = false;
                            // 如果删除的是当前选中的
                            if ($this.activity.activityClassifyId == $this.activityClassifies[$this.operateClassifyIndex].id) {
                                $this.$set($this.activity, "activityClassifyId", null);
                            }
                            $this.activityClassifies.splice($this.operateClassifyIndex, 1);
                        } else {
                            var message = data.message;
                            if (activityApp.isEmpty(message)) {
                                message = "删除" + $this.addEditItem.name + "失败";
                            }
                            app.showMsg(message);
                        }
                    }, function () {
                        app.showMsg("删除" + $this.addEditItem.name + "失败");
                    });
                }
            }
        });

        /**
         * 关闭表单配置页面
         */
        function closeFormConfigLayer(formId) {
            vm.closeFormConfigLayer(formId);
        }
    </script>
</div>
<div th:replace="pc/include/note_editor :: note_editor"></div>
</body>
</html>