<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org/">
<head>
    <meta charset="UTF-8">
    <title th:text="${activity == null ? '创建活动' : '编辑活动'}">创建活动</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="/static/pc/assets/lib/element-ui/lib/theme-chalk/index.css" th:href="@{/pc/assets/lib/element-ui/lib/theme-chalk/index.css}">
    <link rel="stylesheet" href="/static/pc/assets/lib/zTree_v3/css/zTreeStyle/zTreeStyle.css" th:href="@{/pc/assets/lib/zTree_v3/css/zTreeStyle/zTreeStyle.css}">
    <link rel="stylesheet" href="/static/pc/assets/css/reset.css" th:href="@{/pc/assets/css/reset.css}">
    <link rel="stylesheet" href="/static/pc/assets/icomoon/style.css" th:href="@{/pc/assets/icomoon/style.css}">
    <link rel="stylesheet" href="/static/pc/assets/css/public.css" th:href="@{/pc/assets/css/public.css}">
    <link rel="stylesheet" href="/static/pc/assets/css/create.css" th:href="@{/pc/assets/css/create.css}">
    <link rel="stylesheet" href="https://noteyd.chaoxing.com/res/css/pc/note/richtext_detail.css">
    <style type="text/css">
        body .create-class .layui-layer-btn0{
            width: 30px;
            height: 30px;
            border: 1px solid #82c3ff;
            border-radius: 15px;
            font-size: 13px;
            margin: 5px 10px 0 5px;
            color: #0084ff;
            background: #ffffff;
            line-height: 30px;
        }
        body .create-class .layui-layer-btn1{
            width: 30px !important;
            height: 30px !important;
            border: 1px solid #82c3ff !important;
            border-radius: 15px !important;
            font-size: 13px;
            margin: 5px 5px 0 10px;
            color: #ffffff;
            background: #0084ff;
            line-height: 30px;
        }
        .webuploader-element-invisible {
            display: none;
        }
        .webuploader-pick {
            color: #0084FF!important;
            background: unset!important;
            padding: unset!important;
        }
        .el-select, .el-input {
            height: auto;
        }
        [v-cloak] {
            display: none;
        }
    </style>
</head>

<body>
<div :class="{'page': true, 'special-style': (!fullScreen)}" id="activity-vue" v-cloak>
    <div v-show="!showSignInListIframe">
        <!-- 创建/编辑活动头部 -->
        <div class="top flex" id="create">
            <div class="go-back" @click="returnBack">
                <template v-if="isEmbedded">
                    <i class="icon-back"></i><span>返回</span>
                </template>
            </div>
            <div class="name-txt">{{activity.id ? '设置' : '新建'}}</div>
            <button v-if="activity.id" type="button" class="create-btn" @click="editSubmit">保存</button>
            <button v-else type="button" class="create-btn" @click="addSubmit">保存</button>
        </div>
        <!-- 创建活动头部 -->
        <div v-show="templateComponents && activity">
            <div class="info box" v-for="(tplComponents, tplIdx) in tplComponentPartitions">
                <form action="" onsubmit="return false;">
                    <template v-for="(item, index) in tplComponents">
                        <div class="title" v-if="item.code == 'partition'">{{item.name}}</div>
                        <div class="form-item" v-if="item.code == 'activity_name'">
                            <label class="label"><img src="/static/pc/assets/images/required.png" th:src="@{/pc/assets/images/required.png}" class="required-img" v-if="item.required">{{item.name}}</label>
                            <div class="input-box">
                                <el-input type="text" placeholder="请填写" v-model.trim="activity.name" maxlength="50" show-word-limit></el-input>
                                <span class="tips" v-if="item.introduction">{{item.introduction}}</span>
                            </div>
                        </div>
                        <!--活动时间-->
                        <div class="form-item" v-else-if="item.code == 'activity_time_scope'">
                            <label class="label"><img src="/static/pc/assets/images/required.png" th:src="@{/pc/assets/images/required.png}" class="required-img" v-if="item.required">{{item.name}}</label>
                            <div class="input-box">
                                <el-date-picker
                                        v-model="activity.startTimeStamp"
                                        type="datetime"
                                        format="yyyy-MM-dd HH:mm"
                                        value-format="timestamp"
                                        :clearable="false"
                                        :editable="false"
                                        :default-time="['00:00:00']"
                                        placeholder="开始时间">
                                </el-date-picker>
                                <span class="date-range-icon"><img src="/static/pc/assets/images/swap-right.png" th:src="@{/pc/assets/images/swap-right.png}"></span>
                                <el-date-picker
                                        v-model="activity.endTimeStamp"
                                        type="datetime"
                                        format="yyyy-MM-dd HH:mm"
                                        value-format="timestamp"
                                        :clearable="false"
                                        :editable="false"
                                        :default-time="['23:59:59']"
                                        placeholder="结束时间">
                                </el-date-picker>
                                <span class="tips" v-if="item.introduction">{{item.introduction}}</span>
                            </div>
                        </div>
                        <div class="form-item align-start" v-else-if="item.code == 'activity_cover'">
                            <label class="label cover"><img src="/static/pc/assets/images/required.png" th:src="@{/pc/assets/images/required.png}" class="required-img" v-if="item.required">{{item.name}}</label>
                            <div class="input-box">
                                <div class="img-box">
                                    <img :src="activity | getCloudImgUrl" class="cover-img jqthumbImg">
                                </div>
                                <div class="font-box">
                                    <span>大小：小于5M</span>
                                    <span>格式：jpg、png、gif</span>
                                    <div class="btn-box">
                                        <button id="cover-upload-btn" class="cancle-btn upload">上传文件</button>
                                        <div class="cancle-btn picture-btn" @click="pictureShow = true">图片库</div>
                                    </div>
                                </div>
                                <span class="tips" v-if="item.introduction">{{item.introduction}}</span>
                            </div>
                        </div>
                        <div class="form-item" v-else-if="item.code == 'activity_organisers'">
                            <label class="label"><img src="/static/pc/assets/images/required.png" th:src="@{/pc/assets/images/required.png}" class="required-img" v-if="item.required">{{item.name}}</label>
                            <div class="input-box" style="width: 400px;">
                                <el-input type="text" placeholder="请填写" v-model.trim="activity.organisers" maxlength="20"></el-input>
                                <span class="tips" v-if="item.introduction">{{item.introduction}}</span>
                            </div>
                        </div>
                        <template v-else-if="item.code == 'activity_type'">
                            <div class="form-item">
                                <label class="label"><img src="/static/pc/assets/images/required.png" th:src="@{/pc/assets/images/required.png}" class="required-img" v-if="item.required">{{item.name}}</label>
                                <div class="input-box">
                                    <el-radio v-for="(activityType, index) of activityTypes" :key="'activity-type-' + index" v-model="activity.activityType" :label="activityType.value" name="active-type">{{activityType.name}}</el-radio>
                                    <span class="tips" v-if="item.introduction">{{item.introduction}}</span>
                                </div>
                            </div>
                            <div class="form-item" v-show="activity.activityType == 'offline'">
                                <label class="label">位置</label>
                                <div class="input-box">
                                    <input type="text" readonly required lay-verify="required" v-model.trim="activity.address" placeholder="请选择地点" autocomplete="off" class="layui-input name show-addr" style="cursor: pointer;" @click="showActivityMap">
                                    <img src="/static/pc/assets/images/location.png" th:src="@{/pc/assets/images/location.png}" class="length icon">
                                    <input type="text" v-model.trim="activity.detailAddress" lay-verify="required" placeholder="详细地址，例：E5栋1308室" autocomplete="off" class="layui-input name show-addr-detailed">
                                </div>
                            </div>
                        </template>
                        <div class="form-item cancel-margin" v-else-if="item.code == 'activity_classify'">
                            <label class="label"><img src="/static/pc/assets/images/required.png" th:src="@{/pc/assets/images/required.png}" class="required-img" v-if="item.required">{{item.name}}</label>
                            <div class="input-box wrap">
                                <div class="select-activity" v-if="strict == 1">
                                    <el-select v-model="activity.activityClassifyId" placeholder="请选择">
                                        <el-option v-for="item in activityClassifies" :key="item.id" :label="item.name"
                                                   :value="item.id">
                                        </el-option>
                                    </el-select>
                                </div>
                                <template v-if="strict != 1">
                                    <div :class="{'type-item': true, 'paddingR0': !activityClassify.system, 'active': activityClassify.selected}" v-for="(activityClassify, index) of activityClassifies" :key="'activity-classify-' + index" @click="selectActivityClassify(index)">{{activityClassify.name}}
                                        <div class="more-box" v-if="!activityClassify.system && activityClassify.owner">
                                            <div class="more-btn"></div>
                                            <div class="edit-box">
                                                <div @click="toEditActivityClassify(index, $event)">编辑</div>
                                                <div @click="toDeleteActivityClassify(index, $event)">删除</div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="type-item add" @click="toAddActivityClassify">
                                        <div class="add_btn"></div>
                                        新增
                                    </div>
                                </template>
                                <span class="tips" v-if="item.introduction">{{item.introduction}}</span>
                            </div>
                        </div>

                        <div class="form-item" v-else-if="item.code == 'integral'">
                            <label class="label"><img src="/static/pc/assets/images/required.png" th:src="@{/pc/assets/images/required.png}" class="required-img" v-if="item.required">{{item.name}}</label>
                            <div class="input-box setForm">
                                <input type="number" v-model.trim="activity.integral" min="0" placeholder="请输入" class="score-input">
                                <span class="score">分</span>
                                <span class="tips" v-if="item.introduction">{{item.introduction}}</span>
                            </div>
                        </div>
                        <!--学时-->
                        <div class="form-item" v-else-if="item.code == 'period'">
                            <label class="label"><img src="/static/pc/assets/images/required.png" th:src="@{/pc/assets/images/required.png}" class="required-img" v-if="item.required">{{item.name}}</label>
                            <div class="input-box setForm">
                                <input type="number" min="0" step="0.1" v-model.trim="activity.period" @blur="periodChange" placeholder="请输入" class="score-input">
                                <span class="score">学时</span>
                                <span class="tips" v-if="item.introduction">{{item.introduction}}</span>
                            </div>
                        </div>
                        <!--学分-->
                        <div class="form-item" v-else-if="item.code == 'credit'">
                            <label class="label"><img src="/static/pc/assets/images/required.png" th:src="@{/pc/assets/images/required.png}" class="required-img" v-if="item.required">{{item.name}}</label>
                            <div class="input-box setForm">
                                <input type="number" min="0" step="0.1" v-model.trim="activity.credit" @blur="creditChange" placeholder="请输入" class="score-input">
                                <span class="score">学分</span>
                                <span class="tips" v-if="item.introduction">{{item.introduction}}</span>
                            </div>
                        </div>
                        <!--参与时长上限-->
                        <div class="form-item" v-else-if="item.code == 'max_participate_time_length'">
                            <label class="label"><img src="/static/pc/assets/images/required.png" th:src="@{/pc/assets/images/required.png}" class="required-img" v-if="item.required">{{item.name}}</label>
                            <div class="input-box setForm">
                                <input type="number" min="1" step="1" v-model.trim="activity.timeLengthUpperLimit" placeholder="不限" class="score-input">
                                <span class="score">小时</span>
                                <span class="tips" v-if="item.introduction">{{item.introduction}}</span>
                            </div>
                        </div>
                        <!--发布范围-->
                        <div class="form-item last marginTop16" v-else-if="item.code == 'activity_release_scope'">
                            <label class="label"><img src="/static/pc/assets/images/required.png" th:src="@{/pc/assets/images/required.png}" class="required-img" v-if="item.required">{{item.name}}</label>
                            <div class="input-box wrap">
                                <el-select v-if="item.dataOrigin == 'interface'" multiple v-model="releaseClassIds" placeholder="请选择" style="width: 45%">
                                    <el-option v-for="value in classList" :key="value.id" :label="value.name" :value="value.id"></el-option>
                                </el-select>
                                <template v-else>
                                    <!--添加范围后显示后面这项-->
                                    <div v-show="participatedOrgs.length < 1">
                                        <div class="type-item add" @click="toAddParticipateScope(item.name)">
                                            <div class="add_btn"></div>
                                            添加
                                        </div>
                                    </div>
                                    <div class="already_add" v-show="participatedOrgs.length > 0" @click="toAddParticipateScope(item.name)">
                                        <div>
                                            已选择{{participatedOrgs.length}}个单位
                                        </div>
                                        <img src="/static/pc/assets/images/edit-3.png" th:src="@{/pc/assets/images/edit-3.png}">
                                    </div>
                                </template>
                                <span class="tips" v-if="item.introduction">{{item.introduction}}</span>
                            </div>
                        </div>
                        <!--签到-->
                        <div class="form-item align-start" v-else-if="item.code == 'sign_in_out'">
                            <label class="label">{{item.name}}</label>
                            <div class="input-box wrap">
                                <div class="already_add" v-show="participatedOrgs.length > 0" @click="toSignInList">
                                    <div>
                                        已发布{{signInNum}}个签到
                                    </div>
                                    <img src="/static/pc/assets/images/edit-3.png" th:src="@{/pc/assets/images/edit-3.png}">
                                </div>
                                <span class="tips" v-if="item.introduction">{{item.introduction}}</span>
                            </div>
                        </div>
                        <!--作品征集设置-->
                        <div class="form-item align-start" v-else-if="item.code == 'work'">
                            <label class="label">{{item.name}}</label>
                            <div class="input-box column">
                                <div class="set-box">
                                    <el-switch v-model="activity.openWork" class="examine-switch"></el-switch>
                                    <span class="tips" v-if="item.introduction">{{item.introduction}}</span>
                                </div>
                                <div class="set-box configurationForm" v-show="activity.openWork" @click="workManage">
                                    <img src="/static/pc/assets/images/setting.png" th:src="@{/pc/assets/images/setting.png}">
                                    <span class="tips set-information">征集设置</span>
                                </div>
                            </div>
                        </div>
                        <!--小组设置-->
                        <div class="form-item align-start" v-else-if="item.code == 'group'">
                            <label class="label">{{item.name}}</label>
                            <div class="input-box column">
                                <div class="set-box">
                                    <el-switch v-model="activity.openGroup" class="examine-switch"></el-switch>
                                    <span class="tips" v-if="item.introduction">{{item.introduction}}</span>
                                </div>
                            </div>
                        </div>
                        <!--阅读设置-->
                        <div class="form-item align-start" v-else-if="item.code == 'reading'">
                            <label class="label">{{item.name}}</label>
                            <div class="input-box column">
                                <div class="set-box">
                                    <el-switch v-model="activity.openReading" class="examine-switch"></el-switch>
                                    <span class="tips" v-if="item.introduction">{{item.introduction}}</span>
                                </div>
                                <div class="set-box configurationForm" v-show="activity.openReading" @click="readManage">
                                    <img src="/static/pc/assets/images/setting.png" th:src="@{/pc/assets/images/setting.png}">
                                    <span class="tips set-information">配置书单</span>
                                </div>
                            </div>
                        </div>
                        <!--标签-->
                        <div class="form-item cancel-margin marginTop16" v-else-if="item.code == 'tags'">
                            <label class="label">{{item.name}}</label>
                            <div class="input-box wrap">
                                <!--添加满3个后，隐藏添加按钮-->
                                <div class="type-item" v-for="(tag, index) of tags" :key="'tag-' + index">{{tag}}<div class="del_btn" @click="deleteTag(index)"></div></div>
                                <div class="type-item add" @click="toAddTag">
                                    <div class="add_btn"></div>
                                    添加
                                </div>
                                <span class="tips" v-if="item.introduction">{{item.introduction}}</span>
                            </div>
                        </div>
                        <!--评价-->
                        <div v-else-if="item.code == 'activity_rating'">
                            <div class="form-item">
                                <label class="label">{{item.name}}</label>
                                <div class="input-box">
                                    <el-switch v-model="activity.openRating" class="examine-switch"></el-switch>
                                    <span class="tips" v-if="item.introduction">{{item.introduction}}</span>
                                </div>
                            </div>
                            <div class="form-item" v-show="activity.openRating">
                                <label class="label">评价需审核</label>
                                <div class="input-box">
                                    <el-switch v-model="activity.ratingNeedAudit" class="examine-switch"></el-switch>
                                    <span>开启后，审核后的评价才能展示在评价列表</span>
                                </div>
                            </div>
                        </div>
                        <!--定时发布-->
                        <template v-else-if="item.code == 'timing_release'">
                            <div class="form-item">
                                <label class="label">{{item.name}}</label>
                                <div class="input-box">
                                    <el-switch v-model="activity.timingRelease" class="examine-switch"></el-switch>
                                    <span class="tips" v-if="item.introduction">{{item.introduction}}</span>
                                </div>
                            </div>
                            <div class="form-item" v-show="activity.timingRelease">
                                <label class="label"></label>
                                <div class="input-box">
                                    <el-date-picker v-model="activity.timingReleaseTimeStamp"
                                                    type="datetime"
                                                    placeholder="发布时间"
                                                    format="yyyy-MM-dd HH:mm"
                                                    value-format="timestamp"
                                                    prefix-icon="disable"
                                                    :clearable="false"
                                                    :editable="false"
                                                    :picker-options="timingReleasePickerOption">
                                    </el-date-picker>
                                    <span class="date-piker-icon" style="left: 192px;">
                                    <img src="/static/pc/assets/images/calendar.png" th:src="@{/pc/assets/images/calendar.png}">
                                </span>
                                </div>
                            </div>
                        </template>
                        <!--简介-->
                        <div class="form-item align-start" style="margin-bottom: 0px;" v-else-if="item.code == 'introduction'">
                            <label class="label">{{item.name}}</label>
                            <div class="input-box">
                                <!-- 笔记编辑器 -->
                                <div class="wrap ueditor">
                                    <script type="text/plain" id="container" name="content"></script>
                                </div>
                                <span class="tips" v-if="item.introduction">{{item.introduction}}</span>
                            </div>
                        </div>
                        <!--报名设置列表-->
                        <div v-else-if="signUpMap[item.id] && (item.code == 'sign_up' || item.code =='company_sign_up')">
                            <div class="set-box">
                                <div class="title set">{{item.name}}</div>
                                <el-switch v-model="signUpMap[item.id].enable" class="section-switch" @change="signUpEnableChanged(item.id)"></el-switch>
                            </div>
                            <!-- 点击参与设置 -->
                            <form action="" onsubmit="return false;" class="setForm" v-show="!signUpMap[item.id].deleted">
                                <template v-for="(it, idx) in item.children">
                                    <!--报名时间-->
                                    <div class="form-item" v-if="it.code == 'sign_up_time_scope'">
                                        <label class="label"><img src="/static/pc/assets/images/required.png" th:src="@{/pc/assets/images/required.png}" class="required-img" v-if="it.required">{{it.name}}</label>
                                        <div class="input-box">
                                            <el-date-picker
                                                    v-model="signUpMap[item.id] && signUpMap[item.id].startTime"
                                                    type="datetime"
                                                    format="yyyy-MM-dd HH:mm"
                                                    value-format="timestamp"
                                                    :clearable="false"
                                                    :editable="false"
                                                    :default-time="['00:00:00']"
                                                    placeholder="开始时间">
                                            </el-date-picker>
                                            <span class="date-range-icon"><img src="/static/pc/assets/images/swap-right.png" th:src="@{/pc/assets/images/swap-right.png}"></span>
                                            <el-date-picker
                                                    v-model="signUpMap[item.id] && signUpMap[item.id].endTime"
                                                    type="datetime"
                                                    format="yyyy-MM-dd HH:mm"
                                                    value-format="timestamp"
                                                    :clearable="false"
                                                    :editable="false"
                                                    :default-time="['23:59:59']"
                                                    placeholder="结束时间">
                                            </el-date-picker>
                                            <span class="tips" v-if="it.introduction">{{it.introduction}}</span>
                                        </div>
                                    </div>
                                    <!-- todo 微服务和通讯录应区分开 -->
                                    <div class="form-item flexStart" v-else-if="it.code == 'wfw_participation_scope'">
                                        <label class="label"><img src="/static/pc/assets/images/required.png" th:src="@{/pc/assets/images/required.png}" class="required-img" v-if="it.required">{{it.name}}</label>
                                        <div class="join-box">
                                            <div :class="{'autoRange': (!signUpMap[item.id].enableWfwParticipateScope)}">
                                                <el-radio v-model="signUpMap[item.id].enableWfwParticipateScope" :label="false" name="active-type">不限</el-radio>
                                                <el-radio v-model="signUpMap[item.id].enableWfwParticipateScope" :label="true" name="active-type">自定义</el-radio>
                                            </div>
                                            <div class="join-select" v-show="signUpMap[item.id].enableWfwParticipateScope">
                                                <img src="/static/pc/assets/images/add-circle.png" th:src="@{/pc/assets/images/add-circle.png}" class="add-range" @click="toAddSignUpParticipateScope(item.id, it)">
                                                <span v-if="signUpMap[item.id].wfwParticipateScopes.length <= 0">请选择</span>
                                                <div class="add-tags" v-else>
                                                    <span v-for="(scope, scopeIndex) of signUpMap[item.id].wfwParticipateScopes">{{scope.externalName}}<i class="del_btn" @click="deleteSignUpParticipateScope(item.id, it, scopeIndex)"></i></span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="form-item flexStart" v-else-if="it.code == 'contacts_participation_scope'">
                                        <label class="label"><img src="/static/pc/assets/images/required.png" th:src="@{/pc/assets/images/required.png}" class="required-img" v-if="it.required">{{it.name}}</label>
                                        <div class="join-box">
                                            <div :class="{'autoRange': (!signUpMap[item.id].enableContactsParticipateScope)}">
                                                <el-radio v-model="signUpMap[item.id].enableContactsParticipateScope" :label="false" name="active-type">不限</el-radio>
                                                <el-radio v-model="signUpMap[item.id].enableContactsParticipateScope" :label="true" name="active-type">自定义</el-radio>
                                            </div>
                                            <div class="join-select" v-show="signUpMap[item.id].enableContactsParticipateScope">
                                                <img src="/static/pc/assets/images/add-circle.png" th:src="@{/pc/assets/images/add-circle.png}" class="add-range" @click="toAddSignUpParticipateScope(item.id, it)">
                                                <span v-if="signUpMap[item.id].contactsParticipateScopes.length <= 0">请选择</span>
                                                <div class="add-tags" v-else>
                                                    <span v-for="(scope, scopeIndex) of signUpMap[item.id].contactsParticipateScopes">{{scope.externalName}}<i class="del_btn" @click="deleteSignUpParticipateScope(item.id, it, scopeIndex)"></i></span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="form-item" v-else-if="it.code == 'sign_up_person_limit'">
                                        <label class="label"><img src="/static/pc/assets/images/required.png" th:src="@{/pc/assets/images/required.png}" class="required-img" v-if="it.required">{{it.name}}</label>
                                        <div class="input-box">
                                            <div class="select-person-radio">
                                                <el-radio v-model="signUpMap[item.id].limitPerson" :label="false" name="active-type">不限</el-radio>
                                                <el-radio v-model="signUpMap[item.id].limitPerson" :label="true" name="active-type">自定义</el-radio>
                                            </div>
                                            <span class="tips" v-if="it.introduction">{{it.introduction}}</span>
                                            <input v-show="signUpMap[item.id].limitPerson" v-model="signUpMap[item.id].personLimit" type="number" min="1" step="1" maxlength="10" placeholder="请输入正整数" class="person"><span class="person-span" v-show="signUpMap[item.id].limitPerson">人</span>
                                        </div>
                                    </div>
                                    <div class="form-item align-start" v-else-if="it.code == 'sign_up_fill_info'">
                                        <label class="label" style="line-height: 20px;"><img src="/static/pc/assets/images/required.png" th:src="@{/pc/assets/images/required.png}" class="required-img" v-if="it.required">{{it.name}}</label>
                                        <div class="input-box column">
                                            <div class="set-box">
                                                <el-switch v-model="signUpMap[item.id].fillInfo"></el-switch>
                                                <span class="tips" v-if="it.introduction">{{it.introduction}}</span>
                                            </div>
                                            <div v-if="signUpMap[item.id].formType == 'form'" class="set-box configurationForm" v-show="signUpMap[item.id].fillInfo" @click="toConfigForm(item.id)">
                                                <img src="/static/pc/assets/images/setting.png" th:src="@{/pc/assets/images/setting.png}">
                                                <span class="tips set-information">配置填报信息</span>
                                            </div>
                                            <div v-else class="set-box configurationForm" v-show="signUpMap[item.id].fillInfo" @click="toWfwFormConfig(item.id)">
                                                <img src="/static/pc/assets/images/setting.png" th:src="@{/pc/assets/images/setting.png}">
                                                <span class="tips set-information">配置填报信息</span>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="form-item" v-else-if="it.code == 'sign_up_review'" v-show="signUpMap[item.id].formType == 'form'">
                                        <label class="label"><img src="/static/pc/assets/images/required.png" th:src="@{/pc/assets/images/required.png}" class="required-img" v-if="it.required">{{it.name}}</label>
                                        <div class="input-box">
                                            <el-switch v-model="signUpMap[item.id].openAudit"></el-switch>
                                            <span class="tips" v-if="it.introduction">{{it.introduction}}</span>
                                        </div>
                                    </div>
                                    <div class="form-item" v-else-if="it.code == 'sign_up_public_list'">
                                        <label class="label"><img src="/static/pc/assets/images/required.png" th:src="@{/pc/assets/images/required.png}" class="required-img" v-if="it.required">{{it.name}}</label>
                                        <div class="input-box">
                                            <el-switch v-model="signUpMap[item.id].publicList"></el-switch>
                                            <span class="tips" v-if="it.introduction">{{it.introduction}}</span>
                                        </div>
                                    </div>
                                    <template v-else-if="it.code == 'sign_up_cancel_signed_up'">
                                        <div class="form-item">
                                            <label class="label"><img src="/static/pc/assets/images/required.png" th:src="@{/pc/assets/images/required.png}" class="required-img" v-if="it.required">{{it.name}}</label>
                                            <div class="input-box">
                                                <el-switch v-model="signUpMap[item.id].endNotAllowCancel" @change="endNotAllowCancelChange(item.id)"></el-switch>
                                                <span class="tips" v-if="it.introduction">{{it.introduction}}</span>
                                            </div>
                                        </div>
                                        <div class="form-item" v-show="signUpMap[item.id].endNotAllowCancel">
                                            <label class="label"></label>
                                            <div class="input-box" >
                                                <el-radio-group v-model="signUpMap[item.id].notAllowCancelType">
                                                    <el-radio v-for="(type, i) of notAllowCancelTypes" :key="'not-allow-cancel-type' + i" :label="type.value" @change="notAllowCancelTypeChange(item.id)">{{type.label}}</el-radio>
                                                </el-radio-group>
                                                <template v-if="signUpMap[item.id].notAllowCancelType == 'custom'">
                                                    <el-date-picker
                                                            style="margin-left: 10px"
                                                            v-model="signUpMap[item.id].notAllowCancelTime"
                                                            type="datetime"
                                                            format="yyyy-MM-dd HH:mm"
                                                            value-format="timestamp"
                                                            :clearable="false"
                                                            :editable="false"
                                                            :default-time="['00:00:00']"
                                                            placeholder="不可取消报名时间">
                                                    </el-date-picker>&nbsp;&nbsp;后
                                                </template>
                                            </div>
                                        </div>
                                    </template>
                                    <div class="form-item" v-else-if="it.code == 'on_site_sign_up'">
                                        <label class="label"><img src="/static/pc/assets/images/required.png" th:src="@{/pc/assets/images/required.png}" class="required-img" v-if="it.required">{{it.name}}</label>
                                        <div class="input-box">
                                            <el-switch v-model="signUpMap[item.id].onSiteSignUp"></el-switch>
                                            <span class="tips" v-if="it.introduction">{{it.introduction}}</span>
                                        </div>
                                    </div>
                                    <div class="form-item" v-else-if="it.code == 'sign_up_condition'">
                                        <label class="label"><img src="/static/pc/assets/images/required.png" th:src="@{/pc/assets/images/required.png}" class="required-img" v-if="it.required">{{it.name}}</label>
                                        <div class="input-box">
                                            <el-switch v-model="signUpConditionActiveMap[it.id]"></el-switch>
                                            <span class="tips" v-if="it.introduction">{{it.introduction}}</span>
                                        </div>
                                    </div>
                                    <div class="form-item" v-if="false">
                                        <label class="label position"><img src="/static/pc/assets/images/required.png" th:src="@{/pc/assets/images/required.png}" class="required-img">按钮名称</label>
                                        <div class="input-box btn-name">
                                            <el-input type="text" v-model.trim="signUpMap[item.id].btnName" placeholder="请输入内容" maxlength="6" show-word-limit></el-input>
                                        </div>
                                    </div>
                                </template>
                            </form>
                        </div>
                        <div class="form-item" v-else-if="item.type == 'text'">
                            <label class="label"><img src="/static/pc/assets/images/required.png" th:src="@{/pc/assets/images/required.png}" class="required-img" v-if="item.required">{{item.name}}</label>
                            <div class="input-box">
                                <el-input type="text" :placeholder="'请填写' + item.introduction" v-model.trim="activityComponentValueMap[item.id].value"></el-input>
                                <span class="tips" v-if="item.introduction">{{item.introduction}}</span>
                            </div>
                        </div>
                        <div class="form-item" v-else-if="item.type == 'radio'">
                            <label class="label"><img src="/static/pc/assets/images/required.png" th:src="@{/pc/assets/images/required.png}" class="required-img" v-if="item.required">{{item.name}}</label>
                            <div class="input-box">
                                <el-select v-if="item.dataOrigin == 'form'" v-model="activityComponentValueMap[item.id].value" placeholder="请选择">
                                    <el-option v-for="value in item.fieldValues" :key="value" :label="value" :value="value"></el-option>
                                </el-select>
                                <el-select v-if="item.dataOrigin == 'custom'" v-model="activityComponentValueMap[item.id].value" placeholder="请选择">
                                    <el-option v-for="ckItem in item.componentFields" :key="ckItem.id" :label="ckItem.fieldName" :value="ckItem.fieldName"></el-option>
                                </el-select>
                                <span class="tips" v-if="item.introduction">{{item.introduction}}</span>
                            </div>
                        </div>
                        <div class="form-item" v-else-if="item.type == 'checkbox'">
                            <label class="label"><img src="/static/pc/assets/images/required.png" th:src="@{/pc/assets/images/required.png}" class="required-img" v-if="item.required">{{item.name}}</label>
                            <div class="input-box">
                                <el-select v-if="item.dataOrigin == 'form'" multiple v-model="activityComponentValueMap[item.id].value" placeholder="请选择">
                                    <el-option v-for="value in item.fieldValues" :key="value" :label="value" :value="value"></el-option>
                                </el-select>
                                <el-select v-if="item.dataOrigin == 'custom'" multiple v-model="activityComponentValueMap[item.id].value" placeholder="请选择">
                                    <el-option v-for="ckItem in item.componentFields" :key="ckItem.id" :label="ckItem.fieldName" :value="ckItem.fieldName"></el-option>
                                </el-select>
                                <span class="tips" v-if="item.introduction">{{item.introduction}}</span>
                            </div>
                        </div>
                    </template>
                </form>
            </div>
            <!--当前使用的模版-->
            <div class="info box" v-if="activity.id && activity.webTemplateId && !isReselectConfig">
                <div class="set-box">
                    <div class="title">页面设置</div>
                </div>
                <div class="item-box" v-if="usedWebTemplate">
                    <div class="page-demo">
                        <img :src="usedWebTemplate.coverUrl" class="jqthumbImg">
                    </div>
                    <div class="pageset-right">
                        <div class="copy-box">
                            <a type="text" class="copy-link" :href="activity.previewUrl" target="_blank">{{activity.previewUrl}}</a>
                            <a href="javascript:" class="copy" @click="copyTemplatePreviewUrl">复制</a>
                        </div>
                        <button type="button" class="cancle-btn btn-main" @click="configPage">页面配置</button>
                        <button type="button" class="cancle-btn" @click="reselectTemplate">重新选择页面</button>
                    </div>
                </div>
            </div>
            <!--展示页-->
            <div class="info box" v-if="!activity.id">
                <div class="set-box">
                    <div class="title">展示页<span>请选择页面呈现样式</span></div>
                </div>
                <div class="cover-list">
                    <ul>
                        <li :class="{current: operateWebTemplateId == webTemplate.id}" v-for="(webTemplate, index) of webTemplates" :key="'web-templates' + index" v-if="!webTemplate.deleted" @click="selectTemplate(index)">
                            <div class="img-inner-box">
                                <img :src="webTemplate.coverUrl" class="img">
                                <div class="magnifier" @click="previewTemplate(index, $event)"><i></i></div>
                            </div>
                            <p class="overHidden1">{{webTemplate.name}}</p>
                        </li>
                    </ul>
                    <div class="clear"></div>
                </div>
            </div>
            <!--重新选择展示页-->
            <div class="info box" v-if="isReselectConfig">
                <div class="set-box">
                    <div class="title">展示页<span>请选择页面呈现样式</span></div>
                </div>
                <div class="cover-list">
                    <ul>
                        <li :class="{current: operateWebTemplateId == webTemplate.id}" v-for="(webTemplate, index) of webTemplates" :key="'web-templates' + index" v-if="!webTemplate.deleted" @click="selectTemplate(index)">
                            <div class="img-inner-box">
                                <img :src="webTemplate.coverUrl" class="img">
                                <div class="magnifier" @click="previewTemplate(index, $event)"><i></i></div>
                            </div>
                            <p class="overHidden1">{{webTemplate.name}}</p>
                        </li>
                    </ul>
                    <div class="clear"></div>
                </div>
            </div>
        </div>
        <!-- 新增活动分类和自定义选项的弹出框 -->
        <div class="dailog-box1" v-show="addEditActivityClassifyWindowShow">
            <div class="dailog">
                <div class="header">
                    <span>分类</span>
                    <div @click="addEditActivityClassifyWindowShow = false">
                        <img src="/static/pc/assets/images/close.png" th:src="@{/pc/assets/images/close.png}" class="close">
                    </div>
                </div>
                <div class="body">
                    <el-input type="text" class="fenlei-input" v-model.trim="addEditActivityClassify.name" placeholder="请输入" maxlength="10" show-word-limit></el-input>
                </div>
                <div class="footer">
                    <div class="normal-btn cancle" @click="addEditActivityClassifyWindowShow = false">取消</div>
                    <div :class="{'normal-btn': true, 'before-sure': !addEditActivityClassify.name, 'after-sure': addEditActivityClassify.name}" @click="addEditActivityClassifySubmit">确定</div>
                </div>
            </div>
        </div>
        <!--新增标签弹窗-->
        <div class="dailog-box1" v-show="addTagWindowShow">
            <div class="dailog">
                <div class="header">
                    <span>标签</span>
                    <div @click="addTagWindowShow = false">
                        <img src="/static/pc/assets/images/close.png" th:src="@{/pc/assets/images/close.png}" class="close">
                    </div>
                </div>
                <div class="body">
                    <el-input type="text" class="fenlei-input" v-model.trim="addTag" placeholder="请输入" maxlength="6" show-word-limit></el-input>
                </div>
                <div class="footer">
                    <div class="normal-btn cancle" @click="addTagWindowShow = false">取消</div>
                    <div :class="{'normal-btn': true, 'before-sure': !addTag, 'after-sure': addTag}" @click="addTagSubmit">确定</div>
                </div>
            </div>
        </div>
        <!-- 图片库弹窗 start -->
        <div class="dailog-box1" v-show="pictureShow">
            <div class="dailog picture-dialog">
                <div class="header">
                    <span>图片库</span>
                    <img src="/static/pc/assets/images/close.png" th:src="@{/pc/assets/images/close.png}" @click="pictureShow = false" class="close">
                </div>
                <div class="body">
                    <div class="picture-box">
                        <!-- 选中的图片加上 current 类名-->
                        <div :class="{'item-box': true, current: activePicIndex == index }" v-for="(cloudId, index) in pictureCloudIds" @click="activePicIndex = index">
                            <div class="img-box">
                                <img :src="'http://p.ananas.chaoxing.com/star3/origin/' + cloudId" alt="" class="jqthumbImg">
                            </div>
                            <i class="select-pic"></i>
                        </div>
                    </div>
                </div>
                <div class="footer">
                    <div class="normal-btn cancle" @click="cancelPicSelect">取消</div>
                    <div class="normal-btn after-sure" @click="confirmPicSelect">确定</div>
                </div>
            </div>
        </div>
        <!-- 图片库弹窗 end -->

        <!-- 删除分类弹窗 -->
        <vue-confirm ref="deleteClassifyWindow" :message="'确认删除此分类'" :cancel="'保留'" :sure="'删除'" @callback="deleteActivityClassifySubmit"></vue-confirm>
        <!--删除标签标签-->
        <vue-confirm ref="deleteTagWindow" :message="'确认删除此标签'" :cancel="'保留'" :sure="'删除'" @callback="deleteTagSubmit"></vue-confirm>
        <!-- 活动地图弹窗 -->
        <vue-map ref="activityMap" :map-dom-id="'activity-map'" :title="'设置地点'" @callback="activityAddressSure"></vue-map>
        <!--签到-->
        <vue-sign-map ref="signInMap" :map-dom-id="'sign-in-map'" :title="'设置'+ signInMapTitleKey +'地点'" th:uid="${session._login_user_.uid}" th:fid="${session._login_user_.fid}" @callback="signInAddressSure"></vue-sign-map>
        <!-- 活动发布范围弹窗 -->
        <vue-activity-participate-scope :fid="fid" :title="releaseScopeTitle" ref="activityParticipateScopeWindow" @callback="updateParticipatedOrgs"></vue-activity-participate-scope>
        <!--预览url复制容器-->
        <input type="text" id="template-preview-url-input" v-model.trim="activity.previewUrl" style="position: absolute; top: -100px; height: 1px;">
        <!-- 报名参与范围弹窗 -->
        <div class="dailog-box1" v-show="signUpParticipateWindowShow">
            <div class="dailog">
                <div class="header">
                    <span>参与范围</span>
                    <img src="/static/pc/assets/images/close.png" th:src="@{/pc/assets/images/close.png}" @click="cancelSignUpParticipateScope" class="close">
                </div>
                <div class="body">
                    <div class="tree">
                        <div class="tree-head">
                            <span>选择参与的范围</span>
                        </div>
                        <div class="tree-box">
                            <div id="sign-up-participate-scope-tree" class="ztree"></div>
                        </div>
                    </div>
                </div>
                <div class="footer">
                    <div class="normal-btn cancle" @click="cancelSignUpParticipateScope">取消</div>
                    <div class="normal-btn after-sure" @click="sureSignUpParticipateScope">发布</div>
                </div>
            </div>
        </div>
    </div>
    <div v-show="showSignInListIframe">
        <div class="top flex">
            <div class="go-back" @click="getSignId">
                <template>
                    <i class="icon-back"></i><span>返回</span>
                </template>
            </div>
            <div class="name-txt">编辑签到</div>
        </div>
        <iframe id="sign-in-list" src="" width="100%" style="border: 0; background-color: #fff; margin-top: 10px;"></iframe>
    </div>
</div>
<div th:replace="pc/include/common_js :: common_js(~{::script})">
    <script src="//api.map.baidu.com/api?v=3.0&ak=aG5nWGO5m5tkVhBHGuVppoIRfKbyp5H3"></script>
    <script src="https://noteyd.chaoxing.com/res/plugin/ueditor4thirdparty/rich.text.util.js"></script>
    <script type="text/javascript">
        RichTextUitl.loadEditorProfile();
    </script>
    <script src="/static/pc/assets/lib/zTree_v3/js/jquery.ztree.core.js" th:src="@{/pc/assets/lib/zTree_v3/js/jquery.ztree.core.js}"></script>
    <script src="/static/pc/assets/lib/zTree_v3/js/jquery.ztree.excheck.min.js" th:src="@{/pc/assets/lib/zTree_v3/js/jquery.ztree.excheck.min.js}"></script>
    <script src="/static/pc/assets/lib/zTree_v3/js/jquery.ztree.exedit.js" th:src="@{/pc/assets/lib/zTree_v3/js/jquery.ztree.exedit.js}"></script>
    <script src="/static/pc/assets/lib/element-ui/lib/index.js" th:src="@{/pc/assets/lib/element-ui/lib/index.js}"></script>
    <script src="/static/pc/assets/lib/webuploader/webuploader.js" th:src="@{/pc/assets/lib/webuploader/webuploader.js}"></script>
    <script src="/static/pc/assets/component/map.js" th:src="@{/pc/assets/component/map.js}"></script>
    <script src="/static/pc/assets/component/sign-map.js" th:src="@{/pc/assets/component/sign-map.js}"></script>
    <script src="/static/pc/assets/component/activity-participate-scope.js" th:src="@{/pc/assets/component/activity-participate-scope.js}"></script>
    <script src="/static/pc/assets/component/confirm.js" th:src="@{/pc/assets/component/confirm.js}"></script>
    <script src="/static/pc/assets/lib/jqthumb.min.js" th:src="@{/pc/assets/lib/jqthumb.min.js}"></script>
    <script src="/static/pc/assets/lib/set-iframe-height-parent.js" th:src="@{/pc/assets/lib/set-iframe-height-parent.js}"></script>
    <script src="/static/pc/assets/lib/set-iframe-height-child.js" th:src="@{/pc/assets/lib/set-iframe-height-child.js}"></script>
    <script th:inline="javascript">
        vm = new Vue({
            el: "#activity-vue",
            data: {
                uid: [[${session._login_user_.uid}]],
                fid: [[${session._login_user_.fid}]],
                templateId: [[${templateId}]],
                marketId: [[${marketId}]],
                activity: [[${activity}]],
                templateComponents: [[${templateComponents}]],
                tplComponentPartitions: [],
                templateComponentMap: {},
                needInitEditor: false,
                isEmbedded: activityApp.isEmbedded(),
                tags: [],
                // 是否重新选择模版
                isReselectConfig: false,
                // 使用的模版
                usedWebTemplate: [[${usedWebTemplate}]],
                // 模板列表
                webTemplates: [[${webTemplates}]],
                activityTypes: [[${activityTypes}]],
                activityClassifies: [[${activityClassifies}]],
                currGroupType: 'wfw',
                // 文件上传
                uploader: null,
                // 新增修改活动分类弹窗的显示
                addEditActivityClassifyWindowShow: false,
                addEditActivityClassifyIndex: null,
                addEditActivityClassify: {
                    classifyId: null,
                    name: ""
                },
                deleteActivityClassifyId: null,
                // 标签
                addTagWindowShow: false,
                addTag: "",
                deleteActivityTagIndex: "",
                // 发布类型(org: 机构发布， class: 班级发布)
                releaseType: "org",
                classList: [],
                // 参与班级id列表
                releaseClassIds: [[${releaseClassIds}]],
                // 参与机构列表
                participatedOrgs: [[${participatedOrgs}]],
                // 处理的模板id
                operateWebTemplateId: "",
                activityComponentValueMap: {},
                // 签到报名相关
                sign: [[${sign}]],
                // 报名: { originId: signUp }
                signUpMap: {},
                // 报名信息填写类型: { templateComponentId: signUpFillInfoType }
                fillInfoTypeMap: {},
                signUpConditionActiveMap: {},
                notAllowCancelTypes: [
                    {value: 'after_sign_up_end', label: '报名结束后'},
                    {value: 'after_activity_start', label: '活动开始后'},
                    {value: 'custom', label: '自定义'}
                ],
                // 签到: { originId: signIn }
                signInMap: {},
                // 签到方式
                signInWays: [],
                // 签退方式
                signOutWays: [],
                // 扫码方式
                scanCodeWays: [],
                // 表单
                formConfigLayerIndex: "",
                // 报名参与范围
                signUpParticipateWindowShow: false,
                wfwGroups: [[${wfwGroups}]],
                contactGroups: [[${contactGroups}]],
                currWfwGroups: [],
                signUpParticipateScopeTreeObj: null,
                // 活动标示
                activityFlag: [[${activityFlag}]],
                // 当前操作的对象
                operateSignUpOriginId: -1,
                operateSignInOriginId: -1,
                signInMapTitleKey: "签到",
                strict: [[${strict}]],
                // 活动封面上传中
                activityCoverUploading: false,
                timingReleasePickerOption: {
                    disabledDate: function (time) {
                        return activityApp.isBeforeToday(time.getTime());
                    }
                },
                activePicIndex: -1,
                pictureCloudIds: ['6918158e10d931e4b34c3a2005843343','cc6747c266990ae4623ee86b3580bdeb','a702ab20586128ee699c5b91be0ef327','334e2e1acc0e93a3e74e06266ef201b0','b13895d9cb4e8843ad73fbc2f98c5c20','b4b218b10d1f5482bb0cb21a04a79720','3c657a3e83e547547875ad77c5e650e7','18845df01f2b31a5230406071a2d26e7','c2f5af53ae71e6ade49b5349c8f3ad34','73c692ca3c6a8c596ac4353c933bdcce','c53deb05881621a5fd2fddd06c734f1f','6aee62c0290e2612d7a46ac90a53da89','776af507967361fb5385caf6c5e699b2','a843483e29c9e00b2bcd596e497838aa','54d1ada2a655689c15e2daa53072e996','9186c33388e760efa803768b3f9acb55','30ccf973c886947804b41da72296b276','bc46ba6f6729296779f41c06ebcaa40f','d42f5899c5f7761e0935c0036fa516d3','65cf2063eac37c48a09d0698da29c357','b4512fc47200ee1488a332d60ee99f32','fa6a3c3180ce04e49fe8835c4dd6c4d7','3431a538652d386e4902b6cab792ffe2'],
                pictureShow: false,
                fullScreen: activityApp.getUrlParamter("fullScreen"),
                showSignInListIframe: false,
                scrollHeight: 0,
                signInNum: 0,
                wfwFormConfigWindow: null,
                releaseScopeTitle: ""
            },
            created: function () {
                var $this = this;
                // 解决跨域
                document.domain = "chaoxing.com";
                window.addEventListener("message", function (e) {
                    if (e.origin.indexOf("m.oa.chaoxing.com") > -1) {
                        var { data } = activityApp.getJsonObject(e.data);
                        var originId = $this.operateSignUpOriginId;
                        $this.$set($this.signUpMap[originId], 'openAddr', data.openAddr);
                        $this.$set($this.signUpMap[originId], 'pcUrl', data.pcUrl);
                        $this.$set($this.signUpMap[originId], 'wechatUrl', data.wechatUrl);
                        $this.$set($this.signUpMap[originId], 'fillInfoFormId', data.formId);
                        $this.wfwFormConfigWindow.close();
                    }else {
                        try {
                            var data = activityApp.getJsonObject(e.data);
                            if ("sign_in_list" == data.type) {
                                var signId = data.value;
                                if (!$this.sign.id) {
                                    $this.$set($this.sign, "id", signId);
                                }
                                $this.countSignInNum();
                                $this.showSignInListIframe = false;
                                $this.$nextTick(function () {
                                    $(document).scrollTop($this.scrollHeight);
                                });
                            }
                        } catch (e) {
                        }
                    }
                });
                var partitionIndexs = [];
                // 前一个是不是特殊分区（报名属于特殊分区）
                var isPreSpecialPartition = false;
                $($this.templateComponents).each(function(i) {
                    var _this = this;
                    $this.templateComponentMap[_this.id] = _this;
                    if (this.code == 'introduction') {
                        $this.needInitEditor = true;
                    }
                    if ($this.releaseType == "org" && this.code == 'activity_release_scope' && this.dataOrigin == 'interface') {
                        $this.releaseType = "class";
                        // 发布班级url不为空，则请求发布班级列表
                        $this.loadReleaseClassData(this.originIdentify);
                    }
                    if (_this.children && _this.children.length > 0) {
                        $(_this.children).each(function () {
                            if (this.code == 'sign_up_condition') {
                                $this.$set($this.signUpConditionActiveMap, this.id, false);
                            } else if (this.code == 'sign_up_fill_info' && this.signUpFillInfoType) {
                                // 一个报名目前只有一个报名信息填写，故map的映射为 { signUpTplComponentId : signUpFillInfoType }
                                $this.fillInfoTypeMap[_this.id] = this.signUpFillInfoType
                            }
                            $this.templateComponentMap[this.id] = this;
                        });
                    }
                    var isPartition = this.code == 'sign_up' || this.code == 'company_sign_up' || this.code == 'partition';
                    if (isPartition) {
                        partitionIndexs.push(i);
                    }else if (isPreSpecialPartition) {
                        partitionIndexs.push(i);
                    }
                    if (this.code == 'sign_up' || this.code == 'company_sign_up') {
                        isPreSpecialPartition = true;
                    } else {
                        isPreSpecialPartition = false;
                    }
                });
                $(partitionIndexs).each(function (i) {
                    $this.tplComponentPartitions.push($this.templateComponents.slice(i == 0 ? 0 : partitionIndexs[i], i == partitionIndexs.length - 1 ? $this.templateComponents.length : partitionIndexs[i + 1]));
                });
                if (activityApp.isEmpty($this.activity)) {
                    $this.releaseClassIds = [];
                    // 新增活动
                    // 第一个分类的id
                    var firstActivityClassifyId = $this.activityClassifies[0] && $this.activityClassifies[0].id;
                    $this.activity = {
                        id: null,
                        name: "活动",
                        startTimeStamp: activityApp.generateActivityDefaultStartTimeStamp(),
                        endTimeStamp: activityApp.generateActivityDefaultEndTimeStamp(),
                        coverCloudId: activityApp.getDefaultCoverCloudId(),
                        coverUrl: "",
                        organisers: [[${session._login_user_.orgName}]],
                        activityType: "offline",
                        address: "",
                        detailAddress: "",
                        longitude: "",
                        dimension: "",
                        activityClassifyId: firstActivityClassifyId,
                        period: 0.0,
                        credit: 0.0,
                        timeLengthUpperLimit: null,
                        timingRelease: false,
                        timingReleaseTimeStamp: "",
                        openAudit: false,
                        tags: "",
                        openRating: false,
                        ratingNeedAudit: false,
                        integral: 0.0,
                        openWork: false,
                        openReading: false,
                        originType: "",
                        origin: "",
                        templateId: $this.templateId,
                        marketId: $this.marketId,
                        introduction: "",
                        webTemplateId: '',
                        // 目前数据接收实体没有以下字段
                        activityFlag: $this.activityFlag,
                        openGroup: false
                    };
                    // 展示模板页面 初始化默认选择第一个
                    var firstWebTemplate = $this.webTemplates && $this.webTemplates[0];
                    $this.operateWebTemplateId = firstWebTemplate && firstWebTemplate.id;
                    $this.activity.webTemplateId = firstWebTemplate && firstWebTemplate.id;
                } else {
                    $this.marketId = $this.activity.marketId;
                    // 修改活动
                    if ($this.activity.activityComponentValues) {
                        $($this.activity.activityComponentValues).each(function () {
                            var componentField = $.extend({}, this);
                            var tplComponentItem = $this.templateComponentMap[this.templateComponentId];
                            if (!tplComponentItem) {
                                return true;
                            }
                            if (componentField.value && tplComponentItem.type == 'checkbox') {
                                componentField.value = componentField.value.split(',');
                            }
                            $this.$set($this.activityComponentValueMap, this.templateComponentId, componentField);
                        });
                    }
                    if ($this.activity.sucTemplateComponentIds) {
                        var sucTemplateComponentIds = $this.activity.sucTemplateComponentIds;
                        for (var i = 0; i < sucTemplateComponentIds.length; i++) {
                            var tplComponentId = sucTemplateComponentIds[i];
                            $this.$set($this.signUpConditionActiveMap, tplComponentId, true);
                        }
                    }
                }
                $this.$set($this.activity, "timeScope", [$this.activity.startTimeStamp, $this.activity.endTimeStamp]);
                // 标签
                var tags = $this.activity.tags;
                if (activityApp.isEmpty(tags)) {
                    tags = [];
                } else {
                    tags = tags.split(",");
                }
                $this.tags = tags;
                $($this.activityTypes).each(function (i) {
                    if ($this.activity.activityType == this.value) {
                        $this.$set($this.activityTypes[i], "selected", true);
                    } else {
                        $this.$set($this.activityTypes[i], "selected", false);
                    }
                });
                var selectedActivityClassifyId = $this.activity.activityClassifyId;
                $($this.activityClassifies).each(function (i) {
                    if (this.id == selectedActivityClassifyId) {
                        $this.$set($this.activityClassifies[i], "selected", true);
                    } else {
                        $this.$set($this.activityClassifies[i], "selected", false);
                    }
                });
                $this.signInWays = [
                    {name: "普通签到", value: 1},
                    {name: "位置签到", value: 2},
                    {name: "二维码签到", value: 3}
                ];
                $this.signOutWays = [
                    {name: "普通签退", value: 1},
                    {name: "位置签退", value: 2},
                    {name: "二维码签退", value: 3}
                ];
                $this.scanCodeWays = [
                    {name: "参与者扫码", value: 1},
                    {name: "管理员扫码", value: 2}
                ];
                if (activityApp.isEmpty($this.sign.id)) {
                    // 生成新的报名签到
                    $this.sign = signApp.newSign();
                    // 根据模板组件关联关系，初始化数据
                    $($this.templateComponents).each(function () {
                        if (this.code == 'sign_up' || this.code == 'company_sign_up') {
                            var signUp = signApp.newSignUp(this);
                            signUp.originId = this.id;
                            $this.$set($this.signUpMap, this.id, signUp);
                        } else if (this.code == 'sign_in' || this.code == 'sign_out') {
                            var signIn = signApp.newSignIn(this);
                            signIn.originId = this.id;
                            $this.$set($this.signInMap, this.id, signIn);
                        } else if (this.type == 'text' || this.type == 'radio' || this.type == 'checkbox') {
                            $this.$set($this.activityComponentValueMap, this.id, {
                                templateComponentId: this.id,
                                templateId: this.templateId,
                                componentId: this.componentId,
                                value: this.type == 'checkbox' ? [] : ''
                            });
                        }
                    });
                } else {
                    $this.countSignInNum();
                    // 报名签到
                    var signUpTplComponentIds = [], signInTplComponentIds = [];
                    $($this.templateComponents).each(function () {
                        if (this.code == 'sign_up' || this.code == 'company_sign_up') {
                            signUpTplComponentIds.push(this.id);
                        } else if (this.code == 'sign_in' || this.code == 'sign_out') {
                            signInTplComponentIds.push(this.id);
                        } else if ((this.type == 'radio' || this.type == 'checkbox' || this.type == 'text') && !$this.activityComponentValueMap[this.id]) {
                            $this.$set($this.activityComponentValueMap, this.id, {
                                templateComponentId: this.id,
                                templateId: this.templateId,
                                componentId: this.componentId,
                                value: this.type == 'checkbox' ? [] : ''
                            });
                        }
                    });
                    // 报名
                    $($this.sign.signUps).each(function (i) {
                        $this.$set($this.sign.signUps[i], "endNotAllowCancel", !this.endAllowCancel);
                        if (!this.endAllowCancel && !this.notAllowCancelType) {
                            $this.$set($this.sign.signUps[i], "notAllowCancelType", $this.notAllowCancelTypes[0].value);
                        }
                        if (!activityApp.isEmpty(this.id) && signUpTplComponentIds.indexOf(this.originId) != -1) {
                            if (this.wfwParticipateScopes) {
                                $(this.wfwParticipateScopes).each(function () {
                                    if (this.leaf && $this.virtualNodeMap[this.externalId]) {
                                        this.virtualId = $this.virtualNodeMap[this.externalId].virtualId;
                                    } else {
                                        this.virtualId = this.externalId;
                                    }
                                });
                            }
                            if (this.contactsParticipateScopes) {
                                $(this.contactsParticipateScopes).each(function () {
                                    if (this.leaf && $this.virtualNodeMap[this.externalId]) {
                                        this.virtualId = $this.virtualNodeMap[this.externalId].virtualId;
                                    } else {
                                        this.virtualId = this.externalId;
                                    }
                                });
                            }
                            var tplComponentId = $this.sign.signUps[i].originId;
                            $this.$set($this.signUpMap, tplComponentId, $this.sign.signUps[i]);
                        }
                    });

                    $(signUpTplComponentIds).each(function (i) {
                        var originId = signUpTplComponentIds[i];
                        if (!$this.signUpMap[originId]) {
                            var signUp = signApp.newSignUp($this.templateComponentMap[originId]);
                            signUp.originId = originId;
                            signUp.deleted = true;
                            $this.$set($this.signUpMap, originId, signUp);
                        }
                    });
                    // 签到、签退
                    $($this.sign.signIns).each(function() {
                        if (signInTplComponentIds.indexOf(this.originId) != -1) {
                            $this.$set($this.signInMap, this.originId, $.extend({}, this));
                        }
                    });
                    $(signInTplComponentIds).each(function (i) {
                        var originId = signInTplComponentIds[i];
                        if (!$this.signInMap[originId]) {
                            var signIn = signApp.newSignIn($this.templateComponentMap[originId]);
                            signIn.originId = originId;
                            $this.$set($this.signInMap, originId, signIn);
                        }
                    });
                }
                $.each($this.signUpMap, function (key, item) {
                    item.enable = !item.deleted;
                    item.btnName = "报名参与";
                    if (!activityApp.isEmpty(item.startTime)) {
                        // 若报名签到非不限制
                        $this.$set(item, "timeScope", [item.startTime, item.endTime]);
                    }
                    if (activityApp.isEmpty($this.sign.id)) {
                        // 仅在新增的时候，根据signUpTplComponentId 初始化formType
                        var formType = $this.fillInfoTypeMap[item.originId] && $this.fillInfoTypeMap[item.originId].type
                        item.formType = formType || 'form'
                    }
                });
                $.each($this.signInMap, function (key, item) {
                    item.enable = !item.deleted;
                    $this.$set(item, "typeName", item.type == 'sign_in' ? '签到' : '签退');
                    item.btnName = item.type == 'sign_in' ? '签到' : '签退';
                    if (!activityApp.isEmpty(item.startTime)) {
                        $this.$set(item, "timeScope", [item.startTime, item.endTime]);
                    }
                });

                if (activityApp.isEmpty($this.participatedOrgs)) {
                    $this.participatedOrgs = [];
                }
            },
            mounted: function () {
                var $this = this;
                // 初始化笔记便假期
                if ($this.needInitEditor) {
                    app.initUEditor($this.activity.introduction);
                }
                $this.initUploader();
                $this.handleImg();
                $this.initWfwGroups();
            },
            computed: {
                // 虚拟节点map，即非叶子节点复制本身作为其叶子节点，该叶子节点即为虚拟节点
                virtualNodeMap: function () {
                    var $this = this;
                    var nodeMap = {};
                    $($this.currWfwGroups).each(function () {
                        if (this.id !== this.virtualId) {
                            nodeMap[this.id] = this;
                        }
                    });
                    return nodeMap;
                }
            },
            watch: {
                "operateSignInOriginId": function () {
                    var $this = this;
                    if ($this.operateSignInOriginId > -1) {
                        $this.signInMapTitleKey = $this.signInMap[$this.operateSignInOriginId].name;
                    }
                },
                // 作品征集开关
                "activity.openWork": function () {
                    var $this = this;
                    if (!$this.activity.workId && $this.activity.openWork) {
                        // 创建作品征集
                        $this.addWork();
                    }
                },
                // 阅读设置开关
                "activity.openReading": function () {
                    var $this = this;
                    if (!$this.activity.readingId && $this.activity.openReading) {
                        // 创建作品征集
                        $this.addReading();
                    }
                }
            },
            methods: {
                initWfwGroups: function () {
                    var $this = this;
                    var nodeSoncountMap = {}
                    $($this.currWfwGroups).each(function () {
                        var _this = this;
                        _this.chkDisabled = false;
                        var actualSoncount = 0;
                        $($this.currWfwGroups).each(function () {
                            if (_this.id !== this.id && _this.id === this.gid) {
                                actualSoncount++;
                            }
                        });
                        nodeSoncountMap[_this.id] = actualSoncount;
                    });

                    $($this.currWfwGroups).each(function () {
                        // 若一个非叶子节点无自身的虚拟叶子节点，则该节点不可选中
                        var nonLeaf = this.soncount && this.soncount !== 0;
                        if ((nonLeaf && !$this.virtualNodeMap[this.id]) || (this.id === this.virtualId && this.soncount !== nodeSoncountMap[this.id])) {
                            this.chkDisabled = true;
                        }
                    });
                },
                endNotAllowCancelChange: function (signUpTplComponentId) {
                    var $this = this;
                    if ($this.signUpMap[signUpTplComponentId].endNotAllowCancel && !$this.signUpMap[signUpTplComponentId].notAllowCancelType) {
                        $this.$set($this.signUpMap[signUpTplComponentId], "notAllowCancelType", $this.notAllowCancelTypes[0].value);
                        $this.$set($this.signUpMap[signUpTplComponentId], "notAllowCancelTime", null);
                    }
                },
                notAllowCancelTypeChange: function (signUpTplComponentId) {
                    var $this = this;
                    var value = $this.signUpMap[signUpTplComponentId].notAllowCancelType;
                    if (value == "custom" && !$this.signUpMap[signUpTplComponentId].notAllowCancelTime) {
                        $this.$set($this.signUpMap[signUpTplComponentId], "notAllowCancelTime", $this.activity.startTimeStamp);
                    }
                },
                periodChange: function () {
                    var $this = this;
                    var period = $this.activity.period;
                    if (activityApp.isEmpty(period)) {
                        period = 0;
                    } else {
                        period = parseFloat(period).toFixed(1);
                    }
                    $this.$set($this.activity, "period", period);
                },
                creditChange: function () {
                    var $this = this;
                    var credit = $this.activity.credit;
                    if (activityApp.isEmpty(credit)) {
                        credit = 0;
                    } else {
                        credit = parseFloat(credit).toFixed(1);
                    }
                    $this.$set($this.activity, "credit", credit);
                },
                cancelPicSelect: function () {
                    var $this = this;
                    $this.pictureShow = false;
                    $this.activePicIndex = 0;
                },
                confirmPicSelect: function () {
                    var $this = this;
                    var cloudId = $this.pictureCloudIds[$this.activePicIndex];
                    $this.$set($this.activity, "coverUrl", "http://p.ananas.chaoxing.com/star3/origin/" + cloudId + ".jpg");
                    $this.$set($this.activity, "coverCloudId", cloudId);
                    $this.$nextTick(function () {
                        $this.handleImg();
                    });
                    $this.cancelPicSelect();
                },
                signUpEnableChanged: function (tplComponentId) {
                    var $this = this;
                    $this.$set($this.signUpMap[tplComponentId], "deleted", !$this.signUpMap[tplComponentId].enable);
                },
                signInEnableChanged: function (tplComponentId) {
                    var $this = this;
                    $this.$set($this.signInMap[tplComponentId], "deleted", !$this.signInMap[tplComponentId].enable);
                },
                handleImg: function () {
                    $('.jqthumbImg').jqthumb({
                        width: '100%',
                        height: '100%'
                    });
                },
                // 初始化文件上传
                initUploader: function () {
                    var $this = this;
                    $this.uploader = WebUploader.create({
                        // swf文件路径
                        swf: ctx + "/pc/assets/lib/webuploader/Uploader.swf",
                        // 文件接收服务端。
                        server: ctx + "/api/upload/img",
                        // 选择文件的按钮。可选。
                        // 内部根据当前运行是创建，可能是input元素，也可能是flash.
                        pick: "#cover-upload-btn",
                        // 不压缩image, 默认如果是jpeg，文件上传前会压缩一把再上传！
                        resize: false,
                        auto: true,
                        duplicate: true,
                        // 只允许选择图片文件。
                        accept: {
                            title: 'Images',
                            extensions: 'gif,jpg,jpeg,bmp,png',
                            mimeTypes: 'image/*'
                        }
                    });
                    $this.uploader.on("startUpload", function (file, response) {
                        // 上传完成
                        $this.activityCoverUploading = true;
                    });
                    $this.uploader.on("uploadSuccess", function (file, response) {
                        if (response.success) {
                            var data = response.data;
                            data = activityApp.getJsonObject(data);
                            var result = data.result;
                            if (result == 1) {
                                var cloudId = data.objectid;
                                $this.$set($this.activity, "coverUrl", "");
                                $this.$set($this.activity, "coverCloudId", cloudId);
                                $this.$nextTick(function () {
                                    $this.handleImg();
                                });
                            } else {
                                app.showMsg("上传失败");
                            }
                        } else {
                            var errorMessage = response.message;
                            if (activityApp.isEmpty(errorMessage)) {
                                errorMessage = "上传失败";
                            }
                            app.showMsg(errorMessage);
                        }
                    });
                    $this.uploader.on("uploadComplete", function (file, response) {
                        // 上传完成
                        $this.activityCoverUploading = false;
                    });
                    $this.uploader.on("uploadError", function (file, reason) {
                        app.showMsg(reason);
                    });
                },
                // 修改活动类型
                changeActivityType: function (index) {
                    var $this = this;
                    var activityType = $this.activityTypes[index];
                    $this.activity.activityType = activityType.value;
                },
                // 加载发布班级数据
                loadReleaseClassData: function (dataUrl) {
                    var $this = this;
                    var pattern = /^(https?:\/\/(([a-zA-Z0-9]+-?)+[a-zA-Z0-9]+\.)+[a-zA-Z]+)(:\d+)?(\/.*)?(\?.*)?(#.*)?$/;
                    if (!pattern.test(dataUrl)) {
                        app.showMsg("发布班级数据接口地址非法");
                        return;
                    }
                    var url = ctx + "/api/third-party/query/teaching/clazz"
                    dataUrl = $this.packageReleaseClassUrl(dataUrl);
                    app.ajaxPostWithLoading(url, {url: dataUrl}, function (data) {
                        if (data.success) {
                            $this.classList = data.data;
                            var finalReleaseClassIds = [];
                            $(data.data).each(function () {
                                if ($this.releaseClassIds.indexOf(this.id) != -1) {
                                    finalReleaseClassIds.push(this.id);
                                }
                            });
                            $this.releaseClassIds = finalReleaseClassIds;
                        } else {
                            var errorMessage = data.message;
                            if (activityApp.isEmpty(errorMessage)) {
                                errorMessage = "获取班级列表失败";
                            }
                            app.showMsg(errorMessage);
                        }
                    }, function () {
                        app.showMsg("获取班级列表失败");
                    });
                },
                packageReleaseClassUrl: function (dataUrl) {
                    var $this = this;
                    if (dataUrl.indexOf("?") == -1) {
                        dataUrl += "?fid=" + $this.fid + "&uid=" + $this.uid;
                        return dataUrl;
                    }
                    var paramSplitIndex = dataUrl.indexOf("?"),
                        originUrl = dataUrl.substring(0, paramSplitIndex),
                        params = dataUrl.substring(paramSplitIndex + 1).split("&");
                    var existUid = false, existFid = false;
                    $(params).each(function (i) {
                        if (!existUid && params[i].indexOf("uid=") != -1) {
                            existUid = true
                        } else if (!existFid && params[i].indexOf("fid=") != -1) {
                            existFid = true;
                        }
                    });
                    if (!existUid) {
                        params.push("uid=" + $this.uid);
                    }
                    if (!existFid) {
                        params.push("fid=" + $this.fid);
                    }
                    return originUrl + "?" + params.join("&")
                },
                // 显示发布范围弹窗
                toAddParticipateScope: function (title) {
                    var $this = this;
                    $this.releaseScopeTitle = title;
                    $this.$refs.activityParticipateScopeWindow.showWindow($this.participatedOrgs);
                },
                // 更新发布范围的机构
                updateParticipatedOrgs: function () {
                    var $this = this;
                    $this.participatedOrgs = $this.$refs.activityParticipateScopeWindow.selectedOrgs;
                },
                // 显示百度地图
                showActivityMap: function () {
                    var $this = this;
                    $this.$refs.activityMap.show = true;
                },
                showSignInMap: function (tplComponentId) {
                    var $this = this;
                    $this.operateSignInOriginId = tplComponentId;
                    $this.$refs.signInMap.show = true;
                },
                // 确定活动地址
                activityAddressSure: function () {
                    var $this = this;
                    if (activityApp.isEmpty($this.$refs.activityMap.longitude) || activityApp.isEmpty($this.$refs.activityMap.dimension)) {
                        app.showMsg("请选择地址");
                        return;
                    }
                    $this.activity.address = $this.$refs.activityMap.address;
                    $this.activity.longitude = $this.$refs.activityMap.longitude;
                    $this.activity.dimension = $this.$refs.activityMap.dimension;
                },
                // 确定签到地址
                signInAddressSure: function () {
                    var $this = this;
                    if (activityApp.isEmpty($this.$refs.signInMap.longitude) || activityApp.isEmpty($this.$refs.signInMap.dimension)) {
                        app.showMsg("请选择签到地址");
                        return;
                    }
                    $this.$set($this.signInMap[$this.operateSignInOriginId], "address", $this.$refs.signInMap.address);
                    $this.$set($this.signInMap[$this.operateSignInOriginId], "longitude", $this.$refs.signInMap.longitude);
                    $this.$set($this.signInMap[$this.operateSignInOriginId], "dimension", $this.$refs.signInMap.dimension);
                },
                selectActivityClassify: function (index) {
                    var $this = this;
                    $($this.activityClassifies).each(function (i) {
                        if (i == index) {
                            $this.$set($this.activityClassifies[i], "selected", true);
                            $this.activity.activityClassifyId = this.id;
                        } else {
                            $this.$set($this.activityClassifies[i], "selected", false);
                        }
                    });
                },
                toAddActivityClassify: function () {
                    var $this = this;
                    $this.addEditActivityClassify = $this.marketId ? {
                        marketId: $this.marketId,
                        name: ""
                    } : {
                        fid: $this.fid,
                        name: ""
                    };
                    $this.addEditActivityClassifyWindowShow = true;
                },
                toEditActivityClassify: function (index, e) {
                    e.stopPropagation();
                    var $this = this;
                    var activityClassify = $this.activityClassifies[index];
                    $this.addEditActivityClassifyIndex = index;
                    $this.addEditActivityClassify = $this.marketId ? {
                        classifyId: activityClassify.id,
                        name: activityClassify.name,
                        marketId: $this.marketId
                    } : {
                        classifyId: activityClassify.id,
                        name: activityClassify.name,
                        fid: $this.fid,
                    };
                    $this.addEditActivityClassifyWindowShow = true;
                },
                addEditActivityClassifySubmit: function () {
                    var $this = this;
                    if (activityApp.isEmpty($this.addEditActivityClassify.name)) {
                        return;
                    }
                    var isAdd = activityApp.isEmpty($this.addEditActivityClassify.classifyId);
                    var tips = "新增";
                    var orgUrl = ctx + "/api/org/" + $this.fid + "/classify/add";
                    var marketUrl = ctx + "/api/market/" + $this.marketId + "/classify/add";
                    if (!isAdd) {
                        orgUrl = ctx + "/api/org/" + $this.fid + "/classify/edit";
                        marketUrl = ctx + "/api/market/" + $this.marketId + "/classify/update";
                        tips = "修改";
                    }
                    var url = $this.marketId ? marketUrl : orgUrl;
                    var params = $this.marketId ? {
                        classifyId: $this.addEditActivityClassify.classifyId,
                        name: $this.addEditActivityClassify.name,
                        marketId: $this.marketId
                    } : {
                        classifyId: $this.addEditActivityClassify.classifyId,
                        name: $this.addEditActivityClassify.name,
                        fid: $this.fid
                    };
                    app.ajaxPostWithLoading(url, params, function (data) {
                        if (data.success) {
                            var data = data.data;
                            if (isAdd) {
                                data.selected = false;
                                $this.activityClassifies.push(data);
                            } else {
                                data.selected = this.selected;
                                $this.activityClassifies.splice($this.addEditActivityClassifyIndex, 1, data);
                                $this.addEditActivityClassifyIndex = null;
                            }
                            $this.addEditActivityClassifyWindowShow = false;
                        } else {
                            var errorMessage = data.message;
                            if (activityApp.isEmpty(errorMessage)) {
                                errorMessage = tips + "分类失败";
                            }
                            app.showMsg(errorMessage);
                        }
                    }, function () {
                        app.showMsg(tips + "分类失败");
                    });
                },
                toDeleteActivityClassify: function (index, e) {
                    e.stopPropagation();
                    var $this = this;
                    var activityClassify = $this.activityClassifies[index];
                    $this.deleteActivityClassifyId = activityClassify.id;
                    $this.$refs.deleteClassifyWindow.show = true;
                },
                deleteActivityClassifySubmit: function () {
                    var $this = this;
                    var orgUrl = ctx + "/api/org/" + $this.fid + "/classify/" + $this.deleteActivityClassifyId + "/delete";
                    var marketUrl = ctx + "/api/market/" + $this.marketId + "/classify/" + $this.deleteActivityClassifyId + "/delete";
                    var url = $this.marketId ? marketUrl : orgUrl;
                    app.ajaxPostWithLoading(url, {}, function (data) {
                        if (data.success) {
                            $this.$refs.deleteClassifyWindow.show = false;
                            $($this.activityClassifies).each(function (i) {
                                if (this.id == $this.deleteActivityClassifyId) {
                                    if (this.selected) {
                                        $this.activity.activityClassifyId = null;
                                    }
                                    $this.activityClassifies.splice(i, 1);
                                    return false;
                                }
                            });
                        } else {
                            var errorMessage = data.errorMessage;
                            if (activityApp.isEmpty(errorMessage)) {
                                errorMessage = "删除分类失败";
                            }
                            app.showMsg(errorMessage);
                        }
                    }, function () {
                        app.showMsg("删除分类失败");
                    });
                },
                // 添加标签
                toAddTag: function () {
                    var $this = this;
                    $this.addTagWindowShow = true;
                },
                addTagSubmit: function () {
                    var $this = this;
                    if ($this.tags.indexOf($this.addTag) > -1) {
                        app.showMsg("标签已存在");
                        return;
                    }
                    $this.tags.push($this.addTag);
                    $this.activity.tags = $this.tags.join(",");
                    $this.addTag = "";
                    $this.addTagWindowShow = false;
                },
                deleteTag: function (index) {
                    var $this = this;
                    $this.deleteTagIndex = index;
                    $this.$refs.deleteTagWindow.show = true;
                },
                deleteTagSubmit: function () {
                    var $this = this;
                    $this.tags.splice($this.deleteTagIndex, 1);
                    $this.activity.tags = $this.tags.join(",");
                    $this.$refs.deleteTagWindow.show = false;
                },
                // 验证输入
                validateForm: function () {
                    var $this = this;
                    if (activityApp.isEmpty($this.activity.name)) {
                        app.showMsg("活动名称不能为空");
                        return false;
                    }
                    if (activityApp.isEmpty($this.activity.startTimeStamp)) {
                        app.showMsg("活动开始时间不能为空");
                        return false;
                    }
                    if (activityApp.isEmpty($this.activity.endTimeStamp)) {
                        app.showMsg("活动结束时间不能为空");
                        return false;
                    }
                    if ($this.activity.startTimeStamp >= $this.activity.endTimeStamp) {
                        app.showMsg("活动开始时间必须小于结束时间");
                        return false;
                    }
                    if (activityApp.isEmpty($this.activity.coverCloudId)) {
                        app.showMsg("请上传封面");
                        return false;
                    }
                    // 定时发布
                    if ($this.activity.timingRelease && activityApp.isEmpty($this.activity.timingReleaseTimeStamp)) {
                        app.showMsg("请选择发布时间");
                        return false;
                    }
                    if (activityApp.isEmpty($this.activity.webTemplateId)) {
                        app.showMsg("请选择展示页");
                        return false;
                    }
                    // 报名验证
                    var signUpKeys = Object.keys($this.signUpMap);
                    for (var i = 0; i < signUpKeys.length; i++) {
                        var originId = signUpKeys[i];
                        var signUp = $this.signUpMap[originId];
                        var deleted = signUp.deleted;
                        if (!deleted) {
                            if (activityApp.isEmpty(signUp.startTime)) {
                                app.showMsg(signUp.name + "开始时间不能为空");
                                return false;
                            }
                            if (activityApp.isEmpty(signUp.endTime)) {
                                app.showMsg(signUp + "结束时间不能为空");
                                return false;
                            }
                            if (signUp.startTime >= signUp.endTime) {
                                app.showMsg(signUp + "开始时间必须小于结束时间");
                                return false;
                            }
                            // 参与范围
                            var signUpTplComponent = $this.templateComponentMap[originId];
                            if (!signUpTplComponent) {
                                continue;
                            }
                            for (var j = 0; j < signUpTplComponent.children.length; j++) {
                                if (signUpTplComponent.children[j].code == 'wfw_participation_scope') {
                                    if (signUp.enableWfwParticipateScope) {
                                        var participateScopes = signUp.wfwParticipateScopes;
                                        if (participateScopes.length < 1) {
                                            app.showMsg("请选择"+ signUp.name +"参与范围");
                                            return false;
                                        }
                                    }
                                } else if (signUpTplComponent.children[j].code == 'contacts_participation_scope') {
                                    if (signUp.enableContactsParticipateScope) {
                                        var participateScopes = signUp.contactsParticipateScopes;
                                        if (participateScopes.length < 1) {
                                            app.showMsg("请选择"+ signUp.name +"参与范围");
                                            return false;
                                        }
                                    }
                                }

                            }

                            if (signUp.limitPerson) {
                                // 启用人数限制
                                if (signUp.personLimit < 1) {
                                    app.showMsg(signUp.name + "请输入正确的"+ signUp.name +"限制人数");
                                    return false;
                                }
                            }
                            if (signUp.endNotAllowCancel) {
                                if (activityApp.isEmpty(signUp.notAllowCancelType)) {
                                    app.showMsg("请选择"+ signUp.name +"不允许取消报名类型");
                                    return false;
                                }
                                if (signUp.notAllowCancelType == 'custom' && activityApp.isEmpty(signUp.notAllowCancelTime)) {
                                    app.showMsg("请选择"+ signUp.name +"不允许取消报名时间");
                                    return false;
                                }
                            }

                            if (signUp.fillInfo) {
                                if (activityApp.isEmpty(signUp.fillInfoFormId)) {
                                    app.showMsg("请配置"+ signUp.name +"填报信息");
                                    return false;
                                }
                            }
                            if (activityApp.isEmpty(signUp.btnName)) {
                                app.showMsg(signUp.name + "按钮名称不能为空");
                                return false;
                            }
                        }
                    }
                    // 签到设置
                    var signInKeys = Object.keys($this.signInMap);
                    for (var i = 0; i < signInKeys.length; i++) {
                        var signIn = $this.signInMap[signInKeys[i]];
                        var deleted = signIn.deleted;
                        if (!deleted) {
                            // 签到方式
                            if (signIn.way == 2 && !signIn.deleted) {
                                // 位置签到
                                if (activityApp.isEmpty(signIn.address)) {
                                    app.showMsg(signIn.name + "位置不能为空");
                                    return false;
                                }
                            }
                            if (activityApp.isEmpty(signIn.startTime)) {
                                app.showMsg(signIn.name + "开始时间不能为空");
                                return false;
                            }
                            if (!activityApp.isEmpty(signIn.endTime) && signIn.startTime >= signIn.endTime) {
                                app.showMsg(signIn.name + "开始时间必须小于结束时间");
                                return false;
                            }
                            if (signIn.fillInfo) {
                                if (activityApp.isEmpty(signIn.fillInfoFormId)) {
                                    app.showMsg("请选择"+ signIn.name +"需要填写的表单");
                                    return false;
                                }
                            }
                            if (activityApp.isEmpty(signIn.btnName)) {
                                app.showMsg("签到按钮名称不能为空");
                                return false;
                            }
                        }
                    }
                    return true;
                },
                packageSignUpConditionEnable: function () {
                    var $this = this;
                    var keys = Object.keys($this.signUpConditionActiveMap);
                    if (keys.length == 0) {
                        return null;
                    }
                    var sucTemplateComponentIds = [];
                    for (var i = 0; i < keys.length; i++) {
                        var tplComponentId = keys[i];
                        if ($this.signUpConditionActiveMap[tplComponentId]) {
                            sucTemplateComponentIds.push(tplComponentId)
                        }
                    }
                    return sucTemplateComponentIds;
                },
                packageSubmitSign: function () {
                    var $this = this;
                    var waitSubmitSignUps = [], waitSubmitSignIns = [];
                    var signInMap = $.extend({}, $this.signInMap), signUpMap = $.extend({}, $this.signUpMap);
                    $.each(signUpMap, function (key, item) {
                        // 新增，且未开启报名，则不提交
                        if ((!item.id && !item.deleted) || item.id) {
                            // 取消报名设置
                            item.endAllowCancel = !item.endNotAllowCancel;
                            waitSubmitSignUps.push(item);
                        }
                    });
                    $.each(signInMap, function (key, item) {
                        var way = item.way;
                        switch (way) {
                            case 1:
                            case 3:
                                item.address = "";
                                item.longitude = null;
                                item.dimension = null;
                                item.detailAddress = "";
                                break;
                            default:
                        }
                        // 新增，且未开启签到，则不提交
                        if ((!item.id && !item.deleted) || item.id) {
                            waitSubmitSignIns.push(item);
                        }
                    });
                    return $.extend({}, $this.sign, { signUps: waitSubmitSignUps, signIns: waitSubmitSignIns });
                },
                // 下一步（创建活动）
                addSubmit: function () {
                    var $this = this;
                    if (!$this.validateForm()) {
                        return;
                    }
                    if ($this.activityCoverUploading) {
                        app.showMsg("正在上传封面");
                        return;
                    }
                    // 创建活动
                    var url = ctx + "/api/activity/new";
                    var sign = $this.packageSubmitSign();
                    $this.activity.introduction = app.getUEditorContent();
                    $this.activity.sucTemplateComponentIds =  $this.packageSignUpConditionEnable();
                    var participateScopeJsonStr = $this.releaseType == "org" ? activityApp.getJsonStr($this.participatedOrgs) : null;
                    var releaseClassIdJsonStr = $this.releaseType == "class" ? activityApp.getJsonStr($this.releaseClassIds) : null;
                    var params = {
                        activityJsonStr: activityApp.getJsonStr($this.activity),
                        participateScopeJsonStr: participateScopeJsonStr,
                        releaseClassIdJsonStr: releaseClassIdJsonStr,
                        signJsonStr: activityApp.getJsonStr(sign)
                    }
                    app.ajaxPostWithLoading(url, params, function (data) {
                        if (data.success) {
                            app.noticeActivityChange($this.activity.id);
                            var activityId = data.data;
                            $this.$set($this.activity, "id", activityId);
                            app.showMsg("创建成功", function () {
                                $this.returnBack();
                            });
                        } else {
                            var errorMessage = data.message;
                            if (activityApp.isEmpty(errorMessage)) {
                                errorMessage = "创建失败";
                            }
                            app.showMsg(errorMessage);
                        }
                    }, function () {
                        app.showMsg("创建失败");
                    });
                },
                // 编辑活动提交
                editSubmit: function () {
                    var $this = this;
                    if (!$this.validateForm()) {
                        return;
                    }
                    if ($this.activityCoverUploading) {
                        app.showMsg("正在上传封面");
                        return;
                    }
                    // 修改活动
                    var url = ctx + "/api/activity/edit";
                    var sign = $this.packageSubmitSign();
                    $this.activity.sucTemplateComponentIds =  $this.packageSignUpConditionEnable();
                    $this.activity.activityComponentValues = [];
                    $.each($this.activityComponentValueMap, function (key, item) {
                        item.value = item.value && item.value instanceof Array ? item.value.join(',') : item.value;
                        $this.activity.activityComponentValues.push(item);
                    });
                    $this.activity.introduction = app.getUEditorContent();
                    var participateScopeJsonStr = $this.releaseType == "org" ? activityApp.getJsonStr($this.participatedOrgs) : null;
                    var releaseClassIdJsonStr = $this.releaseType == "class" ? activityApp.getJsonStr($this.releaseClassIds) : null;
                    var params = {
                        activityJsonStr: activityApp.getJsonStr($this.activity),
                        participateScopeJsonStr: participateScopeJsonStr,
                        releaseClassIdJsonStr: releaseClassIdJsonStr,
                        signJsonStr: activityApp.getJsonStr(sign)
                    };
                    app.ajaxPostWithLoading(url, params, function (data) {
                        if (data.success) {
                            app.noticeActivityChange($this.activity.id);
                            var activityData = data.data;
                            $this.$set($this.sign, "id", activityData.signId);
                            app.showMsg("修改成功", function () {
                                $this.returnBack();
                            });
                        } else {
                            var errorMessage = data.message;
                            if (activityApp.isEmpty(errorMessage)) {
                                errorMessage = "修改失败";
                            }
                            app.showMsg(errorMessage);
                        }
                    }, function () {
                        app.showMsg("修改失败");
                    });
                },
                returnBack: function () {
                    var $this = this;
                    if ($this.isEmbedded) {
                        window.history.back();
                    } else {
                        window.close();
                    }
                },
                // 选中签到的时间范围
                selectSignInTime: function (tplComponentId, obj) {
                    var $this = this;
                    $this.$set($this.signInMap[tplComponentId], "startTime", obj[0]);
                    $this.$set($this.signInMap[tplComponentId], "endTime", obj[1]);
                },
                // 预览模板
                previewTemplate: function (index, e) {
                    var $this = this;
                    e.stopPropagation();
                    var webTemplate = $this.webTemplates[index];
                    window.open(webTemplate.previewUrl);
                },
                // 选择模板
                selectTemplate: function (index) {
                    var $this = this;
                    var webTemplate = $this.webTemplates[index];
                    $this.operateWebTemplateId = webTemplate.id;
                    $this.activity.webTemplateId = webTemplate.id;
                },
                // 预览页面
                previePage: function () {
                    var $this = this;
                    window.open($this.activity.previewUrl);
                },
                // 配置页面
                configPage: function () {
                    var $this = this;
                    window.open($this.activity.editUrl);
                },
                // 复制预览地址
                copyTemplatePreviewUrl: function () {
                    var $this = this;
                    $("#template-preview-url-input")[0].select();
                    document.execCommand("copy");
                    app.showMsg("复制成功");
                },
                // 表单
                toConfigForm: function (tplComponentId) {
                    var $this = this;
                    $this.operateSignUpOriginId = tplComponentId;
                    var signUp = $this.signUpMap[tplComponentId];
                    var formId = "";
                    if (!activityApp.isEmpty(signUp.fillInfoFormId)) {
                        formId = signUp.fillInfoFormId;
                    }
                    var url = "//reading.chaoxing.com/qd/form/config?formId=" + formId;
                    $('body').addClass('scroll');
                    $this.formConfigLayerIndex = layer.open({
                        title: "表单配置",
                        skin: "create-class",
                        type: 2,
                        content: [url, "no"],
                        area: ["600px", "680px"],
                        btn: ["取消", "完成"],
                        btnAlign: "c",
                        yes: function (index) {
                            var signUp = $this.signUpMap[tplComponentId];
                            if (signUp.fillInfo && activityApp.isEmpty(signUp.fillInfoFormId)) {
                                $this.$set($this.signUpMap[tplComponentId], "fillInfo", false);
                            }
                            // 关闭表单填写
                            app.closeLayerPop(index);
                        },
                        btn2: function () {
                            $("#layui-layer-iframe" + $this.formConfigLayerIndex)[0].contentWindow.submit();
                            return false;
                        },
                        end: function () {
                            $('body').removeClass('scroll');
                        }
                    })
                },
                // 万能表单
                toWfwFormConfig: function (signUpTplComponentId) {
                    var $this = this;
                    if ($this.wfwFormConfigWindow && !$this.wfwFormConfigWindow.closed) {
                        app.showMsg("请先关闭上一个填报信息配置页面");
                        return;
                    }

                    var signUp = $this.signUpMap[signUpTplComponentId];
                    var formId = "";
                    $this.operateSignUpOriginId = signUpTplComponentId;
                    if (!activityApp.isEmpty(signUp.fillInfoFormId)) {
                        formId = signUp.fillInfoFormId;
                    }
                    var url = ctx + '/api/wfw-form/build/create-url';
                    var templateType = ($this.fillInfoTypeMap[signUpTplComponentId] && $this.fillInfoTypeMap[signUpTplComponentId].templateType) || '';
                    var params = {
                        fid: $this.fid,
                        uid: [[${session._login_user_.uid}]],
                        formId: formId,
                        templateType: templateType
                    }
                    app.ajaxPost(url,params, function (res) {
                        if (res.success) {
                            $this.wfwFormConfigWindow = window.open(res.data);
                        } else {
                            var errorMessage = res.message;
                            if (activityApp.isEmpty(errorMessage)) {
                                errorMessage = "获取表单配置地址失败";
                            }
                            app.showMsg(errorMessage);
                        }
                    }, function () {
                        app.showMsg("获取表单配置地址失败");
                    });
                },
                closeFormConfigLayer: function (formId) {
                    var $this = this;
                    app.closeLayerPop($this.formConfigLayerIndex);
                    $this.$set($this.signUpMap[$this.operateSignUpOriginId], "fillInfoFormId", formId);
                },
                toAddSignUpParticipateScope: function(signUpTplComponentId, templateComponent){
                    var $this = this;
                    $this.operateSignUpOriginId = signUpTplComponentId;
                    $this.currGroupType = templateComponent.code == 'wfw_participation_scope' ? 'wfw' : 'contacts';
                    $this.currWfwGroups = templateComponent.code == 'wfw_participation_scope' ? $this.wfwGroups : $this.contactGroups;
                    $this.initWfwGroups();
                    $this.signUpParticipateWindowShow = true;
                    if(!$this.signUpParticipateScopeTreeObj){
                        $this.initGroupTree();
                    }
                },
                initGroupTree: function () {
                    var $this = this;
                    $($this.currWfwGroups).each(function () {
                        this.isParent = this.soncount > 0;
                    })
                    var setting = {
                        check: {
                            enable: true
                        },
                        data: {
                            simpleData: {
                                enable: true,
                                idKey: "virtualId",
                                pIdKey: "gid",
                            },
                            key: {
                                name: "groupname"
                            },
                            keep: {
                                parent: true
                            }
                        },
                        callback: {}
                    };
                    $this.signUpParticipateScopeTreeObj = $.fn.zTree.init($("#sign-up-participate-scope-tree"), setting, $this.currWfwGroups);

                    var signUp = $this.signUpMap[$this.operateSignUpOriginId];

                    var signUpParticipateScopes = (signUp && ($this.currGroupType == 'wfw' ? signUp.wfwParticipateScopes : signUp.contactsParticipateScopes)) || [];

                    // 获取所有父节点
                    for(var i = 0; i < signUpParticipateScopes.length; i++) {
                        var item = signUpParticipateScopes[i];
                        $this.signUpParticipateScopeTreeObj.checkNode($this.signUpParticipateScopeTreeObj.getNodeByParam("virtualId", item.virtualId, null), true, !item.leaf);
                    }

                },
                cancelSignUpParticipateScope: function () {
                    var $this = this;
                    if ($this.signUpParticipateScopeTreeObj) {
                        $this.signUpParticipateScopeTreeObj.destroy();
                        $this.signUpParticipateScopeTreeObj = null;
                    }
                    $this.currWfwGroups = [];
                    $this.currGroupType = 'wfw';
                    $this.signUpParticipateWindowShow = false
                },
                // 确认选择报名参与范围
                sureSignUpParticipateScope: function () {
                    var $this = this;
                    var zTree = $.fn.zTree.getZTreeObj("sign-up-participate-scope-tree");
                    var nodeArr = zTree.getCheckedNodes(true);
                    //首先保存 搜索父节点被全选的，在看非父节点被选中的(非父节点的父节点被全选，则不保存该条记录)
                    var scopes = [];
                    var pNodes = [];
                    var pNodeMap = {};
                    var cNodes = [];
                    $(nodeArr).each(function () {
                        // 半选状态
                        var half = this.getCheckStatus().half;
                        // 只记录全选的
                        if (!half) {
                            var node = { externalId: this.id, virtualId: this.virtualId, externalPid: this.gid, externalName: this.groupname, leaf: !this.isParent };
                            // 如果是非叶子结点节点
                            if (this.isParent) {
                                pNodes.push(node);
                                pNodeMap[node.virtualId] = node;
                            } else {
                                cNodes.push(node);
                            }
                        }
                    });
                    $(cNodes).each(function () {
                        if (!this.externalPid || !pNodeMap[this.externalPid]) {
                            pNodes.push(this);
                            pNodeMap[this.virtualId] = this;
                        }
                    });
                    $(pNodes).each(function () {
                        if (!this.externalPid || !pNodeMap[this.externalPid]) {
                            scopes.push($.extend({}, this, {groupType: $this.currGroupType}));
                        }
                    });
                    if ($this.currGroupType == 'contacts') {
                        $this.$set($this.signUpMap[$this.operateSignUpOriginId], "contactsParticipateScopes", scopes);
                    } else {
                        $this.$set($this.signUpMap[$this.operateSignUpOriginId], "wfwParticipateScopes", scopes);
                    }
                    $this.cancelSignUpParticipateScope();
                },
                deleteSignUpParticipateScope: function (signUpTplComponentId, templateComponent, scopeIndex) {
                    var $this = this;
                    if (templateComponent.code == 'wfw_participation_scope') {
                        $this.signUpMap[signUpTplComponentId].wfwParticipateScopes.splice(scopeIndex, 1);
                    } else {
                        $this.signUpMap[signUpTplComponentId].contactsParticipateScopes.splice(scopeIndex, 1);
                    }
                },
                // 创建作品征集
                addWork: function () {
                    var $this = this;
                    var url = ctx + "/api/work/new";
                    app.ajaxPostWithLoading(url, {}, function (data) {
                        if (data.success) {
                            $this.activity.workId = data.data;
                        } else {
                            var message = data.message;
                            if (activityApp.isEmpty(message)) {
                                message = "开启作品征集失败";
                            }
                            app.showMsg(message, function () {
                                $this.$set($this.activity, "openWork", false);
                            });
                        }
                    }, function () {
                        app.showMsg("开启作品征集失败", function () {
                            $this.$set($this.activity, "openWork", false);
                        });
                    });
                },
                // 创建阅读
                addReading: function () {
                    var $this = this;
                    var url = ctx + "/api/reading/new?activityName=" + $this.activity.name;
                    app.ajaxPostWithLoading(url, {}, function (res) {
                        if (res.success) {
                            $this.activity.readingId = res.data.id;
                            $this.activity.readingModuleId = res.data.modulesId;
                        } else {
                            var message = res.message;
                            if (activityApp.isEmpty(message)) {
                                message = "开启阅读失败";
                            }
                            app.showMsg(message, function () {
                                $this.$set($this.activity, "openReading", false);
                            });
                        }
                    }, function () {
                        app.showMsg("开启阅读失败", function () {
                            $this.$set($this.activity, "openReading", false);
                        });
                    });
                },
                // 作品征集管理
                workManage: function () {
                    var $this = this;
                    var url = activityApp.getWorkManageUrl($this.activity.workId);
                    window.open(url);
                },
                // 阅读书单管理
                readManage: function () {
                    var $this = this;
                    var url = activityApp.getReadingBookManageUrl($this.activity.readingId, $this.activity.readingModuleId);
                    window.open(url);
                },
                // 签到列表管理页
                toSignInList: function () {
                    var $this = this;
                    var signId = $this.sign.id;
                    var url = "";
                    if (signId) {
                        url = "//reading.chaoxing.com/qd/manage/sign-in/list?signId=" + signId + "&back=true";
                    } else {
                        url = "//reading.chaoxing.com/qd/manage/sign-in/list/new?back=true";
                    }
                    $("#sign-in-list").attr("src", url);
                    $this.showSignInListIframe = true;
                    $("#sign-in-list").css("min-height", $(window).height());
                    // 记录滚动条高度后重置滚动条
                    $this.scrollHeight = $(document).scrollTop();
                    $(document).scrollTop(0);
                },
                // 获取报名签到id
                getSignId: function () {
                    $("#sign-in-list")[0].contentWindow.postMessage(activityApp.getJsonStr({type: "get_sign_id"}), "*");
                },
                // 获取签到数量
                countSignInNum: function () {
                    var $this = this;
                    var url = ctx + "/api/sign/" + $this.sign.id + "/sign-in/num";
                    app.ajaxPost(url, {}, function (data) {
                        if (data.success) {
                            $this.signInNum = data.data;
                        } else {
                            var message = data.message;
                            if (activityApp.isEmpty(message)) {
                                message = "获取已发布签到数量失败";
                            }
                            app.showMsg(message);
                        }
                    }, function () {
                        app.showMsg("获取已发布签到数量失败");
                    });
                },
                // 重新选择模版
                reselectTemplate: function () {
                    var $this = this;
                    $this.isReselectConfig = true;
                }
            }
        });

        /**
         * 关闭表单配置页面
         */
        function closeFormConfigLayer(formId) {
            vm.closeFormConfigLayer(formId);
        }
    </script>
</div>
<div th:replace="pc/include/note_editor :: note_editor"></div>
</body>
</html>