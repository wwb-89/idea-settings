<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org/">
<head>
    <title th:text="${activity.name}">活动主页</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="/static/pc/assets/lib/element-ui/lib/theme-chalk/index.css" th:href="@{/pc/assets/lib/element-ui/lib/theme-chalk/index.css}">
    <link rel="stylesheet" href="/static/pc/assets/css/activityHomePage.css" th:href="@{/pc/assets/css/activityHomePage.css}">
    <style>
        [v-cloak] {
            display: none;
        }
    </style>
</head>
<body>
<div class="container" id="activity-vue" v-cloak>
    <div class="slider">
        <div class="title">
            <span th:text="${activity.name}" style="cursor: pointer;" @click="activityHome"></span>
            <i class="icon-qr-code" @click="showActivityHomeQrcode"></i>
        </div>
        <div class="menu">
            <div class="entry menu-item" v-show="menuShow('sign_up') || menuShow('sign_in')">
                <!--报名名单-->
                <div :class="{'item': true, 'active': menus.sign_up.selected}" v-if="signActivityManageIndex.signUpExist && menuShow('sign_up')" @click="toSignUpList">
                    <img :src="menus.sign_up.activeIconUrl" v-if="menus.sign_up.selected">
                    <img :src="menus.sign_up.defaultIconUrl" v-else>
                    <span>{{menus.sign_up.name}}</span>
                </div>
                <!--签到管理-->
                <div :class="{'item': true, 'active': menus.sign_in.selected}" @click="toSignInManage" v-if="menuShow('sign_in')">
                    <img :src="menus.sign_in.activeIconUrl" v-if="menus.sign_in.selected">
                    <img :src="menus.sign_in.defaultIconUrl" v-else>
                    <span>{{menus.sign_in.name}}</span>
                </div>
            </div>
            <div class="entry menu-item" v-show="activity.openClazzInteraction">
                <!--讨论-->
                <div :class="{'item': true, 'active': menus.discuss.selected}" @click="toDiscuss" v-if="menuShow('discuss')">
                    <img :src="menus.discuss.activeIconUrl" v-if="menus.discuss.selected">
                    <img :src="menus.discuss.defaultIconUrl" v-else>
                    <span>{{menus.discuss.name}}</span>
                </div>
                <!--任务-->
                <div :class="{'item': true, 'active': menus.task.selected}" @click="toTask" v-if="menuShow('task')">
                    <img :src="menus.task.activeIconUrl" v-if="menus.task.selected">
                    <img :src="menus.task.defaultIconUrl" v-else>
                    <span>{{menus.task.name}}</span>
                </div>
                <!--作业-->
                <div :class="{'item': true, 'active': menus.homework.selected}" @click="toHomework" v-if="menuShow('homework')">
                    <img :src="menus.homework.activeIconUrl" v-if="menus.homework.selected">
                    <img :src="menus.homework.defaultIconUrl" v-else>
                    <span>{{menus.homework.name}}</span>
                </div>
                <!--评审管理-->
                <div :class="{'item': true, 'active': menus.review_management.selected}" @click="toReviewManagement" v-if="menuShow('review_management')">
                    <img :src="menus.review_management.activeIconUrl" v-if="menus.review_management.selected">
                    <img :src="menus.review_management.defaultIconUrl" v-else>
                    <span>{{menus.review_management.name}}</span>
                </div>
            </div>
            <div class="entry menu-item" v-if="menuShow('results_manage')">
                <!--考核管理-->
                <div :class="{'item': true, 'active': menus.results_manage.selected}" @click="toResultsManage">
                    <img :src="menus.results_manage.activeIconUrl" v-if="menus.results_manage.selected">
                    <img :src="menus.results_manage.defaultIconUrl" v-else>
                    <span>{{menus.results_manage.name}}</span>
                </div>
            </div>
            <div class="entry menu-item" v-if="menuShow('certificate') && activity.certificateTemplateId">
                <!--证书-->
                <div :class="{'item': true, 'active': menus.certificate.selected}" @click="toCertificate">
                    <img :src="menus.certificate.activeIconUrl" v-if="menus.certificate.selected">
                    <img :src="menus.certificate.defaultIconUrl" v-else>
                    <span>{{menus.certificate.name}}</span>
                </div>
            </div>
            <div class="message menu-item" v-if="menuShow('notice')">
                <!--发通知-->
                <div :class="{'item': true, 'active': menus.notice.selected}" @click="toAddNotice">
                    <img :src="menus.notice.activeIconUrl" v-if="menus.notice.selected">
                    <img :src="menus.notice.defaultIconUrl" v-else>
                    <span>{{menus.notice.name}}</span>
                </div>
            </div>
            <div class="statistics menu-item" v-if="menuShow('stat')">
                <!--统计-->
                <div :class="{'item': true, 'active': menus.stat.selected}" @click="toStat">
                    <img :src="menus.stat.activeIconUrl" v-if="menus.stat.selected">
                    <img :src="menus.stat.defaultIconUrl" v-else>
                    <span>{{menus.stat.name}}</span>
                </div>
            </div>
            <div class="entry menu-item" v-if="customAppConfigs" v-show="activity.openCustomAppConfig">
                <!--自定义应用列表-->
                <div v-for="(appConfig, acIndex) in customAppConfigs" :key="'custom-app-config-' + acIndex" :class="{'item': true, 'active': menus[appConfig.code].selected}" @click="toCustomApp(acIndex)" v-if="menuShow(appConfig.code)">
                    <img :src="menus[appConfig.code].activeIconUrl" v-if="menus[appConfig.code].selected">
                    <img :src="menus[appConfig.code].defaultIconUrl" v-else>
                    <span>{{menus[appConfig.code].name}}</span>
                </div>
            </div>
            <div class="statistics menu-item" v-if="menuShow('setting')">
                <!--设置-->
                <div :class="{'item': true, 'active': menus.setting.selected}" th:if="${isCreator}" @click="toSetting">
                    <img :src="menus.setting.activeIconUrl" v-if="menus.setting.selected">
                    <img :src="menus.setting.defaultIconUrl" v-else>
                    <span>{{menus.setting.name}}</span>
                </div>
            </div>
        </div>
    </div>
    <!--活动主页二维码-->
    <el-dialog
            :visible.sync="activityHomeQrcodeShow"
            custom-class="qrCode-dialog"
            width="428px"
            center>
        <div class="inner">
            <div id="qrCode"></div>
            <p class="tips">扫码访问</p>
        </div>
    </el-dialog>
    <div class="content">
        <iframe id="content" src=""></iframe>
    </div>
</div>
<div th:replace="pc/include/common_js :: common_js(~{::script})">
    <script src="/static/pc/assets/lib/layui/layui.js" th:src="@{/pc/assets/lib/layui/layui.js}"></script>
    <script src="/static/pc/assets/lib/element-ui/lib/index.js" th:src="@{/pc/assets/lib/element-ui/lib/index.js}"></script>
    <script src="/static/pc/assets/lib/jquery.qrcode.min.js" th:src="@{/pc/assets/lib/jquery.qrcode.min.js}"></script>
    <script th:inline="javascript">
        var signWebSimpleDomain = [[${signWebDomain}]];
        signWebSimpleDomain = signWebSimpleDomain.replace(/http(|s):\/\//, "");
        vm = new Vue({
            el: "#activity-vue",
            data: {
                mainDomain: [[${mainDomain}]],
                signWebDomain: [[${signWebDomain}]],
                cloudDomain: [[${cloudDomain}]],
                activity: [[${activity}]],
                loginUser: [[${session._login_user_}]],
                signActivityManageIndex: [[${signActivityManageIndex}]],
                activityMenus: [[${activityMenus}]],
                clazzInteractionMenus: [[${clazzInteractionMenus}]],
                customAppConfigs: [[${customAppConfigs}]],
                menus: {
                    // 报名签到
                    sign_up: {
                        name: [[${signActivityManageIndex.signUpKeyword == null || signActivityManageIndex.signUpKeyword == '' ? '报名' : signActivityManageIndex.signUpKeyword}]] + "名单",
                        defaultIconUrl: ctx + "/pc/assets/images/icon-name-list-default.png",
                        activeIconUrl: ctx + "/pc/assets/images/icon-name-list-active.png",
                        url: "//" + signWebSimpleDomain + "/manage/sign-up?signId=" + [[${signActivityManageIndex.signId}]],
                        selected: false
                    },
                    sign_in: {
                        name: "签到管理",
                        defaultIconUrl: ctx + "/pc/assets/images/icon-sign-in-default.png",
                        activeIconUrl: ctx + "/pc/assets/images/icon-sign-in-active.png",
                        url: "//" + signWebSimpleDomain + "/manage/sign-in/list?signId=" + [[${signActivityManageIndex.signId}]],
                        selected: false
                    },
                    results_manage: {
                        name: "考核管理",
                        defaultIconUrl: ctx + "/pc/assets/images/icon-grade-manage-default.png",
                        activeIconUrl: ctx + "/pc/assets/images/icon-grade-manage-active.png",
                        url: ctx + "/activity/" + [[${activity.id}]] + "/results/manage",
                        selected: false
                    },
                    // 证书
                    certificate: {
                        name: "证书发放",
                        defaultIconUrl: ctx + "/pc/assets/images/certificate-default.png",
                        activeIconUrl: ctx + "/pc/assets/images/certificate-active.png",
                        url: ctx + "/activity/" + [[${activity.id}]] + "/certificate",
                        selected: false
                    },
                    // 通知
                    notice: {
                        name: "发通知",
                        defaultIconUrl: ctx + "/pc/assets/images/icon-notice-default.png",
                        activeIconUrl: ctx + "/pc/assets/images/icon-notice-active.png",
                        url: "//" + signWebSimpleDomain + "/manage/notice/add?signId=" + [[${signActivityManageIndex.signId}]],
                        selected: false
                    },
                    // 统计
                    stat: {
                        name: "统计",
                        defaultIconUrl: ctx + "/pc/assets/images/icon-statistics-default.png",
                        activeIconUrl: ctx + "/pc/assets/images/icon-statistics-active.png",
                        url: ctx + "/activity/" + [[${activity.id}]] + "/stat",
                        selected: false
                    },
                    setting: {
                        name: "设置",
                        defaultIconUrl: ctx + "/pc/assets/images/setting-default.png",
                        activeIconUrl: ctx + "/pc/assets/images/setting-active.png",
                        url: ctx + "/activity/" + [[${activity.id}]] + "/setting/index",
                        selected: false
                    }
                },
                iframeUrl: "",
                activityHomeQrcodeShow: false,
                activityHomeQrcodeGenerated: false
            },
            created: function () {
                var $this = this;
                // 解决跨域
                document.domain = $this.mainDomain;
                $this.additionalMenus();
                $this.$nextTick(function () {
                    var signUpIds = $this.signActivityManageIndex.signUpIds;
                    if (!activityApp.isEmpty(signUpIds) && signUpIds.length > 1) {
                        $this.menus.sign_up.name = ($this.signActivityManageIndex.signUpKeyword || '报名') + "项目";
                    }

                    var newMenus = {};
                    var menuKeys = Object.keys($this.menus);
                    $.each(menuKeys, function (i) {
                        var key = menuKeys[i];
                        if ($this.menuShow(key)) {
                            newMenus[key] = $this.menus[key];
                        }
                    });
                    $this.menus = Object.assign({}, newMenus);

                    app.bindActivityChangeEvent(function (activityId) {
                        if ($this.activity.id == activityId) {
                            window.location.reload();
                        }
                    });
                })
            },
            mounted: function () {
                var $this = this;
                $this.$nextTick(function () {
                    $this.resizePageHeight();
                    window.onresize = function () {
                        $this.resizePageHeight();
                    };
                    var firstMenuKey = Object.keys($this.menus)[0];
                    // 自定义应用配置判断
                    var firstShowAppMenu = false, firstAppIndex;
                    if ($this.customAppConfigs && $this.customAppConfigs.length > 0) {
                        for (var i = 0; i < $this.customAppConfigs.length; i++) {
                            var appConfig = $this.customAppConfigs[i];
                            if (firstMenuKey == appConfig.code) {
                                firstShowAppMenu = true
                                firstAppIndex = i;
                            }
                        }
                    }
                    switch (firstMenuKey) {
                        case 'sign_up':
                            if ($this.signActivityManageIndex.signUpExist) {
                                $this.toSignUpList();
                            } else {
                                $this.toSignInManage();
                            }
                            break;
                        case 'sign_in':
                            $this.toSignInManage();
                            break;
                        case 'results_manage':
                            $this.toResultsManage();
                            break;
                        case 'certificate':
                            $this.toCertificate();
                            break;
                        case 'notice':
                            $this.toAddNotice();
                            break;
                        case 'stat':
                            $this.toStat();
                            break;
                        case 'setting':
                            $this.toSetting();
                            break;
                        case 'discuss':
                            $this.toDiscuss();
                            break;
                        case 'task':
                            $this.toTask();
                            break;
                        case 'homework':
                            $this.toHomework();
                            break;
                        case 'review_management':
                            $this.toReviewManagement();
                            break;
                        default:
                            if (firstShowAppMenu) {
                                $this.toCustomApp(firstAppIndex);
                            }
                            break;
                    }
                })
            },
            methods: {
                additionalMenus: function () {
                    var $this = this;
                    if ($this.activity.openClazzInteraction) {
                        $($this.clazzInteractionMenus).each(function () {
                            $this.activityMenus.push(this.code);
                            $this.menus[this.code] = {
                                name: this.name,
                                defaultIconUrl: ctx + "/pc/assets/images/" + this.defaultIcon + ".png",
                                activeIconUrl: ctx + "/pc/assets/images/" + this.activeIcon + ".png",
                                url: this.url,
                                selected: false
                            }
                        });
                    }
                    if ($this.activity.openCustomAppConfig) {
                        $($this.customAppConfigs).each(function () {
                            $this.activityMenus.push(this.code);
                            $this.menus[this.code] = {
                                name: this.title,
                                defaultIconUrl: $this.cloudDomain + '/star3/origin/' + this.defaultIconCloudId,
                                activeIconUrl: $this.cloudDomain + '/star3/origin/' + this.activeIconCloudId,
                                url: this.url + "?activityId=" + $this.activity.id + "&uid=" + $this.loginUser.uid + "&state=" + $this.loginUser.fid,
                                selected: false
                            }
                        });
                    }
                },
                menuShow: function (menu) {
                    // 目前固定notice和setting存在
                    return this.activityMenus.indexOf(menu) != -1;
                },
                // 活动首页
                activityHome: function () {
                    var $this = this;
                    var home = $this.activity.previewUrl;
                    if (!activityApp.isEmpty(home)) {
                        window.open(home);
                    }
                },
                resizePageHeight: function () {
                    // container的最小高度
                    var containerMinHeight = $(".container").css("min-height");
                    containerMinHeight = containerMinHeight.replace(/px/gi, "");
                    var containerHeight = $(".container").height();
                    // 窗口的高度
                    var windowHeight = $(window).height() - 40;
                    // iframe的高度
                    var iframeHeight = $("#content").height();
                    // iframe中内容的真实高度
                    var iframeContentHeight = $("#content").contents().find("body").find("div:first-child").height() + 24;
                    // container应该取最大高度
                    var maxHeight = containerMinHeight > containerHeight ? containerMinHeight : containerHeight;
                    maxHeight = maxHeight > windowHeight ? maxHeight : windowHeight;
                    maxHeight = maxHeight > iframeHeight ? maxHeight : iframeHeight;
                    maxHeight = maxHeight > iframeContentHeight ? maxHeight : iframeContentHeight;
                    // 如果窗口高度能满足最大高度就是用窗口高度
                    if (windowHeight > iframeContentHeight) {
                        maxHeight = windowHeight;
                    }
                    $(".container").height(maxHeight);
                    $("#content")[0].style.height = maxHeight + "px";
                    $("#content").contents().find("body").height(maxHeight);
                },
                loadUrl: function (url, appConfig) {
                    var $this = this;
                    if (url.indexOf("?") != -1) {
                        url += "&";
                    } else {
                        url += "?";
                    }
                    $("#content")[0].src = url + "time=" + new Date().getTime();
                    $("#content")[0].onload = function() {
                        $this.resizePageHeight();
                    };
                },
                selectMenu: function (menuKey, appConfigIndex) {
                    var $this = this;
                    var appConfig;
                    if (!menuKey && !activityApp.isEmpty(appConfigIndex)) {
                        appConfig = $this.customAppConfigs[appConfigIndex];
                        menuKey = appConfig.code;
                    }
                    for (var key in $this.menus) {
                        $this.$set($this.menus[key], "selected", false);
                    }
                    $this.$set($this.menus[menuKey], "selected", true);
                    $this.loadUrl($this.menus[menuKey].url, appConfig);
                },
                // 报名名单
                toSignUpList: function () {
                    var $this = this;
                    $this.selectMenu("sign_up");
                },
                // 签到管理
                toSignInManage: function () {
                    var $this = this;
                    $this.selectMenu("sign_in");
                },
                // 考核管理
                toResultsManage: function () {
                    var $this = this;
                    $this.selectMenu("results_manage");
                },
                // 证书
                toCertificate: function () {
                    var $this = this;
                    $this.selectMenu("certificate");
                },
                // 设置
                toSetting: function () {
                    var $this = this;
                    $this.selectMenu("setting");
                },
                toDiscuss: function () {
                    var $this = this;
                    $this.selectMenu("discuss");
                },
                toTask: function () {
                    var $this = this;
                    $this.selectMenu("task");
                },
                toHomework: function () {
                    var $this = this;
                    $this.selectMenu("homework");
                },
                toReviewManagement: function () {
                    var $this = this;
                    $this.selectMenu("review_management");
                },
                // 发通知
                toAddNotice: function () {
                    var $this = this;
                    $this.selectMenu("notice");
                },
                // 去统计
                toStat: function () {
                    var $this = this;
                    $this.selectMenu("stat");
                },
                //
                toCustomApp: function (appConfigIndex) {
                    var $this = this;
                    $this.selectMenu(null, appConfigIndex)
                },
                // 去编辑活动
                toEdit: function () {
                    var $this = this;
                    var url = ctx + $this.activity.id + "/edit";
                    window.open(url);
                },
                // 是活动创建者
                isActivityCreator: function () {
                    var $this = this;
                    return $this.loginUser.uid == $this.activity.createUid;
                },
                showActivityHomeQrcode: function () {
                    var $this = this;
                    $this.activityHomeQrcodeShow = true;
                    $this.$nextTick(function () {
                        $this.generareActivityHomeQrcode();
                    });
                },
                generareActivityHomeQrcode: function () {
                    var $this = this;
                    if ($this.activityHomeQrcodeGenerated) {
                        return;
                    }
                    var url = $this.activity.previewUrl;
                    $("#qrCode").qrcode({
                        text: url,
                        width: 300,
                        height: 300
                    });
                    $this.activityHomeQrcodeGenerated = true;
                }
            }
        });

        /**
         * 重置iframe的高度
         */
        function resetIframeHeight() {
            vm.resizePageHeight();
        }
    </script>
</div>
</body>
</html>