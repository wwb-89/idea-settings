<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org/">
<head>
    <title th:text="${activity.name}">活动主页</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="/static/pc/assets/css/activityHomePage.css" th:href="@{/pc/assets/css/activityHomePage.css}">
    <style type="text/css">
        [v-cloak] {
            display: none;
        }
    </style>
</head>
<body>
<div class="container" id="activity-vue" v-cloak>
    <div class="slider">
        <div class="title">
            <span th:text="${activity.name}" style="cursor: pointer;" @click="activityHome"></span>
        </div>
        <div class="menu">
            <div class="entry menu-item" v-show="menuShow('sign_up') || menuShow('sign_in')">
                <!--报名名单-->
                <div :class="{'item': true, 'active': menus.signUpList.selected}" v-if="signActivityManageIndex.signUpExist" @click="toSignUpList" v-show="menuShow('sign_up')">
                    <img :src="menus.signUpList.activeIconUrl" v-if="menus.signUpList.selected">
                    <img :src="menus.signUpList.defaultIconUrl" v-else>
                    <span>{{menus.signUpList.name}}</span>
                </div>
                <!--签到管理-->
                <div :class="{'item': true, 'active': menus.signInManage.selected}" @click="toSignInManage" v-show="menuShow('sign_in')">
                    <img :src="menus.signInManage.activeIconUrl" v-if="menus.signInManage.selected">
                    <img :src="menus.signInManage.defaultIconUrl" v-else>
                    <span>{{menus.signInManage.name}}</span>
                </div>
            </div>
            <div class="entry menu-item" v-show="menuShow('results_manage')">
                <!--考核管理-->
                <div :class="{'item': true, 'active': menus.resultsManage.selected}" v-if="signActivityManageIndex.signUpExist || signActivityManageIndex.signInExist" @click="toResultsManage">
                    <img :src="menus.resultsManage.activeIconUrl" v-if="menus.resultsManage.selected">
                    <img :src="menus.resultsManage.defaultIconUrl" v-else>
                    <span>{{menus.resultsManage.name}}</span>
                </div>
            </div>
            <div class="message menu-item" v-if="signActivityManageIndex.signUpExist">
                <!--发通知-->
                <div :class="{'item': true, 'active': menus.notice.selected}" @click="toAddNotice">
                    <img :src="menus.notice.activeIconUrl" v-if="menus.notice.selected">
                    <img :src="menus.notice.defaultIconUrl" v-else>
                    <span>{{menus.notice.name}}</span>
                </div>
            </div>
            <div class="statistics menu-item" v-show="menuShow('stat')">
                <!--统计-->
                <div :class="{'item': true, 'active': menus.stat.selected}" @click="toStat">
                    <img :src="menus.stat.activeIconUrl" v-if="menus.stat.selected">
                    <img :src="menus.stat.defaultIconUrl" v-else>
                    <span>{{menus.stat.name}}</span>
                </div>
            </div>
            <div class="statistics menu-item">
                <!--设置-->
                <div :class="{'item': true, 'active': menus.setting.selected}" th:if="${isCreator}" @click="toSetting">
                    <img :src="menus.setting.activeIconUrl" v-if="menus.setting.selected">
                    <img :src="menus.setting.defaultIconUrl" v-else>
                    <span>{{menus.setting.name}}</span>
                </div>
            </div>
        </div>
    </div>
    <div class="content">
        <iframe id="content" src=""></iframe>
    </div>
</div>
<div th:replace="pc/include/common_js :: common_js(~{::script})">

    <script th:inline="javascript">
        activityVue = new Vue({
            el: "#activity-vue",
            data: {
                activity: [[${activity}]],
                loginUser: [[${session._login_user_}]],
                signActivityManageIndex: [[${signActivityManageIndex}]],
                activityMenus: [[${activityMenus}]],
                menus: {
                    // 报名签到
                    signUpList: {name: "报名名单", defaultIconUrl: ctx + "/pc/assets/images/icon-name-list-default.png", activeIconUrl: ctx + "/pc/assets/images/icon-name-list-active.png", url: "//reading.chaoxing.com/qd/manage/sign-up?signId=" + [[${signActivityManageIndex.signId}]], selected: false},
                    signInManage: {name: "签到管理", defaultIconUrl: ctx + "/pc/assets/images/icon-sign-in-default.png", activeIconUrl: ctx + "/pc/assets/images/icon-sign-in-active.png", url: "//reading.chaoxing.com/qd/manage/sign-in/list?signId=" + [[${signActivityManageIndex.signId}]], selected: false},
                    resultsManage: {name: "考核管理", defaultIconUrl: ctx + "/pc/assets/images/icon-grade-manage-default.png", activeIconUrl: ctx + "/pc/assets/images/icon-grade-manage-active.png", url: ctx + "/activity/" + [[${activity.id}]] + "/results/manage", selected: false},
                    // 通知
                    notice: {name: "发通知", defaultIconUrl: ctx + "/pc/assets/images/icon-notice-default.png", activeIconUrl: ctx + "/pc/assets/images/icon-notice-active.png", url: "//reading.chaoxing.com/qd/manage/notice/add?signId=" + [[${signActivityManageIndex.signId}]], selected: false},
                    // 统计
                    stat: {name: "统计", defaultIconUrl: ctx + "/pc/assets/images/icon-statistics-default.png", activeIconUrl: ctx + "/pc/assets/images/icon-statistics-active.png", url: ctx + "/activity/" + [[${activity.id}]] + "/stat", selected: false},
                    setting: {name: "设置", defaultIconUrl: ctx + "/pc/assets/images/setting-default.png", activeIconUrl: ctx + "/pc/assets/images/setting-active.png", url: ctx + "/activity/" + [[${activity.id}]] + "/setting/index", selected: false}
                },
                iframeUrl: ""
            },
            created: function () {
                var $this = this;
                // 解决跨域
                document.domain = "chaoxing.com";
                var signUpIds = $this.signActivityManageIndex.signUpIds;
                if (!activityApp.isEmpty(signUpIds) && signUpIds.length > 1) {
                    $this.menus.signUpList.name = "报名项目";
                }
                app.bindActivityChangeEvent(function (activityId) {
                    if ($this.activity.id == activityId) {
                        window.location.reload();
                    }
                });
            },
            mounted: function () {
                var $this = this;
                $this.resizePageHeight();
                window.onresize = function () {
                    $this.resizePageHeight();
                };
                if ($this.signActivityManageIndex.signUpExist) {
                    $this.toSignUpList();
                }else {
                    $this.toSignInManage();
                }
            },
            methods: {
                menuShow: function (menu) {
                    return this.activityMenus.indexOf(menu) != -1;
                },
                // 活动首页
                activityHome: function () {
                    var $this = this;
                    var home = $this.activity.previewUrl;
                    if (!activityApp.isEmpty(home)) {
                        window.open(home);
                    }
                },
                resizePageHeight: function () {
                    // container的最小高度
                    var containerMinHeight = $(".container").css("min-height");
                    containerMinHeight = containerMinHeight.replace(/px/gi, "");
                    var containerHeight = $(".container").height();
                    // 窗口的高度
                    var windowHeight = $(window).height() - 40;
                    // iframe的高度
                    var iframeHeight = $("#content").height();
                    // iframe中内容的真实高度
                    var iframeContentHeight = $("#content").contents().find("body").find("div:first-child").height() + 24;
                    // container应该取最大高度
                    var maxHeight = containerMinHeight > containerHeight ? containerMinHeight : containerHeight;
                    maxHeight = maxHeight > windowHeight ? maxHeight : windowHeight;
                    maxHeight = maxHeight > iframeHeight ? maxHeight : iframeHeight;
                    maxHeight = maxHeight > iframeContentHeight ? maxHeight : iframeContentHeight;
                    // 如果窗口高度能满足最大高度就是用窗口高度
                    if (windowHeight > iframeContentHeight) {
                        maxHeight = windowHeight;
                    }
                    $(".container").height(maxHeight);
                    $("#content")[0].style.height = maxHeight + "px";
                    $("#content").contents().find("body").height(maxHeight);
                },
                loadUrl: function (url) {
                    var $this = this;
                    if (url.indexOf("?") != -1) {
                        url += "&";
                    } else {
                        url += "?";
                    }
                    $("#content")[0].src = url + "time=" + new Date().getTime();
                    $("#content")[0].onload = function() {
                        $this.resizePageHeight();
                    };
                },
                selectMenu: function (menuKey) {
                    var $this = this;
                    for (var key in $this.menus) {
                        $this.$set($this.menus[key], "selected", false);
                    }
                    $this.$set($this.menus[menuKey], "selected", true);
                    $this.loadUrl($this.menus[menuKey].url);
                },
                // 报名名单
                toSignUpList: function () {
                    var $this = this;
                    $this.selectMenu("signUpList");
                },
                // 签到管理
                toSignInManage: function () {
                    var $this = this;
                    $this.selectMenu("signInManage");
                },
                // 考核管理
                toResultsManage: function () {
                    var $this = this;
                    $this.selectMenu("resultsManage");
                },
                // 设置
                toSetting: function () {
                    var $this = this;
                    $this.selectMenu("setting");
                },
                // 发通知
                toAddNotice: function () {
                    var $this = this;
                    $this.selectMenu("notice");
                },
                // 去统计
                toStat: function () {
                    var $this = this;
                    $this.selectMenu("stat");
                },
                // 去编辑活动
                toEdit: function () {
                    var $this = this;
                    var url = ctx + $this.activity.id + "/edit";
                    window.open(url);
                },
                // 是活动创建者
                isActivityCreator: function () {
                    var $this = this;
                    return $this.loginUser.uid == $this.activity.createUid;
                }
            }
        });

        /**
         * 重置iframe的高度
         */
        function resetIframeHeight() {
            activityVue.resizePageHeight();
        }
    </script>
</div>
</body>
</html>