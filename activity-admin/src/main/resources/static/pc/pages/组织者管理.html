<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="../assets/lib/element-ui/lib/theme-chalk/index.css">
    <link rel="stylesheet" href="../assets/lib/layui/css/layui.css">
    <link rel="stylesheet" href="../assets/lib/zTree_v3/css/zTreeStyle/zTreeStyle.css">
    <link rel="stylesheet" href="../assets/css/public.css">
    <link rel="stylesheet" href="../assets/css/create.css">
    <link rel="stylesheet" href="../assets/css/organizer-manage.css">
    <title>组织者管理</title>
</head>

<body>
    <div class="manage-container" id="vue" v-cloak>
        <div class="manage-header">
            组织者管理
        </div>
        <div class="manage-content">
            <div class="btn-add btn-size fl" onclick="addStuFun()">
                <img src="../assets/images/add-small.png" alt="">
                <span>添加</span>
            </div>
            <div v-show="!checkAllStatus" class="btn-del-disable btn-size fl">批量移除</div>
            <div v-show="checkAllStatus" class="btn-del btn-size fl">批量移除</div>
            <div class="clear"></div>
            <table class="table-box">
                <thead>
                    <tr>
                        <th class="check-box">
                            <el-checkbox v-model="checkAllStatus" class="check-item-checkbox fl"
                                @change="checkAllChange">
                            </el-checkbox>
                        </th>
                        <th>姓名</th>
                        <th>操作</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <th class="check-box">
                            <el-checkbox v-model="checkedStatus[0]" class="check-item-checkbox fl"
                                @change="checkChangeHandle">
                            </el-checkbox>
                        </th>
                        <th>罗五</th>
                        <th>
                            <span @click="dialogVisible=true">权限设置</span>
                            <span @click="deleteShow=true">移除</span>
                        </th>
                    </tr>
                    <tr>
                        <th class="check-box">
                            <el-checkbox v-model="checkedStatus[1]" class="check-item-checkbox fl"
                                @change="checkChangeHandle">
                            </el-checkbox>
                        </th>
                        <th>张三</th>
                        <th>
                            <span @click="dialogVisible=true">权限设置</span>
                            <span @click="deleteShow=true">移除</span>
                        </th>
                    </tr>
                    <tr>
                        <th class="check-box">
                            <el-checkbox v-model="checkedStatus[2]" class="check-item-checkbox fl"
                                @change="checkChangeHandle">
                            </el-checkbox>
                        </th>
                        <th>李四</th>
                        <th>
                            <span @click="dialogVisible=true">权限设置</span>
                            <span @click="deleteShow=true">移除</span>
                        </th>
                    </tr>
                </tbody>
            </table>
            <div class="no-content" style="display: none;">
                暂无内容
            </div>
        </div>

        <!-- 权限设置弹出框 -->
        <el-dialog class="manageStatusDialog" title="权限设置" :visible.sync="dialogVisible" width="422px"
            :before-close="handleClose">
            <div class="manage-name">
                <span>赵嘉豪</span> 拥有以下模块的管理权限
            </div>
            <div class="manage-status">
                <span class="limit-name">报名管理</span>
                <el-switch v-model="value1"></el-switch><span class="limit-detail">管理报名名单、报名审核等功能</span>
            </div>
            <div class="manage-status">
                <span class="limit-name">签到管理</span>
                <el-switch v-model="value2"></el-switch><span class="limit-detail">管理签到、发布签到</span>
            </div>
            <div class="manage-status">
                <span class="limit-name">评价管理</span>
                <el-switch v-model="value3"></el-switch><span class="limit-detail">管理、审核评价内容</span>
            </div>
            <div class="manage-status last-manage-status">
                <span class="limit-name">成绩管理</span>
                <el-switch v-model="value4"></el-switch><span class="limit-detail">审核用户参与活动的成绩是否为合格</span>
            </div>
            <span slot="footer" class="dialog-footer">
                <div @click="dialogVisible = false" class="btn-size btn-cancel">取消</div>
                <div @click="submithandle" class="btn-size btn-submit">确定</div>
            </span>
        </el-dialog>

        <!-- 确认删除分类弹框 -->
        <div class="dailog-box3" v-show="deleteShow">
            <div class="dailog delete-dailog">
                <div class="warn"><img src="../assets/images/warning.png" alt=""></div>
                <span>移除后可重新添加。确定移除吗？</span>
                <div>
                    <div class="normal-btn" @click="handleSave">保留</div>
                    <div class="normal-btn after-sure" @click="handleSure">移除</div>
                </div>
            </div>
        </div>

        <!--添加学生-->
        <div id="addStu" class="addGrade" style="display: none">
            <div class="gradeList">
                <div class="leftCon">
                    <div class="position">
                        <input placeholder="姓名/手机号/工号">
                        <img src="../assets/images/icon-search.png" onclick="positionNode()">
                    </div>
                    <div class="ztreeDiv">
                        <div class="ztree" id="organizationTree"></div>
                    </div>
                </div>
                <div class="rightCon">
                    <div class="title">已选</div>
                    <div class="selectedList selectedList1">
                        <ul>
                        </ul>
                    </div>
                </div>
                <div class="clear"></div>
            </div>
        </div>
    </div>
</body>


</html>
<script type="text/javascript" src="../assets/lib/vue.js"></script>
<script type="text/javascript" src="../assets/lib/jquery.min.js"></script>
<script type="text/javascript" src="../assets/lib/element-ui/lib/index.js"></script>
<script type="text/javascript" src="../assets/lib/layer/layer.js"></script>
<script type="text/javascript" src="../assets/lib/layui/layui.js"></script>
<script type="text/javascript" src="../assets/lib/zTree_v3/js/jquery-1.4.4.min.js"></script>
<script type="text/javascript" src="../assets/lib/zTree_v3/js/jquery.ztree.core.js"></script>
<script type="text/javascript" src="../assets/lib/zTree_v3/js/jquery.ztree.excheck.js"></script>
<script type="text/javascript" src="../assets/lib/zTree_v3/js/jquery.ztree.exedit.js"></script>

<script>
    var vm = new Vue({
        el: '#vue',
        data: function () {
            return {
                checkAllStatus: false,
                checkedStatus: [false, false, false, false],
                dialogVisible: false,
                // 报名管理状态
                value1: false,
                // 签到管理状态
                value2: false,
                // 评价管理状态
                value3: false,
                // 成绩管理状态
                value4: false,
                deleteShow: false
            }
        },
        created: function () {

        },
        mounted: function () {

        },
        methods: {
            checkChangeHandle: function () {
                if (this.checkedStatus.indexOf(true) >= 0) {
                    this.checkAllStatus = true;
                } else {
                    this.checkAllStatus = false;
                }
            },
            checkAllChange: function () {
                for (var i = 0; i < this.checkedStatus.length; i++) {
                    this.checkedStatus[i] = this.checkAllStatus
                }
            },
            handleClose(done) {
                this.dialogVisible = false;
            },
            // 提交事件
            submithandle: function () {
                layer.msg('权限设置成功');
                this.dialogVisible = false;
            },
            handleSave: function () {
                this.deleteShow = false
            },
            handleSure: function () {
                layer.msg('移除成功');
                this.deleteShow = false
            }
        }
    });

    $(function () {
        layui.use(['form', 'layer', 'laypage', 'upload'], function () {
            var $ = layui.jquery,
                layer = layui.layer
        });

        $(".position input").keypress(function (event) {
            if (event.which === 13) {
                positionNode();
            }
        })
    })
    var zNodes = [{
            id: 1,
            pId: 0,
            name: "北京外国语学校（教导处）",
            open: false,
            isSelect: false
        },
        {
            id: 11,
            pId: 1,
            name: "一年级",
            open: false,
            isSelect: false
        },
        {
            id: 111,
            pId: 11,
            name: "1班",
            isSelect: false
        },
        {
            id: 112,
            pId: 11,
            name: "2班",
            isSelect: false
        },
        {
            id: 1111,
            pId: 111,
            name: "小明",
            img: "http://photo.chaoxing.com/p/70458705_80",
            isSelect: true
        },
        {
            id: 1112,
            pId: 111,
            name: "小红",
            img: "http://photo.chaoxing.com/p/70458705_80",
            isSelect: true
        },
        {
            id: 1121,
            pId: 112,
            name: "小刚",
            img: "http://photo.chaoxing.com/p/70458705_80",
            isSelect: true
        },
        {
            id: 1123,
            pId: 112,
            name: "小黑",
            img: "http://photo.chaoxing.com/p/70458705_80",
            isSelect: true
        },
        {
            id: 1124,
            pId: 112,
            name: "小白",
            img: "http://photo.chaoxing.com/p/70458705_80",
            isSelect: true
        },
        {
            id: 2,
            pId: 0,
            name: "二年级",
            open: false,
            isSelect: false
        },
        {
            id: 21,
            pId: 2,
            name: "2班",
            open: false,
            isSelect: false
        },
    ];

    function organizationTree() {
        var setting = {
            check: {
                enable: true
            },
            data: {
                simpleData: {
                    enable: true
                }
            },
            view: {
                addDiyDom: addDiyDom
            }
        };

        function addDiyDom(treeId, treeNode) {
            var spaceWidth = 10;

            var switchObj = $("#" + treeNode.tId + "_switch"),
                icoObj = $("#" + treeNode.tId + "_ico");
            switchObj.remove();
            icoObj.before(switchObj);

            if (treeNode.img) {
                var img = '<img class="stuImg" src="' + treeNode.img + '">';
                icoObj.before(img);
            }

            if (treeNode.level > 0) {
                var spaceStr = "<span style='display: inline-block;width:" + (spaceWidth * treeNode.level) +
                    "px'></span>";
                switchObj.before(spaceStr);
            }

            var btn = $("#" + treeNode.tId + "_check");
            if (btn) btn.bind("click", function () {
                // 判断是否为人员节点
                if (treeNode.isSelect) {
                    if (!btn.hasClass("checkbox_true_full_focus")) {
                        var html = '<li class="tree' + treeNode.id + '">' +
                            '                                <img src="' + treeNode.img + '">' +
                            '                                <p class="name overHidden1">' + treeNode.name +
                            '</p>' +
                            '                                <div class="deleteIcon" onclick = cancelCheck(' +
                            treeNode.id + ')></div>' +
                            '                            </li>'
                        $(".selectedList ul").append(html);
                    } else {
                        $(".selectedList ul li.tree" + treeNode.id).remove();
                    }
                } else if (treeNode.hasOwnProperty('children')) {
                    var result = [];
                    result = findChildren(treeNode, result);
                    if (!btn.hasClass("checkbox_true_full_focus") && !btn.hasClass(
                            "checkbox_true_part_focus")) {
                        if (result.length > 0) {
                            result.forEach(function (item) {
                                var html = '<li class="tree' + item.id + '">' +
                                    '                                <img src="' + item.img + '">' +
                                    '                                <p class="name overHidden1">' +
                                    item.name + '</p>' +
                                    '                                <div class="deleteIcon" onclick = cancelCheck(' +
                                    item.id + ')></div>' +
                                    '                            </li>'
                                $(".selectedList ul").append(html);
                            });
                        }
                    } else {
                        if (result.length > 0) {
                            result.forEach(function (item) {
                                $(".selectedList ul li.tree" + item.id).remove();
                            });
                        }
                    }

                }

            });
        }
        $.fn.zTree.init($("#organizationTree"), setting, zNodes);
    }

    function addStuFun(obj) {
        this.organizationTree();
        layui.use(['layer'], function () {
            var $ = layui.jquery,
                layer = layui.layer;
            var index = layer.open({
                type: 1,
                title: '选择指定人员',
                move: false,
                content: $("#addStu"),
                area: ['660px'],
                btn: ['取消', '确定'],
                shadeClose: true,
                skin: 'addGrade',
                success: function () {},
                yes: function () {
                    layer.close(index)
                },
                btn2: function () {
                    layer.close(index)
                    layer.msg('操作成功');
                    // 获取当前选中对象
                    var nodeIds = [];
                    var selectNodes = [];
                    $(".selectedList ul li").each(function (index, element) {
                        nodeIds.push($(element).attr("class").slice((0, 4)));
                    });
                    nodeIds.forEach(function (id) {
                        selectNodes.push(zNodes.filter(node => node.id == Number(id))[0]);
                    });
                }
            });
        });
    }

    // 取消选中
    function cancelCheck(id) {
        $(".selectedList ul li.tree" + id).remove();
        var treeObj = $.fn.zTree.getZTreeObj("organizationTree");
        var nodes = treeObj.getCheckedNodes();
        if (nodes.length > 0) {
            var node = nodes.filter(item => item.id == id)[0];
            node.checked = false;
            treeObj.updateNode(node, true);
        }
    }
    // 递归找到所有选中的人员节点
    function findChildren(treeNode, result) {
        if (treeNode.isParent) {
            treeNode.children.forEach(function (item) {
                findChildren(item, result);
            })
        } else {
            if (treeNode.isSelect) {
                result.push(treeNode);
            }
        }
        return result;
    }
    // 定位当前搜索节点位置
    function positionNode() {
        $('#organizationTree a').css('background-color', '#FFF');
        var treeObj = $.fn.zTree.getZTreeObj("organizationTree");
        var keywords = $(".position input").val();
        if (keywords != '') {
            var nodes = treeObj.getNodesByParamFuzzy("name", keywords, null);
            if (nodes.length > 0) {
                nodes.forEach(function (node) {
                    treeObj.selectNode(node);
                    $('#' + node.tId + '_a').css('background-color', 'rgba(0, 132, 255, 0.04)');
                });
            }
        }
    }
</script>