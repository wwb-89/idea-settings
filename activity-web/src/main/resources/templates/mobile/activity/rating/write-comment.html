<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org/">
<head>
    <title>写评价</title>
    <meta http-equiv="Content-type" content="text/html; charset=utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, minimal-ui" />
    <meta name="format-detection" content="telephone=no, email=no">
    <meta http-equiv="Pragma" content="no-cache" />
    <meta http-equiv="cache-control" content="no-cache" />
    <link rel="stylesheet" href="/static/mobile/assets/lib/layui/css/layui.css" th:href="@{/mobile/assets/lib/layui/css/layui.css}" />
    <link rel="stylesheet" href="/static/mobile/assets/css/public.css" th:href="@{/mobile/assets/css/public.css}" />
    <link rel="stylesheet" href="/static/mobile/assets/css/activity-comment.css" th:href="@{/mobile/assets/css/activity-comment.css}"/>
</head>
<style>
    body{
        background: #ffffff;
        padding: 0 1rem;
        box-sizing: border-box;
    }
</style>
<body>
    <div class="write-comment" id="write-comment">
        <form class="layui-form" lay-filter="rateForm" action="">
            <div class="rate-box"><div id="rate" class="rate"></div></div>
            <div class="layui-form-item">
               <textarea placeholder="输入评语" class="layui-textarea input-comment" v-model="rateItem.comment"></textarea>
               <span class="textarea_length" :class="remainNum.fontClass">{{remainNum.text}}</span>
            </div>
            <div class="layui-form-item no-name">
                <span class="fl">匿名提交</span>
                <input type="checkbox" name="anonymous" lay-skin="switch" lay-filter="switchTest" title="匿名开关">
             </div>
             <div class="submit" @click="addSubmit($event)">提交</div>
        </form>
    </div>

    <div th:replace="mobile/include/common_js_exclude_fastclick :: common_js(~{::script})">
        <script src="/static/mobile/assets/lib/layui/layui.js" th:src="@{/mobile/assets/lib/layui/layui.js}"></script>
        <script src="/static/mobile/assets/lib/jqthumb.min.js" th:src="@{/mobile/assets/lib/jqthumb.min.js}"></script>
        <script src="/static/mobile/assets/js/common.js" th:src="@{/mobile/assets/js/common.js}"></script>
        <script th:inline="javascript">
            ratingEditVue = new Vue({
                el: "#write-comment",
                data: {
                    activityId: [[${activityId}]],
                    rateItem: {
                        activityId: [[${activityId}]],
                        anonymous: 0,
                        score: 0,
                        comment: ''
                    }
                },
                created: function () {
                },
                mounted: function () {
                    var $this = this;
                    var rateItemTmp = [[${rateItem}]];
                    $this.rateItem = $.extend($this.rateItem, rateItemTmp);
                    $this.initRateEdit($this.rateItem.score);
                    $this.initForm();
                },
                computed: {
                  remainNum: function() {
                      var $this = this;
                      var comment = $this.rateItem.comment;
                      var res = { fontClass: '', text: '500'};
                      if (!comment) {
                          return res;
                      }
                      var nums = 500 - comment.length;
                      if (nums < 0) {
                          res.fontClass = 'red';
                          res.text = `已超过${Math.abs(nums)}字`;
                      } else {
                          res.text = `${nums}`;
                      }
                      return res;
                  }
                },
                methods: {
                    initForm: function() {
                        var $this = this;
                        layui.use('form', function() {
                            var form = layui.form;
                            form.on('switch(switchTest)', function(data) {
                                $this.rateItem.anonymous = data.elem.checked;
                            })
                            form.val('rateForm', $this.rateItem);
                            form.render();
                        });
                    },
                    initRateEdit: function(score) {
                        var $this = this;
                        layui.use(['rate', 'layer'], function () {
                            var rate = layui.rate;
                            rate.render({
                                elem: '#rate'  //绑定元素
                                ,value: score
                                ,text: true
                                ,setText: function(value){ //自定义文本的回调
                                    var arrs = {
                                        '0':'轻触评分',
                                        '1': '较差'
                                        ,'2': '一般'
                                        ,'3': '良好'
                                        ,'4': '很好'
                                        ,'5': '非常棒'
                                    };
                                    $this.rateItem.score = value;
                                    this.span.text(arrs[value] || (value + "星"));

                                    if(value > 2 || (value <= 2 && $('.input-comment').val().length > 0)){
                                        $('.submit').addClass('active')
                                    }else{
                                        $('.submit').removeClass('active')
                                    }
                                }
                            });
                        })
                    },
                    addSubmit: function () {
                        var $this = this;
                        if ($this.rateItem.score <= 2 && activityApp.isEmpty($this.rateItem.comment)) {
                            app.showMsg('请输入低分理由');
                            return;
                        }
                        if ($this.rateItem.comment.length > 500) {
                            app.showMsg('字数太长了');
                            return;
                        }

                        var url = ctx + "/api/activity/rating/add";
                        var tips = "提交";
                        var successMsg = '评论成功';
                        if (!activityApp.isEmpty($this.rateItem.id)) {
                            url = ctx + "/api/activity/rating/update";
                            tips = "修改";
                            successMsg = tips + successMsg;
                        }
                        var postData = {
                            id: $this.rateItem.id,
                            comment: $this.rateItem.comment,
                            score: $this.rateItem.score,
                            anonymous: $this.rateItem.anonymous
                        }
                        var params = {
                            activityId: $this.activityId,
                            activityRatingDetailJsonStr: activityApp.getJsonStr(postData)
                        };
                        app.ajaxPostLoading(url, params, function (data) {
                            if (data.success) {
                                var url = ctx + "/activity/" + $this.activityId + "/rating";
                                app.showMsg(successMsg);
                                app.openUrl(url)
                            } else {
                                var errorMessage = data.message;
                                if (activityApp.isEmpty(errorMessage)) {
                                    errorMessage = tips + "评价失败";
                                }
                                app.showMsg(errorMessage);
                            }
                        }, function () {
                            app.showMsg(tips + "评价失败");
                        });
                    }
                }
            })
        </script>
    </div>

</body>
</html>
