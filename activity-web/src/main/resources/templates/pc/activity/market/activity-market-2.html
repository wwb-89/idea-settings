<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org/">
<head>
	<title th:text="${market == null ? '活动市场' : market.name}">活动市场</title>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<link rel="stylesheet" href="/static/pc/assets/lib/element-ui/lib/theme-chalk/index.css" th:href="@{/pc/assets/lib/element-ui/lib/theme-chalk/index.css}">
	<link rel="stylesheet" href="/static/pc/assets/css/public.css" th:href="@{/pc/assets/css/public.css}">
	<link rel="stylesheet" href="/static/pc/assets/icomoon/style.css" th:href="@{/pc/assets/icomoon/style.css}">
	<link rel="stylesheet" href="/static/pc/assets/css/activity-market.css" th:href="@{/pc/assets/css/activity-market.css}">
	<link rel="stylesheet" href="/static/assets/lib/mescroll/mescroll.css" th:href="@{/assets/lib/mescroll/mescroll.css}">
	<style>
        [v-cloak] {
            display: none;
        }
	</style>
</head>
<body>
<div class="activity-market2" id="activity-vue" v-cloak>
	<div class="header-con">
		<div class="header-inner-content">
			<div class="searchDiv fl">
				<input type="text" placeholder="搜索标题" class="inputValue" v-model.trim="sw" @keyup.enter="search">
				<i class="icon-delete1" v-show="sw" @click="clearSearch"></i>
				<i class="icon-search1" @click="search"></i>
			</div>
			<div class="user fr" th:if="${session._login_user_ != null}" v-if="showFilter('my')">
				<i class="icon-user"></i>
				<a href="javascript:" @click="my">我的活动</a>
			</div>
			<div class="clear"></div>
		</div>
	</div>
	<div class="inner-content">
		<div class="filter">
			<div class="item" v-if="showFilter('activityType') && activityTypes.length > 0">
				<label>类型</label>
				<div class="option-list">
					<ul>
						<li :class="{'active': item.selected}" v-for="(item, index) of activityTypes" v-if="item.value != 'other' || showOtherActivityType" @click="changeActivityTypesSelected(index)">{{item.name}}</li>
					</ul>
				</div>
				<div class="clear"></div>
			</div>
			<div class="item" v-if="showFilter('activityClassify') && classifies.length > 1">
				<label>分类</label>
				<div class="option-list">
					<ul>
						<li :class="{'active': item.selected}" v-for="(item, index) of classifies" @click="changeActivityClassifySelected(index)">{{item.name}}</li>
					</ul>
				</div>
				<div class="clear"></div>
			</div>
			<div class="item" v-if="showFilter('time')">
				<label>时间</label>
				<div class="option-list">
					<ul>
						<li :class="{'active': item.selected, 'date-li': (item.value == 'specified')}" v-for="(item, index) of activityQueryDates" @click="changeActivityTimeSelected(index)">
							{{item.value == 'specified' ? queryParams.date ? queryParams.date : "选择日期" : item.name}}
							<template v-if="item.value == 'specified'">
								<el-date-picker
										class="select-time"
										v-model="queryParams.date"
										size="mini"
										prefix-icon="false"
										type="date"
										placeholder="选择日期"
										format="yyyy-MM-dd"
										value-format="yyyy-MM-dd"
										@change="selectChange">
								</el-date-picker>
							</template>
						</li>
					</ul>
				</div>
				<div class="clear"></div>
			</div>
			<div class="item" v-if="showFilter('region') && regions.length > 0">
				<label>地区</label>
				<div class="option-list">
					<ul>
						<li :class="{'active': item.selected}" v-for="(item, index) of regions" @click="changeActivityRegionsSelected(index)">{{item.name}}</li>
					</ul>
				</div>
				<div class="clear"></div>
			</div>
		</div>
		<div class="switch-box">
			<p class="list-total fl">共 {{total}} 个</p>
			<div class="fr" v-show="loginUser && showFilter('my')">
				<el-checkbox :label="'只看我能' + signUpKeyword" name="type" v-model="signUpAble" @change="changeSignUpAbleCheckedStatus"></el-checkbox>
			</div>
		</div>
		<div class="card-list" id="mescroll">
			<ul>
				<li v-for="(item, index) of activities" :key="'item-' + index" @click="detail(index)">
					<div class="inner">
						<div class="img-box">
							<div class="tips-box">
								<!--报名状态-->
								<p style="margin-right: .25rem" :class="{'tips': true, 'color5': (item.status == 2), 'color1': (item.status == 3), 'color3': (item.status == 4)}">{{item.status | activityStatusInstructions}}</p>
								<p v-if="item.hasSignUp && item.signUpStatus == 2 && item.status == 2" class="tips sign color6">{{signUpKeyword}}中</p>
							</div>
							<p class="num" v-if="item.openSignUp"><i class="icon-user"></i>{{item.signedUpNum + (!item.personLimit ? '' : ('/' + item.personLimit))}}</p>
							<div class="type-box">
								<span class="type-item" v-if="index < 2" v-for="(tagName, index) of item.tagNames" :key="'tag-name-' + index" :title="tagName">{{tagName}}</span>
								<span class="type-item" v-if="item.tagNames.length > 2" :title="groupTagNames(item.tagNames, 2)">+{{item.tagNames.length - 2}}</span>
							</div>
							<div class="js-crop-img" style="height: 100%;">
								<img :src="item | getCloudImgUrl(cloudDomain)">
							</div>
						</div>
						<div class="card-info">
							<div class="height80">
								<h2 class="title overHidden2" @click="detail(index)"><span class="info-top" v-show="item.top">置顶</span>{{item.name}}</h2>
								<p class="time overHidden1">{{item.startTime | timestampScopeFormat(item.endTime)}}</p>
							</div>
							<p class="address overHidden1">{{item.organisers}}<span v-show="item.address || item.detailAddress" :title="item.address + item.detailAddress"><i v-show="item.organisers">·</i>{{item.address}}{{item.detailAddress ? item.detailAddress : ''}}</span></p>
						</div>
					</div>
				</li>
			</ul>
			<div class="clear"></div>
		</div>
		<!-- 作为加载完成后占位显示没有更多-->
		<div class="noMore"><span></span></div>
	</div>
</div>
<div th:replace="pc/include/common_js :: common_js(~{::script})">
	<script src="/static/pc/assets/lib/element-ui/lib/index.js" th:src="@{/pc/assets/lib/element-ui/lib/index.js}"></script>
	<script src="/static/assets/lib/mescroll/mescroll.js" th:src="@{/assets/lib/mescroll/mescroll.js}"></script>
	<script src="/static/pc/assets/lib/jqthumb.min.js" th:src="@{/pc/assets/lib/jqthumb.min.js}"></script>
	<script src="/static/pc/assets/js/common.js" th:src="@{/pc/assets/js/common.js}"></script>
	<script src="/static/pc/assets/lib/set-iframe-height-child.js" th:src="@{/pc/assets/lib/set-iframe-height-child.js}"></script>
	<script src="/static/pc/assets/lib/jquery.mCustomScrollbar.concat.min.js" th:src="@{/pc/assets/lib/jquery.mCustomScrollbar.concat.min.js}"></script>
	<script src="/static/pc/assets/lib/iframeResizer.contentWindow.min.js" th:src="@{/pc/assets/lib/iframeResizer.contentWindow.min.js}"></script>
	<script th:inline="javascript">
		vm = new Vue({
			el: '#activity-vue',
			data: {
                mainDomain: [[${mainDomain}]],
                cloudDomain: [[${cloudDomain}]],
				loginUser: [[${session._login_user_}]],
				fids: [[${fids}]],
				signUpKeyword: [[${signUpKeyword}]],
				classifyNames: [[${classifyNames}]],
				activityQueryDates: [[${activityQueryDates}]],
				classifies: [],
				activityTypes: [],
				regions: [[${regions}]],
                areaCode: [[${areaCode}]],
				statuses: [],
				sw: [[${sw == null ? "" : sw}]],
				//筛选查询参数对象
				queryParams: {},
				activities: [],
				total: 0,
				loaded: false,
				topFid: [[${topFid}]],
				hideFilter: [[${hideFilter}]],
				mescroll: null,
                // 是否查询能报名的活动
                signUpAble: [[${signUpAble}]],
				showOtherActivityType: activityApp.showOtherActivityType([[${marketId}]]),

                value:''
			},
			created: function () {
				var $this = this;
                // 解决跨域
                document.domain = $this.mainDomain;
				$this.classifies.push({name: "全部",value: "", selected: true});
				$($this.classifyNames).each(function () {
					$this.classifies.push({name: this,value: this,selected: false});
				});
				$($this.activityQueryDates).each(function (i) {
					$this.$set($this.activityQueryDates[i], "selected", i == 0);
				});
				//地区
				var regions = [];
				if($this.regions.length >0){
					$($this.regions).each(function () {
						var region = this;
						region.value = this.code;
						region.selected = false;
						regions.push(region);
					});
					regions.splice(0, 0, {
						name: "全部",
						value: "",
						selected: true
					});
					$this.regions = regions;
				}
				// 活动类型
				$this.activityTypes = [
					{name: '全部', value: '', selected: true},
					{name: '线上', value: 'online', selected: false},
					{name: '线下', value: 'offline', selected: false},
					{name: '线上+线下', value: 'other', selected: false}
				];
				//状态
				$this.statuses = [
					{name: "全部", value: "", selected: true},
					{name: "即将开始", value: "2", selected: false},
					{name: "进行中", value: "3", selected: false},
					{name: "已结束", value: "4", selected: false}
				];
				$this.resetQueryParams();
			},
			mounted:function() {
				var $this = this;
				$this.resetQueryParams();
				// 如果topFid符合regions的manageFid那么选中
				if (!activityApp.isEmpty($this.topFid) && !activityApp.isEmpty($this.regions)) {
					var exist = false;
					var index = 0;
					$($this.regions).each(function (i) {
						if (this.manageFid == $this.topFid) {
							exist = true;
							index = i;
							return false;
						}
					});
					if (exist) {
						$this.changeActivityRegionsSelected(index);
						return;
					}
				}
				$this.initMescroll();
				// 监听父页面的滚动条是否到底
				if (activityApp.isEmbedded()) {
					window.parent.onscroll = function(){
						//scrollTop是滚动条滚动时，距离顶部的距离
						var scrollTop = window.parent.document.documentElement.scrollTop || window.parent.document.body.scrollTop;
						//windowHeight是可视区的高度
						var windowHeight = window.parent.document.documentElement.clientHeight || window.parent.document.body.clientHeight;
						//scrollHeight是滚动条的总高度
						var scrollHeight = window.parent.document.documentElement.scrollHeight || window.parent.document.body.scrollHeight;
						//滚动条到底部的条件
						if (scrollTop + windowHeight == scrollHeight) {
							if ($this.mescroll) {
								$this.mescroll.triggerUpScroll();
							}
						}
					}
				}
			},
			methods: {
				changeSignUpAbleCheckedStatus: function (value) {
					var $this = this;
					$this.queryParams.signUpAble = value;
					$this.resetDataAndParams();
					$this.reloadMescoll();
				},
				resetDataAndParams: function () {
					var $this = this;
					$this.activities = [];
					$this.queryParams.pageNum = 1;
				},
				//改变选中状态
				changeActivityClassifySelected: function(index){
					var $this = this;
					$($this.classifies).each(function (i) {
						$this.$set($this.classifies[i], "selected", i == index);
					});
					$this.queryParams.activityClassifyName = $this.classifies[index].value;
					$this.resetDataAndParams();
					$this.reloadMescoll();
				},
				changeActivityTimeSelected: function(index){
					var $this = this;
					$($this.activityQueryDates).each(function (i) {
						$this.$set($this.activityQueryDates[i], "selected", i == index);
					});
                    var value = $this.activityQueryDates[index].value;
                    if (value != 'specified') {
                        $this.queryParams.dateScope = value;
                        $this.$set($this.queryParams, "date", "");
                        $this.resetDataAndParams();
                        $this.reloadMescoll();
                    }
				},
				changeActivityRegionsSelected: function(index){
					var $this = this;
					$($this.regions).each(function (i) {
						$this.$set($this.regions[i], "selected", i == index);
					});
					$this.queryParams.areaCode = $this.regions[index].value;
					if (activityApp.isEmpty($this.queryParams.areaCode)) {
						$this.queryParams.areaCode = $this.areaCode;
					}
					$this.resetDataAndParams();
					$this.reloadMescoll();
				},
				changeActivityTypesSelected: function(index){
					var $this = this;
					$($this.activityTypes).each(function (i) {
						$this.$set($this.activityTypes[i], "selected", i == index);
					});
					$this.queryParams.activityType = $this.activityTypes[index].value;
					$this.resetDataAndParams();
					$this.reloadMescoll();
				},
				changeActivityStatusSelected: function(index){
					var $this = this;
					$($this.statuses).each(function (i) {
						$this.$set($this.statuses[i], "selected", i == index);
					});
					$this.queryParams.status = $this.statuses[index].value;
					$this.resetDataAndParams();
					$this.reloadMescoll();
				},
				showFilter: function (type) {
					var $this = this;
					return activityApp.isEmpty($this.hideFilter) || $this.hideFilter.indexOf(type) == -1;
				},
				//重置查询条件
				resetQueryParams: function (){
					var $this = this;
					$this.queryParams = {
						pageNum: 1,
						pageSize: 18,
						style: 2,
						sw: [[${sw == null ? "" : sw}]],
						activityClassifyName: "",
						date: "",
						status: "",
                        areaCode: $this.areaCode,
						activityType: "",
						topFid: [[${topFid}]],
						marketId: [[${marketId}]],
						scope: [[${scope}]],
						flag: [[${flag}]],
                        // 是否只查询能报名的，如果是则不分页
                        signUpAble: $this.signUpAble
					};
					$this.activities = [];
				},
				//数据加载渲染
				loadData: function () {
					var $this = this;
					var url = ctx + "/api/activity/list/participate";
					var params = $this.queryParams;
					$this.loaded = false;
					app.ajaxPost(url, {data: activityApp.getJsonStr(params), pageNum: params.pageNum, pageSize: params.pageSize}, function (data) {
						if (data.success) {
                            $this.loaded = true;
                            $this.queryParams.pageNum++;
							var activities = $this.activities;
							$this.total = data.data.total;
							$this.mescroll.endByPage(data.data.size, $this.signUpAble ? data.data.records.length : data.data.pages);
							if (data.data.records.length < 1) {
								return;
							}
							$(data.data.records).each(function () {
								activities.push(this);
							});
							$this.activities = [];
							$this.activities = activities;
							$this.$nextTick(function () {
								cropImgFun("body");
							});
						} else {
							var errorMessage = data.message;
							if (activityApp.isEmpty(errorMessage)) {
								errorMessage = "加载活动列表失败";
							}
							app.showMsg(errorMessage);
						}
					}, function () {
						app.showMsg("加载活动列表失败");
					});
				},
				clearSearch: function () {
					var $this = this;
					$this.sw = "";
					if ($this.sw != $this.queryParams.sw) {
						$this.search();
					}
				},
				search: function () {
					var $this = this;
					$this.queryParams.sw = $this.sw;
					$("#search-input").blur();
					$this.resetDataAndParams();
					// 重载mescroll依旧会请求数据
					$this.reloadMescoll();
				},
				// 重载mescroll依旧会请求数据
				reloadMescoll: function () {
					var $this = this;
					if ($this.mescroll) {
						$this.mescroll.destroy();
						$this.mescroll = null;
					}
                    $this.initMescroll();
				},
				currenClick:function (currentPage) {
					var $this = this;
					$this.queryParams.pageNum = currentPage;
					$this.loadData();
				},
				detail: function (index) {
					var $this = this;
					var activity = $this.activities[index];
					var previewUrl = activity.previewUrl;
					if (!activityApp.isEmpty(previewUrl)) {
						// 回收积分
						activityApp.integralPush(activity.id, activity.name);
						window.open(previewUrl);
					}
				},
				// 我的活动
				my: function () {
					var url = ctx + "/my";
					window.open(url);
				},
				initMescroll: function () {
					var $this = this;
					if ($this.mescroll != null) {
						return;
					}
					$this.mescroll = new MeScroll("body", {
						up: {
							callback: function () {
								$this.loadData();
							},
							htmlNodata: $this.activities && $this.activities.length < 12 ? '' : '<p class="upwarp-nodata">-- 没有更多了 --</p>',
							noMoreSize: 12
						}
					});
				},
                groupTagNames: function (tagNames, startIndex) {
                    var cloneTagNames = $.extend([], tagNames);
                    cloneTagNames.splice(0, startIndex);
                    return cloneTagNames.join("、");
                },
                selectChange: function (){
                    var $this = this;
                    $('.option-list .date-li').siblings().removeClass('active');
                    $('.option-list .date-li').addClass('active');
                    $this.queryParams.dateScope = "specified";
                    $this.resetDataAndParams();
                    $this.reloadMescoll();
                }
			}
		})
	</script>
</div>
</body>
</html>